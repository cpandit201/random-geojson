/*
 * @here/xyz-maps-core
 * (c) 2019 HERE
 */
/* rbush: Copyright (c) 2016 Vladimir Agafonkin */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@here/xyz-maps-common")):"function"==typeof define&&define.amd?define(["exports","@here/xyz-maps-common"],e):e(((t=t||self).here=t.here||{},t.here.xyz=t.here.xyz||{},t.here.xyz.maps=t.here.xyz.maps||{}),t.here.xyz.maps.common)}(this,function(t,v){"use strict";var o=Math.PI,n=function(t,e){return(t+180)/360*e},i=function(t,e){return(180-180/o*Math.log(Math.tan(o/4+t*o/360)))*e/360},s=function(t,e){return 360*t/e-180},a=function(t,e){var r=180-360*t/e;return 360/o*Math.atan(Math.exp(r*o/180))-90},u={mapSizePixel:function(t,e){return t<<e},lon2x:n,lat2y:i,x2lon:s,y2lat:a,pixelToGeo:function(t,e,r){return{longitude:s(t,r),latitude:a(e,r)}},geoToPixel:function(t,e,r){return{x:n(t,r),y:i(e,r)}}},h=v.global.Math,l=256,p=85.05112878,c=-p,f=function(t,e,r){var o=h.pow(2,r),n=h.floor(u.lon2x(t,o));return[r,h.floor(u.lat2y(e,o)),n]},d=function(t){"number"==typeof t&&(t=String(t));for(var e=t.length,r=0,o=0,n=0;n<e;++n)switch(r*=2,o*=2,t[n]){case"1":o++;break;case"3":o++;case"2":r++}return[e,r,o]},g=function(t,e,r){for(var o,n="";0<t--;)n+=(0!=(r&(o=1<<t)))+2*(0!=(e&o));return n},y=function(t,e,r){var o=l<<t,n=l*r,i=l*e;return[u.x2lon(n,o),u.y2lat(i+l,o),u.x2lon(n+l,o),u.y2lat(i,o)]},m=function(t,e){for(var r=[],o=e[1]-t[1]+1,n=e[2]-t[2]+1,i=0;i<o;i++)for(var s=0;s<n;s++)r[r.length]=g(t[0],t[1]+i,t[2]+s);return r},x={geoToGrid:f,pixelToGrid:function(t,e,r){return[r,h.floor(e),h.floor(t)]},quadToGrid:d,tileXYToQuadKey:g,getGeoBounds:y,getTilesOfLevel:function(t,e){var r=[t],o=0,n=r.length,i=t.length;if(e<=i)return[t.substring(0,e)];for(;i<e;){for(;o<n;o++)r.push(r[o]+"0",r[o]+"1",r[o]+"2",r[o]+"3");o=n,n=r.length,i++}return r.slice(o)},getTilesIds:m,getTilesInRect:function(t,e,r,o,n){180<=r&&(r=180-1e-6),t<=-180&&(t=-180),p<=o&&(o=p-1e-6),e<c&&(e=c+1e-6);var i=f(t,o,n),s=f(r,e,n);return m(i,s)}};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var e,_=(function(t,e){t.exports=function(){function g(t,e,r,o,n){for(;r<o;){if(600<o-r){var i=o-r+1,s=e-r+1,a=Math.log(i),u=.5*Math.exp(2*a/3),h=.5*Math.sqrt(a*u*(i-u)/i)*(s-i/2<0?-1:1),l=Math.max(r,Math.floor(e-s*u/i+h)),p=Math.min(o,Math.floor(e+(i-s)*u/i+h));g(t,e,l,p,n)}var c=t[e],f=r,d=o;for(y(t,r,e),0<n(t[o],c)&&y(t,r,o);f<d;){for(y(t,f,d),f++,d--;n(t[f],c)<0;)f++;for(;0<n(t[d],c);)d--}0===n(t[r],c)?y(t,r,d):y(t,++d,o),d<=e&&(r=d+1),e<=d&&(o=d-1)}}function y(t,e,r){var o=t[e];t[e]=t[r],t[r]=o}function i(t,e){return t<e?-1:e<t?1:0}return function(t,e,r,o,n){g(t,e,r||0,o||t.length-1,n||i)}}()}(e={exports:{}},e.exports),e.exports),b=L,r=L;function L(t,e){if(!(this instanceof L))return new L(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function T(t,e,r){if(!r)return e.indexOf(t);for(var o=0;o<e.length;o++)if(r(t,e[o]))return o;return-1}function S(t,e){w(t,0,t.children.length,e,t)}function w(t,e,r,o,n){n||(n=k(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var i,s=e;s<r;s++)i=t.children[s],B(n,t.leaf?o(i):i);return n}function B(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function M(t,e){return t.minX-e.minX}function O(t,e){return t.minY-e.minY}function F(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function C(t){return t.maxX-t.minX+(t.maxY-t.minY)}function P(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function U(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function k(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function D(t,e,r,o,n){for(var i,s=[e,r];s.length;)(r=s.pop())-(e=s.pop())<=o||(i=e+Math.ceil((r-e)/o/2)*o,_(t,i,e,r,n),s.push(e,i,i,r))}L.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,r=[],o=this.toBBox;if(!U(t,e))return r;for(var n,i,s,a,u=[];e;){for(n=0,i=e.children.length;n<i;n++)s=e.children[n],U(t,a=e.leaf?o(s):s)&&(e.leaf?r.push(s):P(t,a)?this._all(s,r):u.push(s));e=u.pop()}return r},collides:function(t){var e=this.data,r=this.toBBox;if(!U(t,e))return!1;for(var o,n,i,s,a=[];e;){for(o=0,n=e.children.length;o<n;o++)if(i=e.children[o],U(t,s=e.leaf?r(i):i)){if(e.leaf||P(t,s))return!0;a.push(i)}e=a.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,r=t.length;e<r;e++)this.insert(t[e]);return this}var o=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===o.height)this._splitRoot(this.data,o);else{if(this.data.height<o.height){var n=this.data;this.data=o,o=n}this._insert(o,this.data.height-o.height-1,!0)}else this.data=o;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=k([]),this},remove:function(t,e){if(!t)return this;for(var r,o,n,i,s=this.data,a=this.toBBox(t),u=[],h=[];s||u.length;){if(s||(s=u.pop(),o=u[u.length-1],r=h.pop(),i=!0),s.leaf&&-1!==(n=T(t,s.children,e)))return s.children.splice(n,1),u.push(s),this._condense(u),this;i||s.leaf||!P(s,a)?o?(r++,s=o.children[r],i=!1):s=null:(u.push(s),h.push(r),r=0,s=(o=s).children[0])}return this},toBBox:function(t){return t},compareMinX:M,compareMinY:O,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var r=[];t;)t.leaf?e.push.apply(e,t.children):r.push.apply(r,t.children),t=r.pop();return e},_build:function(t,e,r,o){var n,i=r-e+1,s=this._maxEntries;if(i<=s)return S(n=k(t.slice(e,r+1)),this.toBBox),n;o||(o=Math.ceil(Math.log(i)/Math.log(s)),s=Math.ceil(i/Math.pow(s,o-1))),(n=k([])).leaf=!1,n.height=o;var a,u,h,l,p=Math.ceil(i/s),c=p*Math.ceil(Math.sqrt(s));for(D(t,e,r,c,this.compareMinX),a=e;a<=r;a+=c)for(D(t,a,h=Math.min(a+c-1,r),p,this.compareMinY),u=a;u<=h;u+=p)l=Math.min(u+p-1,h),n.children.push(this._build(t,u,l,o-1));return S(n,this.toBBox),n},_chooseSubtree:function(t,e,r,o){for(var n,i,s,a,u,h,l,p,c,f;o.push(e),!e.leaf&&o.length-1!==r;){for(l=p=1/0,n=0,i=e.children.length;n<i;n++)u=F(s=e.children[n]),c=t,f=s,(h=(Math.max(f.maxX,c.maxX)-Math.min(f.minX,c.minX))*(Math.max(f.maxY,c.maxY)-Math.min(f.minY,c.minY))-u)<p?(p=h,l=u<l?u:l,a=s):h===p&&u<l&&(l=u,a=s);e=a||e.children[0]}return e},_insert:function(t,e,r){var o=this.toBBox,n=r?t:o(t),i=[],s=this._chooseSubtree(n,this.data,e,i);for(s.children.push(t),B(s,n);0<=e&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(n,i,e)},_split:function(t,e){var r=t[e],o=r.children.length,n=this._minEntries;this._chooseSplitAxis(r,n,o);var i=this._chooseSplitIndex(r,n,o),s=k(r.children.splice(i,r.children.length-i));s.height=r.height,s.leaf=r.leaf,S(r,this.toBBox),S(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(r,s)},_splitRoot:function(t,e){this.data=k([t,e]),this.data.height=t.height+1,this.data.leaf=!1,S(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,r){var o,n,i,s,a,u,h,l,p,c,f,d,g,y;for(u=h=1/0,o=e;o<=r-e;o++)n=w(t,0,o,this.toBBox),i=w(t,o,r,this.toBBox),p=n,c=i,void 0,f=Math.max(p.minX,c.minX),d=Math.max(p.minY,c.minY),g=Math.min(p.maxX,c.maxX),y=Math.min(p.maxY,c.maxY),s=Math.max(0,g-f)*Math.max(0,y-d),a=F(n)+F(i),s<u?(u=s,l=o,h=a<h?a:h):s===u&&a<h&&(h=a,l=o);return l},_chooseSplitAxis:function(t,e,r){var o=t.leaf?this.compareMinX:M,n=t.leaf?this.compareMinY:O;this._allDistMargin(t,e,r,o)<this._allDistMargin(t,e,r,n)&&t.children.sort(o)},_allDistMargin:function(t,e,r,o){t.children.sort(o);var n,i,s=this.toBBox,a=w(t,0,e,s),u=w(t,r-e,r,s),h=C(a)+C(u);for(n=e;n<r-e;n++)i=t.children[n],B(a,t.leaf?s(i):i),h+=C(a);for(n=r-e-1;e<=n;n--)i=t.children[n],B(u,t.leaf?s(i):i),h+=C(u);return h},_adjustParentBBoxes:function(t,e,r){for(var o=r;0<=o;o--)B(e[o],t)},_condense:function(t){for(var e,r=t.length-1;0<=r;r--)0===t[r].children.length?0<r?(e=t[r-1].children).splice(e.indexOf(t[r]),1):this.clear():S(t[r],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}},b.default=r;var E=256,q=null,X=function(){function t(t,e,r){var o=d(t);this.quadkey=t,this.z=o[0],this.y=o[1],this.x=o[2],this.type=e,this.expire=r,this.bounds=y(o[0],o[1],o[2])}return t.prototype.expired=function(t){return(t=t||Date.now())-this.loadStopTs>1e3*this.expire},t.prototype.add=function(t){var e=this.data;e&&-1==e.indexOf(t)&&(e.push(t),this.tree&&this.tree.insert(t))},t.prototype.remove=function(t){var e=this.data.indexOf(t);-1!==e&&(this.data.splice(e,1),this.tree&&this.tree.remove(t))},t.prototype.createTree=function(t){this.tree=b(9,[".bbox[0]",".bbox[1]",".bbox[2]",".bbox[3]"]),t&&this.tree.load(t)},t.prototype.search=function(t){if(this.tree)return this.tree.search(t)},t.prototype.isLoaded=function(){return"number"==typeof this.loadStopTs},t.prototype.getContentBounds=function(){if(!this.cbnds){var t=this.bounds,e=this.provider.margin;if(e){var r=E<<this.z,o=u.lon2x(t[0],r),n=u.lat2y(t[1],r);this.cbnds=[u.x2lon(o-e,r),u.y2lat(n+e,r),u.x2lon(o+e+E,r),u.y2lat(n-e-E,r)]}else this.cbnds=this.bounds}return this.cbnds},t.prototype.project=function(t,e){var r=E<<this.z,o=this.x*E,n=this.y*E;return[Math.round(u.lon2x(t,r)-o),Math.round(u.lat2y(e,r)-n)]},t.prototype.lon2x=function(t){var e=E<<this.z,r=this.x*E;return Math.round(u.lon2x(t,e)-r)},t.prototype.lat2y=function(t){var e=E<<this.z,r=this.y*E;return Math.round(u.lat2y(t,e)-r)},t}(),Y=X.prototype;Y.expire=1/0,Y.error=q,Y.canvasX=q,Y.canvasY=q;var R=[{zIndex:0,type:"Circle",radius:6,fill:"#ff0000"}],j=[{zIndex:0,type:"Line",strokeWidth:10,stroke:"#ff0000"}],z=[{zIndex:0,type:"Polygon",strokeWidth:1,stroke:"#ffffff",fill:"#ff0000"}],A={styleGroups:{Point:R,MultiPoint:R,LineString:j,MultiLineString:j,Polygon:z,MultiPolygon:z},assign:function(t){return t.geometry.type}};function I(t,e){for(var r in e)t[r]=e[r];return t}var G=[],J=function(){function t(t,e){this.styleGroups=null,this._c=null;for(var r in t.assign&&(this.assign=t.assign),t)this[r]=t[r];this._c=e||{}}return t.prototype.assign=function(t,e){return t.geometry.type},t.prototype.getStyleGroup=function(t,e,r){var o=this._c[t.id];return(null==o||r)&&"object"!=typeof(o=this.assign(t,e))&&(o=this.styleGroups[o]),o},t.prototype.setStyleGroup=function(t,e,r){var o=t.id,n=this._c;return e&&r&&(e=this.merge(this.getStyleGroup(t),e)),e?n[o]=e:null===e||!1===e?e=n[o]=G:n[o]&&delete n[o],e},t.prototype.merge=function(t,e){if(null===e||!1===e)return null;for(var r,o=[],n=0,i=t.length;n<i;n++)r=I({},t[n]),e[n]&&I(r,e[n]),o[n]=r;return o},t}(),N="featureRemove",H="featureAdd",Q="featureCoordinatesChange",K="styleGroupChange",W="styleChange",Z="clear",V=function(){function t(t){this._p=[],this._sd=null,this._pev=!0,this.__type="Layer",this.margin=20,this.name="",this.min=15,this.max=20;var r=this;for(var e in t)r[e]=t[e];null==r.id&&(r.id="L-"+(1e8*Math.random()^0)),r._l=new v.Listener(H,N,Q,Z,K,"viewportReady",W);var o,n=t.providers||t.provider;if(n instanceof Array)for(var i=0,s=void 0;i<n.length;i++)for(var a=(s=n[i]).min;a<=s.max;a++)r._p[a]=s.provider;else for(var u=r.min;u<=r.max;u++)r._fp=r._p[u]=n,r._fp.minLevel=r.min,r._fp.maxLevel=r.max;r._p.forEach(function(t,e){"FeatureProvider"==t.__type&&(t.addEventListener(H,r._afl,r),t.addEventListener(N,r._rfl,r),t.addEventListener(Q,r._mfl,r)),t.addEventListener(Z,r._cpl,r)}),r.setMargin(r.getMargin());var h=this._fp&&this._fp.styles;(o=t.style||t.styles||h||A)&&r.setStyle(o),["style","styles","provider","providers"].forEach(function(t){delete r[t]})}return t.prototype.getProvider=function(t){return t?this._p[0^t]:this._fp},t.prototype.addEventListener=function(t,e,r){var o=this._l;return o.isDefined(t)?o.add(t,e,r):this._fp&&this._fp.addEventListener(t,e,r)},t.prototype.removeEventListener=function(t,e,r){var o=this._l;return o.isDefined(t)?o.remove(t,e,r):this._fp.removeEventListener(t,e,r)},t.prototype._mfl=function(t,e,r,o){this._l.trigger(Q,[t,e,r,this],!0)},t.prototype._cpl=function(t,e){this._l.trigger(Z,[this,e],!0)},t.prototype._afl=function(t,e){this._l.trigger(H,[t,e,this],!0)},t.prototype._rfl=function(t,e){this.setStyleGroup(t),this._l.trigger(N,[t,e,this],!0)},t.prototype.setFeatureCoordinates=function(t,e){return this._fp.setFeatureCoordinates(t,e)},t.prototype.addFeature=function(t,e){var r=this._fp;if(r.addFeature)return t=r.addFeature(t),e&&this.setStyleGroup(t,e),t},t.prototype.removeFeature=function(t){var e=this._fp;if(e.removeFeature)return e.removeFeature(t)},t.prototype.setStyleGroup=function(t,e,r){this._sd&&this._l.trigger(K,[t,this._sd.setStyleGroup(t,e,r),this],!0)},t.prototype.getStyleGroup=function(t,e,r){return this._sd&&this._sd.getStyleGroup(t,e,r)},t.prototype.search=function(){var t=this._fp;if(t&&t.search)return t.search.apply(this._fp,arguments)},t.prototype.getTile=function(t,e){var r=t.length,o=this._p[r];if(o)return o.getTile(t,e)},t.prototype.cancelTile=function(t,e){var r="string"==typeof t?t.length:t.quadkey.length,o=this._p[r];if(o&&o.cancel)return o.cancel(t,e)},t.prototype.getCachedTile=function(t){var e=t.length,r=this._p[e];if(r)return r.getCachedTile(t)},t.prototype.setStyle=function(t,e){function r(t){return"function"==typeof t}r(t.getStyleGroup)&&r(t.setStyleGroup)||(t=new J(t,e&&this._sd&&this._sd._c)),this._sd=t,this._l.trigger(W,[t,this],!0)},t.prototype.getStyle=function(){return this._sd},t.prototype.getMargin=function(){return this.margin},t.prototype.setMargin=function(t){t=Number(t||0);for(var e=this._p,r=e.length;r--;)e[r]&&e[r].setMargin(t);return this.margin=t},t.prototype.pointerEvents=function(t){return null!=t&&(this._pev=!!t),this._pev},t.prototype.getCopyright=function(e){for(var t,r=this._p.filter(function(t,e,r){return r.indexOf(t)===e}),o=[],n=0,i=function(t){t.length&&o.push.apply(o,t),--n||e&&e(o)};t=r.pop();)t&&t.getCopyright&&(n++,t.getCopyright(i))},t}();V.prototype.modifyFeatureCoordinates=V.prototype.setFeatureCoordinates;var $=function(t,e){this.longitude=t,this.latitude=e},tt=function(t,e,r,o){this.minLon=t,this.minLat=e,this.maxLon=r,this.maxLat=o},et=function(t,e){this.x=t,this.y=e},rt=function(t,e,r,o){this.minX=t,this.minY=e,this.maxX=r,this.maxY=o},ot=function(){function t(t,e){this._m=0,this.id=t.id,this.properties=t.properties,this.geometry=t.geometry,this.bbox=t.bbox,this._provider=e}return t.prototype.toJSON=function(){return v.JSUtils.clone({id:this.id,type:this.type,bbox:this.bbox,properties:this.properties,geometry:this.geometry})},t.prototype.getProvider=function(){return this._provider},t.prototype.getBBox=function(){return this._provider.decBBox(this)},t}();ot.prototype.type="Feature";var nt=function(){function t(t,e,r){this.lvl=t,this.main="object"==typeof e?e:new v.LRU(e||256),this.sub="object"==typeof r?r:new v.LRU(e||1024),this.main._onDrop=this.main._onDrop||{},this._onDrop=this.main._onDrop}return t.prototype.onDrop=function(t,e){this._onDrop[e.id]=t},t.prototype.forEach=function(t){this.main.forEach(t),this.sub.forEach(t)},t.prototype.clear=function(){this.main.clear(),this.sub.clear()},t.prototype.getCache=function(t){return t==this.lvl?this.main:this.sub},t.prototype.remove=function(t){this.getCache(t.z).remove(t.quadkey)},t.prototype.get=function(t){return this.getCache(t.length).get(t)},t.prototype.set=function(t){var e=this.getCache(t.z).set(t.quadkey,t),r=this._onDrop;e&&r&&(r=r[e.provider.id])&&r(e)},t}(),it=function(){function t(t){this._onDrop={},this.cache=new v.LRU(t||256)}return t.prototype.forEach=function(t){this.cache.forEach(t)},t.prototype.clear=function(){this.cache.clear()},t.prototype.remove=function(t){this.cache.remove(t.quadkey)},t.prototype.get=function(t){return this.cache.get(t)},t.prototype.set=function(t){var e,r=this.cache.set(t.quadkey,t),o=this._onDrop;r&&o&&(e=o[r.provider.id])&&e(r)},t.prototype.onDrop=function(t,e){this._onDrop[e.id]=t},t}(),st=function(t,e){return(st=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function at(t,e){function r(){this.constructor=t}st(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var ut=function(){function t(t,e){this.margin=0,this.dep={},this.Tile=X,this.size=256,this.expire=1/0;for(var r in t=t||{},e)t[r]=e[r];for(var r in t)this[r]=t[r];null==this.id&&(this.id="TP-"+(1e6*Math.random()^0)),this.storage=t.storage||new nt(this.level),this.initStorage(this.storage),this.listeners=new v.Listener("featureAdd","featureRemove","featureCoordinatesChange","clear","error")}return t.prototype.initStorage=function(t){t.onDrop(this._removeTile.bind(this),this)},t.prototype.addEventListener=function(t,e,r){return this.listeners.add(t,e,r)},t.prototype.removeEventListener=function(t,e,r){return this.listeners.remove(t,e,r)},t.prototype.clear=function(t){this.storage.clear()},t.prototype.getCachedTile=function(t){return this.storage.get(t)},t.prototype.setMargin=function(t){this.margin=Number(t),this.storage.forEach(function(t){return t.cbnds=null})},t.prototype.getCachedTilesOfBBox=function(t,h){var l=t[0],p=t[1],c=t[2],f=t[3],d=[];return h^=0,this.storage.forEach(function(t){var e,r,o,n,i,s,a,u=t.getContentBounds();e=u[0],r=u[2],o=u[1],n=u[3],i=l,s=p,a=f,e<=c&&i<=r&&o<=a&&s<=n&&(!h||t.z==h)&&(d[d.length]=t)}),d},t.prototype.config=function(t){for(var e in t=t||{})this.config[e]=t[e];return this},t.prototype.createTile=function(t){var e=new this.Tile(t,this.dataType,this.expire);return e.provider=this,e},t}();ut.prototype.__type="Provider";var ht=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.executing=0,this.parallel=16,this.q=[],this.lq={},this.src=t}return t.prototype.exec=function(){for(var t=this.q;t.length&&this.executing<this.parallel;)this.fire(t.pop(),t.pop(),t.pop())},t.prototype.fire=function(r,o,e,t){var n=this,i=n.src,s=n.lq;t^=0;n.executing++,s[r.quadkey]=[r,o,e,t],i[t].load(r,function(t,e){n.executing--,delete s[r.quadkey],n.exec(),o(t,e)},function(t){e(t),n.executing--,delete s[r.quadkey],n.exec()})},t.prototype.tile=function(t,e,r){this.q.push(r,e,t),this.exec()},t.prototype.abort=function(t){var e,r,o=this,n=o.q,i=o.lq,s=o.src,a=!0;return-1!==(e=n.indexOf(t))?n.splice(e-2,3):(r=i[t.quadkey])?(o.executing--,delete i[t.quadkey],s[r[3]].abort(t)):a=!1,o.exec(),a},t.prototype.store=function(t,e){var r=this.src;for(var o in r)if(r[o].store){r[o].store(t,e);break}},t.prototype.clear=function(){this.src.forEach(function(t){t.clear&&t.clear()})},t.prototype.setUrl=function(){var t=this.src;for(var e in t)t[e].setUrl&&t[e].setUrl.apply(t[e],arguments)},t}(),lt=function(){function t(t){for(var e in this.withCredentials=!1,this.responseType="",t)this[e]=t[e]}return t.prototype.send=function(t){var o=t.success,e=t.error,n=t.responseType||this.responseType,r=t.headers,i=new XMLHttpRequest,s=t.withCredentials;if(i.withCredentials=null!=s?s:this.withCredentials,i.responseType="json"==n?"text":n,i.onload=function(){var t,e,r=this.responseType;""==r||"text"==r?(e=(t=this.responseText).length,"json"==n&&204!=this.status&&(t=JSON.parse(t))):e=(t=this.response).byteLength,200<=this.status&&this.status<=226&&o(t,e)},i.onreadystatechange=function(){4==this.readyState&&(this.status<200||300<=this.status)&&(this.onload=null,0!==this.status&&e&&e(this))},i.open(t.type||"GET",t.url,!0),r)for(var a in r)i.setRequestHeader(a,r[a]);return i.send(t.data||null),i},t}(),pt={},ct=/{([xX]|(COL))}/,ft=/{([yY]|(ROW))}/,dt=/{([zZ]|(LEVEL))}/,gt=/{((qk)|(QK)|(quadkey)|(QUADKEY))}/,yt=/{SUBDOMAIN_INT_1_4}/,vt=/{SUBDOMAIN_INT}/,mt=/{SUBDOMAIN_CHAR}/,xt=function(t){this.name="NetworkError";var e=t.responseType;this.message="Service request failed with HTTP status: '"+t.status+" "+t.statusText+"'",this.statusCode=t.status,""!=e&&"text"!=e||(this.responseText=t.responseText||null)},_t=function(){function t(t){this.withCredentials=!1,this.headers=null,this.store=null,this.baseUrl=null,this.q={};var e=t.responseType||"json",r=t.src||t.url,o=!!t.withCredentials;this.withCredentials=o,this.baseUrl=r,this.headers=v.JSUtils.extend(v.JSUtils.clone(pt),t.headers||{}),"function"==typeof r&&(this.getUrl=function(t){return r(t.z,t.y,t.x,t.quadkey)}),this.http=new lt({responseType:e,withCredentials:o})}return t.prototype.getUrl=function(t){var e=4*Math.random()^0;return this.baseUrl.replace(yt,e+1).replace(vt,e).replace(mt,"abcd"[e]).replace(gt,t.quadkey).replace(dt,t.z).replace(ct,t.x).replace(ft,t.y)},t.prototype.setUrl=function(t){this.baseUrl=t},t.prototype.load=function(t,r,e){var o,n=this.getUrl(t),i=t.quadkey,s=this.q,a={key:i,url:n,success:r,error:e};"image"==t.type?(a.responseType="blob",a.success=function(t){s[i]=o;var e=new Image;e.onload=function(t){delete s[i],v.global.URL.revokeObjectURL(e.src),o._aborted||r(e)},e.src=v.global.URL.createObjectURL(t)}):("json"==t.type&&(a.success=function(t,e){r("FeatureCollection"==t.type?t.features:t,e)}),a.headers=this.headers),o=this.send(a)},t.prototype.abort=function(t){var e=this.q,r=t.quadkey,o=e[r];o&&("image"==t.type&&(o.onload=void 0,o._aborted=!0),o.abort&&o.abort(),delete e[r])},t.prototype.send=function(t){var r=t.key||Math.random(),o=this.q,n=t.success;t.success=function(t,e){delete o[r],n(t,e)};var e=t.error;return t.error=function(t){delete o[r],e(new xt(t))},o[r]=this.http.send(t)},t}();function bt(){return+new Date}var Lt=function(n){function t(t,e){var r=n.call(this,t,{storage:new it(512)})||this;r.name="",r.opacity=1,r.dataType="image";var o=r;return o.loader||(o.loader=new ht(new _t({url:t.url,headers:{Accept:"*/*"}}))),r}return at(t,n),t.prototype.getTile=function(t,e){var o,r=this.loader,n=this.storage;return void 0===(o=n.get(t))&&(n.set(o=this.createTile(t)),o.onLoaded=[]),o.loadStopTs?e&&e(o):(e&&-1==o.onLoaded.indexOf(e)&&o.onLoaded.push(e),o.loadStartTs||(o.loadStartTs=bt(),r.tile(o,function(t){o.loadStopTs=bt(),o.data=t;for(var e=0,r=o.onLoaded;e<r.length;e++){(0,r[e])(o)}o.onLoaded=void 0},function(t){o.loadStopTs=bt(),o.error=t}))),o},t.prototype._removeTile=function(t){t.isLoaded()||(this.storage.remove(t),this.loader.abort(t))},t.prototype.getLoader=function(){return this.loader},t.prototype.clear=function(t){var e=this,r=null;if(t instanceof Array){r=e.getCachedTilesOfBBox(t,e.level);for(var o=0,n=void 0;o<r.length;o++)n=r[o],e.storage.remove(n),r[o]=n.quadkey}else 0==arguments.length&&this.storage.clear();e.listeners.trigger("clear",[e,r],!0)},t.prototype.cancel=function(t){var e;(e=t instanceof X?t:this.storage.get(t))&&this._removeTile(e)},t}(ut);Lt.prototype.__type="ImageProvider";var Tt,St=function(t,e){for(var r,o,n,i,s=t.length;s--;)r=t[s],i=n=void 0,(o=e)&&((n=r[0])<o[0]&&(o[0]=n),n>o[2]&&(o[2]=n),(i=r[1])<o[1]&&(o[1]=i),i>o[3]&&(o[3]=i))},wt=function(t){var e,r=t.geometry.type,o=t.geometry.coordinates,n=!0;if("Point"==r)t.bbox=[o[0],o[1],o[0],o[1]];else if(e=t.bbox=[1/0,1/0,-1/0,-1/0],"MultiLineString"==r)for(var i=0;i<o.length;i++)St(o[i],e);else if("MultiPolygon"==r)for(var s=0;s<o.length;s++)St(o[s][0],e);else"LineString"==r||"MultiPoint"==r?St(o,e):"Polygon"==r?St(o[0],e):n=!1;return n},Bt=function(t){return null!=t.id?t.id=t.id:t.id=1e8*Math.random()^0,t.bbox?(6===t.bbox.length&&(t.bbox=[t.bbox[0],t.bbox[1],t.bbox[3],t.bbox[4]]),t):wt(t)&&t},Mt=Object.freeze({updateBBox:wt,prepareFeature:Bt}),Ot="featureRemove";function Ft(t){this.feature=t}Ft.prototype.cnt=0;var Ct=function(o){function t(t,e){var r=o.call(this,t,e)||this;return r.IDPOOL={},r.dataType="json",r.ignore=!1,r.cnt=0,r.__type="FeatureProvider",r.tree=b(9,[".bbox[0]",".bbox[1]",".bbox[2]",".bbox[3]"]),r.Feature=r.Feature||ot,r}return at(t,o),t.prototype.isDroppable=function(t){return!0},t.prototype.addFeature=function(t){var e,r,o,n=this;if("FeatureCollection"==t.type&&(t=t.features),o=t.length){for(var i=[],s=0;s<o;s++)i[s]=n.addFeature(t[s]);return i}if(n.isFeatureInstance(t,ot)&&t._provider&&t._provider!=n&&(t=t.toJSON()),!1!==(e=n.prepareFeature(t))){if((r=n._insert(e))!=Tt){t=r;for(var a=n.getCachedTilesOfBBox(n.decBBox(t)),u=0,h=void 0;u<a.length;u++)(h=a[u]).add(t),h.z==n.level&&this._mark(t,h);n.tree&&n.tree.insert(t),n.ignore||n.listeners.trigger("featureAdd",[t,a],!0)}}else t=null;return t},t.prototype.all=function(){return this.tree?this.tree.all():this._s({minX:-180,maxX:180,minY:-90,maxY:90})},t.prototype.getFeature=function(t){if(this.IDPOOL[t])return this.IDPOOL[t].feature},t.prototype.getFeatures=function(t,e){t instanceof Array||(t=[t]);for(var r=[],o=0;o<t.length;o++)r[o]=this.getFeature(t[o]);return 1==r.length?r[0]:r},t.prototype.getTile=function(t,e){var r=this.storage,o=r.get(t);return o===Tt&&(r.set(o=this.createTile(t)),o.loadStartTs=o.loadStopTs=Date.now(),o.data=this.search(o.getContentBounds())),e&&e(o),o},t.prototype.setFilter=function(t){this.filter="function"==typeof t?t:Tt},t.prototype.getFeatureClass=function(t){return this.Feature},t.prototype.isFeatureInstance=function(t,e){return t instanceof e},t.prototype.createFeature=function(t,e){return new e(t,this)},t.prototype.search=function(t,e){var r,o;if("object"==typeof t)if(e)for(var n in t)e[n]=t[n];else e=t;var i=e&&e.radius||1;if(t instanceof Array)o=4==t.length?t:v.geotools.getPointBBox(t,i);else{if("number"==typeof t||"string"==typeof t||!t)return this.getFeatures(t);if(t.longitude!=Tt&&t.latitude!=Tt)o=v.geotools.getPointBBox([t.longitude,t.latitude],i);else if(t.minLon!=Tt&&t.minLat!=Tt&&t.maxLon!=Tt&&t.maxLat!=Tt)o=[t.minLon,t.minLat,t.maxLon,t.maxLat];else{if(r=t.point||t.rect||t.viewport)return this.search(r);if(t.id||t.ids)return this.getFeatures(t.id||t.ids)}}return o={minX:o[0],minY:o[1],maxX:o[2],maxY:o[3]},this._s(o)},t.prototype.exists=function(t){return this.IDPOOL[t.id]},t.prototype.setFeatureCoordinates=function(t,e){var r=t;if(t=this.getFeature(t.id)){var o=t.getBBox(),n=t.geometry.coordinates;this.ignore=!0,this.removeFeature(t),t.geometry.coordinates=this.encCoord(t.geometry.type,e),t.bbox=null,this.addFeature(t),this.ignore=!1,this.listeners.trigger("featureCoordinatesChange",[t,o,n,this],!0)}else r.geometry.coordinates=e,this.updateBBox(r)},t.prototype.removeFeature=function(t){var e;if("FeatureCollection"==t.type&&(t=t.features),e=t.length){for(var r=[],o=0;o<e;o++)r[o]=this.removeFeature(t[o]);return r}if(t=this.getFeature(t.id)){for(var n=this.getCachedTilesOfBBox(this.decBBox(t)),i=void 0,s=0;s<n.length;s++)(i=n[s]).isLoaded()&&i.remove(t);this.cnt--,delete this.IDPOOL[t.id],this.tree&&this.tree.remove(t),this.ignore||this.listeners.trigger(Ot,[t,n],!0)}return t},t.prototype.clear=function(t){var e,r=this,o=null;if(4==arguments.length&&(t=Array.prototype.slice.call(arguments)),t instanceof Array){o=r.getCachedTilesOfBBox(t,r.level);for(var n=0,i=void 0;n<o.length;n++)i=o[n],r._removeTile(i,!1),o[n]=i.quadkey}else if(0==arguments.length){var s={},a=r.IDPOOL,u=0;for(var h in r.tree&&r.tree.clear(),a)e=r.getFeature(h),r.isDroppable(e)||(s[h]=new Ft(e),u++,r.tree&&r.tree.insert(e));r.cnt=u,r.dep={},r.IDPOOL=s,ut.prototype.clear.call(this,t)}r.listeners.trigger("clear",[this,o],!0)},t.prototype._insert=function(t,e){var r=t.id,o=null,n=this.getFeatureClass(t),i=this.filter;return i&&!i(t)||(this.IDPOOL[r]===Tt&&(this.cnt++,this.isFeatureInstance(t,n)?t._provider=this:t=this.createFeature(t,n),this.updateBBox(t),this.IDPOOL[r]=new Ft(t),o=t),e&&this._mark(t,e)),o},t.prototype._mark=function(t,e){var r=this.IDPOOL[t.id];r[e.quadkey]||(r.cnt++,r[e.quadkey]=!0)},t.prototype._removeTile=function(t,e){var r,o,n=this,i=t.quadkey;if(r=n.dep[i]){for(var s=0;s<r.length;s++)n.storage.remove(r[s]);delete n.dep[i]}if(n.storage.remove(t),o=t.data)for(s=0;s<o.length;s++)n._dropFeature(o[s],i,e)},t.prototype._dropFeature=function(t,e,r){var o=this,n=o.IDPOOL[t.id];n&&(n[e]&&(n[e]=Tt,n.cnt--),o.isDroppable(t)&&(n.cnt||(o.cnt--,delete o.IDPOOL[t.id],o.tree&&o.tree.remove(t),r&&o.listeners.trigger(Ot,[t,o],!0))))},t.prototype._s=function(n){if(this.tree)return this.tree.search(n);var i,s,a=1e8*Math.random()^0,u=this.level;return this.storage.forEach(function(t){if(t.z==u&&(s=t.search(n)))if(i){r=0,o=s.length;for(var e=void 0;r<o;r++)(e=s[r])._m!=a&&(e._m=a,i[i.length]=e)}else for(var r=0,o=(i=s).length;r<o;r++)i[r]._m=a}),i||[]},t.prototype.encCoord=function(t,e){return e},t.prototype.decCoord=function(t){return t.geometry.coordinates},t.prototype.decBBox=function(t){return t.bbox},t.prototype.prepareFeature=function(t){return t},t.prototype.updateBBox=function(t){return!0},t}(ut);Ct.prototype.prepareFeature=Bt,Ct.prototype.updateBBox=wt,Ct.prototype.modifyFeatureCoordinates=Ct.prototype.setFeatureCoordinates;var Pt,Ut=function(){function t(t,e){this.c=0,this.cbs=[],this.qks=e,this.tile=t}return t.prototype.receive=function(t){var e=this;if(!e.ready){var r=e.tile,o=e.qks,n=o.indexOf(t.quadkey);if(-1!=n&&(o[n]=null,++e.c==o.length)){e.ready=!0,r.processedData=void 0;var i=t.error;i?r.error=i:r.data=r.provider.search(r.getContentBounds()),r.loadStopTs=Date.now(),e.exec(),r.onLoaded.length=0,e.qks=null}}},t.prototype.exec=function(){for(var t=this.cbs,e=t.length,r=this.tile,o=0;o<e;)t[o++](r,r.error);t.length=0},t.prototype.add=function(t){var e=this.cbs;if("function"==typeof t&&-1==e.indexOf(t))return e.push(t),!0},t.prototype.remove=function(t){var e=this.cbs,r=e.indexOf(t);return-1!=r&&e.splice(r,1),e.length},t}();Ut.prototype.ready=!1;var kt=function(h){function t(t,e){var r=h.call(this,{minLevel:8,maxLevel:20,staticData:!1},t)||this;r.sizeKB=0;var o=r,n=t.loader;if(!n)throw new Error("no tile loader defined.");return n instanceof ht||(n=new ht(n)),o.loader=n,"function"==typeof e&&(o._pp=e),r}return at(t,h),t.prototype.cancel=function(t,e){var r,o,n=this.storage,i=e==Pt;if(o=t instanceof this.Tile?t:n.get(t)){t=o.quadkey,r=this.calcStorageQuads(t);for(var s=0,a=void 0,u=void 0;s<r.length;s++)if(a=(u=r[s])==t?o:n.get(u)){var h=a.onLoaded,l=void 0;h&&(i?o.onLoaded.length=0:this.level&&o.z!=this.level?-1!=(l=h.indexOf(o.onLoaded[0]))&&(h[l].remove(e)||h.splice(l,1)):h.splice(h.indexOf(e),1),h.length||this.loader.abort(a)&&n.remove(a))}}},t.prototype.search=function(t,e){var r,o,n=this;if("object"==typeof t)if(e)for(var i in t)e[i]=t[i];else e=t;var s=(e=e||{}).onload,a=e.radius,u=e.remote,h=e.onerror;if(a==Pt&&(a=1),t instanceof Array)o=4==t.length?t:v.geotools.getPointBBox(t,a);else{if("number"==typeof t||"string"==typeof t||!t)return n.getFeatures(t,e);if(t.longitude!=Pt&&t.latitude!=Pt)o=v.geotools.getPointBBox([t.longitude,t.latitude],a);else if(t.minLon!=Pt&&t.minLat!=Pt&&t.maxLon!=Pt&&t.maxLat!=Pt)o=[t.minLon,t.minLat,t.maxLon,t.maxLat];else{if(r=t.point||t.rect||t.viewport)return n.search(r,e);if(t.id||t.ids)return n.getFeatures(t.id||t.ids,e)}}if(o={minX:o[0],minY:o[1],maxX:o[2],maxY:o[3]},u){for(var l,p=x.getTilesInRect(o.minX,o.minY,o.maxX,o.maxY,n.level),c=function(t){p.splice(p.indexOf(t.quadkey),1),l=l||t.error,p.length||(l?h(l):s&&s(n._s(o)))},f=0;f<p.length;f++){var d=p[f],g=n.getCachedTile(d);if(g&&g.isLoaded()){if(g.error)return void(h&&h(g.error));p.splice(f--,1)}else n.getTile(d,c)}if(p.length)return}var y=n._s(o);return s&&s(y),y},t.prototype.getLoader=function(){return this.loader},t.prototype.config=function(t){return h.prototype.config.call(this,t)},t.prototype.clear=function(t){0==arguments.length&&this.loader.clear(),h.prototype.clear.apply(this,arguments)},t.prototype.calcStorageQuads=function(t){return x.getTilesOfLevel(t,this.level)},t.prototype.preprocess=function(t,e,r){var o,n=this._pp;(o="function"==typeof n?n({data:e,quadkey:t.quadkey,x:t.x,y:t.y,z:t.z,provider:this,ready:r}):e)&&r(o)},t.prototype.createTile=function(t){var e,r,o=h.prototype.createTile.call(this,t),n=o.z,i=this.level;if(i&&n!=i)if(i<n)e=t.substr(0,i),(r=this.dep[e])||(r=this.dep[e]=[]),r[r.length]=o;else if(n<i)for(var s=x.getTilesOfLevel(t,i),a=0,u=s.length;a<u;a++)e=s[a],(r=this.dep[e])||(r=this.dep[e]=[]),r[r.length]=o;return o},t.prototype.execTile=function(t){var e,r=t.onLoaded;if(r){for(var o=0,n=r.length;o<n;o++)(e=r[o])instanceof Ut?e.receive(t):e(t);r.length=0}},t.prototype.attachData=function(t,e){for(var r,o,n,i=this,s=[],a=e.length,u=0;u<a;u++)!1!==(r=i.prepareFeature(n=e[u]))?(n=r,(o=i._insert(n,t))?(n=o,s[s.length]=n):i.tree||(s[s.length]=i.getFeature(n.id))):(e.splice(u--,1),a--);if(e=s,t.loadStopTs=Date.now(),i.tree?i.tree.load(e):t.createTree(e),i.staticData?t.data=e:t.data=i.search(t.getContentBounds()),i.margin)for(var h=0,l=t.data.length;h<l;h++)i._mark(t.data[h],t);i.execTile(t)},t.prototype.getTile=function(t,e){var r,o=this,n=o.storage,i=o.level;if((r=n.get(t))==Pt)(r=o.createTile(t)).onLoaded=[],n.set(r);else if(r.isLoaded())return e&&e(r,r.error),r;if(t.length!=i){var s=o.calcStorageQuads(t),a=void 0,u=void 0;r.loadStartTs=Date.now(),r.data=[],r.onLoaded.length?u=r.onLoaded[0]:(u=new Ut(r,s),r.onLoaded.push(u)),u.add(e);for(var h=0;h<s.length;h++)(a=n.get(s[h]))==Pt?a=o.getTile(s[h],u):a.isLoaded()?u.receive(a):-1==a.onLoaded.indexOf(u)&&a.onLoaded.push(u)}else e&&-1==r.onLoaded.indexOf(e)&&r.onLoaded.push(e),r.loadStartTs||(r.loadStartTs=Date.now(),o.loader.tile(r,function(t,e){o.sizeKB+=e/1024,o.preprocess(r,t,function(t){return o.attachData(r,t)})},function(t){r.loadStopTs=Date.now(),r.error=t,r.data=[],o.execTile(r),o.listeners.trigger("error",[t],!0)}));return r},t.prototype._removeTile=function(t,e){h.prototype._removeTile.call(this,t,e),t.isLoaded()||this.loader.abort(t)},t}(Ct),Dt=function(r){function t(t,e){return t.level=t.level||13,t.headers=v.JSUtils.extend({Accept:"application/geo+json"},t.headers||{}),r.call(this,t,e)||this}return at(t,r),t}(function(n){function t(t,e){var r=this,o=(t=t||{}).loader;return o?o instanceof ht||(o=new ht(o)):o=new ht(new _t({url:t.url,withCredentials:t.withCredentials,headers:t.headers})),t.loader=o,(r=n.call(this,t,e)||this).setParams(t.params||{}),r.setHeaders(t.headers||{}),r}return at(t,n),t.prototype.getHeader=function(t){var e=this.loader.src;return e[e.length-1].headers[t]||null},t.prototype.getHeaders=function(){var t=this.loader.src;return v.JSUtils.clone(t[t.length-1].headers)},t.prototype.setHeader=function(t,e){var r=this.loader.src,o=this.getHeaders();o[t]=e,r[r.length-1].headers=o,this.headers=o},t.prototype.setHeaders=function(t){var e=this.loader.src,r=this.getHeaders();v.JSUtils.extend(r,t),e[e.length-1].headers=r,this.headers=r},t.prototype.getParams=function(){return this.params},t.prototype.getParam=function(t){return this.params[t]||null},t.prototype.setParams=function(t){var e,r=this.loader.src,o=r[r.length-1],n=o.baseUrl,i=this.params||{};if(v.JSUtils.extend(i,t),this.params=i,"string"==typeof n){i=v.JSUtils.extend((e=e||{},n.split(/\?|\&/).slice(1).map(function(t){t=t.split(/\=/),e[t[0]]=t[1]}),e),i);var s=n.split(/\?/)[0],a="?";for(var u in i)s+=a+u+"="+i[u],a="&";o.setUrl(s)}},t.prototype.setParam=function(t,e){var r={};r[t]=e,this.setParams(r)},t.prototype.config=function(t){return n.prototype.config.call(this,t),t&&t.url&&this.setParams({}),this},t}(kt)),Et=function(r){function t(t){var e=r.call(this,{minLevel:8,maxLevel:20,storage:new it(512)},t)||this;return e.level=void 0,e}return at(t,r),t.prototype.cancel=function(t){},t.prototype.delete=function(t){this.tree.remove(t)},t.prototype.import=function(t){this.tree.fromJSON(t);for(var e=(t=this.tree.all()).length;e--;)this._insert(t[e])},t.prototype.initStorage=function(t){t.onDrop(t.remove.bind(t),this)},t}(Ct),qt={Point:"MARKER",LineString:"LINE",Polygon:"AREA",MultiPolygon:"AREA"},Xt=function(h){function t(t,e){var r=h.call(this,t,e)||this;return r.isEditable=!0,r.blocked={},r}return at(t,h),t.prototype.writeRoutingPoint=function(t,e,r){this.writeRoutingLink(t,e),this.writeRoutingPosition(t,r)},t.prototype.readRoutingPoint=function(t){return{link:this.readRoutingLink(t),position:this.readRoutingPosition(t)}},t.prototype.getFeatures=function(t,r){r=r||{},t instanceof Array||("object"==typeof t&&(t.remote&&(r.remote=t.remote),t.onload&&(r.onload=t.onload),t=t.ids||t.id),t=[].concat(t));var o=this,e=!0,n=r.onload,i=r.remote;(u=h.prototype.getFeatures.call(this,t))instanceof Array||(u=[u]);for(var s=0;s<u.length;s++)u[s]||(u[s]=t[s],e=!1);function a(){return 1==(u=u.map(function(t){return"object"==typeof t?t:void 0})).length?u[0]:u}if(e||!i){var u=a();return n&&n(u),u}t=u.filter(function(t){return"object"!=typeof t}),o._requestFeatures(t,function(t){for(var e,r=t.length;r--;)e=t[r],u[u.indexOf(e.id)]=o.addFeature(e);n&&n(a())},function(t){var e=r.onerror;e&&e(t)},r)},t.prototype.getFeatureProperties=function(t){return t.properties},t.prototype.detectFeatureClass=function(t){return qt[t.geometry.type]},t.prototype.isoCC=function(t,e){return!0},t.prototype.reserveId=function(t,e){for(var r,o=t.length,n=[];o--;)"string"==typeof(r=t[o].id)&&15<r.length?n.push(t[o].id):n.push(v.JSUtils.String.random(16));setTimeout(function(){e(n.reverse())},0)},t.prototype.blockFeature=function(t,e){var r=t.id||t,o=typeof r;"string"!=o&&"number"!=o||(e?this.blocked[r]=!0:delete this.blocked[r])},t.prototype._insert=function(t,e){return this.blocked[t.id]?null:h.prototype._insert.call(this,t,e)},t}(Dt);Xt.prototype.prepareFeature=function(t){return t.properties||(t.properties={}),null==t.id&&(t.id=v.JSUtils.String.random()),t};var Yt={environment:"prd",space:"",credentials:{},withCredentials:!(Xt.prototype.updateBBox=function(t){var e=t.geometry.type,r=t.geometry.coordinates;if("Point"==e&&t.class&&"MARKER"!=t.class){var o=t.properties&&this.readRoutingPosition(t);if(o)return t.bbox=function(t){for(var e,r,o=1/0,n=-1/0,i=1/0,s=-1/0,a=t.length,u=0;u<a;u++)(e=t[u][0])<o&&(o=e),n<e&&(n=e),(r=t[u][1])<i&&(i=r),s<r&&(s=r);return[o,i,n,s]}([r,this.encCoord(e,o)]),!0}return!!t.bbox||wt(t)}),tags:!1,https:!0,clip:!1,url:null,headers:null},Rt="@ns:com:here:xyz",jt="http://",zt=".here.com/hub/spaces",At={prd:jt+"xyz.api"+zt,cit:jt+"xyz.cit.api"+zt,sit:jt+"xyz.sit.cpdev.aws.in"+zt},It="Method not implemented.",Gt=function(n){function t(t,e){var r,o=n.call(this,(r=t,(r=v.JSUtils.extend(v.JSUtils.clone(Yt),r)).params=v.JSUtils.extend(r.params||{},r.credentials),delete r.credentials,r.url||(r.url=At[r.environment]),r.https&&(r.url=r.url.replace(jt,"https://")),r),e)||this;return o.definition=null,o.setUrl(o.getTileUrl(o.space)),o}return at(t,n),t.prototype.commit=function(t,e,r){var o=this.loader.src,n=o[o.length-1],i=this._addUrlCredentials(this.getLayerUrl(this.space)+"/features","?"),s=function(t){--u||e&&e(t)},a=function(t){r&&r(t)},u=0;function h(t){t instanceof Array||(t=[t]);for(var e,r=t.length;r--;)(e=(t[r]=ot.prototype.toJSON.call(t[r])).properties)&&delete e["@ns:com:here:editor"];return t}if(t){var l=h(t.put||[]);l.length&&(u++,n.send({url:i,success:s,error:a,type:"POST",headers:v.JSUtils.extend(v.JSUtils.clone(this.headers),{"Content-Type":"application/geo+json"}),data:JSON.stringify({type:"FeatureCollection",features:l})}));var p=h(t.remove||[]);p.length&&(u++,n.send({url:i+"&id="+p.map(function(t){return t.id}).join(","),success:s,error:a,headers:this.headers,type:"DELETE"}))}},t.prototype.prepareFeature=function(t){var e=(t=n.prototype.prepareFeature.call(this,t)).properties;return e[Rt]||(e[Rt]={}),t},t.prototype.setMargin=function(t){Xt.prototype.setMargin.call(this,t),this.setUrl(this.getTileUrl(this.space))},t.prototype.getLayerUrl=function(t){return this.url+"/"+t},t.prototype.setUrl=function(t){this.loader.setUrl(this._addUrlCredentials(t))},t.prototype.getTileUrl=function(t){return this._addUrlTags(this.getLayerUrl(t)+"/tile/quadkey/{QUADKEY}?margin="+this.margin+"&clip="+!!this.clip)},t.prototype.setTags=function(t){"string"==typeof t&&(t=[t]),this.tags=t,this.setUrl(this.getTileUrl(this.space)),this.clear()},t.prototype.getFeatureUrl=function(t,e,r){return e instanceof Array||(e=[e]),this.getLayerUrl(t)+"/features?id="+e.join("&id=")},t.prototype.getCopyright=function(e,t){this.getDefinition(function(t){e&&e(t.copyright||[])},t)},t.prototype.getDefinition=function(t,e){var r=this,o=r.getLoader().src,n=r.definition;if(null==n){var i=new v.Queue;n=this.definition=i,o[o.length-1].send({url:r._addUrlCredentials(r.getLayerUrl(r.space),"?"),key:"def",success:function(t){r.definition=t,i.done(t)},error:function(t){r.definition=[],e&&e(t)},headers:this.headers})}t&&(n instanceof v.Queue?n.add(t):t(n))},t.prototype._requestFeatures=function(t,e,r,o){var n=this.loader.src;n[n.length-1].send({key:t.join("&"),url:this._addUrlCredentials(this.getFeatureUrl(this.space,t,o)),success:function(t){e(t.features)},headers:this.headers,error:r})},t.prototype._addUrlCredentials=function(t,e){return t=function(t,e,r){for(var o in e)t+=r+o+"="+e[o],r="&";return t}(t,this.params,e||"&")},t.prototype._addUrlTags=function(t,e){return(e=e||this.tags)&&e.length&&(t+="&tags="+e.join(",")),t},t.prototype.readDirection=function(t){throw new Error(It)},t.prototype.readPedestrianOnly=function(t){throw new Error(It)},t.prototype.writeTurnRestriction=function(t,e,r){throw new Error(It)},t.prototype.readRoutingProvider=function(t){return this.id},t.prototype.readRoutingPosition=function(t){throw new Error(It)},t.prototype.readRoutingLink=function(t){throw new Error(It)},t.prototype.writeRoutingPosition=function(t,e){throw new Error(It)},t.prototype.writeRoutingLink=function(t,e){throw new Error(It)},t.prototype.readTurnRestriction=function(t,e){throw new Error(It)},t.prototype.writeEditState=function(t,e){},t}(Xt),Jt="METADATA",Nt="T!GERDB";function Ht(t,e,r){var o=new XMLHttpRequest;return o.onload=function(){e(JSON.parse(this.responseText))},o.onreadystatechange=function(){var t=this.status;4==this.readyState&&(t<200||300<=t)&&0!==t&&r&&r(this)},o.open("GET",t,!0),o.send(),o}var Qt=function(){function t(t){(t=t||{}).host=t.host||"geocoder.api.here.com",t.version=t.version||"6.2",this.url="https://"+t.host+"/"+t.version+"/geocode.json",this.reverseUrl="https://reverse."+t.host+"/"+t.version+"/reversegeocode.json",this.cfg=t}return t.prototype.createUrl=function(t,e){var r="";for(var o in e=e||{})r+="&"+o+"="+encodeURIComponent(e[o]);return this.reverseUrl+"?app_id="+this.cfg.app_id+"&app_code="+this.cfg.app_code+r},t.prototype.geocode=function(t,e,r){Ht(this.createUrl(this.url,t),e,r)},t.prototype.reverseGeocode=function(t,e,r){Ht(this.createUrl(this.reverseUrl,t),e,r)},t.prototype.getIsoCountryCode=function(t,r,e){var o={mode:"retrieveAddresses",maxresults:1,jsonattributes:1};t instanceof Array?o.prox=t[1]+","+t[0]:o.prox=t.latitude+","+t.longitude,this.reverseGeocode(o,function(t){var e=null;try{e=t.response.view[0].result[0].location.address.country}catch(t){}r&&r(e,t)},e)},t}(),Kt=v.global.here.xyz.maps;Kt.common=v;var Wt=Kt.tile={Tile:X,Utils:x},Zt=Kt.layers={TileLayer:V},Vt=Kt.geo={Point:$,Rect:tt},$t=Kt.pixel={Point:et,Rect:rt},te=Kt.features={Feature:ot},ee=Kt.storage={Level2Storage:nt,LRUStorage:it},re=Kt.providers={ImageProvider:Lt,GeoJSONProvider:Dt,FeatureProvider:Ct,LocalProvider:Et,RemoteTileProvider:kt,EditableProvider:Xt,SpaceProvider:Gt},oe=Kt.projection={webMercator:u},ne=Kt.loaders={HTTPLoader:_t,IndexDBLoader:function(t){var i,s,a,n=0;function u(o){a=!1;var r=o?indexedDB.open(Nt,n+1):indexedDB.open(Nt);r.onupgradeneeded=function(t){var e=t.target.result,r=t.target.transaction;n=0|e.version,e.objectStoreNames.contains(Jt)||e.createObjectStore(Jt).add(s={},"STORES"),null==o||e.objectStoreNames.contains(o)||(e.createObjectStore(o),s[o]=+new Date),r.objectStore(Jt).put(s,"STORES")},r.onsuccess=function(t){function e(){var t;for(var e in a=!0,h)t=h[e],s[t[0]]?t[1]&&t[1]():t[2]&&t[2](),delete h[e]}(i=r.result).onversionchange=function(t){i.close(),a=!1},n=0|i.version,void 0===s?i.transaction(Jt,"readonly").objectStore(Jt).get("STORES").onsuccess=function(t){s=t.target.result,e()}:e()},r.onerror=r.onblocker=function(t){}}var h={},l={};u();var e=this,p=t;e.baseUrl=t,e.abort=function(t){var e=t.quadkey;h[e]&&delete h[e],l[e]&&(l[e].abort(),delete l[e])},e.load=function(e,r,o){var n=e.quadkey;function t(){var t=i.transaction(p,"readonly");(l[n]=t).objectStore(p).get(e.quadkey).onsuccess=function(t){var e=t.target.result;delete l[n],e?r&&here.xyz.maps.common.parseJSONArray(e,r):o&&setTimeout(o,0)}}a?s[p]?t():o&&o():h[n]=[p,t,o]},e.clear=function(t){s[p]&&(i.transaction(p,"readwrite").objectStore(p).clear().onsuccess=t)},e.store=function(t,e){var r=t.quadkey;function o(){t.data?i.transaction(p,"readwrite").objectStore(p).put(JSON.stringify(t.data),t.quadkey).onsuccess=e:e()}s[p]?o():(h[r]=[p,o],a&&u(p))}},Manager:ht},ie=Kt.service||{Geocoder:Qt},se=Kt.data||{prepare:{GeoJSON:Mt}},ae=Kt.build={name:"xyz-maps",version:"0.9.33",revision:"d4016bb",date:"2019-07-30T10:01:06Z"},ue={tile:Wt,layers:Zt,geo:Vt,pixel:$t,features:te,storage:ee,providers:re,projection:oe,loaders:ne,service:ie,data:se,build:ae,common:v};t.build=ae,t.data=se,t.default=ue,t.features=te,t.geo=Vt,t.layers=Zt,t.loaders=ne,t.pixel=$t,t.projection=oe,t.providers=re,t.service=ie,t.storage=ee,t.tile=Wt,Object.defineProperty(t,"__esModule",{value:!0})});
