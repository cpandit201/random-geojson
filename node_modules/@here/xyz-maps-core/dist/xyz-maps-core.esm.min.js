/*
 * @here/xyz-maps-core
 * (c) 2019 HERE
 */
/* rbush: Copyright (c) 2016 Vladimir Agafonkin */
import*as t from"@here/xyz-maps-common";import{global as e,Listener as r,JSUtils as n,LRU as i,geotools as o,Queue as s}from"@here/xyz-maps-common";var a=Math.PI,h=function(t,e){return(t+180)/360*e},u=function(t,e){return(180-180/a*Math.log(Math.tan(a/4+t*a/360)))*e/360},l=function(t,e){return 360*t/e-180},p=function(t,e){var r=180-360*t/e;return 360/a*Math.atan(Math.exp(r*a/180))-90},c={mapSizePixel:function(t,e){return t<<e},lon2x:h,lat2y:u,x2lon:l,y2lat:p,pixelToGeo:function(t,e,r){return{longitude:l(t,r),latitude:p(e,r)}},geoToPixel:function(t,e,r){return{x:h(t,r),y:u(e,r)}}},f=e.Math,d=function(t,e,r){var n=f.pow(2,r),i=f.floor(c.lon2x(t,n));return[r,f.floor(c.lat2y(e,n)),i]},g=function(t){"number"==typeof t&&(t=String(t));for(var e=t.length,r=0,n=0,i=0;i<e;++i)switch(r*=2,n*=2,t[i]){case"1":n++;break;case"3":n++;case"2":r++}return[e,r,n]},y=function(t,e,r){for(var n,i="";t-- >0;)i+=(0!=(r&(n=1<<t)))+2*(0!=(e&n));return i},v=function(t,e,r){var n=256<<t,i=256*r,o=256*e;return[c.x2lon(i,n),c.y2lat(o+256,n),c.x2lon(i+256,n),c.y2lat(o,n)]},m=function(t,e){for(var r=[],n=e[1]-t[1]+1,i=e[2]-t[2]+1,o=0;o<n;o++)for(var s=0;s<i;s++)r[r.length]=y(t[0],t[1]+o,t[2]+s);return r},x={geoToGrid:d,pixelToGrid:function(t,e,r){return[r,f.floor(e),f.floor(t)]},quadToGrid:g,tileXYToQuadKey:y,getGeoBounds:v,getTilesOfLevel:function(t,e){var r=[t],n=0,i=r.length,o=t.length;if(e<=o)return[t.substring(0,e)];for(;o<e;){for(;n<i;n++)r.push(r[n]+"0",r[n]+"1",r[n]+"2",r[n]+"3");n=i,i=r.length,o++}return r.slice(n)},getTilesIds:m,getTilesInRect:function(t,e,r,n,i){r>=180&&(r=180-1e-6),t<=-180&&(t=-180),n>=85.05112878&&(n=85.05112778),e<-85.05112878&&(e=-85.05112778);var o=d(t,n,i),s=d(r,e,i);return m(o,s)}};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var _,b=(function(t,e){t.exports=function(){function t(t,e,r){var n=t[e];t[e]=t[r],t[r]=n}function e(t,e){return t<e?-1:t>e?1:0}return function(r,n,i,o,s){!function e(r,n,i,o,s){for(;o>i;){if(o-i>600){var a=o-i+1,h=n-i+1,u=Math.log(a),l=.5*Math.exp(2*u/3),p=.5*Math.sqrt(u*l*(a-l)/a)*(h-a/2<0?-1:1),c=Math.max(i,Math.floor(n-h*l/a+p)),f=Math.min(o,Math.floor(n+(a-h)*l/a+p));e(r,n,c,f,s)}var d=r[n],g=i,y=o;for(t(r,i,n),s(r[o],d)>0&&t(r,i,o);g<y;){for(t(r,g,y),g++,y--;s(r[g],d)<0;)g++;for(;s(r[y],d)>0;)y--}0===s(r[i],d)?t(r,i,y):t(r,++y,o),y<=n&&(i=y+1),n<=y&&(o=y-1)}}(r,n,i||0,o||r.length-1,s||e)}}()}(_={exports:{}},_.exports),_.exports),T=M,L=M;function M(t,e){if(!(this instanceof M))return new M(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function w(t,e,r){if(!r)return e.indexOf(t);for(var n=0;n<e.length;n++)if(r(t,e[n]))return n;return-1}function B(t,e){S(t,0,t.children.length,e,t)}function S(t,e,r,n,i){i||(i=q(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var o,s=e;s<r;s++)o=t.children[s],O(i,t.leaf?n(o):o);return i}function O(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function F(t,e){return t.minX-e.minX}function C(t,e){return t.minY-e.minY}function P(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function k(t){return t.maxX-t.minX+(t.maxY-t.minY)}function D(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function E(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function q(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function U(t,e,r,n,i){for(var o,s=[e,r];s.length;)(r=s.pop())-(e=s.pop())<=n||(o=e+Math.ceil((r-e)/n/2)*n,b(t,o,e,r,i),s.push(e,o,o,r))}M.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,r=[],n=this.toBBox;if(!E(t,e))return r;for(var i,o,s,a,h=[];e;){for(i=0,o=e.children.length;i<o;i++)s=e.children[i],E(t,a=e.leaf?n(s):s)&&(e.leaf?r.push(s):D(t,a)?this._all(s,r):h.push(s));e=h.pop()}return r},collides:function(t){var e=this.data,r=this.toBBox;if(!E(t,e))return!1;for(var n,i,o,s,a=[];e;){for(n=0,i=e.children.length;n<i;n++)if(o=e.children[n],E(t,s=e.leaf?r(o):o)){if(e.leaf||D(t,s))return!0;a.push(o)}e=a.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,r=t.length;e<r;e++)this.insert(t[e]);return this}var n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var i=this.data;this.data=n,n=i}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=q([]),this},remove:function(t,e){if(!t)return this;for(var r,n,i,o,s=this.data,a=this.toBBox(t),h=[],u=[];s||h.length;){if(s||(s=h.pop(),n=h[h.length-1],r=u.pop(),o=!0),s.leaf&&-1!==(i=w(t,s.children,e)))return s.children.splice(i,1),h.push(s),this._condense(h),this;o||s.leaf||!D(s,a)?n?(r++,s=n.children[r],o=!1):s=null:(h.push(s),u.push(r),r=0,n=s,s=s.children[0])}return this},toBBox:function(t){return t},compareMinX:F,compareMinY:C,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var r=[];t;)t.leaf?e.push.apply(e,t.children):r.push.apply(r,t.children),t=r.pop();return e},_build:function(t,e,r,n){var i,o=r-e+1,s=this._maxEntries;if(o<=s)return B(i=q(t.slice(e,r+1)),this.toBBox),i;n||(n=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,n-1))),(i=q([])).leaf=!1,i.height=n;var a,h,u,l,p=Math.ceil(o/s),c=p*Math.ceil(Math.sqrt(s));for(U(t,e,r,c,this.compareMinX),a=e;a<=r;a+=c)for(U(t,a,u=Math.min(a+c-1,r),p,this.compareMinY),h=a;h<=u;h+=p)l=Math.min(h+p-1,u),i.children.push(this._build(t,h,l,n-1));return B(i,this.toBBox),i},_chooseSubtree:function(t,e,r,n){for(var i,o,s,a,h,u,l,p,c,f;n.push(e),!e.leaf&&n.length-1!==r;){for(l=p=1/0,i=0,o=e.children.length;i<o;i++)h=P(s=e.children[i]),c=t,f=s,(u=(Math.max(f.maxX,c.maxX)-Math.min(f.minX,c.minX))*(Math.max(f.maxY,c.maxY)-Math.min(f.minY,c.minY))-h)<p?(p=u,l=h<l?h:l,a=s):u===p&&h<l&&(l=h,a=s);e=a||e.children[0]}return e},_insert:function(t,e,r){var n=this.toBBox,i=r?t:n(t),o=[],s=this._chooseSubtree(i,this.data,e,o);for(s.children.push(t),O(s,i);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(i,o,e)},_split:function(t,e){var r=t[e],n=r.children.length,i=this._minEntries;this._chooseSplitAxis(r,i,n);var o=this._chooseSplitIndex(r,i,n),s=q(r.children.splice(o,r.children.length-o));s.height=r.height,s.leaf=r.leaf,B(r,this.toBBox),B(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(r,s)},_splitRoot:function(t,e){this.data=q([t,e]),this.data.height=t.height+1,this.data.leaf=!1,B(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,r){var n,i,o,s,a,h,u,l,p,c,f,d,g,y;for(h=u=1/0,n=e;n<=r-e;n++)i=S(t,0,n,this.toBBox),o=S(t,n,r,this.toBBox),p=i,c=o,f=void 0,d=void 0,g=void 0,y=void 0,f=Math.max(p.minX,c.minX),d=Math.max(p.minY,c.minY),g=Math.min(p.maxX,c.maxX),y=Math.min(p.maxY,c.maxY),s=Math.max(0,g-f)*Math.max(0,y-d),a=P(i)+P(o),s<h?(h=s,l=n,u=a<u?a:u):s===h&&a<u&&(u=a,l=n);return l},_chooseSplitAxis:function(t,e,r){var n=t.leaf?this.compareMinX:F,i=t.leaf?this.compareMinY:C;this._allDistMargin(t,e,r,n)<this._allDistMargin(t,e,r,i)&&t.children.sort(n)},_allDistMargin:function(t,e,r,n){t.children.sort(n);var i,o,s=this.toBBox,a=S(t,0,e,s),h=S(t,r-e,r,s),u=k(a)+k(h);for(i=e;i<r-e;i++)o=t.children[i],O(a,t.leaf?s(o):o),u+=k(a);for(i=r-e-1;i>=e;i--)o=t.children[i],O(h,t.leaf?s(o):o),u+=k(h);return u},_adjustParentBBoxes:function(t,e,r){for(var n=r;n>=0;n--)O(e[n],t)},_condense:function(t){for(var e,r=t.length-1;r>=0;r--)0===t[r].children.length?r>0?(e=t[r-1].children).splice(e.indexOf(t[r]),1):this.clear():B(t[r],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}},T.default=L;var X=function(){function t(t,e,r){var n=g(t);this.quadkey=t,this.z=n[0],this.y=n[1],this.x=n[2],this.type=e,this.expire=r,this.bounds=v(n[0],n[1],n[2])}return t.prototype.expired=function(t){return(t=t||Date.now())-this.loadStopTs>1e3*this.expire},t.prototype.add=function(t){var e=this.data;e&&-1==e.indexOf(t)&&(e.push(t),this.tree&&this.tree.insert(t))},t.prototype.remove=function(t){var e=this.data.indexOf(t);-1!==e&&(this.data.splice(e,1),this.tree&&this.tree.remove(t))},t.prototype.createTree=function(t){this.tree=T(9,[".bbox[0]",".bbox[1]",".bbox[2]",".bbox[3]"]),t&&this.tree.load(t)},t.prototype.search=function(t){if(this.tree)return this.tree.search(t)},t.prototype.isLoaded=function(){return"number"==typeof this.loadStopTs},t.prototype.getContentBounds=function(){if(!this.cbnds){var t=this.bounds,e=this.provider.margin;if(e){var r=256<<this.z,n=c.lon2x(t[0],r),i=c.lat2y(t[1],r);this.cbnds=[c.x2lon(n-e,r),c.y2lat(i+e,r),c.x2lon(n+e+256,r),c.y2lat(i-e-256,r)]}else this.cbnds=this.bounds}return this.cbnds},t.prototype.project=function(t,e){var r=256<<this.z,n=256*this.x,i=256*this.y;return[Math.round(c.lon2x(t,r)-n),Math.round(c.lat2y(e,r)-i)]},t.prototype.lon2x=function(t){var e=256<<this.z,r=256*this.x;return Math.round(c.lon2x(t,e)-r)},t.prototype.lat2y=function(t){var e=256<<this.z,r=256*this.y;return Math.round(c.lat2y(t,e)-r)},t}(),Y=X.prototype;Y.expire=1/0,Y.error=null,Y.canvasX=null,Y.canvasY=null;var R=[{zIndex:0,type:"Circle",radius:6,fill:"#ff0000"}],j=[{zIndex:0,type:"Line",strokeWidth:10,stroke:"#ff0000"}],A=[{zIndex:0,type:"Polygon",strokeWidth:1,stroke:"#ffffff",fill:"#ff0000"}],I={styleGroups:{Point:R,MultiPoint:R,LineString:j,MultiLineString:j,Polygon:A,MultiPolygon:A},assign:function(t){return t.geometry.type}};function z(t,e){for(var r in e)t[r]=e[r];return t}var G,N=[],H=function(){function t(t,e){this.styleGroups=null,this._c=null;for(var r in t.assign&&(this.assign=t.assign),t)this[r]=t[r];this._c=e||{}}return t.prototype.assign=function(t,e){return t.geometry.type},t.prototype.getStyleGroup=function(t,e,r){var n=this._c[t.id];return(null==n||r)&&"object"!=typeof(n=this.assign(t,e))&&(n=this.styleGroups[n]),n},t.prototype.setStyleGroup=function(t,e,r){var n=t.id,i=this._c;return e&&r&&(e=this.merge(this.getStyleGroup(t),e)),e?i[n]=e:null===e||!1===e?e=i[n]=N:i[n]&&delete i[n],e},t.prototype.merge=function(t,e){if(null===e||!1===e)return null;for(var r,n=[],i=0,o=t.length;i<o;i++)r=z({},t[i]),e[i]&&z(r,e[i]),n[i]=r;return n},t}(),J="featureRemove",K="featureAdd",Q="featureCoordinatesChange",W="styleGroupChange",Z="styleChange",V="viewportReady",$="clear",tt=function(){function t(t){this._p=[],this._sd=null,this._pev=!0,this.__type="Layer",this.margin=20,this.name="",this.min=15,this.max=20;var e=this;for(var n in t)e[n]=t[n];e.id==G&&(e.id="L-"+(1e8*Math.random()^0)),e._l=new r(K,J,Q,$,W,V,Z);var i,o=t.providers||t.provider;if(o instanceof Array)for(var s=0,a=void 0;s<o.length;s++)for(var h=(a=o[s]).min;h<=a.max;h++)e._p[h]=a.provider;else for(var u=e.min;u<=e.max;u++)e._fp=e._p[u]=o,e._fp.minLevel=e.min,e._fp.maxLevel=e.max;e._p.forEach(function(t,r){"FeatureProvider"==t.__type&&(t.addEventListener(K,e._afl,e),t.addEventListener(J,e._rfl,e),t.addEventListener(Q,e._mfl,e)),t.addEventListener($,e._cpl,e)}),e.setMargin(e.getMargin());var l=this._fp&&this._fp.styles;(i=t.style||t.styles||l||I)&&e.setStyle(i),["style","styles","provider","providers"].forEach(function(t){delete e[t]})}return t.prototype.getProvider=function(t){return t?this._p[0^t]:this._fp},t.prototype.addEventListener=function(t,e,r){var n=this._l;return n.isDefined(t)?n.add(t,e,r):this._fp&&this._fp.addEventListener(t,e,r)},t.prototype.removeEventListener=function(t,e,r){var n=this._l;return n.isDefined(t)?n.remove(t,e,r):this._fp.removeEventListener(t,e,r)},t.prototype._mfl=function(t,e,r,n){this._l.trigger(Q,[t,e,r,this],!0)},t.prototype._cpl=function(t,e){this._l.trigger($,[this,e],!0)},t.prototype._afl=function(t,e){this._l.trigger(K,[t,e,this],!0)},t.prototype._rfl=function(t,e){this.setStyleGroup(t),this._l.trigger(J,[t,e,this],!0)},t.prototype.setFeatureCoordinates=function(t,e){return this._fp.setFeatureCoordinates(t,e)},t.prototype.addFeature=function(t,e){var r=this._fp;if(r.addFeature)return t=r.addFeature(t),e&&this.setStyleGroup(t,e),t},t.prototype.removeFeature=function(t){var e=this._fp;if(e.removeFeature)return e.removeFeature(t)},t.prototype.setStyleGroup=function(t,e,r){this._sd&&this._l.trigger(W,[t,this._sd.setStyleGroup(t,e,r),this],!0)},t.prototype.getStyleGroup=function(t,e,r){return this._sd&&this._sd.getStyleGroup(t,e,r)},t.prototype.search=function(){var t=this._fp;if(t&&t.search)return t.search.apply(this._fp,arguments)},t.prototype.getTile=function(t,e){var r=t.length,n=this._p[r];if(n)return n.getTile(t,e)},t.prototype.cancelTile=function(t,e){var r="string"==typeof t?t.length:t.quadkey.length,n=this._p[r];if(n&&n.cancel)return n.cancel(t,e)},t.prototype.getCachedTile=function(t){var e=t.length,r=this._p[e];if(r)return r.getCachedTile(t)},t.prototype.setStyle=function(t,e){function r(t){return"function"==typeof t}r(t.getStyleGroup)&&r(t.setStyleGroup)||(t=new H(t,e&&this._sd&&this._sd._c)),this._sd=t,this._l.trigger(Z,[t,this],!0)},t.prototype.getStyle=function(){return this._sd},t.prototype.getMargin=function(){return this.margin},t.prototype.setMargin=function(t){t=Number(t||0);for(var e=this._p,r=e.length;r--;)e[r]&&e[r].setMargin(t);return this.margin=t},t.prototype.pointerEvents=function(t){return t!=G&&(this._pev=!!t),this._pev},t.prototype.getCopyright=function(t){for(var e,r=this._p.filter(function(t,e,r){return r.indexOf(t)===e}),n=[],i=0,o=function(e){e.length&&n.push.apply(n,e),--i||t&&t(n)};e=r.pop();)e&&e.getCopyright&&(i++,e.getCopyright(o))},t}();tt.prototype.modifyFeatureCoordinates=tt.prototype.setFeatureCoordinates;var et=function(){return function(t,e){this.longitude=t,this.latitude=e}}(),rt=function(){return function(t,e,r,n){this.minLon=t,this.minLat=e,this.maxLon=r,this.maxLat=n}}(),nt=function(){return function(t,e){this.x=t,this.y=e}}(),it=function(){return function(t,e,r,n){this.minX=t,this.minY=e,this.maxX=r,this.maxY=n}}(),ot=function(){function t(t,e){this._m=0,this.id=t.id,this.properties=t.properties,this.geometry=t.geometry,this.bbox=t.bbox,this._provider=e}return t.prototype.toJSON=function(){return n.clone({id:this.id,type:this.type,bbox:this.bbox,properties:this.properties,geometry:this.geometry})},t.prototype.getProvider=function(){return this._provider},t.prototype.getBBox=function(){return this._provider.decBBox(this)},t}();ot.prototype.type="Feature";var st=256,at=1024,ht=function(){function t(t,e,r){this.lvl=t,this.main="object"==typeof e?e:new i(e||st),this.sub="object"==typeof r?r:new i(e||at),this.main._onDrop=this.main._onDrop||{},this._onDrop=this.main._onDrop}return t.prototype.onDrop=function(t,e){this._onDrop[e.id]=t},t.prototype.forEach=function(t){this.main.forEach(t),this.sub.forEach(t)},t.prototype.clear=function(){this.main.clear(),this.sub.clear()},t.prototype.getCache=function(t){return t==this.lvl?this.main:this.sub},t.prototype.remove=function(t){this.getCache(t.z).remove(t.quadkey)},t.prototype.get=function(t){return this.getCache(t.length).get(t)},t.prototype.set=function(t){var e=this.getCache(t.z).set(t.quadkey,t),r=this._onDrop;e&&r&&(r=r[e.provider.id])&&r(e)},t}(),ut=function(){function t(t){this._onDrop={},this.cache=new i(t||256)}return t.prototype.forEach=function(t){this.cache.forEach(t)},t.prototype.clear=function(){this.cache.clear()},t.prototype.remove=function(t){this.cache.remove(t.quadkey)},t.prototype.get=function(t){return this.cache.get(t)},t.prototype.set=function(t){var e,r=this.cache.set(t.quadkey,t),n=this._onDrop;r&&n&&(e=n[r.provider.id])&&e(r)},t.prototype.onDrop=function(t,e){this._onDrop[e.id]=t},t}(),lt=function(t,e){return(lt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function pt(t,e){function r(){this.constructor=t}lt(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var ct,ft=256,dt=1/0,gt=function(){function t(t,e){this.margin=0,this.dep={},this.Tile=X,this.size=ft,this.expire=dt;for(var n in t=t||{},e)t[n]=e[n];for(var n in t)this[n]=t[n];this.id==ct&&(this.id="TP-"+(1e6*Math.random()^0)),this.storage=t.storage||new ht(this.level),this.initStorage(this.storage),this.listeners=new r("featureAdd","featureRemove","featureCoordinatesChange","clear","error")}return t.prototype.initStorage=function(t){t.onDrop(this._removeTile.bind(this),this)},t.prototype.addEventListener=function(t,e,r){return this.listeners.add(t,e,r)},t.prototype.removeEventListener=function(t,e,r){return this.listeners.remove(t,e,r)},t.prototype.clear=function(t){this.storage.clear()},t.prototype.getCachedTile=function(t){return this.storage.get(t)},t.prototype.setMargin=function(t){this.margin=Number(t),this.storage.forEach(function(t){return t.cbnds=null})},t.prototype.getCachedTilesOfBBox=function(t,e){var r=t[0],n=t[1],i=t[2],o=t[3],s=[];return e^=0,this.storage.forEach(function(t){var a,h,u,l,p,c,f,d=t.getContentBounds();a=d[0],h=d[2],u=d[1],l=d[3],p=r,c=n,f=o,a<=i&&p<=h&&u<=f&&c<=l&&(!e||t.z==e)&&(s[s.length]=t)}),s},t.prototype.config=function(t){for(var e in t=t||{})this.config[e]=t[e];return this},t.prototype.createTile=function(t){var e=new this.Tile(t,this.dataType,this.expire);return e.provider=this,e},t}();gt.prototype.__type="Provider";var yt=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.executing=0,this.parallel=16,this.q=[],this.lq={},this.src=t}return t.prototype.exec=function(){for(var t=this.q;t.length&&this.executing<this.parallel;)this.fire(t.pop(),t.pop(),t.pop())},t.prototype.fire=function(t,e,r,n){var i=this,o=i.src,s=i.lq;n^=0;i.executing++,s[t.quadkey]=[t,e,r,n],o[n].load(t,function(r,n){i.executing--,delete s[t.quadkey],i.exec(),e(r,n)},function(e){r(e),i.executing--,delete s[t.quadkey],i.exec()})},t.prototype.tile=function(t,e,r){this.q.push(r,e,t),this.exec()},t.prototype.abort=function(t){var e,r,n=this,i=n.q,o=n.lq,s=n.src,a=!0;return-1!==(e=i.indexOf(t))?i.splice(e-2,3):(r=o[t.quadkey])?(n.executing--,delete o[t.quadkey],s[r[3]].abort(t)):a=!1,n.exec(),a},t.prototype.store=function(t,e){var r=this.src;for(var n in r)if(r[n].store){r[n].store(t,e);break}},t.prototype.clear=function(){this.src.forEach(function(t){t.clear&&t.clear()})},t.prototype.setUrl=function(){var t=this.src;for(var e in t)t[e].setUrl&&t[e].setUrl.apply(t[e],arguments)},t}(),vt=function(){function t(t){for(var e in this.withCredentials=!1,this.responseType="",t)this[e]=t[e]}return t.prototype.send=function(t){var e=t.success,r=t.error,n=t.responseType||this.responseType,i=t.headers,o=new XMLHttpRequest,s=t.withCredentials;if(o.withCredentials=null!=s?s:this.withCredentials,o.responseType="json"==n?"text":n,o.onload=function(){var t,r,i=this.responseType;""==i||"text"==i?(r=(t=this.responseText).length,"json"==n&&204!=this.status&&(t=JSON.parse(t))):r=(t=this.response).byteLength,this.status>=200&&this.status<=226&&e(t,r)},o.onreadystatechange=function(){4==this.readyState&&(this.status<200||this.status>=300)&&(this.onload=null,0!==this.status&&r&&r(this))},o.open(t.type||"GET",t.url,!0),i)for(var a in i)o.setRequestHeader(a,i[a]);return o.send(t.data||null),o},t}(),mt={},xt=/{([xX]|(COL))}/,_t=/{([yY]|(ROW))}/,bt=/{([zZ]|(LEVEL))}/,Tt=/{((qk)|(QK)|(quadkey)|(QUADKEY))}/,Lt=/{SUBDOMAIN_INT_1_4}/,Mt=/{SUBDOMAIN_INT}/,wt=/{SUBDOMAIN_CHAR}/,Bt=function(){return function(t){this.name="NetworkError";var e=t.responseType;this.message="Service request failed with HTTP status: '"+t.status+" "+t.statusText+"'",this.statusCode=t.status,""!=e&&"text"!=e||(this.responseText=t.responseText||null)}}(),St=function(){function t(t){this.withCredentials=!1,this.headers=null,this.store=null,this.baseUrl=null,this.q={};var e=t.responseType||"json",r=t.src||t.url,i=!!t.withCredentials;this.withCredentials=i,this.baseUrl=r,this.headers=n.extend(n.clone(mt),t.headers||{}),"function"==typeof r&&(this.getUrl=function(t){return r(t.z,t.y,t.x,t.quadkey)}),this.http=new vt({responseType:e,withCredentials:i})}return t.prototype.getUrl=function(t){var e=4*Math.random()^0;return this.baseUrl.replace(Lt,e+1).replace(Mt,e).replace(wt,"abcd"[e]).replace(Tt,t.quadkey).replace(bt,t.z).replace(xt,t.x).replace(_t,t.y)},t.prototype.setUrl=function(t){this.baseUrl=t},t.prototype.load=function(t,r,n){var i,o=this.getUrl(t),s=t.quadkey,a=this.q,h={key:s,url:o,success:r,error:n};"image"==t.type?(h.responseType="blob",h.success=function(t){a[s]=i;var n=new Image;n.onload=function(t){delete a[s],e.URL.revokeObjectURL(n.src),i._aborted||r(n)},n.src=e.URL.createObjectURL(t)}):("json"==t.type&&(h.success=function(t,e){r("FeatureCollection"==t.type?t.features:t,e)}),h.headers=this.headers),i=this.send(h)},t.prototype.abort=function(t){var e=this.q,r=t.quadkey,n=e[r];n&&("image"==t.type&&(n.onload=void 0,n._aborted=!0),n.abort&&n.abort(),delete e[r])},t.prototype.send=function(t){var e=t.key||Math.random(),r=this.q,n=t.success;t.success=function(t,i){delete r[e],n(t,i)};var i=t.error;return t.error=function(t){delete r[e],i(new Bt(t))},r[e]=this.http.send(t)},t}();function Ot(){return+new Date}var Ft=function(t){function e(e,r){var n=t.call(this,e,{storage:new ut(512)})||this;n.name="",n.opacity=1,n.dataType="image";var i=n;return i.loader||(i.loader=new yt(new St({url:e.url,headers:{Accept:"*/*"}}))),n}return pt(e,t),e.prototype.getTile=function(t,e){var r,n=this.loader,i=this.storage;return void 0===(r=i.get(t))&&(i.set(r=this.createTile(t)),r.onLoaded=[]),r.loadStopTs?(e&&e(r),r):(e&&-1==r.onLoaded.indexOf(e)&&r.onLoaded.push(e),r.loadStartTs||(r.loadStartTs=Ot(),n.tile(r,function(t){r.loadStopTs=Ot(),r.data=t;for(var e=0,n=r.onLoaded;e<n.length;e++){(0,n[e])(r)}r.onLoaded=void 0},function(t){r.loadStopTs=Ot(),r.error=t})),r)},e.prototype._removeTile=function(t){t.isLoaded()||(this.storage.remove(t),this.loader.abort(t))},e.prototype.getLoader=function(){return this.loader},e.prototype.clear=function(t){var e=null;if(t instanceof Array){e=this.getCachedTilesOfBBox(t,this.level);for(var r=0,n=void 0;r<e.length;r++)n=e[r],this.storage.remove(n),e[r]=n.quadkey}else 0==arguments.length&&this.storage.clear();this.listeners.trigger("clear",[this,e],!0)},e.prototype.cancel=function(t){var e;(e=t instanceof X?t:this.storage.get(t))&&this._removeTile(e)},e}(gt);Ft.prototype.__type="ImageProvider";var Ct=function(t,e){var r,n;e&&((r=t[0])<e[0]&&(e[0]=r),r>e[2]&&(e[2]=r),(n=t[1])<e[1]&&(e[1]=n),n>e[3]&&(e[3]=n))},Pt=function(t,e){for(var r=t.length;r--;)Ct(t[r],e)},kt=function(t){var e,r=t.geometry.type,n=t.geometry.coordinates,i=!0;if("Point"==r)t.bbox=[n[0],n[1],n[0],n[1]];else if(e=t.bbox=[1/0,1/0,-1/0,-1/0],"MultiLineString"==r)for(var o=0;o<n.length;o++)Pt(n[o],e);else if("MultiPolygon"==r)for(var s=0;s<n.length;s++)Pt(n[s][0],e);else"LineString"==r||"MultiPoint"==r?Pt(n,e):"Polygon"==r?Pt(n[0],e):i=!1;return i},Dt=function(t){return null!=t.id?t.id=t.id:t.id=1e8*Math.random()^0,t.bbox?(6===t.bbox.length&&(t.bbox=[t.bbox[0],t.bbox[1],t.bbox[3],t.bbox[4]]),t):kt(t)&&t},Et=Object.freeze({updateBBox:kt,prepareFeature:Dt});function qt(t){this.feature=t}qt.prototype.cnt=0;var Ut=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.IDPOOL={},n.dataType="json",n.ignore=!1,n.cnt=0,n.__type="FeatureProvider",n.tree=T(9,[".bbox[0]",".bbox[1]",".bbox[2]",".bbox[3]"]),n.Feature=n.Feature||ot,n}return pt(e,t),e.prototype.isDroppable=function(t){return!0},e.prototype.addFeature=function(t){var e,r,n;if("FeatureCollection"==t.type&&(t=t.features),n=t.length){for(var i=[],o=0;o<n;o++)i[o]=this.addFeature(t[o]);return i}if(this.isFeatureInstance(t,ot)&&t._provider&&t._provider!=this&&(t=t.toJSON()),!1!==(e=this.prepareFeature(t))){if(null!=(r=this._insert(e))){t=r;for(var s=this.getCachedTilesOfBBox(this.decBBox(t)),a=0,h=void 0;a<s.length;a++)(h=s[a]).add(t),h.z==this.level&&this._mark(t,h);this.tree&&this.tree.insert(t),this.ignore||this.listeners.trigger("featureAdd",[t,s],!0)}}else t=null;return t},e.prototype.all=function(){return this.tree?this.tree.all():this._s({minX:-180,maxX:180,minY:-90,maxY:90})},e.prototype.getFeature=function(t){if(this.IDPOOL[t])return this.IDPOOL[t].feature},e.prototype.getFeatures=function(t,e){t instanceof Array||(t=[t]);for(var r=[],n=0;n<t.length;n++)r[n]=this.getFeature(t[n]);return 1==r.length?r[0]:r},e.prototype.getTile=function(t,e){var r=this.storage,n=r.get(t);return void 0===n&&(r.set(n=this.createTile(t)),n.loadStartTs=n.loadStopTs=Date.now(),n.data=this.search(n.getContentBounds())),e&&e(n),n},e.prototype.setFilter=function(t){this.filter="function"==typeof t?t:void 0},e.prototype.getFeatureClass=function(t){return this.Feature},e.prototype.isFeatureInstance=function(t,e){return t instanceof e},e.prototype.createFeature=function(t,e){return new e(t,this)},e.prototype.search=function(t,e){var r,n;if("object"==typeof t)if(e)for(var i in t)e[i]=t[i];else e=t;var s=e&&e.radius||1;if(t instanceof Array)n=4==t.length?t:o.getPointBBox(t,s);else{if("number"==typeof t||"string"==typeof t||!t)return this.getFeatures(t);if(null!=t.longitude&&null!=t.latitude)n=o.getPointBBox([t.longitude,t.latitude],s);else if(null!=t.minLon&&null!=t.minLat&&null!=t.maxLon&&null!=t.maxLat)n=[t.minLon,t.minLat,t.maxLon,t.maxLat];else{if(r=t.point||t.rect||t.viewport)return this.search(r);if(t.id||t.ids)return this.getFeatures(t.id||t.ids)}}return n={minX:n[0],minY:n[1],maxX:n[2],maxY:n[3]},this._s(n)},e.prototype.exists=function(t){return this.IDPOOL[t.id]},e.prototype.setFeatureCoordinates=function(t,e){var r=t;if(t=this.getFeature(t.id)){var n=t.getBBox(),i=t.geometry.coordinates;this.ignore=!0,this.removeFeature(t),t.geometry.coordinates=this.encCoord(t.geometry.type,e),t.bbox=null,this.addFeature(t),this.ignore=!1,this.listeners.trigger("featureCoordinatesChange",[t,n,i,this],!0)}else r.geometry.coordinates=e,this.updateBBox(r)},e.prototype.removeFeature=function(t){var e;if("FeatureCollection"==t.type&&(t=t.features),e=t.length){for(var r=[],n=0;n<e;n++)r[n]=this.removeFeature(t[n]);return r}if(t=this.getFeature(t.id)){for(var i=this.getCachedTilesOfBBox(this.decBBox(t)),o=void 0,s=0;s<i.length;s++)(o=i[s]).isLoaded()&&o.remove(t);this.cnt--,delete this.IDPOOL[t.id],this.tree&&this.tree.remove(t),this.ignore||this.listeners.trigger("featureRemove",[t,i],!0)}return t},e.prototype.clear=function(t){var e,r=null;if(4==arguments.length&&(t=Array.prototype.slice.call(arguments)),t instanceof Array){r=this.getCachedTilesOfBBox(t,this.level);for(var n=0,i=void 0;n<r.length;n++)i=r[n],this._removeTile(i,!1),r[n]=i.quadkey}else if(0==arguments.length){var o={},s=this.IDPOOL,a=0;for(var h in this.tree&&this.tree.clear(),s)e=this.getFeature(h),this.isDroppable(e)||(o[h]=new qt(e),a++,this.tree&&this.tree.insert(e));this.cnt=a,this.dep={},this.IDPOOL=o,gt.prototype.clear.call(this,t)}this.listeners.trigger("clear",[this,r],!0)},e.prototype._insert=function(t,e){var r=t.id,n=null,i=this.getFeatureClass(t),o=this.filter;return o&&!o(t)||(void 0===this.IDPOOL[r]&&(this.cnt++,this.isFeatureInstance(t,i)?t._provider=this:t=this.createFeature(t,i),this.updateBBox(t),this.IDPOOL[r]=new qt(t),n=t),e&&this._mark(t,e)),n},e.prototype._mark=function(t,e){var r=this.IDPOOL[t.id];r[e.quadkey]||(r.cnt++,r[e.quadkey]=!0)},e.prototype._removeTile=function(t,e){var r,n,i=t.quadkey;if(r=this.dep[i]){for(var o=0;o<r.length;o++)this.storage.remove(r[o]);delete this.dep[i]}if(this.storage.remove(t),n=t.data)for(o=0;o<n.length;o++)this._dropFeature(n[o],i,e)},e.prototype._dropFeature=function(t,e,r){var n=this.IDPOOL[t.id];n&&(n[e]&&(n[e]=void 0,n.cnt--),this.isDroppable(t)&&(n.cnt||(this.cnt--,delete this.IDPOOL[t.id],this.tree&&this.tree.remove(t),r&&this.listeners.trigger("featureRemove",[t,this],!0))))},e.prototype._s=function(t){if(this.tree)return this.tree.search(t);var e,r,n=1e8*Math.random()^0,i=this.level;return this.storage.forEach(function(o){if(o.z==i&&(r=o.search(t)))if(e){a=0,h=r.length;for(var s=void 0;a<h;a++)(s=r[a])._m!=n&&(s._m=n,e[e.length]=s)}else for(var a=0,h=(e=r).length;a<h;a++)e[a]._m=n}),e||[]},e.prototype.encCoord=function(t,e){return e},e.prototype.decCoord=function(t){return t.geometry.coordinates},e.prototype.decBBox=function(t){return t.bbox},e.prototype.prepareFeature=function(t){return t},e.prototype.updateBBox=function(t){return!0},e}(gt);Ut.prototype.prepareFeature=Dt,Ut.prototype.updateBBox=kt,Ut.prototype.modifyFeatureCoordinates=Ut.prototype.setFeatureCoordinates;var Xt=function(){function t(t,e){this.c=0,this.cbs=[],this.qks=e,this.tile=t}return t.prototype.receive=function(t){if(!this.ready){var e=this.tile,r=this.qks,n=r.indexOf(t.quadkey);if(-1!=n&&(r[n]=null,++this.c==r.length)){this.ready=!0,e.processedData=void 0;var i=t.error;i?e.error=i:e.data=e.provider.search(e.getContentBounds()),e.loadStopTs=Date.now(),this.exec(),e.onLoaded.length=0,this.qks=null}}},t.prototype.exec=function(){for(var t=this.cbs,e=t.length,r=this.tile,n=0;n<e;)t[n++](r,r.error);t.length=0},t.prototype.add=function(t){var e=this.cbs;if("function"==typeof t&&-1==e.indexOf(t))return e.push(t),!0},t.prototype.remove=function(t){var e=this.cbs,r=e.indexOf(t);return-1!=r&&e.splice(r,1),e.length},t}();Xt.prototype.ready=!1;var Yt,Rt,jt=function(t){function e(e,r){var n=t.call(this,{minLevel:8,maxLevel:20,staticData:!1},e)||this;n.sizeKB=0;var i=n,o=e.loader;if(!o)throw new Error("no tile loader defined.");return o instanceof yt||(o=new yt(o)),i.loader=o,"function"==typeof r&&(i._pp=r),n}return pt(e,t),e.prototype.cancel=function(t,e){var r,n,i=this.storage,o=null==e;if(n=t instanceof this.Tile?t:i.get(t)){t=n.quadkey,r=this.calcStorageQuads(t);for(var s=0,a=void 0,h=void 0;s<r.length;s++)if(a=(h=r[s])==t?n:i.get(h)){var u=a.onLoaded,l=void 0;u&&(o?n.onLoaded.length=0:this.level&&n.z!=this.level?-1!=(l=u.indexOf(n.onLoaded[0]))&&(u[l].remove(e)||u.splice(l,1)):u.splice(u.indexOf(e),1),u.length||this.loader.abort(a)&&i.remove(a))}}},e.prototype.search=function(t,e){var r,n,i=this;if("object"==typeof t)if(e)for(var s in t)e[s]=t[s];else e=t;var a=(e=e||{}).onload,h=e.radius,u=e.remote,l=e.onerror;if(null==h&&(h=1),t instanceof Array)n=4==t.length?t:o.getPointBBox(t,h);else{if("number"==typeof t||"string"==typeof t||!t)return i.getFeatures(t,e);if(null!=t.longitude&&null!=t.latitude)n=o.getPointBBox([t.longitude,t.latitude],h);else if(null!=t.minLon&&null!=t.minLat&&null!=t.maxLon&&null!=t.maxLat)n=[t.minLon,t.minLat,t.maxLon,t.maxLat];else{if(r=t.point||t.rect||t.viewport)return i.search(r,e);if(t.id||t.ids)return i.getFeatures(t.id||t.ids,e)}}if(n={minX:n[0],minY:n[1],maxX:n[2],maxY:n[3]},u){for(var p,c=x.getTilesInRect(n.minX,n.minY,n.maxX,n.maxY,i.level),f=function(t){c.splice(c.indexOf(t.quadkey),1),p=p||t.error,c.length||(p?l(p):a&&a(i._s(n)))},d=0;d<c.length;d++){var g=c[d],y=i.getCachedTile(g);if(y&&y.isLoaded()){if(y.error)return void(l&&l(y.error));c.splice(d--,1)}else i.getTile(g,f)}if(c.length)return}var v=i._s(n);return a&&a(v),v},e.prototype.getLoader=function(){return this.loader},e.prototype.config=function(e){return t.prototype.config.call(this,e)},e.prototype.clear=function(e){0==arguments.length&&this.loader.clear(),t.prototype.clear.apply(this,arguments)},e.prototype.calcStorageQuads=function(t){return x.getTilesOfLevel(t,this.level)},e.prototype.preprocess=function(t,e,r){var n,i=this._pp;(n="function"==typeof i?i({data:e,quadkey:t.quadkey,x:t.x,y:t.y,z:t.z,provider:this,ready:r}):e)&&r(n)},e.prototype.createTile=function(e){var r,n,i=t.prototype.createTile.call(this,e),o=i.z,s=this.level;if(s&&o!=s)if(o>s)r=e.substr(0,s),(n=this.dep[r])||(n=this.dep[r]=[]),n[n.length]=i;else if(o<s)for(var a=x.getTilesOfLevel(e,s),h=0,u=a.length;h<u;h++)r=a[h],(n=this.dep[r])||(n=this.dep[r]=[]),n[n.length]=i;return i},e.prototype.execTile=function(t){var e,r=t.onLoaded;if(r){for(var n=0,i=r.length;n<i;n++)(e=r[n])instanceof Xt?e.receive(t):e(t);r.length=0}},e.prototype.attachData=function(t,e){for(var r,n,i,o=[],s=e.length,a=0;a<s;a++)!1!==(r=this.prepareFeature(i=e[a]))?(i=r,(n=this._insert(i,t))?(i=n,o[o.length]=i):this.tree||(o[o.length]=this.getFeature(i.id))):(e.splice(a--,1),s--);if(e=o,t.loadStopTs=Date.now(),this.tree?this.tree.load(e):t.createTree(e),this.staticData?t.data=e:t.data=this.search(t.getContentBounds()),this.margin)for(var h=0,u=t.data.length;h<u;h++)this._mark(t.data[h],t);this.execTile(t)},e.prototype.getTile=function(t,e){var r,n=this,i=n.storage,o=n.level;if(null==(r=i.get(t)))(r=n.createTile(t)).onLoaded=[],i.set(r);else if(r.isLoaded())return e&&e(r,r.error),r;if(t.length!=o){var s=n.calcStorageQuads(t),a=void 0,h=void 0;r.loadStartTs=Date.now(),r.data=[],r.onLoaded.length?h=r.onLoaded[0]:(h=new Xt(r,s),r.onLoaded.push(h)),h.add(e);for(var u=0;u<s.length;u++)null==(a=i.get(s[u]))?a=n.getTile(s[u],h):a.isLoaded()?h.receive(a):-1==a.onLoaded.indexOf(h)&&a.onLoaded.push(h)}else e&&-1==r.onLoaded.indexOf(e)&&r.onLoaded.push(e),r.loadStartTs||(r.loadStartTs=Date.now(),n.loader.tile(r,function(t,e){n.sizeKB+=e/1024,n.preprocess(r,t,function(t){return n.attachData(r,t)})},function(t){r.loadStopTs=Date.now(),r.error=t,r.data=[],n.execTile(r),n.listeners.trigger("error",[t],!0)}));return r},e.prototype._removeTile=function(e,r){t.prototype._removeTile.call(this,e,r),e.isLoaded()||this.loader.abort(e)},e}(Ut),At=function(t){function e(e,r){return e.level=e.level||13,e.headers=n.extend({Accept:"application/geo+json"},e.headers||{}),t.call(this,e,r)||this}return pt(e,t),e}(function(t){function e(e,r){var n=this,i=(e=e||{}).loader;return i?i instanceof yt||(i=new yt(i)):i=new yt(new St({url:e.url,withCredentials:e.withCredentials,headers:e.headers})),e.loader=i,(n=t.call(this,e,r)||this).setParams(e.params||{}),n.setHeaders(e.headers||{}),n}return pt(e,t),e.prototype.getHeader=function(t){var e=this.loader.src;return e[e.length-1].headers[t]||null},e.prototype.getHeaders=function(){var t=this.loader.src;return n.clone(t[t.length-1].headers)},e.prototype.setHeader=function(t,e){var r=this.loader.src,n=this.getHeaders();n[t]=e,r[r.length-1].headers=n,this.headers=n},e.prototype.setHeaders=function(t){var e=this.loader.src,r=this.getHeaders();n.extend(r,t),e[e.length-1].headers=r,this.headers=r},e.prototype.getParams=function(){return this.params},e.prototype.getParam=function(t){return this.params[t]||null},e.prototype.setParams=function(t){var e=this.loader.src,r=e[e.length-1],i=r.baseUrl,o=this.params||{};if(n.extend(o,t),this.params=o,"string"==typeof i){o=n.extend(function(t,e){return e=e||{},t.split(/\?|\&/).slice(1).map(function(t){t=t.split(/\=/),e[t[0]]=t[1]}),e}(i),o);var s=i.split(/\?/)[0],a="?";for(var h in o)s+=a+h+"="+o[h],a="&";r.setUrl(s)}},e.prototype.setParam=function(t,e){var r={};r[t]=e,this.setParams(r)},e.prototype.config=function(e){return t.prototype.config.call(this,e),e&&e.url&&this.setParams({}),this},e}(jt)),It=function(t){function e(e){var r=t.call(this,{minLevel:8,maxLevel:20,storage:new ut(512)},e)||this;return r.level=Yt,r}return pt(e,t),e.prototype.cancel=function(t){},e.prototype.delete=function(t){this.tree.remove(t)},e.prototype.import=function(t){this.tree.fromJSON(t);for(var e=(t=this.tree.all()).length;e--;)this._insert(t[e])},e.prototype.initStorage=function(t){t.onDrop(t.remove.bind(t),this)},e}(Ut),zt={Point:"MARKER",LineString:"LINE",Polygon:"AREA",MultiPolygon:"AREA"},Gt=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.isEditable=!0,n.blocked={},n}return pt(e,t),e.prototype.writeRoutingPoint=function(t,e,r){this.writeRoutingLink(t,e),this.writeRoutingPosition(t,r)},e.prototype.readRoutingPoint=function(t){return{link:this.readRoutingLink(t),position:this.readRoutingPosition(t)}},e.prototype.getFeatures=function(e,r){r=r||{},e instanceof Array||("object"==typeof e&&(e.remote&&(r.remote=e.remote),e.onload&&(r.onload=e.onload),e=e.ids||e.id),e=[].concat(e));var n=this,i=!0,o=r.onload,s=r.remote;(u=t.prototype.getFeatures.call(this,e))instanceof Array||(u=[u]);for(var a=0;a<u.length;a++)u[a]||(u[a]=e[a],i=!1);function h(){return 1==(u=u.map(function(t){return"object"==typeof t?t:Rt})).length?u[0]:u}if(i||!s){var u=h();return o&&o(u),u}e=u.filter(function(t){return"object"!=typeof t}),n._requestFeatures(e,function(t){for(var e,r=t.length;r--;)e=t[r],u[u.indexOf(e.id)]=n.addFeature(e);o&&o(h())},function(t){var e=r.onerror;e&&e(t)},r)},e.prototype.getFeatureProperties=function(t){return t.properties},e.prototype.detectFeatureClass=function(t){return zt[t.geometry.type]},e.prototype.isoCC=function(t,e){return!0},e.prototype.reserveId=function(t,e){for(var r,i=t.length,o=[];i--;)"string"==typeof(r=t[i].id)&&r.length>15?o.push(t[i].id):o.push(n.String.random(16));setTimeout(function(){e(o.reverse())},0)},e.prototype.blockFeature=function(t,e){var r=t.id||t,n=typeof r;"string"!=n&&"number"!=n||(e?this.blocked[r]=!0:delete this.blocked[r])},e.prototype._insert=function(e,r){return this.blocked[e.id]?null:t.prototype._insert.call(this,e,r)},e}(At);Gt.prototype.prepareFeature=function(t){return t.properties||(t.properties={}),null==t.id&&(t.id=n.String.random()),t},Gt.prototype.updateBBox=function(t){var e=t.geometry.type,r=t.geometry.coordinates;if("Point"==e&&t.class&&"MARKER"!=t.class){var n=t.properties&&this.readRoutingPosition(t);if(n)return t.bbox=function(t){for(var e,r,n=1/0,i=-1/0,o=1/0,s=-1/0,a=t.length,h=0;h<a;h++)(e=t[h][0])<n&&(n=e),e>i&&(i=e),(r=t[h][1])<o&&(o=r),r>s&&(s=r);return[n,o,i,s]}([r,this.encCoord(e,n)]),!0}return!!t.bbox||kt(t)};var Nt,Ht={environment:"prd",space:"",credentials:{},withCredentials:!1,tags:!1,https:!0,clip:!1,url:null,headers:null},Jt="http://",Kt={prd:Jt+"xyz.api.here.com/hub/spaces",cit:Jt+"xyz.cit.api.here.com/hub/spaces",sit:Jt+"xyz.sit.cpdev.aws.in.here.com/hub/spaces"},Qt=function(t){return(t=n.extend(n.clone(Ht),t)).params=n.extend(t.params||{},t.credentials),delete t.credentials,t.url||(t.url=Kt[t.environment]),t.https&&(t.url=t.url.replace(Jt,"https://")),t},Wt=function(t){function e(e,r){var n=t.call(this,Qt(e),r)||this;return n.definition=null,n.setUrl(n.getTileUrl(n.space)),n}return pt(e,t),e.prototype.commit=function(t,e,r){var i=this.loader.src,o=i[i.length-1],s=this._addUrlCredentials(this.getLayerUrl(this.space)+"/features","?"),a=function(t){--u||e&&e(t)},h=function(t){r&&r(t)},u=0;function l(t){t instanceof Array||(t=[t]);for(var e,r=t.length;r--;)(e=(t[r]=ot.prototype.toJSON.call(t[r])).properties)&&delete e["@ns:com:here:editor"];return t}if(t){var p=l(t.put||[]);p.length&&(u++,o.send({url:s,success:a,error:h,type:"POST",headers:n.extend(n.clone(this.headers),{"Content-Type":"application/geo+json"}),data:JSON.stringify({type:"FeatureCollection",features:p})}));var c=l(t.remove||[]);c.length&&(u++,o.send({url:s+"&id="+c.map(function(t){return t.id}).join(","),success:a,error:h,headers:this.headers,type:"DELETE"}))}},e.prototype.prepareFeature=function(e){var r=(e=t.prototype.prepareFeature.call(this,e)).properties;return r["@ns:com:here:xyz"]||(r["@ns:com:here:xyz"]={}),e},e.prototype.setMargin=function(t){Gt.prototype.setMargin.call(this,t),this.setUrl(this.getTileUrl(this.space))},e.prototype.getLayerUrl=function(t){return this.url+"/"+t},e.prototype.setUrl=function(t){this.loader.setUrl(this._addUrlCredentials(t))},e.prototype.getTileUrl=function(t){return this._addUrlTags(this.getLayerUrl(t)+"/tile/quadkey/{QUADKEY}?margin="+this.margin+"&clip="+!!this.clip)},e.prototype.setTags=function(t){"string"==typeof t&&(t=[t]),this.tags=t,this.setUrl(this.getTileUrl(this.space)),this.clear()},e.prototype.getFeatureUrl=function(t,e,r){return e instanceof Array||(e=[e]),this.getLayerUrl(t)+"/features?id="+e.join("&id=")},e.prototype.getCopyright=function(t,e){this.getDefinition(function(e){t&&t(e.copyright||[])},e)},e.prototype.getDefinition=function(t,e){var r=this,n=r.getLoader().src,i=r.definition;if(null==i){var o=new s;i=this.definition=o,n[n.length-1].send({url:r._addUrlCredentials(r.getLayerUrl(r.space),"?"),key:"def",success:function(t){r.definition=t,o.done(t)},error:function(t){r.definition=[],e&&e(t)},headers:this.headers})}t&&(i instanceof s?i.add(t):t(i))},e.prototype._requestFeatures=function(t,e,r,n){var i=this.loader.src;i[i.length-1].send({key:t.join("&"),url:this._addUrlCredentials(this.getFeatureUrl(this.space,t,n)),success:function(t){e(t.features)},headers:this.headers,error:r})},e.prototype._addUrlCredentials=function(t,e){return t=function(t,e,r){for(var n in e)t+=r+n+"="+e[n],r="&";return t}(t,this.params,e||"&")},e.prototype._addUrlTags=function(t,e){return(e=e||this.tags)&&e.length&&(t+="&tags="+e.join(",")),t},e.prototype.readDirection=function(t){throw new Error("Method not implemented.")},e.prototype.readPedestrianOnly=function(t){throw new Error("Method not implemented.")},e.prototype.writeTurnRestriction=function(t,e,r){throw new Error("Method not implemented.")},e.prototype.readRoutingProvider=function(t){return this.id},e.prototype.readRoutingPosition=function(t){throw new Error("Method not implemented.")},e.prototype.readRoutingLink=function(t){throw new Error("Method not implemented.")},e.prototype.writeRoutingPosition=function(t,e){throw new Error("Method not implemented.")},e.prototype.writeRoutingLink=function(t,e){throw new Error("Method not implemented.")},e.prototype.readTurnRestriction=function(t,e){throw new Error("Method not implemented.")},e.prototype.writeEditState=function(t,e){},e}(Gt),Zt="METADATA",Vt="T!GERDB";function $t(t,e,r){var n=new XMLHttpRequest;return n.onload=function(){e(JSON.parse(this.responseText))},n.onreadystatechange=function(){var t=this.status;4==this.readyState&&(t<200||t>=300)&&0!==t&&r&&r(this)},n.open("GET",t,!0),n.send(),n}var te=function(){function t(t){(t=t||{}).host=t.host||"geocoder.api.here.com",t.version=t.version||"6.2",this.url="https://"+t.host+"/"+t.version+"/geocode.json",this.reverseUrl="https://reverse."+t.host+"/"+t.version+"/reversegeocode.json",this.cfg=t}return t.prototype.createUrl=function(t,e){var r="";for(var n in e=e||{})r+="&"+n+"="+encodeURIComponent(e[n]);return this.reverseUrl+"?app_id="+this.cfg.app_id+"&app_code="+this.cfg.app_code+r},t.prototype.geocode=function(t,e,r){$t(this.createUrl(this.url,t),e,r)},t.prototype.reverseGeocode=function(t,e,r){$t(this.createUrl(this.reverseUrl,t),e,r)},t.prototype.getIsoCountryCode=function(t,e,r){var n={mode:"retrieveAddresses",maxresults:1,jsonattributes:1};t instanceof Array?n.prox=t[1]+","+t[0]:n.prox=t.latitude+","+t.longitude,this.reverseGeocode(n,function(t){var r=null;try{r=t.response.view[0].result[0].location.address.country}catch(t){}e&&e(r,t)},r)},t}(),ee=e.here.xyz.maps;ee.common=t;var re=ee.tile={Tile:X,Utils:x},ne=ee.layers={TileLayer:tt},ie=ee.geo={Point:et,Rect:rt},oe=ee.pixel={Point:nt,Rect:it},se=ee.features={Feature:ot},ae=ee.storage={Level2Storage:ht,LRUStorage:ut},he=ee.providers={ImageProvider:Ft,GeoJSONProvider:At,FeatureProvider:Ut,LocalProvider:It,RemoteTileProvider:jt,EditableProvider:Gt,SpaceProvider:Wt},ue=ee.projection={webMercator:c},le=ee.loaders={HTTPLoader:St,IndexDBLoader:function(t){var e,r,n,i=0;function o(t){n=!1;var o=t?indexedDB.open(Vt,i+1):indexedDB.open(Vt);o.onupgradeneeded=function(e){var n=e.target.result,o=e.target.transaction;i=0|n.version,n.objectStoreNames.contains(Zt)||n.createObjectStore(Zt).add(r={},"STORES"),t==Nt||n.objectStoreNames.contains(t)||(n.createObjectStore(t),r[t]=+new Date),o.objectStore(Zt).put(r,"STORES")},o.onsuccess=function(t){function a(){var t;for(var e in n=!0,s)t=s[e],r[t[0]]?t[1]&&t[1]():t[2]&&t[2](),delete s[e]}(e=o.result).onversionchange=function(t){e.close(),n=!1},i=0|e.version,r===Nt?e.transaction(Zt,"readonly").objectStore(Zt).get("STORES").onsuccess=function(t){r=t.target.result,a()}:a()},o.onerror=o.onblocker=function(t){}}var s={},a={};o();var h=t;this.baseUrl=t,this.abort=function(t){var e=t.quadkey;s[e]&&delete s[e],a[e]&&(a[e].abort(),delete a[e])},this.load=function(t,i,o){var u=t.quadkey;function l(){var r=e.transaction(h,"readonly");a[u]=r,r.objectStore(h).get(t.quadkey).onsuccess=function(t){var e=t.target.result;delete a[u],e?i&&here.xyz.maps.common.parseJSONArray(e,i):o&&setTimeout(o,0)}}n?r[h]?l():o&&o():s[u]=[h,l,o]},this.clear=function(t){r[h]&&(e.transaction(h,"readwrite").objectStore(h).clear().onsuccess=t)},this.store=function(t,i){var a=t.quadkey;function u(){t.data?e.transaction(h,"readwrite").objectStore(h).put(JSON.stringify(t.data),t.quadkey).onsuccess=i:i()}r[h]?u():(s[a]=[h,u],n&&o(h))}},Manager:yt},pe=ee.service||{Geocoder:te},ce=ee.data||{prepare:{GeoJSON:Et}},fe=ee.build={name:"xyz-maps",version:"0.9.33",revision:"d4016bb",date:"2019-07-30T10:01:06Z"};export default{tile:re,layers:ne,geo:ie,pixel:oe,features:se,storage:ae,providers:he,projection:ue,loaders:le,service:pe,data:ce,build:fe,common:t};export{fe as build,ce as data,se as features,ie as geo,ne as layers,le as loaders,oe as pixel,ue as projection,he as providers,pe as service,ae as storage,re as tile};
