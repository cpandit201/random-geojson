/*
 * @here/xyz-maps-display
 * (c) 2019 HERE
 */
import{TaskManager as t,LRU as e,global as n,Listener as i,Map as r,JSUtils as o}from"@here/xyz-maps-common";import{tile as a,projection as s,geo as l,pixel as u,layers as c}from"@here/xyz-maps-core";var h=function(t,e,n,i){("string"==typeof e?[e]:e).forEach(function(e){t.addEventListener(e,n,i)})},p=function(t,e,n){("string"==typeof e?[e]:e).forEach(function(e){t.removeEventListener(e,n)})},f=function(t,e){return 0^parseInt((i=e,(o=(n=t).ownerDocument.defaultView.getComputedStyle(n,null))&&""===(r=o.getPropertyValue(i))&&(r=n.style[i]),r));var n,i,r,o},d=function(t,e,n,i,r){var o,a=document.createElement("canvas"),s=a.style;return function(t,e,n){t.setAttribute("width",e),t.setAttribute("height",n)}(a,e,n),a.setAttribute("oncontextmenu","return false;"),function(t,e){["-webkit-user-select","-moz-user-select","-ms-user-select","user-select"].forEach(function(n){t.style[n]=e})}(a,"none"),s.top=s.left="0px",s.position="absolute",1!=r&&(s.opacity=String(r)),t.querySelectorAll("canvas[type=layer]"),a.setAttribute("type","layer"),(o=t.querySelectorAll("canvas")[i])?t.insertBefore(a,o):t.appendChild(a),a},v=function(t,e){return(v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function y(t,e){function n(){this.constructor=t}v(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var g=document.createElement("canvas").getContext("2d"),m="abcdefghijklmnopqrstuvwxyz",x=(m=m+m.toUpperCase()+"0123456789").length,w={},L={},M="normal 12px Arial",b=function(t){return w[t]||(g.font=t,w[t]=g.measureText(m).width/x),w[t]},T=function(t){return L[t]=L[t]||new Function("f","return f."+t)},z=function(t,e,n,i){var r=e[t];return"function"==typeof r?r(n,i):r},C=function(t,e,n){for(var i,r,o,a=0,s=0,l=0;l<t.length;l++)o=t[l],(r=z("zIndex",o,e,n))>s&&(s=r),(i=z("strokeWidth",o,e,n)||1)>a&&(a=i);return[a,s]},S=function(t,e,n){for(var i,r,o,a,s,l,u,c,h,p,f,d=0,v=1/0,y=-1/0,g=1/0,m=-1/0,x=0;x<t.length;x++)if((p=z("zIndex",t[x],e,n))>d&&(d=p),r=t[x],"Image"==(o=z("type",r,e,n))||z("fill",r,e,n)){if("Text"==o){if(null==(f=r.text)&&(f=T(r.textRef)(e)),null==f)continue;a=b(r.font||M)*f.length,s=14}else i=z("strokeWidth",r,e,n)||1,"Circle"==o?s=a=2*z("radius",r,e,n)^0:(a=0^z("width",r,e,n),s=null==(s=z("height",r,e,n))?a:0^s),s+=i,a+=i;(l=(0^z("offsetX",r,e,n))-.5*a)<v&&(v=l),(u=l+a)>y&&(y=u),(c=(0^z("offsetY",r,e,n))-.5*s)<g&&(g=c),(h=c+s)>m&&(m=h)}if(y!=-1/0)return[v,g,y,m,d]},k=function(t){return t.type&&null!=t.zIndex},D=function(t,e,n){for(var i,r=0,o=0;o<t.length;o++)(i=z("zIndex",t[o],e,n))>r&&(r=i);return r};function N(){var t=this._s;for(var e in this.ready=!0,t)t[e][0](this,t[e][1])}var I,j=new(function(){function t(){this.src={}}return t.prototype.isRequested=function(t){return!!this.src[t]},t.prototype.isReady=function(t){return this.src[t]&&this.src[t].ready},t.prototype.get=function(t,e,n,i,r){var o=this.src;if(null==o[t]){var a=o[t]=new Image;a.ready=!1,a._s={},e&&(a._s[n]=[e,i]),a.crossOrigin="Anonymous",a.onload=N,a.src=t}else e&&(o[t].ready?e(o[t],i):o[t]._s[n]=[e,i]);return o[t]},t}()),E=2*Math.PI,P=Math.PI/180,A=Math.log(2048)/Math.log(2),O=A+9,R=function(t,e,n,i,r,o,a,s,l,u,c,h){var p=a.z;e+=0^z("offsetX",i,r,p),n+=0^z("offsetY",i,r,p);var f,d,v,y,g,m,x=z("rotation",i,r,p),w=e+512<<A|n+512^0|(x+360)%360<<O;c[w]||(c[w]=1,x&&(x*=P,l.translate(e,n),l.rotate(x),g=e,m=n,e=0,n=0),"Text"==t?(i.stroke&&0!=i.strokeWidth&&l.strokeText(o,e,n),i.fill&&l.fillText(o,e,n)):"Circle"==t?(d=z("radius",i,r,p),l.moveTo(e+d,n),l.arc(e,n,d,0,E,!1)):(e-=(v=z("width",i,r,p))/2,n-=(y=z("height",i,r,p)||v)/2,"Image"==t?(f=z("src",i,r,p),j.isReady(f)?l.drawImage(j.get(f),e,n,v,y):j.get(f,function(){return h.updateTile(a,s,u)},a.quadkey)):"Rect"==t&&l.rect(e,n,v,y)),x&&(l.rotate(-x),l.translate(-g,-m)))},B=Math,_=function(){function t(){this.o=.5}return t.prototype.init=function(t){return this.o=t,!0},t.prototype.createSymbol=function(t,e){return t-("Circle"==e.type?e.radius:e.width)>0},t.prototype.drawSymbol=function(t,e,n,i,r,o,a,s,l,u,c){R(r.type,e,n,r,a,!1,o,s,i,l,u,c)},t.prototype.angle=function(t,e){return Math.atan2(t,e)},t.prototype.place=function(t,e,n,i,r,o,a,s,l,u){var c,h,p,f,d,v,y,g,m,x,w=this.o;c=e.lon2x(t[0][0]),h=e.lat2y(t[0][1]);for(var L=1;L<t.length;L++)m=(p=e.lon2x(t[L][0]))-c,x=(f=e.lat2y(t[L][1]))-h,d=B.sqrt(B.pow(m,2)+B.pow(x,2))-16,(v=this.createSymbol(d,r))&&(y=(m*w+c)*u,g=(x*w+h)*u,n.setTransform(u,0,0,u,y,g),n.rotate(this.angle(x,m)),n.translate(-y,-g),this.drawSymbol(v,y,g,n,r,e,i,o,a,s,l),n.setTransform(u,0,0,u,0,0)),c=p,h=f},t}(),Z=function(t){function e(e){var n=t.call(this)||this;return t.prototype.init.call(n,.5),n.setCharWidth(e),n}return y(e,t),e.prototype.setCharWidth=function(t){this.cw=t},e.prototype.init=function(t){return"string"!=typeof t&&(t=String(t)),this.lw=t.length*this.cw,this.label=t,!0},e.prototype.angle=function(t,e){return Math.atan(t/e)},e.prototype.createSymbol=function(t){var e,n,i=this.label,r=this.cw,o=this.lw,a=Math.floor(t/o);return a>0&&(e=i,a>1&&(a=1+Math.floor((a-1)/8),n=new Array(Math.floor(1.5*(t-o)/r/a)).join(" "),e=i+new Array(a).join(n+i))),e},e.prototype.drawSymbol=function(t,e,n,i,r){r.stroke&&i.strokeText(t,e,n),r.fill&&i.fillText(t,e,n)},e}(_),Y=function(t,e,n){var i,r,o,a,s=t.length-1;for(e.moveTo(o=n.lon2x(t[s][0]),a=n.lat2y(t[s][1]));s--;)i=n.lon2x(t[s][0]),r=n.lat2y(t[s][1]),(o-i||a-r)&&e.lineTo(o=i,a=r)},W="round",q="center",X="middle",G=1,V=[],U=new Z(b(M)),F=new _;var Q,H={init:function(t,e,n){t.globalAlpha=e.opacity==I?1:e.opacity;var i,r,o=e.font,a=e.stroke;if(a&&(t.strokeStyle=a,o&&(n=1),(i=e.strokeWidth)&&"number"==typeof i||(i=G),t.lineWidth=i*n),e.fill&&(t.fillStyle=e.fill),o){var s=e.font||M;U.setCharWidth(b(s)),t.font=s,t.textAlign=e.textAlign||q,t.textBaseline=e.textBaseline||X}else t.lineCap=e.strokeLinecap||W,t.lineJoin=e.strokeLinejoin||W,(r=e.strokeDasharray)instanceof Array?t.setLineDash(r):t.setLineDash(V),(e.fill||e.stroke)&&t.beginPath();return!0},feature:function(t,e,n,i,r,o,a,s,l,u){var c=n.geometry.coordinates,h=n.geometry.type,p=t.z,f=z("type",r,n,p);if("LineString"==h){if("Circle"==f||"Rect"==f||"Image"==f){var d=z("offset",r,n,p);if(d!=I)return F.init(d),void F.place(c,t,e,n,r,o,a,s,l,u);h="MultiPoint"}}else if(("Polygon"==h||"MultiPolygon"==h)&&"Polygon"!=f&&"Line"!=f){var v=n.bbox;return R(f,t.lon2x(v[0]+(v[2]-v[0])/2),t.lat2y(v[1]+(v[3]-v[1])/2),r,n,i,t,o,e,a,s,l)}if("Point"==h)R(f,t.lon2x(c[0]),t.lat2y(c[1]),r,n,i,t,o,e,a,s,l);else if("Text"==f){if(!U.init(i))return;if("MultiLineString"==h)for(var y=0;y<c.length;y++)U.place(c[y],t,e,n,r,o,a,s,l,u);else"LineString"==h&&U.place(c,t,e,n,r,o,a,s,l,u)}else if("LineString"==h)Y(c,e,t);else if("Polygon"==h||"MultiLineString"==h)for(var g=0;g<c.length;g++)Y(c[g],e,t);else if("MultiPolygon"==h)for(y=0;y<c.length;y++)for(g=0;g<c[y].length;g++)Y(c[y][g],e,t);else if("MultiPoint"==h)for(var m=c.length;m--;)R(f,t.lon2x(c[m][0]),t.lat2y(c[m][1]),r,n,i,t,o,e,a,s,l)}},$=100,J="";function K(t,e,n){this.spawn=function(e,n,i,r,o,a,s,l,u){var c=this.createTask(e,n,i,r,o,i.bounds,a,s,l,u);return t.start(c),c},this.createTask=function(i,r,o,a,s,l,u,c,h,p){var f=s.index(a),d=s.getContext(f);return t.create({priority:i,delay:p,time:n,init:function(){if(!h){d.setTransform(e,0,0,e,0,0);var t=a.getStyle().backgroundColor;t?(d.fillStyle=t,d.globalAlpha=1,d.fillRect(0,0,256,256)):d.clearRect(0,0,256,256)}return{tile:o,ctx:d,data:u,lI:0,gI:0,fI:0,style:Q,dTile:s,layer:a,bI:$}},onDone:function(){s.dirty(f),c(d,this)},exec:function(t){var n,i=t.tile,o=t.data,a=o.length;if(a){for(;!(n=o[t.lI])&&t.lI<a;)++t.lI;if(n){var s=n[t.gI];if(s){var l=t.ctx,u=s.shared,c=u.font!=Q;if(t.style!=u){t.style=u;var h=H.init(l,u,o.swzs,i.z);if(t.pmap={},!h)return t.fI=0,t.gI++,t.bI=$,this.CONTINUE}for(;t.bI--;){var p=t.fI++,f=s.features[p];if(!f){c?l.setTransform(e,0,0,e,0,0):(u.fill&&l.fill(),u.stroke&&(u.strokeWidth||u.strokeWidth==Q)&&l.stroke()),t.fI=0,t.gI++;break}var d=s.styles[p],v=void 0,y=void 0;(!c||(v="function"==typeof(y=d.textRef?T(d.textRef):d.text)?y(f):y)!==Q&&v!==J)&&H.feature(i,l,f,v,d,t.dTile,t.layer,t.pmap,r,e)}}else t.fI=0,t.gI=0,t.lI++;return t.bI=$,this.CONTINUE}}}})}}var tt=4,et=function(){function e(e,n){this.dpr=1,this.debug=!1,this.rz=0,this.sx=0,this.sy=0,this.s=1;var i=t.getInstance();this.ts=e,this.dpr=n,this.painter=new K(i,n,tt)}return e.prototype.drawGrid=function(t,e,n){var i=n+"  L"+n.length,r=this.ctx;r.strokeRect(t,e,256,256),r.strokeText(i,t+8,e+16),r.fillText(i,t+8,e+16)},e.prototype.applyTransform=function(){var t=this.s,e=this.rz;if(this._s!=t||this._rz!=e){this._s=t,this._rz=e;var n=this.ctx,i=this.canvas,r=i.width,o=i.height,a=r/2-this.sx,s=o/2-this.sy,l=this.dpr;n.setTransform(1,0,0,1,r/2,o/2),n.rotate(e),n.translate(-r/2+a,-o/2+s),n.scale(t,t),n.translate(-a,-s),n.scale(l,l)}},e.prototype.init=function(t){var e=t.getContext("2d",{alpha:!1});e.font="bold 14px Arial",e.lineWidth=3,e.strokeStyle="red",e.fillStyle="white",e.textAlign="start",e.textBaseline="alphabetic",this.ctx=e,this.canvas=t},e.prototype.setBuckets=function(t){this.buckets=t},e.prototype.clear=function(){},e.prototype.setBackgroundColor=function(t){this.buckets.bgColor(t)},e.prototype.grid=function(t){this.debug=t},e.prototype.setScale=function(t,e,n){this.s=t,this.sx=e,this.sy=n},e.prototype.setRotation=function(t,e){this.rz=t},e.prototype.prepare=function(t,e,n,i,r,o){return this.painter.spawn(3,i,e,n,r,t,o)},e.prototype.tile=function(t,e,n){this.ctx.drawImage(t.combine(),e,n,256,256),this.debug&&this.drawGrid(e,n,t.quadkey)},e.prototype.preview=function(t,e,n,i){var r=t.getContext(i);r.clearRect(0,0,t.size,t.size);for(var o=0,a=e.length;o<a;o++){var s=e[o],l=this.buckets.get(s[0],!0),u=void 0;l&&(u=l.getData(i))&&(r.setTransform(1,0,0,1,0,0),r.drawImage(u,s[1],s[2],s[3],s[4],0+s[5],0+s[6],s[7],s[8]),t.dirty(i))}},e}(),nt=function(t){function e(e,n,i,r,o){var a=t.call(this)||this,s=i.length;return a.c=new Array(s),a.init(n,i,r),a.bPool=e,a.ctx=e.claimCtx(r),a.canvas=a.ctx.canvas,a.ctx.fillStyle=o,a}return y(e,t),e.prototype.destroy=function(t){if(null!=t)(e=this.c[t])&&(e.canvas&&this.bPool.releaseCtx(e),this.c[t]=void 0);else for(var e,n=this.c.length;n--;)(e=this.c[n])&&e.canvas&&(this.bPool.releaseCtx(e),this.c[n]=void 0)},e.prototype.init=function(e,n,i){t.prototype.init.call(this,e,n,i);var r=n.length;for(this.c.length=r;r--;)this.c[r]=void 0;this._c=!1,this._ready=!1},e.prototype.dirty=function(t,e){var n=this.c[t],i=e!=n;e&&n&&i&&this.destroy(t),e||(i=!0,e=this.c[t]),i&&(this.c[t]=e,this._c=!1)},e.prototype.clear=function(t){var e;(e=this.c[t])&&(e.setTransform&&this.bPool.releaseCtx(e),this.c[t]=void 0,this.preview(t,void 0),this.ready(t,!1),this._c=!1,this.combine())},e.prototype.getContext=function(t){return this.c[t]||(this.c[t]=this.bPool.claimCtx(this.size)),this.c[t]},e.prototype.getData=function(t){return this.c[t]&&(this.c[t].canvas||this.c[t])},e.prototype.combine=function(){var t,e=this,n=e.size;if(!e._c){e._c=!0,e.ctx.fillRect(0,0,n,n);for(var i=0;i<e.c.length;i++)(t=this.getData(i))&&e.ctx.drawImage(t,0,0,n,n)}return e.canvas},e.prototype.addLayer=function(e){t.prototype.addLayer.call(this,e);this.c.splice(e,0,void 0),this._c=!1,this._ready=!1},e.prototype.removeLayer=function(e){t.prototype.removeLayer.call(this,e);this.destroy(e),this.c.splice(e,1),this._c=!1},e}(function(){function t(){this.r=[],this.p=[]}return t.prototype.init=function(t,e,n){this.luTs=null,this.quadkey=t,this.size=n,this.layers=e,this.tasks={},this.r.length=0,this.p.length=0},t.prototype.busy=function(t){var e=t.id;for(var n in this.tasks)if(e==this.tasks[n]._lid)return!0},t.prototype.addTask=function(t,e){t._lid=e.id,this.tasks[t.id]=t},t.prototype.cancelTasks=function(t){var e,n=this.tasks;for(var i in n)e=n[i],t&&t.id!=e._lid||(e.cancel(),delete n[i])},t.prototype.removeTask=function(t,e){delete this.tasks[t.id]},t.prototype.index=function(t){return this.layers.indexOf(t)},t.prototype.ready=function(t,e){return 2==arguments.length&&(this.r[t]=e,e&&(this.luTs=Date.now())),this.r[t]},t.prototype.addLayer=function(t){this.r.splice(t,0,!1),this.p.splice(t,0,void 0)},t.prototype.removeLayer=function(t){this.r.splice(t,1),this.p.splice(t,1)},t.prototype.preview=function(t,e){return 2==arguments.length&&(this.p[t]=e),this.p[t]},t}()),it=[],rt={length:0,max:128,clear:function(){this.length=0},create:function(t){var e=document.createElement("canvas");return e.width=e.height=t,this.length++,e.getContext("2d")},get:function(t){return it.length?(this.length++,it.shift()):this.create(t)},release:function(t){t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.lineWidth=1,t.globalAlpha=1,it.push(t),this.length--},makeSpace:null},ot=function(){function t(t){this.tiles=new e(t)}return t.prototype.get=function(t,e){return e?this.tiles._[t]&&this.tiles._[t].data:this.tiles.get(t)},t.prototype.forEach=function(t){return this.tiles.toArray().forEach(t)},t}(),at=256,st=function(t){function e(e,n){var i=t.call(this,e||at)||this;return i.ctxCache=rt,i._bgc=null,i.tSize=n,i}return y(e,t),e.prototype.bgColor=function(t){this._bgc=t,this.forEach(function(e){e.ctx.fillStyle=t})},e.prototype.clear=function(){this.tiles.clear(),rt.clear()},e.prototype.setSize=function(t){this.tiles.setSize(t)},e.prototype.releaseCtx=function(t){return rt.release(t)},e.prototype.claimCtx=function(t){if(rt.length<rt.max)return rt.get(t);var e=this.tiles.tail.data;return e.destroy(),rt.release(e.ctx),e.ctx=null,e.canvas=null,this.tiles.remove(e.quadkey),e.cancelTasks(),this.claimCtx(t)},e.prototype.create=function(t,e){var n=this.tiles.get(t);return n||(this.tiles.length>=this.tiles.max?((n=this.tiles.tail.data).destroy(),n.init(t,e,this.tSize)):n=new nt(this,t,e,this.tSize,this._bgc),this.tiles.set(t,n)),n},e}(ot),lt=function(){return function(t){this.ready=!1,this.cnt=0,this.layer=t}}(),ut=function(t){function e(){for(var n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];var r=t.apply(this,n)||this;return r.map={},Object.setPrototypeOf(r,e.prototype),r}return y(e,t),e.prototype.indexOf=function(e){var n=this.map[e.id];return t.prototype.indexOf.call(this,n)},e.prototype.add=function(t,e){var n,i=t.id,r=this.map[i];return r?(this.splice(this.indexOf(r),1),this.splice(e,0,r),n=!1):(r=this.map[i]=new lt(t),this.splice(e,0,r),n=!0),n},e.prototype.remove=function(t){var e=this.indexOf(t);return-1!==e&&(this.splice(e,1),delete this.map[t.id]),e},e.prototype.get=function(t){return this.map[t]},e}(Array),ct=function(){function t(t,e){this.display=t,this.render=e}return t.prototype.forEachTile=function(t,e){t._provider.getCachedTilesOfBBox(t.getBBox()).forEach(e)},t.prototype.remove=function(t,e,n){for(var i=0;i<e.length;i++)this.removeFromTile(t,e[i],n)},t.prototype.modifyInTile=function(t,e,n,i){var r=this.isVertexDataInitialized(e);return!!r&&(this.display.updateTile(e,r,i,t),!0)},t.prototype.isVertexDataInitialized=function(t){return this.display.getBucket(t.quadkey)},t.prototype.addToTile=function(t,e,n){var i=this.isVertexDataInitialized(e);i&&this.display.updateTile(e,i,n,t)},t.prototype.removeFromTile=function(t,e,n){var i=this.isVertexDataInitialized(e);i&&this.display.updateTile(e,i,n,t)},t.prototype.add=function(t,e,n){if(e)for(var i=0;i<e.length;i++)this.addToTile(t,e[i],n)},t.prototype.updateGeometry=function(t,e,n,i){for(var r=i.getProvider(),o=r.getCachedTilesOfBBox(e),a=r.getCachedTilesOfBBox(t.getBBox()),s=0,l=a.length;s<l;s++){var u=o.indexOf(a[s]);-1===u?this.addToTile(t,a[s],i):(this.modifyInTile(t,a[s],n,i),o.splice(u,1))}for(s=0,l=o.length;s<l;s++)this.removeFromTile(t,o[s],i),this.removeFromTile(t,o[s],i)},t.prototype.repaint=function(t,e,n){var i=this;i.forEachTile(t,function(e){var r=i.isVertexDataInitialized(e);r?i.display.updateTile(e,r,n,t):e.preview&&(e.preview=void 0)})},t.prototype.clear=function(t,e){e=e||[];var n=this.display,i=n.layers.indexOf(t);n.buckets.forEach(function(n){e.length&&!function(t,e){for(var n,i,r=t.length,o=0;o<e.length;o++)if(i=t,n=e[o],r>e[o].length&&(n=i,i=e[o]),0===n.search(i))return!0}(n.quadkey,e)||(n.clear(i),n.ready(i,!1),n.cancelTasks(t),n.luTs=null)}),n.update()},t}(),ht=a.Utils,pt=[],ft=function(){function t(t,e){this.display=t,"number"==typeof e?(this.down=e,this.up=e):(this.down=e[0],this.up=e[1])}return t.prototype.lookUp=function(t,e,n,i,r){var o,a,s,l=t.quadkey,u=t.size,c=e-n;if(o=Number(l[c]),r.x+=o%2*u/2,r.y+=Number(o>1)*u/2,s=l.substring(0,c),this.hasData(s,i)){var h=u/Math.pow(2,n);return a=[],this.add(a,s,r.x,r.y,h,0,0,u),a}r.x/=2,r.y/=2},t.prototype.add=function(t,e,n,i,r,o,a,s){t.push([e,n,i,r,r,0^o,0^a,s,s])},t.prototype.hasData=function(t,e){var n=this.display.buckets.get(t,!0);if(n)return n.ready(e)&&n.getData(e)},t.prototype.lookDown=function(t,e,n,i){var r,o,a,s,l,u,c=t.size,h=e+n;r=ht.getTilesOfLevel(t.quadkey,h);for(var p=0;p<r.length;p++){o=a=0,s=c;for(var f=0;f<n;f++)s/=2,o+=(l=r[p][e+f])%2*s,a+=Number(l>1)*s,f==n-1&&this.hasData(r[p],i)&&(u=u||[],this.add(u,r[p],0,0,c,o,a,s))}return u},t.prototype.create=function(t,e,n,i){var r,o=t.quadkey.length,a=e.min,s=e.max,l=s-o,u=o-a,c={x:0,y:0},h=0;n=n||this.down,(i=i||this.up)>u&&(i=u),n>l&&(n=l);for(var p=i>n?i:n,f=t.index(e);h++<p;){if(o-h>=a&&(r=this.lookUp(t,o,h,f,c)))return r;if(o+h<=s&&h<n&&(r=this.lookDown(t,o,h,f)))return r}return pt},t}(),dt=M,vt=function(){return 1},yt=function(){function t(t,e){this.tm=t,this.ms=e}return t.prototype.exclusiveRuntime=function(t){this.ms=t},t.prototype.spawn=function(t,e,n,i,r,o,a){var s=this.createTask(t,e,n,i,r,o);return this.tm.start(s,a),s},t.prototype.createTask=function(t,e,n,i,r,o){var a=[],s=this.ms,l=this.tm.create({time:s,priority:t,init:function(){if(i){for(var t=i.length,o=Date.now();t--;)i[t];l.time=s-(Date.now()-o)}return[n,i,r,0,a,300,e,{}]},name:"cluster",onDone:function(){var t=e.getStyle(),i=t&&(t.strokeWidthZoomScale||t.LineStringZoomScale)||vt;a.swzs=i(n.z),o(a,this)},exec:function(t){var e,n,i,r,o,a,s,l,u,c,h,p,f,d,v,y,g,m,x,w=t[0],L=t[1],M=t[2],b=t[6],T=L.length,C=t[4],S=w.z;if(L&&!(t[3]>=T)){for(;t[5]--&&(o=L[t[3]++]);)if(!M[a=o.id]&&(M[a]=!0,i=b.getStyleGroup(o,S))){i.length||(i=[i]);for(var D=0,N=i.length;D<N;D++)r=i[D],k(r)&&(e=z("zIndex",r,o,S),s=z("type",r,o,S),v=z("opacity",r,o,S),p=void 0,h=void 0,f=void 0,d=void 0,m=void 0,y=void 0,g=void 0,void 0,x=void 0,void 0,"Image"==s?n="I":(h=z("fill",r,o,S),f=z("stroke",r,o,S),d=z("strokeWidth",r,o,S),n="Line"==s?"L"+((y=z("strokeLinecap",r,o,S))||"*")+((g=z("strokeLinejoin",r,o,S))||"*")+((m=z("strokeDasharray",r,o,S))||"*"):"Text"==s?"T"+((p=z("font",r,o,S)||dt)||"*"):"Circle"==s?"C"+z("radius",r,o,S)||"*":"R"+(x=z("width",r,o,S))+(z("height",r,o,S)||x),n+=(f||"*")+(d||"*")+(h||"*")),null!=v&&(n+=100*v^0),null==(c=(l=C[e]=C[e]||[])[n])?(c=l[n]=l.length,u=l[c]={shared:{font:p,fill:h,opacity:v,stroke:f,strokeWidth:d,strokeLinecap:y,strokeLinejoin:g,strokeDasharray:m},features:[],styles:[]}):u=l[c],u.features.push(o),u.styles.push(r))}return t[5]=300,t[3]<T}}});return l},t}();function gt(t,e,n){if(e[t+="EventListener"])for(var i in n)e[t](i,n[i])}var mt,xt=4,wt=function(){function e(n,i,r,o,a,s){this.updating=!1,this.dirty=!1,this.globalBgc=!1;var l=this,u=f(n,"width"),c=f(n,"height"),h=d(n,u,c,0);this.previewer=new ft(l,s),this.cluster=new yt(t.getInstance(),xt),h.className="tmc",l.render=a,l.tileSize=i,l.buckets=o,l.layers=new ut,l.w=u,l.h=c,l.canvas=h,l.dpr=e.getPixelRatio(r),l.setSize(u,c),l.setBGColor();var p=new ct(l,a);l.listeners={clear:p.clear.bind(p),featureAdd:p.add.bind(p),featureRemove:p.remove.bind(p),featureCoordinatesChange:p.updateGeometry.bind(p),styleGroupChange:p.repaint.bind(p),styleChange:function(t,e){l.setLayerBgColor(e)}}}return e.getPixelRatio=function(t){return 0^((t="auto"==t?Math.min(2,n.devicePixelRatio||1):t||1)<1?1:t)},e.prototype.addLayer=function(t,e,n){var i=!1;return this.layers.add(t,n)&&(gt("add",t,this.listeners),0==n&&this.setLayerBgColor(t),this.buckets.forEach(function(t){t.addLayer(n)}),i=!0),i},e.prototype.removeLayer=function(t){var e=this.layers.remove(t);return-1!==e&&(this.buckets.forEach(function(n){n.cancelTasks(t),n.removeLayer(e)}),gt("remove",t,this.listeners)),e},e.prototype.getBucket=function(t,e){return e?this.buckets.create(t,this.layers):this.buckets.get(t)},e.prototype.handleTile=function(t,e,n,i){var r,o=this,a=!1;if(n?a=!0:n=o.getBucket(t.quadkey,!0),null==i&&(i=o.layers.indexOf(e)),t.error&&(o.layers[i].error=!0),!n.ready(i)&&!n.busy(e)&&(r=t.data)){var s=function(e,n){t.isLoaded()&&e.ready(e.index(n),!0),o.update(a)};n.ready(i,!1),e.render?e.render(t,r,e,n,s):o.prepareTile(t,r,e,n,s)}},e.prototype.setLayerBgColor=function(t){var e=t.getStyle().backgroundColor;!this.globalBgc&&e&&this.render.setBackgroundColor(e)},e.prototype.isVisible=function(t){for(var e=t.quadkey,n=this.quads,i=0;i<n.length;i++)if(n[i][0]==e)return!0;return!1},e.prototype.updateTile=function(t,e,n,i){if(e&&!e.busy(n)){var r=e.index(n);e.ready(r,!1),this.isVisible(t)&&this.handleTile(t,n,e,r)}},e.prototype.setSize=function(t,e){var n=this.dpr,i=this.canvas;this.w=t,this.h=e,i.width=t*n,i.height=e*n,i.style.width=t+"px",i.style.height=e+"px"},e.prototype.cancel=function(t,e){var n=this.buckets.get(t,!0);n&&n.cancelTasks(e)},e.prototype.preview=function(t,e,n){var i=this.previewer.create(t,e);return t.preview(n,i),i},e.prototype.initViewport=function(t,e,n){var i,r=this.layers,o=r.length;this.dirty=!0;for(var a,s,l=0;l<o;l++){s=(a=r[l]).layer,a.error=!1,a.ready=!1,a.cnt=0,a.visible=n>=s.min&&n<=s.max;for(var u=0,c=void 0,h=void 0;u<t.length;u++)c=t[u][0],h=this.getBucket(c,!0),t[u][3]=!0,i=h.ready(l),a.visible?i||h.preview(l)||this.preview(h,s,l):h.ready(l,!0)}this.quads=t},e.prototype.viewport=function(t){var e,n,i,r,o=this.quads,a=this.render,s=o.length,l=this.layers,u=l.length,c=this.buckets,h=0;for((this.dirty||t)&&(this.render.clear(),this.dirty=!1);h<s;){if(n=o[h],(e=this.getBucket(n[0]))&&(i=n[1],r=n[2],n[3]!=e.luTs||t)){n[3]=e.luTs,a.tile(e,i,r,c);for(var p,f=0;f<u;f++)!(p=l[f]).ready&&e.ready(f)&&++p.cnt==s&&(p.ready=!0)}h++}},e.prototype.update=function(t){var e=this;e.updating||(e.updating=!0,requestAnimationFrame(function(){e.viewport(t),e.updating=!1}))},e.prototype.setBGColor=function(t){t&&(this.globalBgc=!0),"rgba(0, 0, 0, 0)"!=(t=t||n.getComputedStyle(this.canvas.parentElement,null).getPropertyValue("background-color"))&&"transparent"!=t||(t="#ffffff"),this.render.setBackgroundColor(t)},e.prototype.showGrid=function(t){this.render.grid(!!t)},e.prototype.setTransform=function(t,e,n){this.render.setScale(this.s=t,0,0),this.render.setRotation(this.rz=e,this.rx=n),this.render.applyTransform()},e.prototype.getLayers=function(){return this.layers},e.prototype.destroy=function(){var t=this.canvas;t.parentElement.removeChild(t)},e.prototype.clearLayer=function(t){var e=this.getLayers().indexOf(t);this.buckets.forEach(function(t){t.preview(e,!1),t.ready(e,!1)})},e}(),Lt={1:[512,3,512],2:[128,2,128],3:[64,1,128]},Mt=256,bt=function(t,e,n,i,r){var o=Math.sin(r),a=Math.cos(r),s=t-n,l=e-i;return[a*s-o*l+n,o*s+a*l+i]},Tt=function(t){function e(e,n,i){var r;n=n||Mt,i=wt.getPixelRatio(i);var o=Lt[i][1],a=new et(n*i,i),s=Lt[i][0],l=new st(s,n*i);return a.setBuckets(l),r=t.call(this,e,n,i,l,a,o)||this,a.init(r.canvas),r}return y(e,t),e.prototype.preview=function(e,n,i){var r=t.prototype.preview.call(this,e,n,i);return r&&this.render.preview(e,r,n,i),r},e.prototype.prepareTile=function(t,e,n,i,r){var o=this,a=o.render;if("image"==t.type){var s=i.index(n);i.dirty(s,e),r(i,n)}else if(e.length)i.addTask(o.cluster.spawn(4,n,t,e,{},function(e,s){i.removeTask(s,n),null==i&&(i=void 0),i.addTask(a.prepare(e,t,n,o,i,function(t,e){i.removeTask(e,n),r(i,n)}),n)}),n);else{s=i.index(n);i.destroy(s),i.dirty(s),r(i,n)}},e.prototype.addLayer=function(e,n,i){var r=t.prototype.addLayer.call(this,e,n,i);return r&&this.setupTilePool(),r},e.prototype.removeLayer=function(e){var n=t.prototype.removeLayer.call(this,e);return-1!==n&&this.setupTilePool(),n},e.prototype.setSize=function(e,n){t.prototype.setSize.call(this,e,n),this.setupTilePool(),this.render._s=void 0,this.setTransform(this.s,this.rz,this.rx)},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.buckets.clear()},e.prototype.setupTilePool=function(){var t=(Math.ceil(this.w/Mt)+1)*(Math.ceil(this.h/Mt)+1),e=t,n=Lt[this.dpr],i=t*this.getLayers().length;e<n[0]&&(e=n[0]),this.buckets.setSize(e),i<n[2]&&(i=n[2]),this.buckets.ctxCache.max=i},e.prototype.update=function(e){t.prototype.update.call(this)},e.prototype.project=function(t,e,n,i){var r=this.s;return bt(t*=r,e*=r,this.w/2,this.h/2,this.rz)},e.prototype.unproject=function(t,e){var n=this.s,i=this.w/2,r=this.h/2,o=bt(t,e,i,r,-this.rz);return o[0]=(o[0]-i)/n+i,o[1]=(o[1]-r)/n+r,o},e}(wt);function zt(t,e,n,i,r){var o=!1,a=0^r.zoomAnimationMs;function s(e){var n,i,r=e.targetTouches;if(r){var o=r.length,a=r[o-1],s=void 0;if(o){var l=t.getBoundingClientRect(),u=a.pageX-l.left,c=a.pageY-l.top;o>1?(n=(u+(s=r[o-2]).pageX-l.left)/2,i=(c+s.pageY-l.top)/2):(n=u,i=c)}}else n=e.clientX,i=e.clientY;return[0^n,0^i]}function l(t,e,n,i){return Math.sqrt(Math.pow(t-n,2)+Math.pow(e-i,2))}var u=null;function c(t){var e=1;if(t.scale!=mt)return t.scale;var n=t.targetTouches,i=n.length,r=n[i-1],o=n[i-2];if(o){var a=l(r.clientX,r.clientY,o.clientX,o.clientY);null==u&&(u=a),e=a/u}return e}var f,d,v,y,g,m,x,w,L,M=8;function b(t){for(var e=0,n=t.length;n--;e+=t[n]);return e}var T,z;function C(t,o){if(!g){var a=r.minPanMapThreshold;if(Math.abs(t-f)<a&&Math.abs(o-d)<a)return!0;n.cancel()}if(m=Date.now(),i.drag&&!e.lockViewport().pan){var s=t-v,l=o-y;L<M?(x[L]=s,w[L]=l,L++):L=0,e.pan(s,l),g=!0}v=t,y=o}function S(t){if(g){var e=Date.now();e-m<25&&n.pan(e,3*b(x),3*b(w))}}function k(t){s(t),L=0,x=[],w=[]}function D(t){k(t);var n=t.targetTouches,i=n.length,r=s(t);if(v=r[0],y=r[1],f=v,d=y,c(t),g=!1,2==i){var o=n[i-1],a=n[i-2];u=l(o.clientX,o.clientY,a.clientX,a.clientY),z=e.getZoomlevel(),T=e.rotate(),function(t){if(t.rotation!=mt)return t.rotation;var e=t.targetTouches,n=e.length,i=e[n-1],r=e[n-2];if(r){var o=r.clientX-i.clientX,a=r.clientY-i.clientY;return 180*Math.atan2(a,o)/Math.PI}}(t)}}function N(t){var e=s(t),n=c(t);C(e[0],e[1]),t.targetTouches.length>1&&(R(z+Math.log2(n),e[0],e[1],!1),n),v=e[0],y=e[1],t.preventDefault()}var I=Date.now();function j(t){var e=s(t),n=t.targetTouches.length;e&&(v=e[0],y=e[1],f=v,d=y),n<2&&(u=null);var i=Date.now(),r=i-I;n&&(I=i),c(t),0==n&&1==t.changedTouches.length&&r>350&&S()}var E=null;function P(n){E=n.button,k(n),g=!1,h(t,"mousemove",A),T=e.rotate(),v=n.clientX,y=n.clientY,f=v,d=y}function A(t){0==E?C(t.clientX,t.clientY):2==E&&o&&e.rotate(T+.7*(v-t.clientX))}function O(e){E=null,p(t,"mousemove",A),g&&S()}function R(t,n,i,r){var o=e.lockViewport();if(t>=o.minLevel&&t<=o.maxLevel){var s=r&&a;e.setZoomlevel(t,n,i,s,r)}}function B(n,r){if(i.zoom)if((n=n||WIN.event).shiftKey){if(r=n.wheelDelta?n.wheelDelta/120:(-n.detail||0)/3){var o=t.getBoundingClientRect();e.setZoomlevel(e.getZoomlevel()+(r>0?.1:-.1),n.pageX-o.left,n.pageY-o.top)}}else!function(n,i){if(i=(n=n||WIN.event).wheelDelta?-n.wheelDelta/120:(n.detail||0)/3){var r=Math.round(e.getZoomlevel()+(i<0?1:-1)),o=t.getBoundingClientRect();R(r,n.pageX-o.left,n.pageY-o.top,!0)}n.preventDefault&&n.preventDefault(),n.returnValue=!1}(n,r)}function _(){e.resize(t.offsetWidth,t.offsetHeight)}this.rotate=function(t){o=!!t},this.drag=function(e){var n=e?h:p;setTimeout(function(){n(t,"touchstart",D),n(window,"touchend",j),n(t,"touchmove",N),n(t,"mousedown",P),n(window,"mouseup",O)},0)},this.scroll=function(e){(e?h:p)(t,["mousewheel","DOMMouseScroll"],B)},this.resize=function(t){(t?h:p)(window,"resize",_)}}var Ct;function St(t,e){this.type=t,this.timeStamp=Date.now(),e!=Ct&&(this.data=this.detail=e)}var kt=St.prototype;kt.nativeEvent=null,kt.detail=null,kt.data=null,kt.target=null,kt.mapX=null,kt.mapY=null,kt.type=null,kt.button=null,kt.timeStamp=null,kt.toString=function(){return"TigerEvent "+this.type},kt.stopPropagation=function(){var t=this.nativeEvent;if(t._stopPropagation=!0,"mousemove"==t.type||"touchmove"==t.type)return t.stopImmediatePropagation(),t.preventDefault()};var Dt=250;function Nt(e,n,r,o){var a,s,l=!1,u=!1,c=new i("click");c.sync(!0);var f,d="pointerup",v="pointerenter",y="pointerleave",g="pointerdown",m="pointermove",x="pressmove",w="tap",L="dbltap",M=[d,v,y,g,m,x,w,L],b={};function T(t){return-1!==M.indexOf(t)}function z(t){f=n.getCenter(),u=!0,l=!1,a=I(t),s=R(a),E(g,t,a,s),"touchstart"==t.type&&t.target.parentNode==e&&t.preventDefault()}function C(t){var e,n,i;if(u){var r=o.minPanMapThreshold;if(!l&&(n=(e=I(t))[0]-a[0],i=e[1]-a[1],Math.abs(n)<r&&Math.abs(i)<r))return}l=!0,u?s&&c.isListened(x)&&(n=(e=I(t))[0]-a[0],i=e[1]-a[1],c.trigger(x,[j(x,t,e[0],e[1],s),n,i],!1)):"touchmove"!=t.type&&(c.isListened(v)||c.isListened(y)||c.isListened(m))&&(P=t,b.pointerenter||b.pointerleave||A||(A=!0,O.start()))}function S(t){if(u){var i=n.getCenter();if(!(f.longitude!=i.longitude||f.latitude!=i.latitude)&&t.target.parentNode==e&&(s||!l)){var r=I(t);E(w,t,r,s),E(d,t,r,s),function(t){var e=Date.now(),n=s&&s.feature;e-N<Dt&&!l&&k==n&&E(L,t,a,s);k=n,N=e}(t)}u=l=!1}}M.forEach(function(t){c.addEvent(t),b[t]=!1});var k,D,N=0;function I(t){var n=t.type;"touchstart"!=n&&"touchmove"!=n&&"touchend"!=n||(t=t.changedTouches[t.changedTouches.length-1]);var i=e.getBoundingClientRect();return[t.pageX-i.left,t.pageY-i.top]}function j(t,e,i,r,o){var a=new St(t,o);return a.mapX=i,a.mapY=r,a.nativeEvent=e,o&&(a.target=o.feature,a.detail.display=n),a.button=e.button,a}function E(t,e,n,i){c.trigger(t,[j(t,e,n[0],n[1],i)],!1)}var P,A=!1,O=t.getInstance().create({delay:40,prority:5,exec:function(){!function(t){var e=I(t),n=R(e);E(m,t,e,n),n?D?D.feature.id!==n.feature.id&&(E(y,t,e,D),E(v,t,e,n)):E(v,t,e,n):D&&E(y,t,e,D);D=n}(P),A=!1}});function R(t){return n.getFeatureAt({x:t[0],y:t[1]},{layers:n.layers.filter(function(t){return t.pointerEvents()})})}var B=0,_=!1;function Z(){return{touchstart:z,touchmove:C,touchend:S,mousedown:z,mouseup:S,mousemove:C}}this.enable=function(t){T(t)&&delete b[t]},this.disable=function(t){T(t)&&(b[t]=!0)},this.destroy=function(){var t=Z();if(_){for(var n in t)p(e,n,t[n]);_=!1}},this.addEventListener=function(t,n,i){if(T(t)&&c.add(t,n,i)){B++;var r=Z(),o=void 0;if(!_)for(var t in r){o=r[t];var a=e;if("mouseup"==t)for(;a.parentNode;)a=a.parentNode;h(a,t,o),_=!0}}},this.removeEventListener=function(t,n,i){if(T(t)&&c.remove(t,n,i)&&!--B&&_){var r=Z();for(var t in r)c.isListened(t)||p(e,t,r[t]);_=!1}}}var It=function(t,e,n,i,r,o){var a,s,l,u,c=r-n,h=o-i,p=c*c+h*h,f=-1;return 0!=p&&(f=((t-n)*c+(e-i)*h)/p),f<0?(a=n,s=i):f>1?(a=r,s=o):(a=n+f*c,s=i+f*h),l=t-a,u=e-s,Math.sqrt(l*l+u*u)},jt=function(){function t(t){this.map=t}return t.prototype.feature=function(t,e,n,i,r){return this.geometry(t,e,n.getProvider().decCoord(n),n.geometry.type,i,n,r)},t.prototype.geometry=function(t,e,n,i,r,o,a,s){var l,u,c,h,p,f=!1,d=this.map;if("Point"==i){if(s=s||S(r,o,a)){var v=d.geoToPixel(n[0],n[1]),y=Math.round(v.x+s[0]),g=Math.round(v.y+s[1]),m=Math.round(v.x+s[2]),x=Math.round(v.y+s[3]);u=e,c=m,h=g,p=x,f=(l=t)>=y&&l<=c&&u>=h&&u<=p}}else if("LineString"==i){for(var w=(s=s||C(r,o,a))[0],L=n.length,M=1/0,b=d.geoToPixel(n[0][0],n[0][1]),T=void 0,z=void 0,k=1;k<L;k++)T=d.geoToPixel(n[k][0],n[k][1]),(z=It(t,e,b.x,b.y,T.x,T.y))<M&&(M=z),b=T;f=M<=w/2}else if("Polygon"==i){var N=n[0],I=d.pixelToGeo(t,e);(f=function(t,e,n){for(var i,r,o,a,s=!1,l=0,u=n.length-1;l<n.length;u=l++)i=n[l][0],o=n[l][1],r=n[u][0],o>e!=(a=n[u][1])>e&&t<(r-i)*(e-o)/(a-o)+i&&(s=!s);return s}(I.longitude,I.latitude,N))&&(s=s||[D(r,o,a)])}else{var j=void 0;if("MultiPolygon"==i?(j="Polygon",s=[D(r,o,a)]):"MultiPoint"==i?(j="Point",s=S(r,o,a)):"MultiLineString"==i&&(j="LineString",s=C(r,o,a)),j)for(var E=0,P=n.length;E<P;E++)if(this.geometry(t,e,n[E],j,r,o,a,s)){f=!0;break}}return f&&s},t}(),Et=32;function Pt(t){return"number"==typeof t}function At(t){var e=new jt(t);this.search=function(n,i,r,o,a,s){var l=t.getZoomlevel(),u=t.layers;if(a=a?a instanceof Array?a.slice().sort(function(t,e){return u.indexOf(t)>u.indexOf(e)}):[a]:u,Pt(n)&&Pt(i)&&Pt(r)&&Pt(o)){return function(n,i,r,o,a,s,l){for(var u,c,h,p,f,d,v,y,g=n+(r-n)/2,m=i+(o-i)/2,x=180,w=-180,L=180,M=-180,b=[t.pixelToGeo(n,i),t.pixelToGeo(r,i),t.pixelToGeo(r,o),t.pixelToGeo(n,o)],T=4,z=[];T--;){var C=b[T].longitude,S=b[T].latitude;C<x&&(x=C),C>w&&(w=C),S<L&&(L=S),S>M&&(M=S)}u=[x,L,w,M];for(var k=a.length;k--;){c=(h=a[k]).getProvider(s);var D=[],N=0;if(s<=h.max&&s>=h.min&&c.search){d=(f=c.search(u))&&f.length;for(var I={};p=f[--d];)if((v=h.getStyleGroup(p,s))&&(y=e.feature(g,m,p,v,s))){var j=y.pop();j>N&&(N=j),I[j]?l||I[j].push(p):I[j]=[p]}if(l&&I[N])return[{layer:h,features:I[N]}];for(var E in I)D=D.concat(I[E]);D.length&&z.push({layer:h,features:D})}}return z.reverse()}(n-Et,i-Et,r+Et,o+Et,a,l,s)}}}var Ot="mapviewchange",Rt=Ot+"start",Bt=Ot+"end",_t=1e3/30,Zt=100;function Yt(t){if("function"==typeof Event)var e=new Event(t);else(e=document.createEvent("Event")).initEvent(t,!0,!0);return e}var Wt,qt=!0;function Xt(t,e,n){var i,r,o,a,s,l,u=null;function c(){if(l){l=!1;var i=t.getCenter();e(Bt,{changed:{center:i.longitude!=o.longitude||i.latitude!=o.latitude}},qt)}for(var r,u,h,p=n.getLayers(),f=!0,d=0;d<p.length;d++)if(h=(r=(u=p[d]).layer).id,u.ready){if(!a[h]&&(a[h]=!0,!u.error)){var v=Yt("viewportReady");v.detail=v.data={map:t,layer:r},r._l.trigger("viewportReady",[v],!0)}}else f=!1;f||(s=setTimeout(c,Zt))}function h(){var n,h,p,f,d,v=t.getViewBounds(),y=t.getCenter(),g=t.rotate(),m=Ot,x={changed:{center:!0}};if(i){if(x.changed.center=y.longitude!=o.longitude||y.latitude!=o.latitude,h=r,p=v,f=g,d=!0,(n=i).minLon==p.minLon&&n.maxLon==p.maxLon&&n.minLat==p.minLat&&n.maxLat==p.maxLat&&h==f||(d=!1),d)return clearInterval(u),u=i=r=null,s&&clearTimeout(s),s=setTimeout(c,Zt);i=v,r=g,o=y}else a={},m=Rt,i=v,r=g,o=y,l=!0;e(m,x,qt)}this.watch=function(t){s&&(clearTimeout(s),s=null),t?u||(u=setInterval(h,_t)):u&&(clearInterval(u),u=null)}}var Gt=function(){function t(t,e,n){this._v=!0;this.display=n,this.cPrefix=t.className+"-ui-",this.parent=t,this.opt=e,e.visible&&(this.create(t,e),this.enable())}return t.prototype.show=function(){this.html||this.create(this.parent,this.opt),this.html.style.display="inline"},t.prototype.hide=function(){var t=this.html;t&&(t.style.display="none")},t.prototype.enable=function(){this.toggleListeners(!0)},t.prototype.disable=function(){this.toggleListeners(!1)},t.prototype.toggleListeners=function(t){var e=this,n=e.listeners,i=(t?"add":"remove")+"EventListener";for(var r in n){var o=e.querySelectorAll(r);for(var a in n[r])o.forEach(function(t){t[i](a,n[r][a].bind(e))})}},t.prototype.insertRule=function(t,e){var n,i=(Wt=Wt||(n=document.createElement("style"),document.head.appendChild(n),n)).sheet;i.insertRule?i.insertRule(t+" {"+e+"}",i.cssRules.length):i.addRule&&i.addRule(t,e)},t.prototype.create=function(t,e){var n=this.templ.replace(/class\=\"/g,'class="'+this.cPrefix);n=n.replace(/\>[\s]+\</g,"><");var i,r=(i=n,(new DOMParser).parseFromString(i,"text/html").body.childNodes[0]),o=r.style,a=e.position,s="."+t.className+" ";for(var l in a)o[l]=a[l];if(this.style)for(var u in this.style)this.insertRule(s+this.prefixClass(u),this.style[u]);this.html=t.appendChild(r)},t.prototype.prefixClass=function(t){return t=t.replace(/\./g,"."+this.cPrefix)},t.prototype.querySelector=function(t){return this.html.querySelector(this.prefixClass(t))},t.prototype.querySelectorAll=function(t){return this.html.querySelectorAll(this.prefixClass(t))},t}(),Vt=function(t){function e(e,n,i,r){var o=t.call(this,e,n,i)||this,a=o;return r&&r.zoomAnimationMs&&(a.ams=r.zoomAnimationMs),o}return y(e,t),e.prototype.enable=function(){t.prototype.enable.call(this);var e=this.querySelector(".info"),n=this.display;e.innerText=n.getZoomlevel(),n.addEventListener("mapviewchangeend",this._zll=function(t){e.innerText=Math.round(100*n.getZoomlevel())/100})},e.prototype.disable=function(){t.prototype.disable.call(this),this.display.removeEventListener("mapviewchangeend",this._zll)},e}(Gt);Vt.prototype.listeners={".zoomBtn":{click:function(t){var e=0^t.srcElement.getAttribute("dir");this.display.setZoomlevel(this.display.getZoomlevel()+e,this.ams)}}},Vt.prototype.style={".zoomctrl":"        position: absolute;        right:  10px;        bottom: 20px;        text-align: center;        font-family: sans-serif;        color: white;        user-select: none;",".zoomctrl div":"        background-color: #0f1621;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;",".zoomctrl .zoomBtn":"        height: 28px;        font-size: 32px;        /* border: 1px solid white; */        line-height: 22px;        font-weight: 200;",".zoomctrl .zoomBtn:hover":"        background-color: #383c45;        cursor: pointer;"},Vt.prototype.templ='<div class="zoomctrl">         <div class="zoomBtn" dir="1">+</div>         <div class="info">L</div>        <div class="zoomBtn" dir="-1">-</div>     </div>';var Ut=function(t){function e(e,n,i){return t.call(this,e,n,i)||this}return y(e,t),e.prototype.add=function(t){!function(t,e,n,i){var r=document.createElement(t);e&&(r.className=e),n&&(r.innerText=n),i&&i.appendChild(r)}("div",this.prefixClass(".src").substr(1),"© "+t.label,this.html)},e.prototype.setData=function(t){if(this.data=t,this.html){this.html.innerText="";for(var e=0,n=t;e<n.length;e++){var i=n[e];this.add(i)}}},e}(Gt);Ut.prototype.style={".copyright-popup":"        user-select: none;        background-color: rgba(0,0,0,0.1);        position: absolute;        bottom: 15px;        padding: 2px;        right: 120px;        z-index: 1;        width:  auto;        color: #fff;        font-family: arial;        font-size: 11px;        opacity: 0.8;        height: auto;",".src":"        opacity: 0.8;        margin: 4px;    "},Ut.prototype.templ='<div class="copyright-popup"></div>';var Ft=n.document,Qt=function(t,e){var n,i,r,o=t.scopes,a=o.length;if(!a)return!0;for(;n=o[--a];){var s=n.layer.getProvider(e).level||e;if(i=n.minLevel||-1/0,r=n.maxLevel||1/0,s>=i&&s<=r)return!0}return!1},Ht=function(t,e){t.style.display=e?"inline":"none"},$t=function(t){function e(e,n,i){var o=t.call(this,e,n,i)||this;o.sources=new r,o.sLen=0,o.srcWidth=0;var a=o;return a.$src=a.querySelector(".sources"),a.$here=a.querySelector(".here"),a.$btn=a.querySelector(".btn"),o.details=new Ut(e,{visible:!1},i),o}return y(e,t),e.prototype.enable=function(){var e=this;t.prototype.enable.call(this),e.display.addObserver("zoomlevel",e.onZoomChange=function(t,n,i){n%1||(e.sources.forEach(function(t){Ht(t.el,Qt(t,n))}),e.showDetails(!1),e.handleOverflow())}),e.display.addEventListener("addLayer removeLayer",e.onLayerChange=function(t){var n=t.detail.layer;n.getCopyright(function(i){"addLayer"==t.type?i.forEach(function(t){return e.addSource(t,n)}):i.forEach(function(t){return e.removeSource(t,n)})})}),e.display.addEventListener("resize",e.onResize=function(){return e.handleOverflow()})},e.prototype.disable=function(){var e=this;t.prototype.disable.call(this),e.display.removeObserver("zoomlevel",e.onZoomChange),e.display.removeEventListener("addLayer removeLayer",e.onLayerChange),e.display.removeEventListener("resize",e.onResize)},e.prototype.calcWidth=function(){var t=0^this.display.getZoomlevel(),e=this.sources,n=0;return e.forEach(function(e){n+=Qt(e,t)&&e.width}),n},e.prototype.handleOverflow=function(){var t=this,e=t.$btn,n=t.display.getWidth(),i=t.calcWidth(),r=n-132^0;t.$src.style.width=(r<i?r-10:i)+"px",i>Math.min(r,384)?Ht(e,!0):(Ht(e,!1),t.showDetails(!1))},e.prototype.showDetails=function(t){var e=this.details,n=this.display.getZoomlevel();this.$btn.innerText=t?"-":"+",t?(e.show(),e.setData(this.sources.values().filter(function(t){return Qt(t,n)}))):e.hide()},e.prototype.addSource=function(t,e){var n,i=this,r=i.sources,o=t.label,a=t.scopes,s=0^i.display.getZoomlevel(),l=r.get(o);l?(n=l.el,l.cnt++):((n=Ft.createElement("span")).className=this.prefixClass(".source").substr(1),n.innerText="© "+o,i.$src.appendChild(n),l={label:o,scopes:[],el:n,cnt:1,width:n.getBoundingClientRect().width},r.set(o,l),i.sLen++,i.srcWidth+=l.width),null!=a&&a.forEach(function(t){return l.scopes.push({minLevel:t.minLevel,maxLevel:t.maxLevel,layer:e})}),Ht(i.$here,!1),Ht(n,Qt(l,s)),i.handleOverflow()},e.prototype.removeSource=function(t,e){var n,i,r=this,o=t.label,a=r.sources.get(o);if(a){if(i=a.scopes,n=t.scopes)for(var s=0,l=void 0;s<n.length;s++){l=n[s];for(var u=0,c=void 0;s<i.length;u++)if((c=i[u]).layer==e&&c.minLevel==l.minLevel&&c.maxLevel==l.maxLevel){i.splice(u,1);break}}--a.cnt||(r.$src.removeChild(a.el),r.sources.delete(o),r.handleOverflow(),--r.sLen||Ht(r.$here,!0))}},e}(Gt);$t.prototype.listeners={".btn":{click:function(t){var e="+"==this.$btn.innerText;this.showDetails(e)}}},$t.prototype.style={".copyright *":"        color: #fff;        font-family: arial;        opacity: 0.8;        text-decoration: none;",".copyright":"        right: 0px;        bottom: 0px;        padding: 1px 4px;        margin: 0px;        background-color: rgba(0,0,0,.1);        position: absolute;        font-size: 11px;        line-height: 13px;        overflow: hidden;        white-space: nowrap;        user-select: none;",".sources":"        width:auto;        max-width: 384px;        float: left;        white-space: nowrap;        overflow: hidden;        text-overflow: ellipsis;        border-right: 2px;",".btn":"        font-family: sans-serif;        font-weight: bold;        text-align: center;        height: 12px;        width: 12px;        float: left;        padding: 0px;        line-height: 9px;        margin: 1px 2px 0px;        background-color: inherit;        box-sizing: border-box;        border-radius: 3px;        border: 1px solid;",".divider, .here, .source":"        white-space: nowrap;        padding-right: 4px;"},$t.prototype.templ='<div class="copyright">        <span style="float: left; white-space: nowrap;">            <span class="sources"></span>            <span class="here">© 2019 HERE</span>         </span>        <span class="tac" style="float: right; white-space: nowrap;">            <span class="btn">+</span>            <span class="divider" style="white-space: nowrap;">|</span>            <a target="_blank" style="white-space: nowrap;" href="https://legal.here.com/us-en/terms/serviceterms/">Terms and Conditions</a>        </span>    </div>';var Jt=function(t){function e(e,n,i){return t.call(this,e,n,i)||this}return y(e,t),e}(Gt);Jt.prototype.style={".here-logo":"        position: absolute;        bottom: 4px;        left: 4px;        z-index: 1;        margin:  0px;        background-image: url(data:image/svg+xml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA3OC45NCA3NS4zMSI+PGRlZnM+PHN0eWxlPi5jbHMtMXtmaWxsOm5vbmU7fS5jbHMtMntmaWxsOiNmZmY7fS5jbHMtM3tmaWxsOiM0OGRhZDA7fTwvc3R5bGU+PC9kZWZzPjx0aXRsZT5VbnRpdGxlZC0xPC90aXRsZT48cmVjdCBjbGFzcz0iY2xzLTEiIHdpZHRoPSI3OC45NCIgaGVpZ2h0PSI3NS4zMSIvPjxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTUwLjA5LDM4LjJsMy41NC0zLjYzTDQ5LjgsMzAuNjZjLTMuMTEtMy4xOS0yLjItNC44OC0xLjQ4LTUuNjFhNS45Myw1LjkzLDAsMCwxLDEuMjMtMSw5LjA3LDkuMDcsMCwwLDAsMS43MSwyLjM3YzMuNzEsMy44Myw3Ljc2LDMuMywxMC44Ny4wOWExMS42NywxMS42NywwLDAsMCwzLTQuNTNMNjIsMjAuMjVhMTIuNzQsMTIuNzQsMCwwLDEtMi4xOSwzLjIyYy0xLjY4LDEuNzUtMy4yOSwxLjc1LTQuMzcuODVsNi4zNy02LjQ5LS44LS44MmMtMy43NC0zLjg2LTcuMjItNC4wNy0xMC4zNi0uODVhNi41Miw2LjUyLDAsMCwwLTEuNDYsNy4xNmwtMi4zNC0yLjg0YTQuMjcsNC4yNywwLDAsMC0xLjA4Ljg4LDUuMjcsNS4yNywwLDAsMC0xLjIsNC41OUw0MywyNC41N2wtMy4xMSwzLjE5LDQuMjgsNC4zOWMtMy40LTIuODctNi40NS0yLjcyLTkuMjcuMTdzLTIuNjgsNi40OS0uMzEsOS40N2wtLjQtLjQxYy0yLjU0LTIuNi01LTMuMTYtNy40Mi0uNjRhNC43MSw0LjcxLDAsMCwwLTEuNTEsNC4xbC02LTYuMTEtMy40OSwzLjU3TDI3LjM5LDU0LjJoNy4wOGwtNC44OC01Yy0xLjcxLTEuNzMtMi4yMy0yLjkyLTEuMTctNCwuNzctLjgyLDEuNjYtLjc5LDIuNzQuMzJMMzcsNTEuNTZsMy41NC0zLjYzLTQuNC00LjVjMy40OCwzLDcuMjgsMi4yMiwxMC4xNi0uNzZhMTIuNTcsMTIuNTcsMCwwLDAsMi43NC0zLjg5TDQ2LDM3YTE0LjA4LDE0LjA4LDAsMCwxLTEuODgsMi42M2MtMS43MSwxLjc1LTMuMzEsMS43NS00LjM5Ljg1TDQ2LDM0Wm0tMTIuNjIuMjlhMi40NSwyLjQ1LDAsMCwxLDAtMy41MSwyLjM0LDIuMzQsMCwwLDEsMy40NSwwWk01My4yNSwyMi4zMmEyLjQ1LDIuNDUsMCwwLDEsMC0zLjUxLDIuMzEsMi4zMSwwLDAsMSwzLjQzLDBaIi8+PHBvbHlnb24gaWQ9Im9yaWciIGNsYXNzPSJjbHMtMyIgcG9pbnRzPSIxMy44MSA1NC4yIDEzLjgxIDU0LjIgMjAuOTIgNjEuNDggMjguMDIgNTQuMiAyOC4wMiA1NC4yIDEzLjgxIDU0LjIiLz48L3N2Zz4=);        background-repeat: no-repeat;        width:  38px;        height: 38px;        cursor: pointer;"},Jt.prototype.templ='<div class="here-logo"></div>';var Kt,te={ZoomControl:Vt,Copyright:$t,HERE:Jt},ee={Copyright:{visible:!0},ZoomControl:{visible:!0},HERE:{visible:!0}},ne=function(){function t(t,e,n){var i=e.UI||e.ui||{},r=this.components={};for(var a in this.el=t,i=o.extend(!0,o.clone(ee),i)){var s=i[a];s.visible&&te[a]&&(r[a]=new te[a](t,s,n,e))}}return t.prototype.destroy=function(){var t=this.el,e=this.components;for(var n in e)e[n].disable();t.parentNode.removeChild(t)},t}(),ie=o.isFunction,re=function(){function t(t,e){this.startTs=0;this.map=t,ie(e.onStart)&&(this.onStart=e.onStart),ie(e.onStop)&&(this.onStop=e.onStop),this._animate=this._animate.bind(this)}return t.prototype.zoom=function(){var t=+new Date-this.startTs,e=t/this.duration,n=e%1;if(e>=1&&(n=1),this.map.setZoomlevel(this.zoomStart+n*this.zoomDelta,this.zoomX,this.zoomY),t<this.duration)return!0;this.startTs=0,this.onStop()},t.prototype._animate=function(){this.zoom()&&requestAnimationFrame(this._animate)},t.prototype.onStart=function(){},t.prototype.onStop=function(){},t.prototype.animate=function(t,e,n,i){this.startTs||(this.onStart(),this.startTs=Date.now(),this.zoomX=e,this.zoomY=n,this.zoomStart=this.map.getZoomlevel(),this.duration=i,this.zoomDelta=t-this.zoomStart,requestAnimationFrame(this._animate))},t}(),oe=function(t,e,n,i){return n*Math.sin(t/i*(Math.PI/2))+e},ae=o.isFunction,se=function(){function t(t,e){e=e||{};var n=this;n.map=t,n.duration=e.duration||500,ae(e.onStart)&&(n.onStart=e.onStart),ae(e.onStop)&&(n.onStop=e.onStop),n.raf=function(){n._pan()&&(n.rafId=requestAnimationFrame(n.raf))}}return t.prototype._pan=function(){var t=this.deltaX,e=this.deltaY,n=this.duration,i=this.startTs,r=Date.now()-i;r>n&&(r=n);var o=oe(r,0,t,n),a=oe(r,0,e,n);if(this.map.pan(o-this.lastDx||0,a-this.lastDy||0),o!=t||a!=e)return this.lastDx=o,this.lastDy=a,!0;this.onStop()},t.prototype.pan=function(t,e,n){this.startTs=t,this.deltaX=e,this.deltaY=n,this.onStart(),this.raf()},t.prototype.cancel=function(){var t=this.rafId;t&&(cancelAnimationFrame(t),this.rafId=null),this.onStop(),this.startTs=0,this.lastDx=0,this.lastDy=0},t.prototype.onStart=function(){},t.prototype.onStop=function(){},t}(),le=function(t,e){for(var n=0,i=[t,e];n<i.length;n++)for(var r=i[n],o=0;o<r.length;o++){for(var a=void 0,s=void 0,l=void 0,u=void 0,c=void 0,h=(o+1)%r.length,p=r[o],f=r[h],d=[f[1]-p[1],p[0]-f[0]],v=0,y=t;v<y.length;v++){var g=y[v];c=d[0]*g[0]+d[1]*g[1],(void 0===a||c<a)&&(a=c),(void 0===s||c>s)&&(s=c)}for(var m=0,x=e;m<x.length;m++){g=x[m];c=d[0]*g[0]+d[1]*g[1],(void 0===l||c<l)&&(l=c),(void 0===u||c>u)&&(u=c)}if(s<l||u<a)return!1}return!0},ue=function(t,e,n,i,r){var o=Math.sin(r),a=Math.cos(r),s=t-n,l=e-i;return[a*s-o*l+n,o*s+a*l+i]},ce=a.Utils,he=s.webMercator,pe=function(){function t(t){this.size=t}return t.prototype.init=function(t,e,n,i){for(var r=t.minLon,o=t.maxLon,a=t.minLat,s=t.maxLat,l=r+.5*(o-r),u=a+.5*(s-a),c=he.lon2x(l,1),h=he.lat2y(u,1),p=1/0,f=1/0,d=-1/0,v=-1/0,y=function(t,n){var i=ue(he.lon2x(t,1),he.lat2y(n,1),c,h,e);return[he.x2lon(i[0],1),he.y2lat(i[1],1)]},g=0,m=[y(r,s),y(o,s),y(r,a),y(o,a)];g<m.length;g++){var x=m[g];x[0]<p&&(p=x[0]),x[0]>d&&(d=x[0]),x[1]<f&&(f=x[1]),x[1]>v&&(v=x[1])}this.minLon=p,this.maxLon=d,this.minLat=f,this.maxLat=v,this.boundsMinLon=r,this.boundsMaxLat=s},t.prototype.getGrid=function(t,e){void 0===e&&(e=this.size);for(var n=[],i=this.minLon,r=this.maxLon,o=this.minLat,a=this.maxLat,s=this.boundsMinLon,l=this.boundsMaxLat,u=e<<t,c=ce.geoToGrid(i,a,t),h=ce.geoToGrid(r,o,t),p=h[2]-c[2]+1,f=h[1]-c[1]+1,d=c[2]*e,v=c[1]*e,y=he.lon2x(s,u),g=he.lat2y(l,u),m=ce.getTilesIds(c,h),x=0,w=0;x<f;x++){n[x]=[];for(var L=0;L<p;L++)n[x][L]=m[w++]}return this.x=d-y,this.y=v-g,n},t}(),fe={ui:{},zoomLevel:18,center:{longitude:8.534,latitude:50.162},layers:null,credentials:null,maxLevel:20,minLevel:2,debug:!1,minPanMapThreshold:4,zoomAnimationMs:100},de=s.webMercator,ve=l.Rect,ye=l.Point,ge=u.Point,me=c.TileLayer,xe=180,we=-xe,Le=85.05112878,Me=-Le,be=256,Te="longitude",ze="latitude",Ce="width",Se="height",ke="zoom",De="drag",Ne="addLayer",Ie="removeLayer";function je(t,e){e=o.extend(o.extend(!0,{},fe),e||{});var n,r,a=this,s=0,l=0,u=f(t,Ce),c=f(t,Se),h=u,p=c,d=h/2,v=p/2,y=0,g=0,m=e.zoomlevel||e.zoomLevel,x=be<<m,w=new i("center","rotation","zoomlevel","mapviewchangestart","mapviewchange","mapviewchangeend","resize",Ne,Ie),L=[],M={},b={},T={},z={},C=1,S=0,k=0,D=0;a.layers=L,a.id=1e6*Math.random()^0;var N=t;(t=document.createElement("div")).className="_"+o.String.random(11),t.style["-webkit-tap-highlight-color"]="rgba(0,0,0,0)",t.style.position="relative",t.style.width=u+"px",t.style.height=c+"px",N.appendChild(t);var I=new pe(256);function j(t,e,n){w.trigger(t,[new St(t,e)],n)}function E(t,e,n){w.trigger(t,[t,e,n],!0)}a.setBackgroundColor=function(t){Z.setBGColor&&Z.setBGColor(t)},a.addEventListener=function(t,e){t.split(" ").forEach(function(t){if(w.isDefined(t))return w.add(t,e);V.addEventListener(t,e)})},a.removeEventListener=function(t,e){t.split(" ").forEach(function(t){if(w.isDefined(t))return w.remove(t,e);V.removeEventListener(t,e)})};var P=1,A={};function O(t,e){t.loadStartTs&&(t.isLoaded()||e.cancelTile(t,X[e.id]))}function R(){I.init(function(){var t=(h+s)/2,e=(p+l)/2;n=b.x-t/P,r=b.y-e/P;var i=de.x2lon(n,x),o=de.y2lat(r,x),a=b.x+t/P,u=b.y+e/P,c=de.x2lon(a,x),f=de.y2lat(u,x);return M=new ve(i,f,c,o),S=b.x-t-n,k=b.y-e-r,M}(),y,h,p);var t=be,e=I.getGrid(m,1),i=I.x*t-S,o=I.y*t-k;Y.watch(!0),Z.setTransform(P,y,D);var a,f,d,v,g=[Z.unproject(0,0),Z.unproject(u-1,0),Z.unproject(u-1,c-1),Z.unproject(0,c-1)],w=[],C=L.length;for(a=0;a<C;a++)w[a]=q[L[a].id],q[L[a].id]={};var N=[[],[],[],[]];A={};for(var j=[],R=0,B=e.length;R<B;R++)for(var _=0,W=e[R].length;_<W;_++){var G=_*t+i,V=R*t+o,F=G+t,Q=V+t,H=e[R][_];N[0][0]=G,N[0][1]=V,N[1][0]=F,N[1][1]=V,N[2][0]=F,N[2][1]=Q,N[3][0]=G,N[3][1]=Q,G=Math.round(G),V=Math.round(V),A[H]=[G,V],le(g,N)&&(j[j.length]=[H,G,V])}Z.initViewport(j,M,m);for(var $=0,J=j.length;$<J;$++){var K,tt=j[$][0];for(a=0;a<C;a++)K=(f=L[a]).id,m>=f.min&&m<=f.max&&(q[K][tt]=f.getTile(tt,X[K]))}for(var et in w[0])if(!q[L[0].id][et]){for(a=0;a<C;a++)(d=w[a][et])&&(v=d,U&&v.z==m||O(v,L[a]));Z.cancel(et)}Z.update(),(z[Te]!=T[Te]||z[ze]!=T[ze])&&(E("center",T,z),z=T)}var B=0,_=0;a.getWidth=function(){return h-B},a.getHeight=function(){return p-_},a.getViewBounds=function(){var t=M.minLon,e=M.maxLon,n=M.minLat,i=M.maxLat;return n<=Me&&(n=-90),i>=Le&&(i=90),t<we&&(t=we),e>xe&&(e=xe),new ve(t,n,e,i)},a.setViewBounds=function(t){var e,n,i,r,o,s,l=arguments;4==l.length?(e=l[0],n=l[1],i=l[2],r=l[3]):(t.bbox&&(t=t.bbox),t instanceof Array?(e=t[0],n=t[1],i=t[2],r=t[3]):(e=t.minLon,n=t.minLat,i=t.maxLon,r=t.maxLat)),o=i-e,s=r-n,a.setZoomlevel(function(t,e,n,i,r,o){for(var a,s,l,u=be<<20,c=20;c>=0;--c)if(l=20-c,a=(de.lon2x(n,u)>>l)-(de.lon2x(t,u)>>l),s=(de.lat2y(e,u)>>l)-(de.lat2y(i,u)>>l),a<=r&&s<=o)return c;return 0}(e,n,i,r,a.getWidth(),a.getHeight())),a.setCenter(e+o/2,n+s/2)};var Z=new(e.Renderer||Tt)(t,256,e.devicePixelRatio),Y=new Xt(a,j,Z);a._display=Z;var W=new At(a);a.getFeatureAt=function(t,e){(e=e||{}).topOnly=!0;var n=a.getFeaturesAt(t,e);if(n.length)return(n=n[n.length-1]).feature=n.features[0],n},a.getFeaturesAt=function(t,e){var n,i,r,o;if(e=e||{},t.x!=Kt&&t.y!=Kt){var a=t.x,s=t.y,l=0^e.width,u=e.height||l;n=a-l/2,i=a+l/2,r=s-u/2,o=s+u/2}else t.minX!=Kt&&t.maxX!=Kt&&(n=t.minX,r=t.minY,i=t.maxX,o=t.maxY);return n!=Kt&&W.search(n,r,i,o,e.layers,e.topOnly)};var q={},X={};function G(t,e){var n=t.id;q[n]||(q[n]={},X[n]=function(e){A[e.quadkey]&&Z.handleTile(e,t)},Z.addLayer(t,t.getStyle(),e),t.addEventListener("clear",a.refresh),j(Ne,{index:e,layer:t}))}var V=new Nt(t,a,L,e),U=!1,F=!1,Q=new re(a,{onStart:function(){U=!0,V.disable("pointerenter")},onStop:function(){U=!1,F||V.enable("pointerenter")}}),H={};H[ke]=!0,H[De]=!0;var $=new zt(t,a,new se(a,{onStart:function(){F=!0,V.disable("pointerenter")},onStop:function(){F=!1,U||V.enable("pointerenter")}}),H,e);function J(t){return function(t){t[0]/=C,t[1]/=C}(t),t[0]=n+(s+B)/2+t[0],t[1]=r+(l+_)/2+t[1],t}$.drag(!0),$.scroll(!0),a.getBehavior=function(){return o.clone(H)},a.setBehavior=function(t,e){var n=typeof t,i="object"==n?t:{};"string"==n&&(i[t]=e),i[ke]!=Kt&&(H[ke]=!!i[ke]),i[De]!=Kt&&(H[De]=!!i[De])},a.getZoomlevel=function(){return m+C%1};function K(t,e){return 2!=arguments.length&&(t instanceof Array?(e=t[1],t=t[0]):(e=(t=t||T)[ze],t=t[Te])),!isNaN(t)&&!isNaN(e)&&"number"==typeof t&&"number"==typeof e&&(t>xe?t-=360:t<we&&(t+=360),e<Me?e=Me:e>Le&&(e=Le),(T={})[Te]=t,T[ze]=e,b=new ge(de.lon2x(t,x),de.lat2y(e,x)),!0)}a.setZoomlevel=function(t,n,i,r){if(t=Math.round(1e3*t)/1e3,2==arguments.length&&(r=n,n=Kt),n!=Kt&&i!=Kt||(n=d,i=v),t>e.maxLevel&&(t=e.maxLevel),r)Q.animate(t,n,i,"number"==typeof r?r:250);else if(t<=e.maxLevel&&t>=e.minLevel&&(m!=t||1!=C)){var o=a.getZoomlevel(),s=(0^t)-m,l=1+Math.round(t%1*1e4)/1e4;if(function(t,e,n){var i=ue(e,n,d,v,-y),r=u/2-i[0],o=c/2-i[1];J(i),P=t,K(de.x2lon(i[0]+r/t,x),de.y2lat(i[1]+o/t,x))}(l,n,i),s){t^=0;var h=ue(n||0,i||0,d,v,-y),p=m-t,f=Math.pow(.5,p);if(0!==p){J(h);var g=x;x=be<<(m=t);var w=de.x2lon(h[0]+(b.x-h[0])/f,g),L=de.y2lat(h[1]+(b.y-h[1])/f,g);C=l,a.setCenter(w,L)}}else C=l,R();E("zoomlevel",a.getZoomlevel(),o)}},a.getLayers=function(t){return t!=Kt?L[t]:L.slice()},a.addLayer=function(t,e){for(var n in L)if(L[n]===t)return;e==Kt&&(e=L.length),G(t,e),L.splice(e,0,t),R()},a.removeLayer=function(t){for(var e=0;e<L.length;e++)if(L[e]==t){var n,i=t.id;for(var r in Z.removeLayer(t),t.removeEventListener("clear",a.refresh),q[i])O(n=q[i][r],t),Z.cancel(n.quadkey,t);delete q[i],delete X[i],L.splice(e,1),R(),j(Ie,{index:e,layer:t});break}},a.setCenter=function(){K.apply(a,arguments)&&R()},a.getCenter=function(){return new ye(T.longitude,T.latitude)},a.rotate3D=function(t,e,n){if(t!==Kt){var i=t%360|0;D=i*Math.PI/180,function(t,e){1==arguments.length&&(e=t);var n=h-B,i=p-_;B=(h=n*t)-n,_=(p=i*e)-i}(1-2.5*i/100),n!==Kt&&n!==y?a.rotate(n):R()}return D},a.rotate=function(t,e,n){if(t!==Kt){var i=(0|t)*Math.PI/180;if(i!==y){1===arguments.length&&(e=d,n=v);var r=d-e,o=v-n,s=ue(r,o,0,0,-y),l=y;b.x-=s[0]/C,b.y-=s[1]/C,y=i,g=Math.round(y/Math.PI*180),a.pan(-r,-o),R(),E("rotation",y,l)}}return g};var tt={pan:!1,minLevel:1,maxLevel:e.maxLevel};a.lockViewport=function(t){if(t){var n=t.pan,i=t.minLevel,r=t.maxLevel;i=!1===i?1:i,r=!1===r?e.maxLevel:r,n!=Kt&&(tt.pan=n),"number"==typeof i&&(tt.minLevel=i),"number"==typeof r&&(tt.maxLevel=r)}return tt},a.pan=function(t,e,n,i){if(e=(e^0-(0^i))/C,0!=(t=(t^0-(0^n))/C)||0!=e){var r=ue(t,e,0,0,-y),o=b.x-r[0],s=b.y-r[1];a.setCenter(de.x2lon(o,x),de.y2lat(s,x))}},a.resize=function(e,n){e!=Kt&&n!=Kt||(e=f(t.parentNode,Ce),n=f(t.parentNode,Se)),h===e&&p===n||(t.style.width=e+"px",t.style.height=n+"px",Z.setSize(e,n),d=(h=e)/2,v=(p=n)/2,u=h,c=p,R(),j("resize",{width:u,height:c}))},a.repaint=function(){R()},a.refresh=function(t){t instanceof Array||(t=[t]);for(var e=t.length;e--;)t[e]instanceof me&&Z.clearLayer(t[e]);R()},a.debug=function(t){Z.showGrid(t),R()},a.addObserver=function(t,e){return"zoomLevel"==t&&(t="zoomlevel"),w.add(t,e)},a.removeObserver=function(t,e){return"zoomLevel"==t&&(t="zoomlevel"),w.remove(t,e)},a.pixelToGeo=function(t,e){1==arguments.length&&(e=t.y,t=t.x);var i=Z.unproject(t,e,S,k),o=i[0]+n+s/2+S,a=i[1]+r+l/2+k;return o%=x,(a%=x)<0&&(a+=x),new ye(de.x2lon(o,x),de.y2lat(a,x))},a.geoToPixel=function(t,e){e==Kt&&(e=t.latitude,t=t.longitude),e<Me?e=Me:e>Le&&(e=Le);var i=de.lon2x(t,x)-n-s/2,o=de.lat2y(e,x)-r-l/2,a=Z.project(i,o,S,k);return new ge(a[0],a[1])},a.getContainer=function(){return t.parentNode},a.destroy=function(){for(var t in et.destroy(),L.forEach(a.removeLayer),Z.destroy(),Y.watch(!1),V.destroy(),$.drag(!1),$.scroll(!1),$.resize(!1),a)delete a[t]};var et=new ne(t,e,a);(e.layers||[]).forEach(function(t,e){G(t,e),L.push(t)}),a.setCenter(e.center)}n.here.xyz.maps.Map=je;export default je;export{je as Map};
