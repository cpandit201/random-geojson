/*
 * @here/xyz-maps-editor
 * (c) 2019 HERE
 */
import{JSUtils as e,geotools as t,global as r,Listener as n,Map as i,Set as o}from"@here/xyz-maps-common";import{features as s,providers as a,layers as c,loaders as u}from"@here/xyz-maps-core";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var l=function(e,t){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function d(e,t){function r(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function p(e,t,r){e._e().listeners.trigger(t,e,r)}function h(e,t){var r=e.__;return r||(r=e.__={isEditable:!0}),t?r[t]:r}var f={private:h,_evl:{pointerdown:function(){var e=h(this);e.moved=!1,e.pdm=[0,0]},pointerup:function(e){var t=h(this),r=t.moved;!t.isSelected&&this._e()._config.featureSelectionByDefault?f._select(this):r&&f.markAsModified(this),p(this,e,r?"dragStop":"pointerup")},pointerenter:function(e){this._e().listeners.trigger(e,this)},pointerleave:function(e){this._e().listeners.trigger(e,this)}},deHighlight:function(e){var t=h(e);t.selector&&(e._e().objects.overlay.remove(t.selector),t.selector=null,t.pointerdown=void 0,t.pressmove=void 0)},_editable:function(e,t){var r=h(e);return null!=t&&(r.isEditable=!!t),f.deHighlight(e),r.isEditable},_select:function(e){var t=e._e();if(t.objects.selection.select(e)){var r=h(e);r.pressmove=function(n,i,o,s,a){r.isEditable&&r.isSelected&&!t._config.editRestrictions(e,1)&&(t.map.pixelMove(e,i-r.pdm[0],o-r.pdm[1]),r.pdm[0]=i,r.pdm[1]=o,p(e,n,r.moved?"dragMove":"dragStart"),r.moved=!0)},r.selector||(r.selector=t.objects.overlay.addCircle(e.coord(),void 0,{type:"MARKER_SELECTOR"}))}},_setCoords:function(e,t){e._e().objects.history.origin(e);var r=h(e,"selector");r&&r._provider.setFeatureCoordinates(r,t),e._provider.setFeatureCoordinates(e,t.slice())},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),f.deHighlight(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),(null==t||t)&&e._e().objects.history.saveChanges(),e}},v=Math,A=v.PI,g=v.pow,y=v.sqrt,m=function(e,t,r){var n,i,o=(t[1]-e[1])/(t[0]-e[0]),s=e[1]-o*e[0];return n=v.abs(r[1]-o*r[0]-s)/y(g(o,2)+1),(i=_(r,e))<n&&(n=i),(i=_(r,t)<n)&&(n=i),n},S=function(e,t,r,n,i){void 0===r&&(r=0),void 0===n&&(n=e.length),void 0===i&&(i=[]);var o=0,s=0;n--;for(var a=r+1;a<n;a++){var c=m(e[r],e[n],e[a]);c>o&&(s=a,o=c)}return o>t?(S(e,t,r,s,i),S(e,t,s,n+1,i)):(i.push(e[r]),n-r>0&&i.push(e[n])),i},E=function(e,t){var r=t[0]-e[0],n=t[1]-e[1];return r||n?(180+180*v.atan2(n,r)/A)%360:0},C=function(e,t,r){var n=(E(e,t)-180)*A/180;return[e[0]+(r||0)*v.cos(n),e[1]+(r||0)*v.sin(n)]},k=function(e,t){for(var r=999999,n=!1,i=0;i<e.length-1;i++){var o=i+1,s=L(e[i],e[o],t);if(s){var a=_(s,t);a<r&&(r=a,n=i)}}return n},x=function(e,t,r,n){var i=(n[0]-r[0])*(e[1]-r[1])-(n[1]-r[1])*(e[0]-r[0]),o=(t[0]-e[0])*(e[1]-r[1])-(t[1]-e[1])*(e[0]-r[0]),s=(n[1]-r[1])*(t[0]-e[0])-(n[0]-r[0])*(t[1]-e[1]);if(0!=s){var a=i/s,c=o/s;if(0<=a&&a<=1&&0<=c&&c<=1)return[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}},L=function(e,t,r){if(e[0]==t[0]){var n=[e[0],r[1]];return!!I(e,t,n)&&n}if(e[1]==t[1]){var i=[r[0],e[1]];return!!I(e,t,i)&&i}var o=(t[1]-e[1])/(t[0]-e[0]),s=e[1]-o*e[0],a=-1/o,c=(r[1]-a*r[0]-s)/(o-a),u=[c,o*c+s];return!!I(e,t,u)&&u},b=function(e,t,r){return[(t[0]-e[0])*r+e[0],(t[1]-e[1])*r+e[1]]},_=function(e,t){return y(g(e[0]-t[0],2)+g(e[1]-t[1],2))},I=function(e,t,r,n){n=n||1e-7;var i=r[0]-e[0],o=r[1]-e[1],s=t[0]-e[0],a=t[1]-e[1],c=(i*s+o*a)/(s*s+a*a);return(c=(s=i-(c=c<0?0:c>1?1:c)*s)*s+(a=o-c*a)*a)<n*n},P=function(e){for(var t=0,r=0;r<e.length-1;r++)t+=_(e[r],e[r+1]);return t},w=function(e,t,r){for(var n=R(e,t),i=R(e,r),o=k(e,n),s=k(e,i),a=[n],c=o+1;c<s+1;c++)a.push([e[c][0],e[c][1]]);return a.push(i),a},R=function(e,t){for(var r,n,i,o,s=0,a=0;a<e.length-1;a++)if(n=e[a],i=e[a+1],(s+=r=_(n,i))>=t)return o=(t-(s-r))/r,[(i[0]-n[0])*o+n[0],(i[1]-n[1])*o+n[1]];return i};function F(e,t,r){for(var n=0,i=r.length-1;n<i;n++)if(x(e,t,r[n],r[n+1]))return 1}function D(e,t){for(var r=0,n=e.length-1;r<n;r++)if(F(e[r],e[r+1],t))return 1}function N(e,t){for(var r=e[0],n=e[1],i=!1,o=0,s=t.length-1;o<t.length;s=o++){var a=t[o][0],c=t[o][1],u=t[s][0],l=t[s][1];c>n!=l>n&&r<(u-a)*(n-c)/(l-c)+a&&(i=!i)}return i}function T(e,t,r,n,i,o){var s,a=e.objects.overlay;function c(t){var r,n=this.properties["@ns:com:here:editor"];"pointerleave"==t.type?(delete n.hovered,r="default"):(n.hovered=!0,r="move"),document.body.style.cursor=r,e.setStyle(this)}function u(t,r){e.listeners.trigger(t,h,r)}var l=!1,d=0,p=0;var h=a.addPoint([r,n],{type:"AREA_SHAPE",poly:i[0],index:i[1],hole:i[2],AREA:{style:e.getStyle(t)}});return h.__={pointerdown:function(){l=!1,d=0,p=0},pressmove:function(r,n,i,s,c){l||(l=!0,o.hideShape(o.private(t,"midShapePnts"),a),u(r,"dragStart"));var f=h.getIndex(),v=h.properties.poly,A=h.properties.hole,g=o.getCoords(t)[v],y=g[A],m=y[f],S=e.map.translateGeo(y[f],n-d,i-p);if(y[f]=S,f||(y[y.length-1]=S),!function(e,t,r){for(var n=0,i=t.length;n<i;n++)if(n!=r&&D(e,t[n]))return 1}(y,g,A)&&function(e,t,r){for(var n=0^r,i=e.length;n<i;n++)for(var o=0;o<e[n].length;o++)if(!N(e[n][o],t))return 0;return 1}(g,g[0],1)){var E=o.private(t,"shapePnts");o.forEachAt(t,m,function(e,t,r,n,i){i[t][r][n][0]=S[0],i[t][r][n][1]=S[1],o._setCoords(e,i,!1);for(var s=0,a=void 0,c=void 0;s<E.length;s++)(c=(a=E[s]).geometry.coordinates)[0]==m[0]&&c[1]==m[1]&&a.getProvider().setFeatureCoordinates(a,S.slice())}),d=n,p=i}},pointerup:function(e){l&&o.markAsModified(t),o.addVShapes(t),u(e,l?"dragStop":s)},pointerenter:c,pointerleave:c},h.class="AREA_SHAPE",h.getArea=function(){return t},h.remove=function(){return o.deleteShape(t,this)},h.getIndex=function(){return this.properties.index},h.removeGeometry=function(){var e=h.properties.poly,r=h.properties.hole,n=t.coord();n[e].splice(r,1),o._setCoords(t,n,!1),o.deHighlight(t),o._select(t),o.markAsModified(t)},h}function O(e,t,r,n,i,o){var s;function a(t){var r,n=this.properties["@ns:com:here:editor"];"pointerleave"==t.type?(delete n.hovered,r="default"):(n.hovered=!0,r="move"),document.body.style.cursor=r,e.setStyle(this)}var c=e.objects.overlay.addPoint([r,n],{type:"AREA_VIRTUAL_SHAPE",poly:i[0],index:i[1],hole:i[2],AREA:{style:e.getStyle(t)}});return c.__={pointerdown:function(){s=!1},pressmove:function(e,r,n,i,a){var u=c.properties,l=u.index+1,d=u.poly,p=c.geometry.coordinates;if(!s){s=!0;for(var h=o.private(t,"midShapePnts"),f=0,v=void 0,A=void 0,g=void 0;f<h.length;f++)(A=(v=h[f]).geometry.coordinates)[0]==p[0]&&A[1]==p[1]&&(g=v.properties,o.addShp(t,p.slice(),g.poly,g.hole,g.index+1));s=o.getShp(t,d,u.hole,l)}s.__.pressmove.apply(s,arguments)},pointerup:function(e){if(s){var r=c.properties,n=o.getShp(t,r.poly,r.hole,r.index+1);n.__.pointerup.call(n,e)}},pointerenter:a,pointerleave:a},c.isNode=!1,c}function B(e,t,r){var n=e[0],i=e[1],o=t[0],s=t[1],a=r[0],c=r[1],u=a-o,l=c-s,d=((n-o)*u+(i-s)*l)/(u*u+l*l);return _([n,i],d<0?[o,s]:d>1?[a,c]:[o+d*u,s+d*l])}function j(e,t){for(var r=1/0,n=t.length-1,i=0;i<n;i++){var o=B(e,t[i],t[i+1]);o<r&&(r=o)}return r}function M(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,shapePnts:[],midShapePnts:[]}),t?r[t]:r}function G(e){var t=M(e),r=e._e().objects.overlay;W.hideShape(t.shapePnts,r),W.hideShape(t.midShapePnts,r)}function H(e,t,r,n){for(var i,o=0;o<t[r].length;o++){i=t[r][o];for(var s=0;s<i.length-1;s++)e.push(n(i[s],i[s+1],[r,s,o]))}}function z(e){for(var t=M(e,"midShapePnts"),r=W.getCoords(e),n=0;n<r.length;n++)H(t,r,n,function(t,r,n){return new O(e._e(),e,(t[0]+r[0])/2,(t[1]+r[1])/2,n,W)})}function K(e){M(e,"isSelected")&&(G(e),function(e){for(var t=M(e,"shapePnts"),r=W.getCoords(e),n=0;n<r.length;n++)H(t,r,n,function(t,r,n){return new T(e._e(),e,t[0],t[1],n,W)})}(e),z(e))}function U(e){var t=M(this);t.allowEdit&&!t.isSelected&&(this._e().listeners.trigger(e,this),this.editState("hovered","pointerenter"==e.type),this._e().setStyle(this))}function V(e){var t=M(this);t.isSelected||this._e()._config.featureSelectionByDefault&&t.allowEdit&&W._select(this,e),this._e().listeners.trigger(e,this)}var Q,W={private:M,_evl:{pointerenter:U,pointerleave:U,dbltap:V,pointerup:V},deHighlight:function(e){var t=M(e);t.isSelected&&(G(e),e.editState("hovered",!1),e.editState("selected",!1),e._e().setStyle(e),t.isSelected=!1)},_editable:function(e,t){var r=M(e);t&&t!=r.allowEdit?document.body.style.cursor="pointer":t||t==r.allowEdit||(W.deHighlight(e),document.body.style.cursor="default"),r.allowEdit=t},_select:function(e,t){var r=M(e);r.isSelected||(e._e().objects.selection.select(e),e._e().dump(e,"info"),r.isSelected=!0,e.editState("selected",!0),e._e().setStyle(e),K(e))},_setCoords:function(e,t,r){"number"==typeof t[0][0][0]&&(t=[t]);for(var n=t.length;n--;)for(var i=t[n],o=i.length;o--;){var s=i[o];s[s.length-1]=s[0]}e._e().objects.history.origin(e),"Polygon"==e.geometry.type&&(1==t.length?t=t[0]:e.geometry.type="MultiPolygon"),e._provider.setFeatureCoordinates(e,t),r&&K(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),W.deHighlight(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),(t||void 0===t)&&e._e().objects.history.saveChanges(),e},deleteShape:function(e,t){var r=t.properties,n=W.getCoords(e),i=n[r.poly][r.hole];return!(i.length<=4)&&(i.splice(t.getIndex(),1),W._setCoords(e,n),W.deHighlight(e),W._select(e),W.markAsModified(e),!0)},getCoords:function(e){var t=e.coord();return"Polygon"==e.geometry.type?[t]:t},isClockwise:function(e){for(var t=0,r=0,n=void 0,i=e.length-1;r<i;r++)n=(r+1)%i,t+=e[r][0]*e[n][1],t-=e[n][0]*e[r][1];return t<0},forEachAt:function(e,t,r){for(var n=e._e(),i=function(e){return Math.round(1e9*e)},o=i(t[0]),s=i(t[1]),a=n.objects.getInBBox([t[0],t[1],t[0],t[1]],n.getLayer(e)),c=a.length;c--;)for(var u=a[c],l=W.getCoords(u),d=l.length;d--;)for(var p=l[d].length;p--;)for(var h=l[d][p],f=h.length-1;f--;)i(h[f][0])==o&&i(h[f][1])==s&&r(u,d,p,f,l)},getPoly:function(e,t){for(var r=e.e,n=W.getCoords(e),i=1/0,o=null,s=0;s<n.length;s++){var a=j(t,n[s][0].map(function(e){return r.map.getGeoCoord(e[0],e[1])}));a<i&&(i=a,o=s)}return o},addVShapes:z,getShp:function(e,t,r,n){for(var i=M(e,"shapePnts"),o=0,s=void 0;o<i.length;o++)if((s=i[o].properties).poly==t&&s.index==n&&s.hole==r)return i[o]},addShp:function(e,t,r,n,i){for(var o=W.getCoords(e),s=o[r][n],a="number"==typeof i?i:k(s,t)+1,c=0;c<s.length;c++)if(s[c][0]==t[0]&&s[c][1]==t[1])return!1;return s.splice(a,0,t),W._setCoords(e,o),K(e),a},hideShape:function(e,t){e instanceof Array||(e=[e]);for(var r=0;r<e.length;r++)t.remove(e[r]);e.length=0}},J=function(e){function t(t,r,n,i){var o=this;Q=i;var s=t._e().getStyle(t);return(o=e.call(this,{properties:{index:n,LINE:{properties:t.prop(),style:s}},geometry:{type:"Point",coordinates:r}})||this)._l=t,o}return d(t,e),t.prototype.getLine=function(){return this._l},t.prototype.pointerdown=function(e){var t=this.properties,r=this.geometry.coordinates,n=e.detail.display;t.moved=!1;var i=n.geoToPixel.apply(n,r);t.x=i.x,t.y=i.y,Q.removeShapes(this.getLine(),"vShps","LINE_VIRTUAL_SHAPE"==this.class&&this)},t.prototype.pressmove=function(e,t,r){var n=e.detail.display,i=this.properties,o=n.pixelToGeo(i.x+t,i.y+r),s=o.longitude,a=o.latitude,c=this.getLine(),u=c.coord();i.moved||(i.moved=!0,c._e().listeners.trigger(e,this,"dragStart")),this.getProvider().setFeatureCoordinates(this,[s,a]),u[i.index][0]=s,u[i.index][1]=a,Q._setCoords(c,u)},t.prototype.pointerup=function(e){var t=this.getLine(),r=this.properties.moved;r&&Q.markAsModified(t),Q.displayShapes(t),t._e().listeners.trigger(e,this,r?"dragStop":void 0)},t.prototype.remove=function(){Q.removeCoord(this.getLine(),this.properties.index)},t}(s.Feature);J.prototype.class="LINE_SHAPE";var Y,Z=function(e){function t(t,r,n,i){return Y=i,e.call(this,t,r,n,i)||this}return d(t,e),t.prototype.pointerdown=function(t){e.prototype.pointerdown.call(this,t)},t.prototype.pressmove=function(t,r,n){var i=this.properties,o=this.getLine();i.moved||(i.index++,Y.addCoord(o,this.geometry.coordinates.slice(),i.index,!0),Y.removeShapes(o,"vShps",this)),e.prototype.pressmove.call(this,t,r,n)},t.prototype.pointerup=function(t){this.getProvider().removeFeature(this),e.prototype.pointerup.call(this,t)},t}(J);function q(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,highlight:!0,moved:!1,shps:[],vShps:[]}),t?r[t]:r}Z.prototype.class="LINE_VIRTUAL_SHAPE";var X=function(e,t,r){void 0===r&&(r=!1),t&&e.editState(t,r),e._e().setStyle(e,void 0)};function $(e){q(this,"isEditable")&&this._e().listeners.trigger(e,this)}var ee,te,re,ne,ie={private:q,_evl:{pointerenter:$,pointerleave:$,pointerup:function(e){var t=q(this);t.isEditable&&(!t.isSelected&&this._e()._config.featureSelectionByDefault&&ie._select(this),this._e().listeners.trigger(e,this))}},addCoord:function(e,t,r,n){var i=e.coord();if(null==r){if(!1===(r=k(i,t)))return!1;r++}return i.splice(r,0,t),ie._setCoords(e,i),n||ie.displayShapes(e),r},removeCoord:function(e,t){var r,n=e.coord(),i=n.length;return i>2&&t>=0&&t<i&&(r=n.splice(t,1),ie._setCoords(e,n),ie.displayShapes(e)),r},createShapes:function(e,t,r,n){var i=q(e,r),o=t.length;i.length&&ie.removeShapes(e,r);for(var s=0;s<o;s++)i[s]=new n(e,[t[s][0],t[s][1]],s,ie),e._e().objects.overlay.addFeature(i[s])},createVShapes:function(e){for(var t=e.geometry.coordinates,r=[],n=1;n<t.length;n++)r.push(b(t[n-1],t[n],.5));ie.createShapes(e,r,"vShps",Z)},displayShapes:function(e){if(q(e,"isSelected")){var t=e.geometry.coordinates;ie.createShapes(e,t,"shps",J),ie.createVShapes(e)}},removeShapes:function(e,t,r){var n=q(e,t);n.forEach(function(t){t!=r&&e._e().objects.overlay.remove(t)}),n.length=0},deHighlight:function(e){q(e,"isSelected")&&(X(e,"selected",!1),ie.removeShapes(e,"shps"),ie.removeShapes(e,"vShps"))},_editable:function(e,t){var r=q(e);return null!=t&&(r.isEditable=!!t),ie.deHighlight(e),r.isEditable},_select:function(e){e._e().objects.selection.select(e)&&(X(e,"selected",!0),ie.displayShapes(e))},_setCoords:function(e,t){e._e().objects.history.origin(e),e.getProvider().setFeatureCoordinates(e,t)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),ie.deHighlight(e),e.getProvider().removeFeature(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),(null==t||t)&&e._e().objects.history.saveChanges(),e}},oe=function(){return function(e,t){this.offset=e,this.distance=t}}(),se=function(e,t){for(var r=0,n=0,i=0;i<t.length-1;i++){var o=t[i],s=t[i+1];0!=I(t[i],t[i+1],e)&&(n=r+_(o,e)),r+=_(o,s)}return n/r},ae=function(e,t){for(var r=0,n={lenPntToLine:1/0,lenTotal:0,shp:0},i=0;i<e.length-1;i++){var o=e[i],s=e[i+1],a=L(e[i],e[i+1],t);if(0!=a){var c=_(a,t);c<n.lenPntToLine&&(n.shp=i,n.lenPntToLine=c,n.lenTotal=r+_(o,a))}r+=_(o,s)}var u=0,l={shp:-1,distancePoi:1/0,length:-1};for(i=0;i<e.length;i++){var d=_(e[i],t);i>0&&(u+=_(e[i],e[i-1])),d<l.distancePoi&&(l.shp=i,l.distancePoi=d,l.length=u)}return n.lenPntToLine<l.distancePoi?new oe(n.lenTotal/r,n.lenPntToLine):new oe(l.length/r,l.distancePoi)},ce=function(e,t,r){if(t[0]==r[0]&&t[1]==r[1])return!1;var n=e[0]-t[0],i=e[1]-t[1],o=r[0]-t[0];return n*(r[1]-t[1])-i*o>0?"L":"R"},ue=function(e,t,r,n){e.target=r||"display",e._e().listeners.trigger(t,e,n)};function le(e,t){var r=null,n=e.getLink();if(n){var i=n.coord(),o=k(i,e.coord());if(!1!==o)var s=i[o],a=i[o+1];s!==te&&a!==te&&(r=ce(t.coord(),s,a))}return r}function de(e,t,r){ee=r;var n,i,o,s,a=this,c=e._e();function u(){this.prevDMove=null,n.moved=!1}function l(t,r,i,s,u){var l=this.prevDMove||[0,0],d=r-l[0],h=i-l[1];if(o&&!c._config.editRestrictions(e,1)){var f=c.map.getEventsMapXY(t),v=c.map.getGeoCoord(f[0]+d,f[1]+h);v.pop();var A=c.objects.getNearestLine(v,[o]),g=-1!=[0,e.geometry.coordinates.length-1].indexOf(A.shpIndex);if(n.moved||(n.moved=!0,ue(e,t,"routing","dragStart")),g||a.setRoutingPoint(o,A.point),A.distance>1||g){var y=c.objects.getNearestLine(v,o.getProvider(),{ignore:[o],maxDistance:10});if(y&&(y.distance<A.distance||g))return ee.defaults(o),a.setRoutingPoint(y.line,y.point),void ee.displayAsSelected(y.line,e.id,!0)}g||p()}l[0]=r,l[1]=i,this.prevDMove=l}function d(r){n.moved&&(t.setRoutingData(e),p(le(a,e)),t.markAsModified(e)),ue(e,r,"routing",n.moved?"dragStop":te)}function p(e){if(o){var t=o.coord(),r=P(t),i=0^ae(t,s).offset,u=R(t,r*i),l=R(t,r*i+(i<1?1:-1));u[0]==l[0]&&l[1]==u[1]||n&&(a.updateStreetLine(),c.objects.overlay.setFeatureCoordinates(n,s.slice()))}}a.getLink=function(){return o},a.coord=function(){return s},a.show=function(){if(o&&!n){var t=e.class;i=c.objects.overlay.addPath([e.coord().slice(),s.slice()],te,{type:t+"_LINE"}),(n=c.objects.overlay.addPoint(s.slice(),{type:t+"_ROUTING_POINT"})).pointerdown=u,n.pressmove=l,n.pointerup=d}return o&&(p(le(a,e)),ee.displayAsSelected(o,e.id)),o},a.hide=function(){n&&(n.pointerdown=n.pressmove=n.pointerup=te,c.objects.overlay.remove(n),c.objects.overlay.remove(i),n=i=null)},a.updateRoutingPoint=function(){var r,n,i=t.getRoutingData(e),a=i.link,u=t.getRoutingProvider(e),l=i.position;if(o=s=null,a&&u&&(o=u.search(a)),o){if(l){n=o.coord();for(var d=0;d<n.length-1;d++)if(I(n[d],n[d+1],l,1e-6))return s=l,o;r=l}else r=e.coord();var p=c.objects.getNearestLine(r,[o]);p&&(o=p.line,s=p.point)}return o},a.searchLink=function(){var r=t.getRoutingProvider(e);return r&&c.objects.getNearestLine(e.coord(),r,{maxDistance:c._config.maxRoutingPointDistance})},a.setRoutingPoint=function(e,t){if(s=o=null,e)o=e,s=t;else{var r=a.searchLink();r&&(o=r.line,s=r.point)}return o},a.clearRoutingPoint=function(){o=s=null,a.hide()},a.updateStreetLine=function(){if(i){var r=e.coord(),n=t.private(e);if(n.isSelected){var o=(c.getStyle(n.selector)[0]||[])[1]||{};r=c.map.getGeoCoord(C(c.map.getPixelCoord(r),c.map.getPixelCoord(s),o.radius||o.width/2))}c.objects.overlay.setFeatureCoordinates(i,[s].concat([r]))}}}var pe=function(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,isHovered:!1,cLink:null,moved:!1,prevDMove:null}),t?r[t]:r};var he=function(e){return Math.round(1e5*e)/1e5},fe=function(e){return"PLACE"==e.class},ve=function(e){var t=pe(e);return null==t._rp&&(t._rp=new de(e,Se,re)),t._rp};function Ae(e,t){var r=!fe(e),n=Se.getRoutingData(e).link,i=pe(e);i.isHovered=t;var o=n||r;if(n||r){var s=ve(e);(s.updateRoutingPoint()||s.setRoutingPoint())&&(i.cLink=s.show(),o&&Se.setRoutingData(e))}t&&ue(e,t)}function ge(e,t){var r=pe(e,"cLink");pe(e).isHovered=!t,r&&re.defaults(r,e.id)&&re.private(r,"isSelected")&&re.displayAsSelected(r),t&&ue(e,t),ve(e).hide()}function ye(e){var t=pe(this);t.allowEdit&&!t.isSelected&&("pointerenter"==e.type?Ae(this,e):ge(this,e))}function me(e,t,r,n,i){var o=pe(this),s=this._e();if(o.isSelected&&!s._config.editRestrictions(this,1)){o.moved||(o.moved=!0,Se.getRoutingData(this).link!=ne&&Se.connect(this,null),ue(this,e,"display","dragStart"));var a=o.prevDMove||[0,0],c=t-a[0],u=r-a[1];s.map.pixelMove(this,c,u),a[0]=t,a[1]=r,o.prevDMove=a,ve(this).updateStreetLine()}}var Se={private:pe,setLinkTools:function(e){re=e},_evl:{pointerenter:ye,pointerleave:ye,dbltap:function(e){ue(this,e)},pointerup:function(e){var t=pe(this),r=t.moved,n=this._e();t.allowEdit&&(t.isSelected||(n.dump(this),n._config.featureSelectionByDefault&&Se._select(this)),r&&(ve(this).show(),Se.markAsModified(this)),ue(this,e,"display",r?"dragStop":ne),t.moved=!1,t.prevDMove=null)},pointerdown:function(){var e=pe(this);e.allowEdit&&e.isSelected&&(e.moved=!1,e.prevDMove=null)}},deHighlight:function(e){var t=pe(e);return t.selector&&e._e().objects.overlay.remove(t.selector),t.selector=null,t.isSelected&&(ge(e),t.pressmove=null,t.isSelected=!1,t.cLink&&re.defaults(t.cLink,e.id)),e},_editable:function(e,t){var r=pe(e);t!=r.allowEdit&&(t||(Se.deHighlight(e),r.isHovered&&(r.isHovered.type="mouseout",ge(e,r.isHovered))),r.allowEdit=t)},_select:function(e){e._e().objects.selection.select(e)&&(pe(e).pressmove=me,Se.highlight(e),Ae(e))},_setCoords:f._setCoords,markAsRemoved:f.markAsRemoved,markAsModified:f.markAsModified,_props:function(t,r){var n=arguments.length,i=t.getProvider().getFeatureProperties(t);if(n>1){if(2==n&&"string"==typeof r)return i[r];if(3==n){var o=r;(r={})[o]=arguments[2]}t._e().objects.history.origin(t),e.extend(i,r)}return i},highlight:function(e){var t=pe(e);t.selector||(t.selector=e._e().objects.overlay.addCircle(e.geometry.coordinates,ne,{type:e.class+"_SELECTOR"}))},getRoutingProvider:function(e){var t=e._e(),r=e.getProvider().readRoutingProvider(e,t.layers.map(function(e){return e.getProvider()}));return t.getProviderById(r)},getRoutingData:function(e){return e.getProvider().readRoutingPoint(e)},setRoutingData:function(e){var t=ve(e),r=t.getLink(),n=t.coord(),i=pe(e);i.cLink=r;var o=n?[he(n[0]),he(n[1]),0|n[2]]:[],s=Se.getRoutingData(e),a=s.position||[],c=r?r.id:null;s.link==c&&o[0]==he(a[0])&&o[1]==he(a[1])||(e._e().objects.history.ignore(function(){i.writeProp=!0,e.getProvider().writeRoutingPoint(e,r,n?o:n),delete i.writeProp}),Se._setCoords(e,e.geometry.coordinates))},connect:function(e,t,r){var n=pe(e);if(!n.writeProp){var i=ve(e),o=i.getLink(),s=(Se.getRoutingData(e).position||[]).slice();o&&re.defaults(o),t?n.cLink=i.setRoutingPoint(t,r):(n.cLink=i.updateRoutingPoint())||!1===t||(n.cLink=i.setRoutingPoint()),(fe(e)||n.cLink)&&Se.setRoutingData(e),n.isSelected&&(n.cLink?Ae(e):ge(e));var a=Se.getRoutingData(e).position||[];o==n.cLink&&s[0]==a[0]&&s[1]==a[1]||Se.markAsModified(e,!1)}},disconnect:function(e){var t=pe(e);t.writeProp||(ge(e),ve(e).clearRoutingPoint(),t.cLink=null,fe(e)||ve(e).setRoutingPoint(),Se.setRoutingData(e),Se.markAsModified(e,!1))},getRoutingPosition:function(e){var t=ve(e),r=t.coord();return r||(t.updateRoutingPoint(),r=t.coord()),r&&[r[0],r[1],r[2]||0]||ne}};function Ee(e,t,r){this.isPntInFence=function(){return!0},this.isHidden=function(){return!0},this.remove=function(){}}var Ce,ke,xe,Le="@ns:com:here:editor",be=function(e){return e.__||(e.__={})},_e=function(e,t){var r,n,i=e.coord()[t],o=e.getConnectedLinks(t),s=e._e();return o.push(e),null!=(r=s.objects.getNearestLine(i,e.getProvider(),{maxDistance:s._config.autoConnectShapeDistance,ignore:o.map(function(e){return e.id})}))&&((n=r.point)[2]=i[2]||0,null===Ce.connectShpToLink(e,t,r=r.line,n)&&(r=null)),r};function Ie(e,t){be(this).line._e().listeners.trigger(e,this,t)}function Pe(){var e=(r=be(this)).line,t=e._e();r._cls=r.cLinks.map(function(e){return e.link}),r.drg=!1;var r,n=this.geometry.coordinates,i=t.display.geoToPixel.apply(t.display,n);(r=be(this)).x=i.x,r.y=i.y,t.dump(this),Ce.removeShapePnts(e,!0),t.listeners.trigger("_clearOverlay"),Ce.hideDirection(e),ke=new Ee(t,n[0],n[1])}function we(e,t,r){var n=be(this),i=n.line,o=i._e(),s=o._config,a=o.map.getGeoCoord(n.x+t,n.y+r);if(!s.editRestrictions(i,1))if(ke.isPntInFence(a)){if(!ke.isHidden()&&ke.hide(),s.autoSnapShape)for(var c=2*(21-o.display.getZoomlevel()),u=i.getProvider().search({point:a,radius:c}),l=u.length,d=void 0;d=u[--l];)if(d.id!=i.id&&-1==n._cls.indexOf(d)){var p=o.map.calcCrossingAt(d.geometry.coordinates,a,s.minShapeDistance,xe,c);if(p&&p.index!=xe){a=p;break}}Ce.moveShapeAtIndexTo(i,n.index,a[0],a[1]),n.drg||(n.drg=!0,Ie.call(this,e,"dragStart"))}else ke.isHidden()&&ke.show()}function Re(e){var t,r,n=be(this),i=n.index,o=n.drg,s=!1,a=n.line,c=!1,u=!1,l=n.cLinks;n._cls=null,o&&("boolean"==typeof(r=Ce.fixGeo(a,i))?c=!r:(c=r>=0,(u=i!=r)&&(i=r))),Ce.showDirection(a),ke.isHidden()&&!c&&o&&(t=_e(a,i)),t||(o&&((!1===r?l:a.getConnectedLinks(i,!0)).forEach(function(e){var t=Ce.fixGeo(e.link,e.index);u="number"==typeof t||!t||u,Ce.markAsModified(e.link,!1,!1)}),s=!0),Ce.createAddShapePnts(a)),ke&&ke.remove(),n.drg=!1,(u||o)&&Ce.refreshGeometry(a),a._e().listeners.trigger(e,a.editState("removed")?this:Ce.private(a,"shps")[i],o?"dragStop":void 0),s&&Ce.markAsModified(a,!0,!1)}function Fe(){var e=be(this);document.body.style.cursor="default",e.cLinks.forEach(function(e){Ce.defaults(e.link)}),delete this.properties[Le].hovered,e.line._e().setStyle(this)}function De(){var e=be(this),t=e.line._e();document.body.style.cursor="move",e.cLinks.forEach(function(e){for(var r=t.getStyle(e.link),n=0;n<r.length;n++)r[n].opacity=.5;t.setStyle(e.link,r)}),this.properties[Le].hovered=!0,t.setStyle(this)}var Ne,Te=function(r){function n(t,n,i,o){var s;Ce=o;var a=t._e(),c=t.getConnectedLinks(i,!0),u=0==i||i==t.geometry.coordinates.length-1,l={type:"Feature",geometry:{type:"Point",coordinates:n.slice()},properties:{isNode:u,isConnected:!!c.length,"@ns:com:here:editor":{},NAVLINK:{properties:e.extend(!0,{},t.properties),style:a.getStyle(t)},parent:t}};s=r.call(this,l,a.objects.overlay.layer.getProvider())||this;var d=be(s);return d.index=i,d.line=t,d.drg=!1,d.cLinks=c,d.dblclick=Ie,d.pressmove=we,d.pointerdown=Pe,d.pointerup=Re,a._config.editRestrictions(t,1)||(d.pointerenter=De,d.pointerleave=Fe),s}return d(n,r),n.prototype.getLink=function(){return this.properties.parent},n.prototype.isNode=function(){return this.properties.isNode},n.prototype.isOverlapping=function(){return Ce.checkOverlapping(this.properties.parent,this.getIndex())},n.prototype.getIndex=function(){return be(this).index},n.prototype.editTurnRestrictions=function(){if(this.isNode())return this.getLink().editTurnRestrictions(this.getIndex())[0]},n.prototype.getConnectedLinks=function(){return this.getLink().getConnectedLinks(this.getIndex())},n.prototype.remove=function(){var e=this.getLink();e._e()._config.editRestrictions(e||this,2)||Ce.deleteShape(e,this)},n.prototype.disconnect=function(){var e=be(this),r=e.line._e();if(this.isNode()&&e.cLinks.length){var n=e.line,i=e.index,o=n.coord(),s=o[i],a=o[i+(i?-1:1)],c=90-t.calcBearing(s,a),u=r.map.movePoint(s,r._config.disconnectShapeDistance,c);r.hooks.trigger("Navlink.disconnect",{link:n,index:i},n.getProvider()),o[i][0]=u[0],o[i][1]=u[1],Ce._setCoords(n,o),Ce.fixGeo(n),Ce.refreshGeometry(n),Ce.markAsModified(n)}},n.prototype.splitLink=function(){var e,t=this.getLink(),r=t._e();return this.isNode()||(e=r.objects.splitLinkAt({link:t,index:this.getIndex()})).length&&r.objects.history.saveChanges(),e},n}(s.Feature);Te.prototype.class="NAVLINK_SHAPE";var Oe,Be=function(t){function r(r,n,i,o){var s,a,c=r._e(),u=c.display;var l=s=t.call(this,{type:"Feature",geometry:{type:"Point",coordinates:n.slice()},properties:{type:"NAVLINK_VIRTUAL_SHAPE",NAVLINK:{properties:e.extend(!0,{},r.properties),style:c.getStyle(r)},parent:r}},c.objects.overlay.layer.getProvider())||this;return l.pointerdown=function(){var e=l.properties.parent;l.moved=!1,o.hideDirection(e);var t=u.geoToPixel.apply(u,this.geometry.coordinates);a=new Ee(c,l.x=t.x,l.y=t.y)},l.pressmove=function(e,t,r,n,s){var u=l.properties.parent,d=c.map.getGeoCoord(l.x+t,l.y+r);if(a.isPntInFence(d)){a.isHidden()||a.hide();var p=o.private(u,"shps");if(!l.moved){o.addShp(u,d,i,!1,!0),o.removeShapePnts(u,!0,l.id),l.pointerenter=l.pointerleave=Ne,l.moved=!0;var h=p[i];h.x=l.x,h.y=l.y,h.__.pointerdown.call(h)}var f=p[i];f.__.pressmove.apply(f,arguments)}else a.isHidden()&&a.show()},l.pointerup=function(e){var t=l.properties.parent,r=o.private(t);if(l.moved){var n=r.shps[i];n.__.pointerup.call(n,e),this.getProvider().removeFeature(this)}else r.isSelected&&o.showDirection(t)},c._config.editRestrictions(r,1)||(l.pointerenter=l.pointerleave=function(e){var t="pointerenter"==e.type;document.body.style.cursor=t?"move":"default",this.properties["@ns:com:here:editor"].hovered=t,c.setStyle(this)}),s}return d(r,t),r}(s.Feature),je=function(){return function(){}}(),Me=function(e,t){var r=e.__;return r||(r=e.__={isSelected:!1,isEditable:!0,allowEdit:!0,shps:[],vShps:[],isHovered:null,_cPnt:null,arrows:null,prevBBox:null,isGeoMod:!1,dh:null,xt:null}),t?r[t]:r};function Ge(t,r){var n=arguments.length,i=t.getProvider().getFeatureProperties(t);if(n>1){if(2==n&&"string"==typeof r)return i[r];if(3==n){var o=r;(r={})[o]=arguments[2]}t._e().objects.history.origin(t),e.extend(i,r)}return i}var He=function(e){for(var t=Ze.getConnectedObjects(e),r=0;r<t.length;r++)if(Se.private(t[r],"isSelected"))return!0};function ze(e){var t=e.type;Me(this,"allowEdit")&&this._e()._config.featureSelectionByDefault&&("dbltap"==t||"pointerup"==t)&&Ze._select(this),this._e().listeners.trigger(e,this)}function Ke(e,t){if(t)for(var r in t)e.editState(r,t[r]);e._e().setStyle(e,Oe)}function Ue(e){var r=Me(e),n=r.prevBBox=r.prevBBox||e.bbox.slice();return Ze.getConnectedObjects(e,t.mergeBBoxes(n,e.bbox))}function Ve(e,t){Me(e).isGeoMod=!0,e._e().objects.history.origin(e),e._provider.setFeatureCoordinates(e,t)}function Qe(e,t){if(e._e().objects.overlay.remove(t),t.class){for(var r in t)"id"!=r&&"type"!=r&&"class"!=r&&"properties"!=r&&"geometry"!=r&&(t[r]=Oe);t.isDeleted=!0}}function We(e,t){var r=e.__.ol;e.properties.isOverlapping=t,r!=(e.__.ol=t)&&e.getLink()._e().setStyle(e,Oe)}function Je(e){e.listeners.trigger("featureUnselected",{featureUnselected:!0})}function Ye(e){var t=Me(this);t.allowEdit&&(document.body.style.cursor="default",ze.call(this,e),t.isSelected||He(this)||Ke(this,{hovered:!1}),t.isHovered=null)}var Ze={private:Me,_evl:{pointerenter:function(e){var t=Me(this);t.allowEdit&&(document.body.style.cursor="Pointer",t.isHovered=e,ze.call(this,e),Ke(this,{hovered:!0}))},pointerleave:Ye,dbltap:ze,pointerup:ze},deHighlight:function(e){return Me(e,"isSelected")&&(Ke(e,{selected:!1,hovered:!1}),Ze.removeShapePnts(e),Ze.hideDirection(e)),e},_editable:function(e,t){var r=Me(e);if(t!=r.allowEdit){if(!t){var n=r.isHovered;n&&(n.type="mouseout",Ye.call(n.target,n)),Ze.deHighlight(e)}r.allowEdit=t}},_select:function(e){Me(e,"isSelected")||(e._e().objects.selection.select(e),e._e().dump(e,"info"),Ze.refreshGeometry(e))},_setCoords:function(e,t){for(var r=t.length;r--;)t[r][2]=t[r][2]||0;Ue(e),Ve(e,t),Ze.refreshGeometry(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),Ze.hideDirection(e),Ue(e).forEach(function(e){Se.disconnect(e)}),Ze._editable(e,!1);var t=e.coord();(function(e,t,r){return r=r||0,e[2]==t[2]&&_(e,t)<=r})(t[0].slice(0,2),t[t.length-1].slice(0,2))&&(t[0][0]+=1e-5,t[0][1]+=1e-5,Ve(e,t))},markAsModified:function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=!0);var n=e.editState("modified"),i=Me(e);if(e.editState("modified",Date.now()),i.isGeoMod){var o=e.coord();Ue(e).forEach(function(t){var r=R(o,P(o)*ae(o,Se.getRoutingPosition(t)).offset);Se.connect(t,e,r)}),i.isGeoMod=!1}return n||(Ke(e),!i.isSelected&&r&&Ze.defaults(e)),t&&e._e().objects.history.saveChanges(),e},_props:Ge,getConnectedObjects:function(e,t){return e._e().objects.getInBBox(t||e.bbox).filter(function(t){var r=t.class;if("PLACE"==r||"ADDRESS"==r)return t.getLink()==e})},refreshGeometry:function(e){Ze.removeShapePnts(e),Me(e,"isSelected")&&(Ze.displayAsSelected(e),Ze.showDirection(e),Ze.createShapes(e),Ze.createAddShapePnts(e))},checkOverlapping:function(e,t){var r=e.coord(),n=t==Oe,i=n?1:t,o=n?r.length-1:i+1,s=[];o==r.length&&o--;for(var a,c=e._e().objects.getInBBox(e.bbox,e.getProvider()),u=c.length;u--;)if((a=c[u]).id!=e.id&&"NAVLINK"==a.class)for(var l=i;l<o;l++)for(var d=0,p=a.coord();d<p.length;d++)if(r[l][0]==p[d][0]&&r[l][1]==p[d][1]){s.push(l);break}return n?s:!!s.pop()},createLinkShape:function(e,t,r){return e._e().objects.overlay.addFeature(new Te(e,t,r,Ze))},createShapes:function(e){var t=Me(e,"shps"),r=e.geometry.coordinates,n=r.length;if(!e.editState("removed")){var i=Ze.checkOverlapping(e);if(t.length)t.forEach(function(t,r){t.__.cLinks=e.getConnectedLinks(r,!0)});else for(var o=0;o<n;o++){var s=Ze.createLinkShape(e,[r[o][0],r[o][1]],o);We(s,i.indexOf(o)>=0),t[o]=s}}},createAddShapePnts:function(e){var t=Me(e,"vShps");if(!t.length&&!e.editState("removed")&&!e._e()._config.editRestrictions(e,1))for(var r=e.geometry.coordinates,n=1,i=void 0,o=void 0;n<r.length;n++)i=r[n-1],o=r[n],t.push(e._e().objects.overlay.addFeature(new Be(e,b(i,o,.5),n,Ze)))},removeShapePnts:function(e,t,r){function n(t){for(var n=0;n<t.length;n++)t[n].id!=r&&Qe(e,t[n]);t.length=0}var i=Me(e),o=i.vShps;return t||n(i.shps),(o.length||t)&&n(o),e},moveShapeAtIndexTo:function(e,t,r,n,i){var o=e.coord(),s=Me(e,"shps");o[t][0]=r,o[t][1]=n,Ue(e),Ve(e,o),Ze.hideDirection(e);var a=s[t];return!i&&a&&(e._e().objects.overlay.setFeatureCoordinates(a,[r,n]),a.__.cLinks.forEach(function(t){var i=t.link;!e._e()._config.editRestrictions(i,1)&&Ze.moveShapeAtIndexTo(i,t.index,r,n)}),We(a,Ze.checkOverlapping(e,t))),o},deleteShape:function(e,t,r){var n="number"==typeof t?t:t.getIndex(),i=e.coord();if(i.length>2){i.splice(n,1);var o=Me(e),s=o.shps;s.length&&(Qe(e,s[n]),s.splice(n,1),s.forEach(function(e){e.__.index-=Number(e.getIndex()>=n)})),Ue(e),Ve(e,i),r||Ze.markAsModified(e),o.isSelected&&Ze.refreshGeometry(e)}},showDirection:function(e){if(!e.editState("removed")){var r=(""+e.getProvider().readDirection(e)).toUpperCase(),n=void 0,i=void 0,o=void 0,s=void 0,a=void 0;if(Ze.hideDirection(e),"START_TO_END"==r?s=90:"END_TO_START"==r&&(s=-90),s!=Oe){var c=Me(e).arrows=[];n=e.geometry.coordinates;for(var u=0;u<n.length-1;u++)i=n[u],o=n[u+1],a=t.calcBearing(i,o)-s,c.push(e._e().objects.overlay.addPoint(b(i,o,.5),{type:"NAVLINK_DIRECTION",bearing:a}))}}return e},displayAsSelected:function(e,t,r){var n=Me(e);n.isSelected||(n._cPnt=t),Ke(e,{selected:!0})},addShp:function(e,t,r,n,i,o){var s=e.coord(),a=e._e(),c=a.map.calcCrossingAt(s,t,a._config.minShapeDistance,o);if(r="number"==typeof r?r:c.index,!c.existingShape||i){c.existingShape&&(r=k(s,t)+1),t[2]=t[2]||0,a.map.clipGeoCoord(t),s.splice(r,0,t),function(e,t){for(var r=Ge(e,"bn")||[],n=0;n<r.length;n++)r[n]+=r[n]>=t}(e,r),Ue(e),Ve(e,s);var u=Me(e,"shps");u.length&&(u.splice(r,0,Ze.createLinkShape(e,t,r)),u.forEach(function(e){e.__.index+=Number(e.getIndex()>r)}),u.forEach(function(t){We(t,Ze.checkOverlapping(e,t.getIndex()))})),Ze.refreshGeometry(e)}else n||(r=!1);return r},defaults:function(e,t){var r=Me(e);return(!t||t==r._cPnt)&&(r._cPnt=null,Ke(e,{selected:!1,hovered:!1}),e)},hideDirection:function(e){var t=Me(e,"arrows");if(t){for(var r=0;r<t.length;r++)e._e().objects.overlay.remove(t[r]);t.length=0}return e},fixGeo:function(e,t,r,n){return Xe(e,t,r,n)},connectShpToLink:function(e,t,r,n,i,o,s){var a,c=new je,u=e._e().objects;if(r.id!=e.id){var l=function(e,t,r,n,i,o,s){var a=e._e(),c=e.coord(),u=e.getConnectedLinks(t,!0),l=i[0],d=i[1],p=a.objects.factory,h=a._config.minShapeDistance,f=a.map.calcCrossingAt(r.coord(),i,h,n),v=a.map.clipGeoCoord(f.point),A=null,g=f.existingShape,y=g&&(m=r,S=f.index,-1!=(Ge(m,"bn")||[]).indexOf(S==m.geometry.coordinates.length-1?"N":S));var m,S;c[t][0]=l,c[t][1]=d,Ze._setCoords(e,c),y&&p.blockShapeAtIndex(e,t);null!==f.index&&(A=a.objects.splitLinkAt(g?{link:r,index:f.index,avoidSnapping:!0}:{link:r,point:v,preferSegment:n,avoidSnapping:!0}),qe(e,t,v[0],v[1]),u.forEach(function(e){var t=e.link;qe(t,e.index,v[0],v[1]),Xe(t,e.index,!0),y&&p.blockShapeAtIndex(t,e.index),Ze.markAsModified(t,!1,!1),Ze.defaults(t)}));return A}(e,t,r,i,n);if(null===l)return null;t>0&&t<e.geometry.coordinates.length-1&&(Me(e,"isSelected")&&Je(e._e()),Ze.deHighlight(e),a=u.splitLinkAt({link:e,index:t}));var d=e.geometry.coordinates;2==d.length&&d[0][0]==d[1][0]&&d[0][1]==d[1][1]&&u.remove(e),Ze.markAsModified(e),Me(e,"isSelected")&&Ze.refreshGeometry(e),l&&(c.targetSplittedInto=l),a&&(c.splittedInto=a)}return c},isIntersection:function(e,t,r){var n=Math.pow(10,e._config.intersectionScale),i=function(e){return Math.round(e*n)};return i(t[0])==i(r[0])&&i(t[1])==i(r[1])}},qe=Ze.moveShapeAtIndexTo;function Xe(e,t,r,n){var i=e._e(),o=i.objects,s=!0===r,a=t||0,c=e.getZLevels().length,u=t===Oe?c:a+1,l=!0,d=i._config.minShapeDistance||2;function p(a){if(n==a)return!0;function c(e){return 0==e||e==v-1}function u(t){var r=e.getConnectedLinks(t,!0);return r.forEach(function(e){var t=e.link;Ze.markAsModified(t,!1),qe(t,e.index,p[0],p[1],!0)}),r}for(var l,p,h=e.coord(),f=Me(e),v=h.length,A=!1,g=!1,y=function(n){if(a!=n&&function(e,t,r){return r=r||1,e[2]==t[2]&&i.map.distance(e,t)<=r}(h[n],h[a],d)){if(l=Math.abs(a-n)-1,c(n)&&c(a)?1==l?A=a:g=n:c(a)?l<=1?A=a:g=n:c(n)?(1==l&&a>n&&(A=n),0==l?A=a:l>0?g=a:A=n):0==l?A=a:g=n,!1!==g){var y,m,S=void 0;if(p=h[g],2==v){var E=u(t);qe(e,a==g?n:a,p[0],p[1]),Je(e._e()),o.remove(Ze.deHighlight(e)),E.forEach(function(e){s||Xe(e.link,e.index,!0)})}else u(a),qe(e,a,p[0],p[1]),(m=o.splitLinkAt({link:e,index:g===v-1||0===g?~~(v/2):g})).forEach(function(t,n){Xe(t,Oe,r.concat(e,m[Number(0==n)]))}),!(S=m[Number(a>=g)]).editState("removed")&&Math.abs(a-g)>=2&&(S.coord().forEach(function(e,t){e[0]==p[0]&&e[1]==p[1]&&(y=t)}),y&&o.splitLinkAt({link:S,index:y}));return{value:!1}}if(!1!==A){var C=h[n][0],k=h[n][1],x=!1;e.getConnectedLinks(A,!0).forEach(function(e){var t,n=e.link;Ze.markAsModified(n,!1),Ze.moveShapeAtIndexTo(n,e.index,C,k,!0),t=n,x=!(s||-1!=r.indexOf(t))}),qe(e,a==n?n:a,C,k,!0),Ze.deleteShape(e,A,!0),c(A)&&(!c(a)&&a-1>0&&qe(e,a-1,C,k,!0),f.isSelected&&Ze.refreshGeometry(e),x&&h.length>2&&o.splitLinkAt({link:e,index:n-Number(0===A)}));var L=a-n,b=void 0;return L>0?b=a-1-l:L<0&&(b=a+l),{value:b}}}},m=0;m<v;m++){var S=y(m);if("object"==typeof S)return S.value}return!0}if(!e.editState("removed")&&a<c)for(r=s||!r?[]:r;a<u&&!0===(l=p(a));a++);return l}var $e={};$e.MARKER=f,$e.AREA=W,$e.LINE=ie;var et=$e.NAVLINK=Ze;function tt(e){return $e[e.class]}function rt(e){return function(t){var r=t.class,n=$e[r][e];if(n)return n.apply(n,arguments)}}($e.PLACE=$e.ADDRESS=Se).setLinkTools(et);var nt={getTool:function(e,t){var r=tt(e);return r&&t?r[t]:r},private:rt("private"),getEventListener:function(e,t){var r=tt(e);return r?r._evl[t]||r.private(e,t):e.__&&e.__[t]||e[t]}};for(var it in $e)for(var ot in $e[it])nt[ot]||(nt[ot]=rt(ot));var st=function(){return function(){}}(),at=st.prototype;at.created=!1,at.modified=!1,at.removed=!1,at.split=!1,at.selected=!1,at.hovered=!1;var ct=s.Feature,ut=function(e){return 3==e.length?[e[0],e[1],e[2]]:[e[0],e[1]]},lt=function(t){function r(e,r){var n=t.call(this,e,r)||this;return n.properties["@ns:com:here:editor"]=new st,n}return d(r,t),r.prototype.toString=function(){return this.class+" 🌎 "+this.id},r.prototype.getProvider=function(){return this._provider},r.prototype._e=function(){return this._provider._e},r.prototype.editState=function(e,t){var r=arguments.length,n=this,i=n.properties["@ns:com:here:editor"];if(!r)return i;if(2==r){if(this._esu)return;t?i[e]=t:delete i[e],"hovered"!=e&&"selected"!=e&&n._e().objects.history.ignore(function(){n._esu=!0,n.getProvider().writeEditState(n,e),n._esu=void 0})}return i[e]},r.prototype.style=function(e){if("string"==typeof e||0==arguments.length)return this._e().getStyle(this,void 0);this._e().setStyle(this,e,!0)},r.prototype.prop=function(t){var r=!1,n=arguments.length,i=this.getProvider().getFeatureProperties(this);if(!n||1==n&&"string"==typeof t)return"object"==typeof(t=t?i[t]:i)?e.extend(!0,new t.constructor,t):t;if(2==n){var o={};o[t]=arguments[1],t=o}for(var s in t){var a=t[s],c="object"==typeof a,u=i[s];(c&&JSON.stringify(a)!=JSON.stringify(u)||!c&&u!==a)&&(r||(this._e().objects.history.origin(this),r=!0),i[s]=a)}r&&(this._e().setStyle(this),nt.markAsModified(this))},r.prototype.getCoordinates=function(){return this.coord()},r.prototype.coord=function(e){var t,r=this.geometry.type;if(e instanceof Array)nt.deHighlight(this),nt._setCoords(this,e),nt.markAsModified(this);else if(e=this.getProvider().decCoord(this),"Point"==r)t=ut(e);else{t=[];for(var n=e.length,i=0;i<n;i++)t[i]=ut(e[i])}return t},r.prototype.editable=function(e){return nt._editable(this,e),this.unselect(),this},r.prototype.select=function(){nt._select(this)},r.prototype.unselect=function(){nt.private(this,"isSelected")&&this._e().objects.selection.clearSelected()},r.prototype.transform=function(){this._e().transformer.show(this)},r.prototype.remove=function(){this._e().objects.remove(this,{save:!0})},r}(ct);lt.prototype.id=null;var dt="coordinates",pt="info";function ht(t){var n={};function i(e){return e.properties["@ns:com:here:editor"]}function o(e){return!!i(e).created}function s(e){return!!i(e).removed}function a(e,t,i,s){var a=e.id,c=[];for(var u in t)o(t[u])&&(n[a][u]||c.push(t[u]));c.length>0?e.reserveId(c,function(e){for(var r in t){o(t[r])&&!n[a][r]&&(n[a][r]=e.shift())}i(n[a],a)},s):r.setTimeout(function(){i(n[a],a)},0)}this.submit=function(r,i,c,u){var l=t._config.services.reverseGeocoder.getISOCC,d=u||e.String.random(),p=0;function h(){!function(r,i,s){var c,u,l,d=0;for(var p in l=JSON.stringify(r),r){for(var h in d++,u=!1,r[p])if(o(r[p][h])){u=!0;break}n[p]||(n[p]={}),u?(t.dump("REQUESTING PERMANENT IDs..",pt),a(t.getProviderById(p),r[p],function(n,o){var s,a,u="#"+e.String.random()+"#";for(var p in n)(c=r[o][p])&&(s=n[p],a=c.id.replace(/(?=[.\\+*?[^\]$(){}\|])/g,"\\"),l=l.replace('"'+a+'":{',u).replace(new RegExp('"link":"'+a+'"',"g"),'"link":"'+s+'"').replace(new RegExp('"'+a+'"|'+a,"g"),"number"==typeof s?s:'"'+s+'"').replace(u,'"'+s+'":{'),t.dump(c.id+" -> "+s,pt));--d||i(JSON.parse(l))},s)):d--}!d&&i(r)}(r,function(e){!function(e,r,i,o){var a=0;function c(){--a||(r(JSON.parse(JSON.stringify(n))),n={})}for(var u in e){a++;var l=t.getProviderById(u),d=e[u],p=[],h=[],f=void 0;for(var v in d)(s(f=d[v])?h:p).push(f);var A=n[u],g={};for(var y in A)g[A[y]]=y;p.length|h.length?l.commit({put:p,remove:h},c,function(e){i&&i(e)},o):c()}}(e,i,c,d)},c)}function f(e){if(e)return"number"==typeof e[0]?e:f(e[0])}for(var v in t.dump("COMMIT",d,pt),r){var A=function(e){var n=r[v][e],i=t.getProviderById(v);s(n)?o(n)&&delete r[v][e]:l&&(i.isoCC(n)||(p++,t.dump(n.id,"["+i.detectFeatureClass(n)+"] MISSING ISOCC -> REVERSE GEOCODING..",pt),function(e,t){l(t[0],t[1],function(t){t&&i.isoCC(e,t),--p||h()})}(n,f(n.geometry[dt]))))};for(var g in r[v])A(g)}p||h()}}function ft(t,r){var n=!1,i=new ht(t);function o(e){!function(){var e,r,n=t.objects.history.getChanges(),i=[];for(var o in n)for(var s in r=t.getProviderById(o),n[o])(e=r.search(s))&&delete e.properties["@ns:com:here:editor"],i.push(r,n[o][s].bbox);for(var a=0;a<i.length;a+=2)(r=i[a]).clear.apply(r,i[a+1])}(),t.objects.history.clear(e),t.display.refresh()}r.revert=function(){for(var e=t.observers.get("history.current");e--;)t.objects.history.recoverViewport(-1,!0);o()},r.submit=function(e){var r,s=!1,a=[],c=!1,u=(e=e||{}).ignoreEventBlock,l=e.layer,d=e.onError,p=e.onSuccess,h=e.transactionId;if("function"==typeof u)throw new Error("Invalid parameter!");if(u||!n){for(var f in l=l instanceof Array?l:[l]){var v=l[f];v&&v instanceof WIKI.Layer&&"MARKER"==v.type&&(v.base&&a.push(v.base),v.delta&&a.push(v.delta),v.src&&a.push(v.src))}for(var A in r=t.objects.history.getChanges())a.length>0&&a.indexOf(A)<0?(c=!0,delete r[A]):s=!0;if(s)return t.objects.clear(),function(e,r,o,s){n||(t.objects.selection.clearSelected(),t.observers.change("ready",n),n=!0,i.submit(e,function(e){n=!1,r.call(null,e)},function(e){n=!1,o.call(null,e)},s))}(r,function(e){o(c?a:null),p&&p({permanentIDMap:e})},function(e){d&&d(e)},h),!0}return!1},r.info=function(){var r=[],n=t.objects.history.getChanges();for(var i in n)for(var o in n[i])r[r.length]=e.clone(n[i][o]);return r},r.export=function(){return JSON.stringify(t.objects.history.getChanges())},r.import=function(e){return"string"==typeof e&&(e=JSON.parse(e)),t.objects.history.import(e)}}var vt,At=function(){function e(e){this.type="CONTAINER",this.length=0,this._e=e}return e.prototype.push=function(e,t){var r,n,i={};t&&"Feature"==t.type&&(e=arguments,t=void 0),null==e.length&&(e=[e]);for(var o=this._e,s=0,a=e;s<a.length;s++){var c=a[s];(n=o.objects.add(c,t,i))&&(c=n,r=!0),this[this.length++]=c}return r&&o.objects.history.saveChanges(),this.length},e.prototype.forEach=function(e,t){for(var r=0;r<this.length;r++)e.call(t,this[r],r)},e.prototype.toArray=function(){for(var e=[],t=0;t<this.length;t++)e[e.length]=this[t];return e},e.prototype.highlight=function(){for(var e,t=this.length;e=this[--t];)nt.highlight(e)},e.prototype.remove=function(){for(var e=this._e.objects,t=!1,r=this.length;r--;)t=e.remove(this[r],{animation:!1,save:!1})||t,delete this[r];t&&(this.length=0,e.history.saveChanges())},e.prototype.transform=function(){this.length&&this._e.transformer.show(this.toArray())},e.prototype.unhighlight=function(){for(var e,t=this.length;e=this[--t];)nt.deHighlight(e)},e.prototype.pop=function(){if(this.length){var e=this[--this.length];return delete this[this.length],e}},e.prototype.getBBox=function(){for(var e,t=[1/0,1/0,-1/0,-1/0],r=0;r<this.length;r++)(e=this[r].getBBox?this[r].getBBox():this[r].bbox)[0]<t[0]&&(t[0]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[2]>t[2]&&(t[2]=e[2]),e[3]>t[3]&&(t[3]=e[3]);return this.length?t:[0,0,0,0]},e}(),gt=function(e){return e.x!=vt&&e.y!=vt||e.longitude!=vt&&e.latitude!=vt};function yt(e,t){var r=function(t,n){if(gt(t)&&(t=e.map.getGeoCoord(t)),"number"==typeof t[0])return t[0]+=n[0],t[1]+=n[1],e.map.clipGeoCoord(t);for(var i=[],o=0;o<t.length;o++)i[o]=r(t[o],n);return i};t.addFeature=function(n,i,o){var s,a,c=arguments,u=[],l={},d={},p=function(e,t){var r=t&&t.id;(d[r]=d[r]||[]).push(e)};if(n instanceof lt)p(n,i);else if(n instanceof Array)n.forEach(function(e){return p(e,i)});else for(var h in d=n)"Feature"==(n=d[h]).type&&(d[h]=[n]);if(o=c[c.length-1],gt(o)){o=e.map.getGeoCoord(o);var f=e.display.getViewBounds();a=[o[0]-f.minLon,o[1]-f.maxLat]}else a=[0,0];var v=function(t){d[t].forEach(function(n){var i=n.geometry;i.coordinates=r(i.coordinates,a),(n=e.objects.add(n,"undefined"==t?vt:t,l))&&(s=!0,u.push(n))})};for(var A in d)v(A);return s&&e.objects.history.saveChanges(),u.length>1?t.createFeatureContainer.apply(t,u):u[0]},t.getFeature=function(t,r){return e.objects.get(t,r)||null},t.createFeatureContainer=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=new At(e);return n.push(t),n},t.clearObjectSelection=function(){return e.objects.selection.clearSelected()||null}}
// const isCoordinate = (c) => {
//         if (isCoordinate(c)) {
//             c = HERE_WIKI.map.getGeoCoord(c);
//             return HERE_WIKI.map.clipGeoCoord(c);
function mt(e,r,n,i,o,s){var a,c,u,l,d,p,h=n.addImage(r,o);h.pressmove=function(r,n,o,s,h){a||i.visible(!(a=!0));for(var f=t.calcBearing(u,e.map.getGeoCoord(r.mapX,r.mapY))-l,v=0;v<c.length;v++)p=c[v],nt._setCoords(p,e.map.rotateGeometry(p.geometry,u,f-d));d=f},h.pointerdown=function(r){a=!1,u=i.getCenter(),l=t.calcBearing(u,e.map.getGeoCoord(r.mapX,r.mapY)),c=i.getObjects(),d=0},h.pointerup=function(){a&&(c.length>1||"Point"!=c[0].geometry.type)&&(i.markObjsAsMod(),i.objBBoxChanged()),c=null,u=null,i.visible(!0)},h.pointerenter=h.pointerleave=function(t){var r="pointerenter"==t.type;document.body.style.cursor=r?"move":"default",e.setStyle(h,r?s:o)},this.setPosition=function(e,t){n.setFeatureCoordinates(h,[e,t])},this.hide=function(){n.hideFeature(h)},this.show=function(){n.showFeature(h)},this.remove=function(){n.remove(h)}}function St(e,t,r,n,i,o){var s,a,c,u=r.addCircle(t,i),l=null;u.pointerdown=function(){s=!1,a=0,c=0,l=n.getObjects()},u.pressmove=function(t,r,i,o,u){s=!0;for(var d=0;d<l.length;d++)e.map.pixelMove(l[d],r-a,i-c);a=r,c=i,n.objBBoxChanged()},u.pointerup=function(){s&&n.markObjsAsMod(),l=null},this.setPosition=function(e,t){r.setFeatureCoordinates(u,[e,t])},this.getCenter=function(){return u.geometry.coordinates.slice()},this.hide=function(){r.hideFeature(u)},this.show=function(){r.showFeature(u)},this.remove=function(){r.remove(u)}}function Et(e,t,r,n,i,o,s,a,c){for(var u,l,d,p,h,f=[o.addRect(t,r,n,i,a)],v=[[[t,i],[n,i]],[[n,i],[n,r]],[[n,r],[t,r]],[[t,r],[t,i]]],A=0;A<v.length;A++){var g=A%2;f.push(o.addPath(v[A],[{zIndex:0,type:"Line",opacity:.02,strokeWidth:4}],{orientation:g?"V":"H",index:A,cursor:(g?"ew":"ns")+"-resize"}))}function y(t,r,n){var i=this.properties.index,o=this.properties.orientation,a=null,c=null,f=h,v=[],A=e.map.getGeoCoord(t.mapX,t.mapY),g=s.getGap();if((1!=f.length||"Point"!=f[0].geometry.type)&&(p=!0,"V"==o&&l>0?(v[1]=u[3],c=1,v[0]=u[0]+(1==i?0:l),A[0]+=1==i?-g:g,a=(l+A[0]-(u[0]+l))/l,a=3==i?1-a:a):d>0&&(v[0]=u[0],a=1,v[1]=u[3]-(2==i?0:d),A[1]+=2==i?g:-g,c=(d+(u[1]-A[1]))/d,c=0==i?1-c:c),a&&c)){for(var y=0;y<f.length;y++){var m=f[y],S=e.map.scaleGeometry(m.geometry,[a/this.properties.fx,c/this.properties.fy],v);nt._setCoords(m,S)}s.objBBoxChanged(),this.properties.fx=a,this.properties.fy=c}}function m(){h=s.getObjects(),p=!1,u=h.getBBox(),l=u[2]-u[0],d=u[3]-u[1],this.properties.fx=1,this.properties.fy=1}function S(){p&&s.markObjsAsMod()}function E(){document.body.style.cursor=this.properties.cursor}function C(){document.body.style.cursor="default"}for(var k=0;k<f.length;k++){var x=f[k];x.pointerdown=m,x.pressmove=y,x.pointerup=S,x.pointerenter=E,x.pointerleave=C}this.update=function(e,t,r,n){var i=[[[e,n],[r,n]],[[r,n],[r,t]],[[r,t],[e,t]],[[e,t],[e,n]]];o.modifyRect(f[0],e,t,r,n);for(var s=1;s<f.length;s++)o.setFeatureCoordinates(f[s],i[s-1])},this.hide=function(){o.hideFeature(f)},this.show=function(){o.showFeature(f)},this.remove=function(){o.remove(f)}}var Ct="data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAAKIAELHhEaLCEqOjE5SEFIVlFYZXF2gYCFj5CVnaCkq7CzucDDx9DS1uDh5PDx8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABIALAAAAAATABMAAAVpoCSOkmCaZDqeLKqWbSykck2aRCEQSIIQrZXJAFFEjkdFECYwHCELwwISWbCYzadOMKBuYwOD+JuIJGq1ghktK5/ZrUfEcG1FHAdBgRFpXLECC0hHDQN/gAUJinSHgGw0cDMvaC+QJy8hADs=",kt="data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAELHhAZKyApOTA4R0BHVlBXZGBmcnB1gICFjo+UnK+yuL/Cx8/R1d/g4+/w8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABEALAAAAAATABMAAAVpYCSOEWSaZDqeLKqWbQylck2aTgM5SqI4rZWJIUAEjkdEEAZhHAUHxkEQOLCYzacO8qBuYw+G+JsIJGq1hhktK5/ZrUGAcW0FCAtIwxAoXLEQB0hHBQ9/gA0JinSHgGw0cDMvaC+QJy8hADs=",xt=18,Lt=function(e){for(var t=[1/0,1/0,-1/0,-1/0],r=0,n=e;r<n.length;r++){var i=n[r],o=i.getBBox?i.getBBox():i.bbox;o[0]<t[0]&&(t[0]=o[0]),o[1]<t[1]&&(t[1]=o[1]),o[2]>t[2]&&(t[2]=o[2]),o[3]>t[3]&&(t[3]=o[3])}return t};function bt(e,t){var r=e.objects.overlay,n=this,i=null,o=null,s=null,a=null,c=[];function u(e){for(var t=e.length;t--;){var r=e[t];c.indexOf(r.id)>=0&&nt._editable(r,!0)}}n.markObjsAsMod=function(){for(var t=a.length,r=0;r<t;r++)nt.markAsModified(a[r],!1);t&&e.objects.history.saveChanges()},n.getObjects=function(){return a},n.visible=function(e){s&&(e?(i.show(),s.show(),o.show()):(i.hide(),s.hide(),o.hide()))},this.isActive=function(){return null!==i},this.hide=function(){i&&(i.remove(),s.remove(),o.remove()),i=o=s=null,null!=a&&(u(a),a=null)},this.objBBoxChanged=function(){var t=a.getBBox(),c=t[0]-=4e-5,u=t[1]-=4e-5,l=t[2]+=4e-5,d=t[3]+=4e-5,p=t[0]+(t[2]-t[0])/2,h=t[1]+(t[3]-t[1])/2;null!=i?i.update(c,u,l,d):(i=new Et(e,c,u,l,d,r,n,{type:"Line",zIndex:0,strokeDasharray:[4,4],strokeWidth:2,stroke:"#010B1E"}),o=new St(e,[p,h],r,n,{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:"#010B1E",strokeWidth:3,opacity:.3,radius:9}),s=new mt(e,[l,u],r,n,[{type:"Image",zIndex:4,src:Ct,width:xt,height:xt}],[{type:"Image",zIndex:4,src:kt,width:xt,height:xt}])),s.setPosition(l,u),o.setPosition(p,h)},this.getGap=function(){return 4e-5},this.getCenter=function(){return o.getCenter()},this.show=function(t){var r;e.listeners.trigger("_clearOverlay"),null!=a&&u(a),(a=t instanceof Array?t:[t]).getBBox=function(){return Lt(a)},c=[];for(var i=0;i<a.length;i++)r=a[i],nt.deHighlight(r),nt.private(r,"allowEdit")&&(c.push(r.id),nt._editable(r,!1));n.objBBoxChanged()}}var _t,It=["ready","active","history.current","history.length","changes.length"],Pt={ready:!0,active:null},wt=function(){function e(){this.listeners=new n(It).sync(!0),this.val={};for(var e,t,r=this.val,i=It.length;e=It[--i];)t=Pt[e],r[e]=t!==_t&&t}return e.prototype.addObserver=function(e,t,r){var n=this.val;if("*"==e)for(var i in n)this.addObserver(i,t,r);else this.listeners.add(e,t,r)},e.prototype.removeObserver=function(e,t,r){var n=this.val;if("*"==e)for(var i in n)this.removeObserver(i,t,r);else this.listeners.remove(e,t,r)},e.prototype.get=function(e){return this.val[e]},e.prototype.change=function(e,t,r){var n=this.val[e];(r||n!=t&&this.get("active"))&&(this.val[e]=t,this.listeners.trigger(e,[e,t,n]))},e}(),Rt=function(){return function(e,t,r,n,i,o,s){var a=this;a.type=e,a.timeStamp=Date.now(),a.mapX=t,a.mapY=r,a.nativeEvent=n,a.button=i,a.target=o,a.detail=s}}(),Ft=Rt.prototype;Ft.nativeEvent=null,Ft.detail=null,Ft.target=null,Ft.mapX=null,Ft.mapY=null,Ft.type=null,Ft.button=null,Ft.timeStamp=null,Ft.toString=function(){return"EditorEvent "+this.type};var Dt,Nt=function(){function e(){this.listeners=new n("tap","dbltap","pointerup","pointerenter","pointerleave","dragStart","dragStop","dragMove","featureUnselected","error","_domResize","_panMap","_layerAdd","_layerRemove","_clearOverlay").sync(!0)}return e.prototype.trigger=function(e,t,r){var n,i,o,s,a=r||e.type||e;return(s=t)&&s.class?(i=e.detail,o=t):i=t,"touchend"==e.type&&(e=e.changedTouches[0]),n=this.listeners.trigger(a,[new Rt(a,e.mapX,e.mapY,e.nativeEvent,e.button,o,i)],function(e){return"_"==e[0]}(a)),"pointerup"==a&&(n=this.listeners.trigger("tap",[new Rt("tap",e.mapX,e.mapY,e.nativeEvent,e.button,o,i)],!1)||n),n},e.prototype.bind=function(e,t,r){return this.listeners.add(e,t,r)},e.prototype.remove=function(e,t,r){return this.listeners.remove(e,t,r)},e.prototype.supported=function(){return this.listeners.getEvents()},e.prototype.destroy=function(){this.listeners=null},e}(),Tt=function(){function e(e,t){this.s=[],this.zClearFeat=null,this.ie=e,this.display=t;var r=this,n=this.s,i=n.push;if(n.push=function(){for(var e=0;e<arguments.length;e++)nt.private(arguments[e]).isSelected=!0;i.apply(n,arguments)},n.remove=function(){for(var e=0;e<arguments.length;e++)nt.private(arguments[e]).isSelected=!1,n.splice(n.indexOf(arguments[e]),1)},e._config.keepFeatureSelection){var o=t.getZoomlevel();t.addEventListener("mapviewchangeend",function(){var e=t.getZoomlevel();if(e!=o){var n=r.getCurSelObj()||r.zClearFeat,i=void 0;n&&(i=n._provider.minLevel,o>=i?e<i&&(r.clearSelected(),r.zClearFeat=n):e>=i&&nt._select(n))}o=e})}}return e.prototype.select=function(e){var t=this.display.getZoomlevel(),r=e.getProvider();if(t>=r.minLevel&&t<=r.maxLevel)return this.clearSelected(),this.s.push(e),!0;this.zClearFeat=e},e.prototype.getCurSelObj=function(){return this.s[0]},e.prototype.unselectFeature=function(e){var t,r=this.ie;if(e||!r._config.keepFeatureSelection){if(t=this.getCurSelObj()){var n=nt.private(t,"xt");n&&n.clear(),r.listeners.trigger("featureUnselected",{featureUnselected:!0})}this.clearSelected()}},e.prototype.clearSelected=function(){var e,t=this.s,r=this.ie;return r.listeners.trigger("_clearOverlay"),t.forEach(function(r){var n=nt.getTool(r,"deHighlight");n&&(e=r,n(r,!0),t.remove(r)),nt.private(r).isSelected=!1}),t.length=0,this.zClearFeat=null,r.transformer.hide(),e},e}(),Ot="@ns:com:here:editor",Bt=function(){function e(){this.steps={}}return e.prototype.clone=function(e){return e?JSON.parse(JSON.stringify(e)):e},e.prototype.add=function(e,t,r){var n=this.steps[e]||{},i=n[t]=n[t]||{},o=r.id;if(!i[o])return i[o]=r,this.set(e,n),!0},e.prototype.remove=function(e,t,r){try{var n=this.steps[e][t],i=r.id;if(n[i])return delete n[i],this.set(e,this.steps[e]),!0}catch(e){}return!1},e.prototype.get=function(e){return this.clone(this.steps[e])},e.prototype.set=function(e,t){this.steps[e]=this.clone(t)},e.prototype.clear=function(){var e=this.steps;for(var t in e)delete e[t]},e}(),jt=function(e){return e.properties[Ot]},Mt=function(e){var t=e.toJSON(),r=jt(t);return t.class=e.class,r&&(delete r.hovered,delete r.selected),t},Gt=function(e){var t=jt(e);return t.modified||t.removed||t.split||t.created},Ht=function(){function t(e){this.current=0,this.total=0,this.changes={},this.cached=null,this._a=!0;this.iEdit=e,this.storage=new Bt}return t.prototype.updateObservers=function(e){var t=this.iEdit.observers;t.change("changes.length",this.getLength()),t.change("history.length",this.total),t.change("history.current",this.current,e)},t.prototype.getTotal=function(){return this.total},t.prototype.getLength=function(){var e=this.getChanges(),t=0;for(var r in e)for(var n in e[r])jt(e[r][n]).origin||t++;return t},t.prototype.remove=function(e){var t=e.getProvider().id;this.storage.remove(this.current,t,e)&&(delete this.changes[t][e.id],this.cached=null)},t.prototype.origin=function(e,t){var r=e.id,n=e.getProvider().id,i=this.storage,o=this.changes,s=this.current,a=i[s],c=o[n];if(c||(c=o[n]={}),c[r]=e,!a||!a[n]||!a[n][r]){var u=Mt(e),l=jt(u);t&&(l.removed=!0),l.origin=!0,i.add(s,n,u)}},t.prototype.saveChanges=function(){var e=0;if(this.active()){this.cached=null;var t=function(e){var t={},r=0;for(var n in e)for(var i in t[n]={},e[n])t[n][i]=Mt(e[n][i]),r++;return{data:t,length:r}}(this.changes);if(e=t.length){var r=++this.current;this.storage.set(r,t.data),r>this.total?this.total++:this.total=r,this.iEdit.dump("History step saved...",r,"warn"),this.changes={},this.updateObservers()}}return e},t.prototype.getChanges=function(){if(!this.cached){for(var e=this.storage,t=this.current,r={},n=1,i=void 0;n<=t;n++)for(var o in i=e.get(n))for(var s in i[o]){var a=i[o][s];c=void 0,(c=jt(a)).created&&c.removed?r[o]&&r[o][s]&&delete r[o][s]:Gt(a)&&((r[o]=r[o]||{})[s]=a)}this.cached=r}var c;return this.cached},t.prototype.clear=function(){this.storage.clear(),this.current=0,this.total=0,this.changes={},this.cached=null,this.updateObservers(!0)},t.prototype.import=function(t){var r=this.storage;for(var n in t)for(var i in t[n]){var o=this.iEdit.objects.get(i,n);if(o)this.origin(o);else{var s=e.extend(!0,{},t[n][i]),a=s.properties[Ot]=s.properties[Ot]||{};a.removed=!0,a.origin=!0,r.add(this.current,n,s)}}this.total=++this.current,r.set(this.current,t),this.recoverViewport(0)},t.prototype.recoverViewport=function(e,t){var r=+new Date,n=this.current+e,i=this.storage.get(n),o=this.iEdit;if(this.cached=null,n>=0&&n<=this.total){o.objects.selection.unselectFeature(),o.dump(arguments,n,"REBUILDED VIEW IN",+new Date-r,"ms"),o.objects.selection.getCurSelObj()&&o.listeners.trigger("featureUnselected",{featureUnselected:!0}),o.objects.selection.clearSelected();var s=[];for(var a in i){var c=i[a];for(var u in c){s["NAVLINk"==(h=c[u]).class?"unshift":"push"]({provider:o.getProviderById(a),feature:h})}}for(var l=0,d=s;l<d.length;l++){var p=d[l],h=p.feature,f=p.provider,v=f.search(h.id);v&&f.removeFeature(v);var A=jt(h);if(!A.removed){for(var g in h=o.objects.create(h,f,void 0,!0),A)h.properties[Ot][g]=A[g];o.setStyle(h)}}this.current=n,t||this.updateObservers()}},t.prototype.active=function(e){return arguments.length&&(this._a=!!e),this._a},t.prototype.ignore=function(e){var t=this.active();this.active(!1),e(),this.active(t)},t}(),zt=function(e,t,r){return{geometry:{coordinates:t,type:e},type:"Feature",properties:r||{}}},Kt=function(e,t){for(var r=0;r<e.length;r++)null!=e[r].opacity&&(e[r]._opacity=e[r]._opacity||e[r].opacity),e[r].opacity=t;return e},Ut=function(e){for(var t=0;t<e.length;t++)e[t].opacity=null==e[t]._opacity?1:e[t]._opacity,delete e[t]._opacity;return e},Vt=function(e){return e=e?e instanceof Array?e:[e]:void 0},Qt=function(e,t,r,n){return[[[e,t],[e,n],[r,n],[r,t],[e,t]]]},Wt=function(){function e(e){this.layer=e}return e.prototype.getProvider=function(){return this.layer.getProvider()},e.prototype.hideFeature=function(){for(var e,t=this.layer,r=0;r<arguments.length;r++)(e=arguments[r])instanceof At&&(e=e.toArray()),e instanceof Array?this.hideFeature.apply(this,e):t.setStyleGroup(e,Kt(t.getStyleGroup(e),0))},e.prototype.showFeature=function(){for(var e,t=this.layer,r=0;r<arguments.length;r++)(e=arguments[r])instanceof At&&(e=e.toArray()),e instanceof Array?this.showFeature.apply(this,e):t.setStyleGroup(e,Ut(t.getStyleGroup(e)))},e.prototype.addFeature=function(e,t){return(e=this.layer.addFeature(e,Vt(t))).properties["@ns:com:here:editor"]=e.properties["@ns:com:here:editor"]||new st,e},e.prototype.addCircle=function(e,t,r){return this.addFeature(zt("Point",e,r),t)},e.prototype.remove=function(e){var t=this.layer;if(e instanceof At)for(var r=0;r<e.length;r++)t.removeFeature(e[r]);else e&&t.removeFeature(e)},e.prototype.setFeatureCoordinates=function(e,t){e._provider.setFeatureCoordinates(e,t)},e.prototype.getStyles=function(e){return this.layer.getStyleGroup(e)},e.prototype.modifyRect=function(e,t,r,n,i){this.setFeatureCoordinates(e,Qt(t,r,n,i))},e.prototype.addRect=function(e,t,r,n,i){return this.addFeature(zt("Polygon",Qt(e,t,r,n)),i)},e.prototype.addPolygon=function(e,t,r){return this.addFeature(zt("Polygon",[e],r),t)},e.prototype.addSquare=function(e,r,n,i,o){var s=t.movePoint;return n^=0,this.addPolygon([s(e,r,-45+n),s(e,r,45+n),s(e,r,135+n),s(e,r,225+n),s(e,r,-45+n)],i,o)},e.prototype.addPath=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"LineString"},type:"Feature",properties:r||{}},Vt(t))},e.prototype.addPoint=function(e,t,r){t instanceof Array||(r=t,t=void 0);var n={geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}};return this.addFeature(n,Vt(t))},e.prototype.addImage=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}},Vt(t))},e}(),Jt="data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO8AAPACAvoCAvoMDPAODvASEvoXF/oZGfAdHfAkJPAqKv1BQf1KSv5QUP9dXf9paf9zc/95ef+Ghv+Njf+Skv+dnf+lpf+rq/vFxf3MzPzW1vfa2vvc3P3i4v7q6v/y8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACIALAAAAAAYABgAAAb/QJFwKAyBOpnMBhQiOp2hDSZSsVgqkYum+SR6LoJAoBMKecICCrkbbQQECwHZLFAkAoPtcxNeFARyZWcCBnECekMeboYGgXSEdYAdQyEXAYYCBWOCgI1wARRcGwOZgKVzg54BjRoiIRgBCqannJCACgEWZRMBCbMGm4+eAr4QHx8Pq78BHLXDjQgbHQzKpn/NwtaNHdPVgH+ondpyHsnDtNmdAQcbIby+1o6ppsUfr7Gz4M6muLoiGwRKfXPUQdzAVq4sYdIXgoPBBaC4iPDg4FImhh3eNMI1YBIRPpcKMEwF8ZDEIhvcRAqXABgBRE88WAgTzIMYARXWdEGJQUKVDStZYO6kdCRJByY7gwAAOw==",Yt="#111111",Zt=function(e){return e.properties["@ns:com:here:editor"].hovered},qt=function(e){return[{zIndex:0,type:"Circle",radius:13,fill:"#ffffff",stroke:Yt,strokeWidth:1.5},{zIndex:1,type:"Text",fill:Yt,font:"normal 16px Arial",text:e}]},Xt=function(e){return[{zIndex:1,type:"Image",src:e,width:24,height:24,rotation:function(e){return e.properties.rotation}}]},$t=function(){var e=this;this.styleGroups={ADDRESS_LINE:[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#FF0000"}],ADDRESS_ROUTING_POINT:[{zIndex:0,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zIndex:1,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}],ADDRESS_SELECTOR:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}],PLACE_LINE:[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#FF0000"}],PLACE_ROUTING_POINT:[{zIndex:0,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zIndex:1,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}],AREA_SHAPE:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:Yt,radius:function(e){return Zt(e)?6:4},fill:function(e){return Zt(e)?Yt:e.properties.AREA.style[0].fill}}],AREA_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",strokeWidth:1,fill:Yt,stroke:Yt,radius:function(e){return Zt(e)?5:3}}],LINE_SHAPE:[{zIndex:0,type:"Circle",radius:function(e){return e.properties.LINE.style[0].strokeWidth/2+4^0},stroke:function(e){var t=e.properties.LINE.style.filter(function(e){return"Line"==e.type}),r=t.length-1;return r>0?t[r].stroke:Yt},fill:function(e){var t=e.properties.LINE.style;return t.length>1?t[0].stroke:"#151515"},strokeWidth:2}],LINE_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",radius:function(e){return e.properties.LINE.style[0].strokeWidth/2^0},fill:"#151515"}],MARKER_SELECTOR:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}],PLACE_SELECTOR:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}],NAVLINK_SHAPE:[{zIndex:0,type:function(e){return e.properties.isConnected?"Rect":"Circle"},width:function(e){return Zt(e)?18:12},rotation:45,radius:function(e){return Zt(e)?9:6},strokeWidth:2,fill:function(e){return e.isOverlapping()?"#FFFFFF":e.properties.NAVLINK.style[0].stroke},stroke:function(e){return e.isOverlapping()?"#FF0000":"#FFFFFF"}}],NAVLINK_VIRTUAL_SHAPE:[{zIndex:1,type:"Circle",radius:function(e){return e.properties.NAVLINK.style[0].strokeWidth/5},opacity:.7,fill:Yt,stroke:Yt,strokeWidth:2}],NAVLINK_DIRECTION_HINT_1WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACUcHCMfICMgICklJSsnKS4qKzMvLzMvMTo3OD05OlpXWGVjY2pnZ25rbHFub5mXmJ6dncXExMjHx9bV1eXl5e7u7vHx8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABkALAAAAAAfAAwAAAVcYCaO5FgUZaquo7EQyMDOQ20PBGVFikHMKkHDQSQ+KpjkxEE4BIAjwSVJrVItkIQPKrV6qxJGU7bqfr/hMct8TmK1P6CwaEQqmU6o6GbL7XpxeiwuMGSCMwQohyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12}],NAVLINK_DIRECTION_HINT_2WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACMeISMfHyQhISklJisnKS0pKjIuLjMvMUNAQElFRVJPUG5rbHh1do2LjJORkrWztM/OztbW1uvr6////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABUALAAAAAAfAAwAAAV6YCWOpBgYoxGUbEsWhnKMh2IUbl4dBBNRicAgkKBEGISZTjQ4IB4TitTBqDqklMkDcRi4bgsIdkwmQxawkQBBaEjK8LikQUAIBDx3fD+eJwUpBWF8cGdpLU1PUVNVDFdSWlxeSzs9P0FDRUdJlCwwMjQ2OJ0uJykrSyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12}],NAVLINK_DIRECTION_HINT_BLOCKED:[{zIndex:1,type:"Image",src:Jt,rotation:90,width:24,height:24}],NAVLINK_DIRECTION_HINT_A:qt("A"),NAVLINK_DIRECTION_HINT_B:qt("B"),NAVLINK_DIRECTION:[{zIndex:0,type:"Image",src:"data:image/gif;base64,R0lGODdhEAAcALMAAAAAACgbGxwcHCMfHyMfICMhISsrK////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAAAgALAAAAAAQABwAAAQ/EMlJq5WE3Jt3HdngTVk3FiVRjGApbmkKx2ZFy9Qd53pJ9jggjjfk7Dy0URJ5nBUtS6eP+bQ1jVXiVFrDbiURADs=",width:16,height:28,rotation:function(e){return-e.properties.bearing},opacity:.7}],NAVLINK_DIRECTION_NONE:[{zIndex:0,type:"Image",src:Jt,width:24,height:24,rotation:90}],TURN_RESTRICTION_START:[{type:"Image",zIndex:1,src:"data:image/gif;base64,R0lGODdhJAAUAPcAAAAAAAAAgAsDAA4JABMNABcQABoQAAARKwgSABQVMgYWIhMXIQ0YLQ0ZQRsaAAobJBocQAcfLAofUQYgHx0gTQAhzhIheRchXwUiJRAiKwAkxiMkXQclKB8mZwAonhQoKyEpGCUpLwkqoBsqgwQrpgAsygAtuwAtxCEtVgYurTEutQAv02kviQcwq0AwsAExvQAy0QEzxQ4zuA8zpCwzOTczAAE1ywo1xQo3yB45OgM6yww6yxA6wRI6sy46tAA71H87jwA92w890C09bxE+0DM+jh0/yx8/sBxBxAdC1A1C1SFCtABD2xND1BtDuAFF4h5FzxNG2xVHx2dIshZJ2SNK1xtL1kxLJCVM4T5Mx0hMNBZN6xxN3DxNqEBNeXhNjilO0CJP3X9Pph9R4yNT5jlTwyxU3EBUuXZVoytW5DNW1RtX81hXKCxY7S9Z3DtZrEZZsFRZYoZZoSNa7TZa2U5ajj1b0Thc4yFd+S5d5jJd5ktdvU5dnEFexURe0T5f20Jf3T9g1lZgdFdgbzJh7jpi5D5j3VljilxjajNk9z1k7EBl5ktl2JJllS5m/k9ntDto9FRoxF1otjRp/U9p3lhpbGFplHZpklVq0ENr7Utr4mBs0VJt23Rtw2lxrkdy9lVy9E1z6FJz60J0/lx03VB15GF28GV351p45U15/VN57mR58Ft68mZ66ml62Vh77Gh8znV8pHl8x1R9/FV/9GZ/5WqA43CA636AlICA/1uC/FyC9XOC3W6E3HSEwYSEj4uFgGCG93WH1ICHooeHnI6HbnKJ6A+L/2iL8nuMv3OO4GqP/5CPnaeQpImSso+Ti3KU/IuUwIGV8H2W+IKY4ZiYopmZsHea/ZGbzJqbiHqc/oqc4oSd65Od1oWg9QCi/4Si/Jaj2LSjz4uk+o2l55Cm7JGn9qGooI2p/5ip3pKq/KGq5qer1qaswI6w/5W0/5y1/a61q7i446u57Ki9/p6//7/H16zJ/7rL/7TM/7/R/+bm5gD/////qv///wAAACH5BAkAAP8ALAAAAAAkABQAAAj/AP8JHGgLlShUtlyduoWJUStWplqtWtXKFapatmr1EuaL2MCPuCJl+vQJEiEzacCAWeKhzJkyamKmaZNoEiE7eyR5snRJ1kdScYpwMWNlRwwrThpIGOKFzyFEggYJqkNnDhkyY7g0MYLEB5pNAkHtudInTRIbJ2zkQSEAAQgtj1IVMhTIjh9DecJQUdKkiY0SK1h8EXinC5xMVWzEiGHjSAEGEQ4AeDNqjWU8jlKpoqUnjRkwUG7YUDFFFKnEaE8sZmyBwIMJCgDMiHJjx44mXMjoIWSolKpQhqzgOPFElJ8fq5PHuEBAAQYFAjwoXnyiuokTKWQsvoEjxo0SlPzA/7ihXDGEAQ+eAyAxPfmLGNeV39DASI3q8i8SCEgfm73yGO+9998Jf3DxH2P5oYfBAwL4p5yAB9pARxg26IBfAq5xwKCD7gEYIR2A/CBEewhCkOGGJC4GoXwEavJEXzuQSEGGCzSYoocrbkefKFswwYQSRBjFWAcGZPBBCA6IYAN5HbYwAw8xblcCJ/8oUogeTwTxg2I2jGBABDnQ4MAMMJRQgg1o/qBDE0ok8cObTRBxAhas/DMLL9hAo4oeUTQRRQ81IFJJHGx0McksuswySiKEFAKcIZq88soiP7ggRp3L2FIMNcsE88kYUTCxQTbxnPOML+CQsw01yiiDzC60IHFzjTbIuFFBBUDIMdA0zHSzjC6fzPFDGFLg0o4zsURTDTDA/DJMMtfMuswrdtyQxSadNMLLR//MQw886ozjjTfjcMMNJ7CkE0446ZRTjjfgoPMOOtJssw471jTDLbf44JPPR+OMs69AAYMzjjrmhMNtQAA7",width:36,height:20,rotation:function(e){return e.properties.rotation}}],TURN_RESTRICTION_LINE:[{type:"Line",zIndex:0,strokeWidth:5,strokeLinecap:"round",stroke:function(e){return"TURN_RESTRICTION_ALLOWED"==e.properties.sign?"#0000ff":"#ff0000"}}],TURN_RESTRICTION_ONEWAY:Xt(Jt),TURN_RESTRICTION_FORBIDDEN:Xt("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO0AAO4ACPAAAPYlK/YpL/YrMO4sMu9VV/tVV/xWWfxYWu9aW/BaXPBkZvBnafBpav9zdf93efOOj/+Oj/OPkP+PkP+RkvOSk/SenvSfoPSjo/WnqPWpqfe/v/XDxP/Dw/bHyPnOzvnR0fni4v309P749////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACgALAAAAAAYABgAAAb2QJRwKDyRRp/PiHQiOp2lz2VhGAwIi8un9CSeRpKAeEyOjJrPE2gQEAQYGA4HwxgPQOihOnAIOEQlJ4InJSIPfAF4RCMDfRmDkIMZfAMjQyURYo+RnJMBEVwoH2IOnKYnhwEeKCcXYiKnnCJiF0YLAQiBsZF1CkcFARW7nBgBBCIhbBvDkR1iScrMkM4BSgYBE9KDxcckCri60g0BCUyuAbDSI2IWTaN+2hBiqyiYYsvDGmKgQyKNAfhObaAkwgsIRA5GmIBUSF4fRQbZiGmAoUMHDOPGQHRyQkQmMiAjwOpyyQOFBATEEEhAwUMokl6OhFDChGQQADs="),TURN_RESTRICTION_ALLOWED:Xt("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAAA/qgBFqgBLrABTrgBWsQBZrwBdsQJlswBnuAtnsxFntBNoswBpuR5qtSNrtClstj10uEt+w0+AxFCBxG6Pwm6TzXWTxHKVznuXxnyYxoGax4OcyIym1Y+p15Cp1papz5ms0KGy06q41q672LG+2bTA2rzH3r7I3r/J4MLL37/M6MHO6cXO4MfQ4c7V5tDX59DY59Tb6d7j7uDl7uLm8OXp8uns9PHz9/P0+f///wAAAAAAAAAAAAAAAAAAACH5BAkKADsALAAAAAAYABgAAAb/wJ1wKNTVZK0WrKYjOp05VGfSOBwaFA8K9yTqXpgB4YBgMBAHwgDzaj51rALh4VgoEAjFwvEYs9xDcAIKD3iGCw90CA8KAn9ELwV6hngKBwNiDmUIBS9DOBZzlGUHFSUjHKJ9GFw7KAOFo3cRMzo6ILCLBCo7Oh0EEA7Cww4QaDK2IbAOBB5GElYE0tPSlwNttwMQBxM1MAkIFRoZ4xrm4xsXGje2IAIODTEuBQg2tvf4+bYiBgctLgTq6Rt4j98BFS/AXeCwgYPDhw3NsdOhDN4SaGmoTbOGTdm2br6AERtm7AAyigLoEPjQ5EQuWQhoJcv1YEAKIaAIaKLEoJQJThKpCjHDkGNIJAYLRi04ICDTpk5eWAyKdSiRJgcKAjzyskIOnTuU+BAosNXJFwtiyAhDo4YNoC44pEhIIC2BhA5bunTRQeNFkhc03hIJAgA7"),TURN_RESTRICTION_PEDESTRIAN:Xt("data:image/gif;base64,R0lGODdhGAAYAOYAAAAAAO0AAO4ACPAAAPYlK/YpLy0rK/YrMO4tMjMxMUVDRFRTU+9UVvtVV/xVWF9WVvxYWvBZW+9bXWNdXfBjZe9kZmhnZ/BnafBpa2xsbHJxcv9zdf93eX18fISEhIuLi/OOj/+Oj/OPkP+PkP+RkvOSk5iVlZ2dnfSenvSkpPWpqaysrLO0tLy8vPe/v8PDw//Dw/XExMjHyPbHyPnOzsbPz8/Pz8fQ0PnR0dPT09zc3Pri4uPj4+rq6vLy8v3z8////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKAEEALAAAAAAYABgAAAf/gEGCg4JAOzgxMzg7QISOjj8xJBAHAwMFECQxP4+EQDQbAaKjpBs4jY9AMAOjDCApKSIMowMwqIOqAQgBFDQ/QMBAPzQUugG2hDQDuynBzsEougM4gz+hASjP2kDRARycQS6iFdvbFAIBMUFAIaI4NT3OPNs0oiSGDQEMQCwAK8EvFuh49iNCAAiHCAQoAYxHBwUtgOnIwAJYDx9ARAQ4gGOGKBXOcmTw0GLFBwAedACYAERFgAExYnx85iPDAgAADAB48cFEy5cxcChkGIxFghM5ZNiwoMFZiQAEFuWTACyghoE9WKzIgBFYwYOM2gXAceNBjmA+WrCIF6xegHvhUERhKKftgih1QayJakYXWLcN4ILU25WNbjQE0zzBMIbh1DMadnchU8xKlIQSKlSUkEBrsqNP10iVOtWpmosRDRRCdUDCReDSuHbQiEmDUelAADs="),UNKNOWN:[{zIndex:0,type:"Circle",strokeWidth:1,stroke:"#FF0000",fill:"#0000FF",radius:10}]},this.assign=function(t){var r=t.class||t.properties.type;return void 0!==e.styleGroups[r]?r:"UNKNOWN"}},er=function(e){function t(t){void 0===t&&(t={});var r=this;return t.name="EOP",(r=e.call(this,t)||this).id="EOP-"+r.id,r}return d(t,e),t}(a.LocalProvider),tr=function(e){var t=new er;return t._e=function(){return e},new c.TileLayer({name:"EditorOverlay",min:1,max:20,styles:new $t,provider:t})},rr=a.EditableProvider,nr="pointerenter pointerleave pointerup pressmove pointerdown dbltap",ir=function(e){return e.class},or=function(e){for(var t,r=e.length;r--;){if((t=e[r].getProvider())&&"NAVLINK"==t.class)return r+1}return e.length},sr=function(){function r(e,t){this.listen=!1;this.iEdit=e,this.display=t,this.history=new Ht(e),this.selection=new Tt(e,t);var r=tr(e);this.overlay=new Wt(r);var n=new i([[r.id,r]]);this.layers=n,t.addLayer(r,or(t.getLayers())),this.arrangeOverlay=this.arrangeOverlay.bind(this),this.pointerListener=this.pointerListener.bind(this),e.listeners.bind("_layerAdd",function(e){var t=e.detail.layer;n.set(t.id,t)}),e.listeners.bind("_layerRemove",function(t){var r=t.detail.layer;n.delete(r.id);var i=e.objects.selection.getCurSelObj();i&&e.getLayer(i)==r&&e.objects.selection.clearSelected()}),this.onMVCStart=this.onMVCStart.bind(this)}return r.prototype.onMVCStart=function(){this.selection.unselectFeature()},r.prototype.splitLinkAt=function(t){return function(t,r){var n,i,o=r.link,s=r.index,a=r.preferSegment,c=r.avoidSnapping,u=o.coord(),l=u.length-1,d=Ze._props(o),p=t._config.minShapeDistance;if(r.point&&(n=r.point[0],i=r.point[1]),0===s||s===l||n==u[0][0]&&i==u[0][1]||n==u[l][0]&&i==u[l][1])return!1;if(void 0===s){var h=t.map.calcCrossingAt(u,r.point,p,a);if(s=h.index,h.existingShape&&(0===s||s===l))return!1;s=Ze.addShp(o,[n,i],null,!0,null,a),u=o.coord()}Ze.deHighlight(o);var f=o.getProvider(),v=function(r,n){var i=e.extend(!0,{},d),o={type:"Feature",geometry:{type:"LineString",coordinates:r},properties:i};return delete i["@ns:com:here:editor"],t.objects.create([o],f,n,void 0)},A=v(u.slice(0,s+1),c&&s),g=v(u.slice(s),c&&0),y=se(u[s],u);y>.995&&(y=1);var m=ae(u,u[s]).offset,S=Ze.getConnectedObjects(o);for(var E in S){var C=S[E],k=Se.getRoutingPosition(C),x=m>ae(u,k).offset?A:g;Se.connect(C,x,k),Se.markAsModified(C,!1)}return t.hooks.trigger("Navlink.split",{link:o,index:s,children:[A,g],relativePosition:y},f),o.editState("split",Date.now()),t.objects.remove(o,{animation:!1,split:!0}),[A,g]}(this.iEdit,t)},r.prototype.destroy=function(){this.display.removeLayer(this.overlay.layer)},r.prototype.arrangeOverlay=function(e){var t=e&&e.detail.layer,r=this.display,n=this.overlay.layer;if(r.getLayers){var i=r.getLayers();if(!(t.getProvider()instanceof er)){var o=i.map(function(e){var t=e.getProvider();return t&&t.class}).indexOf("NAVLINK");r.removeLayer(n),o>=0?r.addLayer(n,o+1):r.addLayer(n)}}},r.prototype.pointerListener=function(e){var t=this.iEdit,r=e.target,n=e.type;if(r){var i=e.detail.layer;if(!this.layers.has(i.id))return;var o=nt.getEventListener(r,n);if(o)return e.stopPropagation(),o.apply(r,arguments)}"pointerup"!=n&&"dbltap"!=n||t.objects.selection.unselectFeature("viewportChange"==t._config.keepFeatureSelection),t.listeners.trigger(e,null)},r.prototype.listenDisplay=function(e){var t=this.display,r=this.listen,n=this.pointerListener,i=this.arrangeOverlay;e?r||(this.listen=!0,t.addEventListener("mapviewchangestart",this.onMVCStart),t.addEventListener(nr,n),t.addEventListener("addLayer removeLayer",i)):r&&(this.listen=!1,t.removeEventListener("mapviewchangestart",this.onMVCStart),t.removeEventListener(nr,n),t.removeEventListener("addLayer removeLayer",i))},r.prototype.clear=function(){},r.prototype.get=function(e,t){var r=this.iEdit;return t?"object"!=typeof t&&(t=r.getLayer(t)):t=r.getLayer(e),"object"!=typeof e&&t&&(e=t.search(e)),e&&t?e:null},r.prototype.getInBBox=function(e,t){e||(e=[(e=this.display.getViewBounds()).minLon,e.minLat,e.maxLon,e.maxLat]);var r=1/Math.pow(10,this.iEdit._config.intersectionScale);e=[e[0]-r,e[1]-r,e[2]+r,e[3]+r],(t=t||this.layers.values())instanceof Array||(t=[t]);for(var n,i=[],o=0;o<t.length;o++)if(n=t[o].search(e))for(var s=0;s<n.length;s++)i.push(n[s]);return i},r.prototype.remove=function(e,t){var r=!1;if((t=t||{}).split||!this.iEdit._config.editRestrictions(e,2)){var n=null==t.animation||t.animation;n&&nt.private(e,"isSelected")&&this.selection.clearSelected(),ir(e)&&(this.history.origin(e),nt.markAsRemoved(e,n),t.save&&this.history.saveChanges(),r=!0);var i=e.getProvider();return e.editState&&!e.editState("created")&&i.blockFeature(e,!0),i.removeFeature(e),r}},r.prototype.add=function(e,t,r){var n=this.iEdit;if(!e.getProvider()&&("string"==typeof t?t=this.layers.get(t):t||(t=n.getLayerForClass(ir(e))),t)){var i=e.id,o=i!=Dt&&t.search(i);return i!=Dt&&o?o:this.create(e,t.getProvider(),Dt,Dt,r)}},r.prototype.create=function(e,t,r,n,i){var o=this.iEdit,s=[];e=e instanceof Array?e:[e],i=i||{};for(var a=function(a){var c,u=e[a],l=u.id;if(n||(u.id=Dt),u=t.prepareFeature(u),c=t.detectFeatureClass(u),l==Dt&&(l=u.id),i[l]=u.id,u=function(e){return n&&t.blockFeature(e,!1),e=t.addFeature(e),e=t.search(e.id),n||(e.editState("created",Date.now()),nt.markAsModified(e,!1),o.objects.history.origin(e,!0)),s.push(e),e}(u),"NAVLINK"===c)u.geometry.coordinates.forEach(function(e){e[2]=0^e[2]}),n||nt.fixGeo(u,Dt,Dt,r);else if("PLACE"===c||"ADDRESS"===c){var d=nt.getRoutingData(u),p=d.link;if(i[p]){var h=nt.getRoutingProvider(u),f=h&&h.search(i[p]);o.objects.history.ignore(function(){u.getProvider().writeRoutingPoint(u,f,d.position)})}"ADDRESS"===c&&(nt.connect(u),u.getLink()||(o.objects.history.remove(u),t.removeFeature(s.pop()),o.dump("No Link found within "+o._config.maxRoutingPointDistance+" meters","warn")))}},c=0;c<e.length;c++)a(c);return s.length>1?s:s[0]},r.prototype.getNearestLine=function(r,n,i){var o=this.iEdit;i=e.extend({ignore:[],maxDistance:1/0,shapeThreshold:0,onlyExsitingShape:!1},i||{});var s,a,c,u,l,d,p,h,f,v={line:null,point:null,distance:1/0,shpIndex:null,segmentNumber:null},A=r,g=i.maxDistance,y=g<1/0?t.getPointBBox(A,g):null;function m(e){return e[2]===Dt||A[2]===Dt||e[2]===A[2]?t.distance(e,A):1/0}n instanceof rr&&(n=this.getInBBox(y,n)),r=o.map.getPixelCoord(r);for(var S=0,E=n;S<E.length;S++){var C=E[S];if(-1==i.ignore.indexOf(C.id)&&(s=C.bbox,g==1/0||(a=y[0],c=y[2],u=y[1],l=y[3],d=s[0],p=s[2],h=s[1],f=s[3],a<=p&&d<=c&&u<=f&&h<=l))){for(var k,x=C.geometry.coordinates,b=void 0,_=i.maxDistance,I=void 0,P=[],w=void 0,R=void 0,F=0;F<x.length;F++)P[F]=o.map.getPixelCoord(k=x[F]),(R=m(k))<_&&(_=R,I=F,b=0^(F>0&&F-1),w=k);if(!i.onlyExsitingShape&&(w==Dt||_>i.shapeThreshold))for(F=0;F<P.length-1;F++)(k=L(P[F],P[F+1],r))&&(R=m([(k=o.map.getGeoCoord(k))[0],k[1]]))<_&&(_=R,I=null,b=F,w=k);w&&_<v.distance&&(v.point=w,v.distance=_,v.shpIndex=I,v.segmentNumber=b,v.line=C,g=t.distance(w,A),y=t.getPointBBox(A,g))}}return v.line?v:null},r}(),ar=function(){function e(e,t){var r=this;this.busy=null,this.display=t,this.iEdit=e,this.observers=e.observers,this.onStart=this.onStart.bind(this),this.onStop=this.onStop.bind(this),e.listeners.bind("_layerAdd",function(e){e.detail.layer.addEventListener("viewportReady",r.onStop)}),e.listeners.bind("_layerRemove",function(e){e.detail.layer.removeEventListener("viewportReady",r.onStop)})}return e.prototype.onStart=function(){this.busy||(this.busy=new o(this.iEdit.layers),this.observers.change("ready",!1))},e.prototype.onStop=function(e){var t=e.detail.layer,r=this.busy;r&&(r.delete(t),r.size||(this.observers.change("ready",!0),this.busy=null))},e.prototype.start=function(){this.display.addEventListener("mapviewchangestart",this.onStart)},e.prototype.stop=function(){this.display.removeEventListener("mapviewchangestart",this.onStart)},e}(),cr=["Navlink.split","Navlink.disconnect","Feature.remove"],ur=function(e,t){var r=e.__=e.__||String(1e9*Math.random()^0);return t&&(r+=";"+t.id),r},lr=function(){function e(e){this.h=new n(cr),this.h.sync(!0),this.history=e,this.w=new Map}return e.prototype.add=function(e,t,r){var n=ur(t,r),i=this.w.get(n);return i||this.w.set(n,i=function(e,t){var r=function(r,n){t&&n!=t||e(r)};return r.h=e,r}(t,r)),this.h.add(e,i)},e.prototype.remove=function(e,t,r){return this.h.remove(e,this.w.get(ur(t,r)))},e.prototype.get=function(e){return this.h.get(e).map(function(e){return e[0].h})},e.prototype.trigger=function(e,t,r){var n=this.history,i=n.active();n.active(!1),this.h.trigger(e,[t,r]),n.active(i)},e}(),dr=Math.PI/180,pr=function(){return function(e,t,r,n){this.point=[e,t],this.index=r,this.existingShape=n}}();function hr(e,t){if("number"==typeof e[0])return t(e);for(var r=[],n=e.length;n--;)r[n]=hr(e[n],t);return r}var fr,vr=function(){function e(e){this.display=e}return e.prototype.distance=function(e,r){return t.distance(e,r)},e.prototype.rotatePoint=function(e,t,r){return this.clipGeoCoord(function(e,t,r){var n=e[0]-t[0],i=e[1]-t[1],o=r*dr;return[t[0]+(Math.cos(o)*n-Math.sin(o)*i/Math.abs(Math.cos(t[1]*dr))),t[1]+(Math.sin(o)*n*Math.abs(Math.cos(t[1]*dr))+Math.cos(o)*i),0^e[2]]}(e,t,r))},e.prototype.movePoint=function(e,r,n,i){return this.clipGeoCoord(t.movePoint(e,r,n,i))},e.prototype.scaleGeometry=function(e,t,r){var n=this;return hr(e.coordinates,function(e){return n.clipGeoCoord([r[0]+(e[0]-r[0])*t[0],r[1]+(e[1]-r[1])*t[1],0^e[2]])})},e.prototype.rotateGeometry=function(e,t,r){var n=this;return hr(e.coordinates,function(e){return n.rotatePoint(e,t,r)})},e.prototype.getClosestPoint=function(e,t,r){var n=e[0]-t[0],i=e[1]-t[1],o=e[1]*t[0]-e[0]*t[1],s=n*r[0]+i*r[1],a=1/(n*n+i*i);return[(s*n+o*i)*a,(s*i-o*n)*a]},e.prototype.calcCrossingAt=function(e,t,r,n,i){var o,s,a,c=null,u=i||1/0,l=!1,d=null,p=null;if(null!=n){var h=this.calcCrossingAt(e.slice(n,n+2),t,r,void 0,i);return h.index+=n,h}for(var f=0;f<e.length;f++)o=e[f],(a=this.distance(o,t))<=u&&(u=a,d=o[0],p=o[1],c=f,l=!0);if(u>r||!l)for(f=0;f<e.length;f++)f<e.length-1&&(s=L(e[f],e[f+1],t))&&(a=this.distance(s,t))<u&&(u=a,c=f+1,d=s[0],p=s[1],l=!1);return new pr(d,p,c,l)},e.prototype.translateGeo=function(e,t,r){var n=this,i=n.display;return hr(e,function(e){var o=i.geoToPixel(e[0],e[1]);return n.getGeoCoord(o.x+t,o.y+r,e[2])})},e.prototype.pixelMove=function(e,t,r){var n=e.getProvider(),i=this.translateGeo(n.decCoord(e),t,r),o=nt.getTool(e,"_setCoords");o?o(e,i):n.setFeatureCoordinates(e,i)},e.prototype.clipGeoCoord=function(e){return e[0]=Math.round(1e9*e[0])/1e9,e[1]=Math.round(1e9*e[1])/1e9,e},e.prototype.getGeoCoord=function(e,t,r){var n,i=this.display;return arguments.length>1?n=i.pixelToGeo(e,t):null!=(n=e).x&&null!=n.y?(r=n.z,n=i.pixelToGeo(n.x,n.y)):null!=e[0]&&null!=e[1]&&(r=n[2],n=i.pixelToGeo(n[0],n[1])),this.clipGeoCoord([n.longitude,n.latitude,0|r])},e.prototype.getPixelCoord=function(e,t,r){var n=this.display;return 2==arguments.length?e=n.geoToPixel(e,t):null!=e.longitude&&null!=e.latitude?e=n.geoToPixel(e.longitude,e.latitude):null!=e[0]&&null!=e[1]&&(e=n.geoToPixel(e[0],e[1])),[e.x,e.y,0|e.z]},e.prototype.getEventsMapXY=function(e){var t,r,n=this.display;if(null!=e.mapX)t=e.mapX,r=e.mapY;else{var i=n.getContainer().getBoundingClientRect();t=e.pageX-i.left,r=e.pageY-i.top}return[t,r]},e}(),Ar="error",gr=function(){return function(t,r){this._config=t;var n=this;n.observers=new wt,n.listeners=new Nt,n.objects=new sr(n,r),n.hooks=new lr(n.objects.history);var i=new ar(n,r);i.start();var o=n.objects.overlay.layer,s={};function a(e){n.listeners.trigger(Ar,e)}s[o.getProvider().id]=o,n.listeners.bind("_layerAdd",function(e){for(var t=e.detail.layer,r=t.getProvider(),n=0,i=["src","base","delta","id"];n<i.length;n++){var o=r[i[n]];o&&(s[o]=t)}t.removeEventListener(Ar,a),t.addEventListener(Ar,a)}),n.getLayerForClass=function(e){for(var t,r,i,o,s=0,a=n.layers;s<a.length;s++){var c=a[s];c.getProvider&&(o=c.getProvider()),(r=o.class)?e==r&&(i=c):t||(t=c)}return i||t},n.getProviderById=function(e){return s[e].getProvider()},n.getLayerById=function(e){for(var t=0,r=n.layers;t<r.length;t++){var i=r[t];if(i.id==e)return i}},n.getLayer=function(e){var t;if("object"==typeof e){var r=e._provider;e=r.src||r.delta||r.base||r.id}return e&&(t=s[e]),t},n.getStyle=function(t,r){var n=this.getLayer(t).getStyleGroup(t,fr,r);return e.extend(!0,[],n)},n.setStyle=function(e,t,r){this.getLayer(e).setStyleGroup(e,t,r)},n.map=new vr(r),n.transformer=new bt(n),n.display=r,n.destroy=function(){i.stop(),n.objects.destroy(),n.listeners.destroy()},n.dump=e.dump}}(),yr=function(e){var t=e.class;return"NAVLINK"==t?"NAVLINK":String(t)+(e.src||e.base+e.delta||e.id)},mr=function(e,t,r){var n=t.hooks;if(n)for(var i in n){var o=n[i];o instanceof Array||(o=[o]);for(var s=0,a=o;s<a.length;s++){var c=a[s];r.hooks[e](i,c,t)}}},Sr=function(e,t,r){var n={},i=e.layers=[];t.addLayer=function(t){if(t){var r=t.getProvider();if("FeatureProvider"==r.__type&&r.isEditable&&(!n[yr(r)]||"NAVLINK"==r.class)){if(r._e instanceof gr)throw new Error("Provider already in use by another editor");return r._e=e,t.class=r.class,e.listeners.trigger("_layerAdd",{layer:t}),n[yr(r)]=t,i.push(t),mr("add",r,e),!0}}return!1},t.getLayers=function(e){return e?i[e]:i.slice()},t.removeLayer=function(t){if(t){var r=t.getProvider(),o=yr(r);if("FeatureProvider"==r.__type&&r.isEditable&&n[o])return e.listeners.trigger("_layerRemove",{layer:t}),delete n[o],i.splice(i.indexOf(t),1),mr("remove",r,e),delete r._e,!0}return!1},r instanceof Array&&r.forEach(t.addLayer)},Er=function(t){function r(r,n,i,o,s){var a=t.call(this,{type:"Feature",geometry:{type:"Point",coordinates:o},properties:{"@ns:com:here:editor":{},index:i,isMoved:!1}},r.overlay.getProvider())||this;a.type="Feature";var c=r.getFeature().geojson,u=a;return u.properties[s]={properties:e.extend(!0,{},c.properties),style:n.getStyle(c)},u._b=r,u.__={pointerdown:function(){this.properties.isMoved=!1,this.properties.p=n.display.geoToPixel.apply(n.display,this.geometry.coordinates)},pressmove:function(e,t,i,o,s){var a=this.properties.p,c=n.map.getGeoCoord(a.x+t,a.y+i);r.getFeature().update(this.properties.index,c),this._provider.setFeatureCoordinates(this,c.slice()),this.isMoved=!0},pointerup:function(e){this.properties.isMoved||n.listeners.trigger(e,this)}},u.class=s+"_SHAPE",a}return d(r,t),r.prototype.remove=function(){this.__=null,this._b.removeShape(this.properties.index)},r.prototype.getLength=function(){return this._b.getLength()},r.prototype.getIndex=function(){return this.properties.index},r}(s.Feature),Cr=function(){function e(e,t){this.type="LineString",this.path=[],this.geojson=e.addFeature({type:"feature",geometry:{type:"LineString",coordinates:[t,[t[0]-1e-6,t[1]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;t&&(r[e]=t),r.length>1&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(r))},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.createGeo=function(e){return e.slice()},e.prototype.isValid=function(){return this.path.length>1},e}(),kr=function(){function e(e,t){this.path=[],this.type="MultiPolygon",this.geojson=e.addFeature({type:"feature",geometry:{type:"MultiPolygon",coordinates:[[[t,[t[0]-1e-6,t[1]],[t[0]-1e-6,t[1]-1e-6],t]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;t&&(r[e]=t),r.length>2&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(r))},e.prototype.createGeo=function(e){return[[e.concat([e[0]])]]},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.isValid=function(){return this.path.length>2},e}(),xr=[{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:"#000000",strokeWidth:2,radius:6}],Lr=[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#ffffff"}];function br(t,r){var n=e.clone(t||xr);return n.forEach(function(e){return e.zIndex=(0^e.zIndex)+r}),n}var _r=function(){function t(e,t,r){this.shapes=[],this.originLink=null,this.originPos=null;this.overlay=e,this.iEdit=t,this.display=r,this.onBoardUp=this.onBoardUp.bind(this),this.updateMousePosition=this.updateMousePosition.bind(this)}return t.prototype.onBoardUp=function(){this.mousedown=!1},t.prototype.updateMousePosition=function(e){var t=this,r=t.iEdit,n=t.feature,i=t.shapes,o=t.display,s=t.cursor,a=t.mousedown,c=t.overlay;if(a){var u=r.map.getEventsMapXY(e),l=s.properties.prevPos;o.lockViewport().pan||o.pan(u[0]-l[0],u[1]-l[1],0,0),l[0]=u[0],l[1]=u[1]}else{var d=r.map.getGeoCoord(r.map.getEventsMapXY(e));n.update(i.length,d),c.setFeatureCoordinates(s,d)}},t.prototype.init=function(){var e=this,t=e.iEdit,n=e.display,i=e.overlay,o=e.updateMousePosition,s=n.getViewBounds(),a=[s.minLon,s.maxLat];this.feature=new this.FeatureClass(i,a);var c=i.addCircle(a,br(xr,1));c.pointerdown=function(r,n,i){var o=c.properties;o.prevPos=t.map.getEventsMapXY(r),e.mousedown=!0,o.panned=!1},c.pressmove=function(e,t,r,n,i){o(e),c.properties.panned=!0},c.pointerup=function(r){c.properties.panned||e.addShape(t.map.getGeoCoord(r.mapX,r.mapY),void 0,r),e.onBoardUp()},this.cursor=c,r.addEventListener("mousemove",this.updateMousePosition),r.addEventListener("mouseup",this.onBoardUp)},t.prototype.addShape=function(e,t,r){var n,i=this.iEdit,o=this.settings,s=this.shapes,a=this.feature;if(t){if(this.originLink=t,n=t.geometry.coordinates,"number"==typeof e)e=[n[e][0],n[e][1],n[e][2]];else{var c=i.map.calcCrossingAt(n,e,i._config.minShapeDistance);!c.existingShape||0!=c.index&&c.index!=n.length-1||(this.originLink=null),e=c.point}this.originPos=e}var u=this.overlay.addFeature(new Er(this,i,s.length,e,o.mode),br(this.shpStyle,9));a.update(s.length,e),s.push(u),o.onShapeAdd&&o.onShapeAdd(new Rt("onShapeAdd",e[0],e[1],r,r&&r.button,u,{index:u.properties.index}))},t.prototype.removeShape=function(e){var t=this,r=t.shapes,n=t.iEdit,i=t.overlay,o=t.feature,s=t.settings;null==e&&(e=r.length-1);var a=r[e],c=n.map.getGeoCoord(a.geometry.coordinates);i.remove(a),r.splice(e,1),o.removeAt(e);for(var u=e;u<r.length;u++)r[u].properties.index--;o.update(),s.onShapeRemove&&s.onShapeRemove(new Rt("onShapeRemove",c[0],c[1],void 0,void 0,void 0,{index:e}))},t.prototype.getFeature=function(){return this.feature},t.prototype.getLength=function(){return this.shapes.length},t.prototype.setAttributes=function(t){var r=this,n=r.feature,i=r.iEdit,o=r.cursor,s=r.settings,a=r.shapes;if(t){e.extend(n.properties,t);var c=function(t,r){var n,i,o,s,a=t.mode;if(t.styleGroup)n=t.styleGroup;else if("NAVLINK"!=a&&"AREA"!=a||(r.editState=function(){return{}},r.class=a),n=t.layer.getStyleGroup(r),"AREA"!=a)return(s=e.clone(xr))[0].fill=n[0].stroke,(o=e.clone(Lr))[0].stroke=(n[1]||n[0]).stroke,{feature:o,shape:s};var c=function(e){return-1!=["Circle","Image","Rect","Text"].indexOf(e.type)};if(o=n.filter(function(e){return!c(e)}),s=n.filter(c),o.length||(o=t.layer.getStyleGroup(r)),!t.styleGroup||!s.length){s=e.clone(xr);var u=o[0];i=u.stroke;var l=void 0;"AREA"==a?(l=u.fill,i&&(s[0].stroke=i)):l=i,l&&(s[0].fill=l)}return{feature:o,shape:s}}(s,n.geojson);this.shpStyle=c.shape,n.geojson.class=void 0,i.setStyle(n.geojson,c.feature),a.concat(o).forEach(function(e){i.setStyle(e,br(c.shape,i.getStyle(e)[0].zIndex))})}},t.prototype.createGeom=function(){var e=this.feature,t=this.shapes,r=this.settings,n=t.map(function(e){return e.geometry.coordinates});return"AREA"!=r.mode&&(n=S(n,r.generalization||1e-5)),{type:e.type,coordinates:e.createGeo(n)}},t.prototype.create=function(e){var t=this,r=t.iEdit,n=t.FeatureClass,i=t.shapes,o=t.feature,s=t.originLink,a=t.originPos,c=t.settings;if(this.setAttributes(e),n==Cr){var u=i[0].geometry.coordinates;s&&a[0]==u[0]&&a[1]==u[1]&&r.objects.splitLinkAt({link:r.objects.get(s),point:u})}if(o.isValid()){var l=r.objects.create({type:"Feature",geometry:this.createGeom(),properties:o.properties},c.layer.getProvider(),void 0,void 0);return r.objects.history.saveChanges(),this.hide(),l}},t.prototype.isActive=function(){return this.active},t.prototype.show=function(e){if(!this.active){var t=this.overlay.layer,r=this.iEdit,n=this.display;r.objects.listenDisplay(!1),n.removeLayer(t),n.addLayer(t),r.objects.listenDisplay(!0),this.settings=e,"AREA"==e.mode?this.FeatureClass=kr:this.FeatureClass=Cr,this.originLink=null,this.originPos=null,this.active=!0,this.init(),this.setAttributes(e.attributes)}},t.prototype.hide=function(){var e=this.display,t=this.overlay,n=this.shapes,i=this.feature;if(this.active){this.active=!1;var o=t.layer;e.removeLayer(o),e.addLayer(o),t.remove(i.geojson),this.feature=null,n.forEach(function(e){return t.remove(e)}),n.length=0,t.remove(this.cursor),this.cursor=null,r.removeEventListener("mousemove",this.updateMousePosition),r.removeEventListener("mouseup",this.onBoardUp)}},t}(),Ir="AREA",Pr="NAVLINK";function wr(e,t,r){var n=this,i=e.objects.overlay,o=new _r(i,e,e.display),s=o,a=!1;n.addShape=function(t,r){a&&s.addShape(e.map.getGeoCoord(t),r)},n.removeShape=function(e){a&&s.removeShape(e)},n.getLength=function(){return s.getLength()},n.cancel=function(){s.hide(),a=!1},n.setProperties=function(e){a&&s.setAttributes(e)},n.setAttributes=n.setProperties,n.create=function(e){if(a){var t=s.create(e);return t&&(a=!1),t}},n.start=function(t){var i=(t=t||{}).connectTo,c=t.mode||Pr;return c="string"!=typeof c?c===r.features.Area?Ir:Pr:c.toUpperCase(),t.mode=c,t.attributes=t.properties||t.attributes||{},a||(s="FREEHAND"==t.control?touchDraw:o,t.layer=t.layer||e.getLayerForClass(c),(c!=Ir||t.layer)&&(e.listeners.trigger("_clearOverlay"),s.show.call(s,t),a=s.isActive(),t.position&&n.addShape(t.position,i))),a},n.isActive=function(){return a},n.getGeometry=function(){return s.createGeom()}}var Rr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return d(t,e),t}(lt);Rr.prototype.class="MARKER";var Fr=function(e){for(var t,r=[],n=0;n<e.length;n++)for(var i=e[n],o=r[r.length]=[],s=0;s<i.length;s++)o[s]=3==(t=i[s]).length?[t[0],t[1],t[2]]:[t[0],t[1]];return r},Dr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return d(t,e),t.prototype.coord=function(e){var t,r=this.geometry.type;if(e instanceof Array)W.deHighlight(this),W._setCoords(this,e),W.markAsModified(this);else if(e=this.getProvider().decCoord(this),"Polygon"==r)t=Fr(e);else{t=[];for(var n=0;n<e.length;n++)t[n]=Fr(e[n])}return t},t.prototype.addShape=function(e,t,r){var n=!1;return(e=this._e().map.getGeoCoord(e))?(1==arguments.length&&(t=W.getPoly(this,e)),!1!==(n=W.addShp(this,e,0^t,0,r))&&W.markAsModified(this)):function(e){throw new Error(e)}("missing coordinate"),n},t.prototype.addHole=function(e){var t=this;if(e){e=this._e().map.getPixelCoord(e);for(var r=W.getPoly(this,e),n=W.getCoords(this),i=n[r],o=1/0,s=0;s<i.length;s++){var a=W.getMaxSpace(e,i[s]);a<o&&(o=a)}if((o=Math.floor(.5*o))>8){var c=e[0],u=e[1],l=[[c-o,u+o],[c+o,u+o],[c+o,u-o],[c-o,u-o],[c-o,u+o]].map(function(e){return t._e().map.getGeoCoord(e)});W.isClockwise(i[0])||l.reverse(),i.push(l),W._setCoords(this,n,!0),W.markAsModified(this)}}},t}(lt);Dr.prototype.class="AREA";var Nr,Tr="#FFFFFF",Or="#FF0000",Br="#000000";function jr(t,r,n){var i,o=this,s=t.objects.overlay,a=n.link,c=n.candidate,u=n.searchPnt,l=n.foundPnt||u,d=!!n.foundPnt,p=t.map.getPixelCoord(n.cx,n.cy),h={zIndex:0,type:"Line",stroke:Or,strokeWidth:22,strokeLinecap:"round",opacity:.5},f={zIndex:1,type:"Line",stroke:Tr,strokeWidth:18,strokeLinecap:"round",opacity:.8},v={zIndex:2,type:"Line",stroke:Br,strokeWidth:14,strokeLinecap:"round",opacity:.8},A={zIndex:3,type:"Circle",stroke:Or,strokeWidth:1,opacity:.5,radius:12,fill:Or},g={zIndex:4,type:"Circle",stroke:Tr,strokeWidth:2,opacity:1,radius:10,fill:Tr},y={zIndex:5,type:"Circle",stroke:Tr,radius:3,fill:Tr};function m(e){return t.getStyle(e)[0].stroke}function S(){return E(a,u)}function E(e,t){for(var r=e.coord(),n=0;n<r.length;n++)if(t.x==r[n][0]&&t.y==r[n][1])return n;return k(r,[t.x,t.y])}o.class="CROSSING"+(d?"_CANDIDATE":""),o.type="Feature",o.geometry=d?{type:"LineString",coordinates:[[u.x,u.y],[l.x,l.y]]}:{type:"Point",coordinates:[n.cx,n.cy]},o.x=p[0],o.y=p[1],o.getRelatedLink=function(){return c};var C=t.display.geoToPixel(u.x,u.y),x=t.display.geoToPixel(l.x,l.y);o.distance=_([C.x,C.y],[x.x,x.y]),o.connect=function(){if(!c.id||!a.id||c.editState("removed")||c.editState("modified")>r.createTS||a.editState("removed")||a.editState("modified")>r.createTS)return!1;var e,n,i=E(c,l),s=[];for(var u in d||(e=nt.addShp(a,t.map.clipGeoCoord([l.x,l.y]),null,!0)),n=d?S():e,!1!==S()&&(d&&a.getConnectedLinks(n).forEach(function(e){nt.markAsModified(e,!1,!1)}),(nt.connectShpToLink(a,n,c,t.map.clipGeoCoord([l.x,l.y]),i,!1,!0).splittedInto||[]).forEach(function(e){null!=e&&s.push(e)})),o.hide(),o)"type"!==u&&(o[u]=Nr);return o.isDeleted=!0,r.getCrossings({links:s,croLink:a})},o.show=function(){i=i||function(n,i,o,a,c){var u=r.cStyles,l=m(o),d=m(a),p=e.extend;function S(e){return s.addPath([[n.x,n.y],[i.x,i.y]],e)}function E(e,t){return s.addCircle([e.x,e.y],t)}function C(e){t.listeners.trigger(e,c)}if(p(h,u.connector1),p(f,u.connector2),p(v,u.connector3),p(A,u.search1),p(g,{fill:l},u.search2),p(y,{fill:d,stroke:d},u.found),l&&d){var k=[S(h),S(f),S(v),E(n,A),E(n,g),E(i,y)];return k.forEach(function(e){e.pointerup=C}),k}}(u,l,a,c,o),t.objects.overlay.showFeature(i)},o.hide=function(){i&&i.forEach(function(e){e._provider.removeFeature(e)}),i=null},o.getLink=function(){return a},o.getConnectedLinks=function(){return d?a.getConnectedLinks(S()):[]}}function Mr(e,r){var n,i,o,s,a,c=this,u=[],l=[],d=!1,p="CROSSING",h=p+"_CANDIDATE";function f(t,r,n,i){var o=this,s=null,a=i||n;o.candidate=r,o.link=t,o.foundPnt=i,o.searchPnt=n,o.distance=i?_([n.x,n.y],[i.x,i.y]):0,o.cx=(a.x-n.x)/2+n.x,o.cy=(a.y-n.y)/2+n.y,o.getSimplified=function(){return s||(s=new jr(e,c,o))}}function v(t,r,n){var i=[],o=t.coord();function s(r){for(var n=!1,i=[],s=function(e,t){for(var r,n=[],i=0;i<e.length-1;i++)for(var o=0;o<t.length-1;o++)(r=x(e[i],e[i+1],t[o],t[o+1]))&&(r.s1=i+1,r.s2=o+1,n.push(r));return n}(o,r.coord()),c=0,u=0,l=s.length;c<l-1;u=++c)for(var d=s[c],p=void 0;++u<l;)p=s[u],d[0]==p[0]&&d[1]==p[1]&&Math.abs(p.s1-d.s1)<=1&&Math.abs(p.s2-d.s2)<=1&&(s.splice(u--,1),l--);for(c=0;c<s.length;c++){n=!1;for(var h=0,v=void 0;h<a.length;h++)if((v=a[h]).link.id==r.id&&Ze.isIntersection(e,s[c],v.link.coord()[v.index])){n=!0;break}n||i.push(new f(t,r,{x:s[c][0],y:s[c][1]}))}return i}if(!t.editState("removed")){var a=t.getConnectedLinks(0,!0).concat(t.getConnectedLinks(o.length-1,!0));n.forEach(function(e){i=i.concat(s(e))})}return i}function A(r){var s,u=[];c.createTS=+new Date,(r.length==a?[r]:r).forEach(function(r){if(!(r.editState("removed")||o&&o!=p&&o!=h)){var c=t.extendBBox(r.getBBox(),n),l=e.objects.getInBBox(c,r.getProvider()),A=l.indexOf(r);-1!=A&&l.splice(A,1),o!=h&&(u=u.concat(v(r,0,l))),o!=p&&r.coord().forEach(function(t,o){(s=function t(r,o,s,c){var u,l,p;if(s===a)for(var h in u=r.getConnectedLinks(o,!0),s=[r.id],u)s.push(u[h].link.id);return l=r.coord(),null!=(p=e.objects.getNearestLine(l[o],c,{ignore:s,maxDistance:n,shapeThreshold:i,onlyExsitingShape:d}))&&function(e,t){for(var r in e)if(-1!=t.indexOf(e[r].link.id))return!0;return!1}(p.line.getConnectedLinks(p.shpIndex,!0),s)?(s.push(p.line.id),t(r,o,s,c)):p}(r,o,a,l))&&u.push(new f(r,s.line,{x:t[0],y:t[1],index:o},{x:s.point[0],y:s.point[1],index:s.shpIndex}))})}});for(var l=0,A=void 0;l<(A=u.length);l++)for(;l<--A;)u[l].cx==u[A].cx&&u[l].cy==u[A].cy&&u[l].candidate==u[A].candidate&&0==u[A].distance&&u[A].foundPnt&&u[l].searchPnt.x==u[A].searchPnt.x&&u[l].searchPnt.y==u[A].searchPnt.y&&u.splice(A,1);return u}c.getRelatedLink=function(){return r},c.setRelatedLink=function(e){e&&(s=[r=e])},c.setRelatedLink(r),c.clear=function(){c.createTS=0,l.forEach(function(e){e.hide&&e.hide()}),u.length=0,l.length=0},c.getCrossings=function(t,a){return t=t||{},c.setRelatedLink(a),t.links?t.croLink&&t.links.length&&(s=s.concat(t.links)):(o==t.class&&n==t.maxDistance||(c.createTS=0),c.cStyles=t.styles||{},o=t.class),n=t.maxDistance||e._config.XTestMaxDistance||3,i=e._config.minShapeDistance,(!c.createTS||r.editState("modified")>c.createTS||t.links)&&(c.clear(),u=A(s)),l.length=0,u.forEach(function(e,t){l[t]=e.getSimplified()}),l}}var Gr=function(){function e(e){this.hide=function(){return e.hideRestrictions()},this.isActive=function(){return e.isActive()}}return e.prototype.hide=function(){},e.prototype.isActive=function(){return!1},e}(),Hr=function(e){return e.getProvider().readPedestrianOnly(e)},zr=function(e){return e.getProvider().readDirection(e)},Kr=function(e,t,r,n){var i=zr(r);return r.getZLevels()[n]===e.getZLevels()[t]&&("BOTH"==i||(0==n?"START_TO_END":"END_TO_START")==i)},Ur=function(e,t,r,n,i){t.getProvider().writeTurnRestriction(e,{index:r,link:t},{index:i,link:n})},Vr=8e-5,Qr="TURN_RESTRICTION_",Wr=function(e,t,r,n){var i=function(e,t,r,n){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:n})}(e,t,r,n);return Kr(e,t,r,n)?i?"FORBIDDEN":Hr(r)?"PEDESTRIAN":"ALLOWED":"ONEWAY"},Jr=function(){function e(e,r,n,i,o,s){var a=e.objects.overlay,c=0==o?1:i.coord().length-2,u=i.coord(),l=u[o].slice(),d=u[c].slice(),p=C(l,d,Vr),h=Wr(r,n,i,o),f=a.addPath([p,l,s],null,{type:Qr+"LINE",sign:Qr+h}),v=a.addImage(p,null,{type:Qr+h,rotation:-t.calcBearing(l,p)});this.sign=v,this.line=f,this.overlay=a,this.to=i,this.from=r,Ze.showDirection(i),a.remove(f),v.pointerenter=function(){a.addFeature(f)},v.pointerleave=function(){a.remove(f)},v.pointerup=function(){Kr(r,n,i,o)&&!Hr(i)&&(e.objects.history.ignore(function(){Ur("ALLOWED"==h,r,n,i,o)}),h="ALLOWED"==h?"FORBIDDEN":"ALLOWED",e.objects.history.saveChanges()&&(v.properties.type=Qr+h,f.properties.sign=v.properties.type,e.setStyle(v),e.setStyle(f)))}}return e.prototype.hide=function(){Ze.hideDirection(this.to),this.overlay.remove(this.sign),this.overlay.remove(this.line),this.sign=null,this.line=null},e}(),Yr=function(){function e(e){var t=this;this.editor=e,this.overlay=e.objects.overlay,this.trs=[],e.listeners.bind("_clearOverlay",function(){return t.hideRestrictions()})}return e.prototype.hideCar=function(){this.car&&this.overlay.remove(this.car),this.car=null},e.prototype.showCar=function(e,r){var n=e.coord(),i=0==r?1:n.length-2,o={geometry:{coordinates:C(n[r],n[i],1e-4),type:"Point"},type:"Feature",properties:{type:"TURN_RESTRICTION_START",rotation:-t.calcBearing(n[r],n[i])}};this.car=this.overlay.addFeature(o)},e.prototype.showRestrictions=function(e,t){var r=this,n=zr(e);if(!("B"!=n&&(0==t?"F":"T")==n||Hr(e))){var i=e.getConnectedLinks(t,!0);i.length&&this.showCar(e,t),this.trs=i.map(function(n){return new Jr(r.editor,e,t,n.link,n.index,r.car.geometry.coordinates)})}},e.prototype.hideRestrictions=function(){var e=this.trs;for(var t in e)e[t].hide(),e[t]=null;e.length=0,this.hideCar()},e.prototype.isActive=function(){return this.trs.length>0},e}(),Zr="NAVLINK_DIRECTION_HINT_A",qr="NAVLINK_DIRECTION_HINT_B",Xr="NAVLINK_DIRECTION_HINT_1WAY",$r="NAVLINK_DIRECTION_HINT_2WAY",en="NAVLINK_DIRECTION_HINT_BLOCKED",tn=function(){function e(e,r,n,i){var o=r.coord(),s="END_TO_START"==n?180:0,a=[];i||a.push(e.addPoint(o[0].slice(),{type:Zr}),e.addPoint(o[o.length-1].slice(),{type:qr}));for(var c=0;c<o.length-1;c++){var u=o[c],l=o[c+1],d={type:"BLOCKED"==n?en:"BOTH"==n?$r:Xr};"BLOCKED"!=n&&(d.bearing=s-t.calcBearing(u,l)),a.push(e.addPoint(b(u,l,.5),d))}this.overlay=e,this.points=a}return e.prototype.destroy=function(){this.overlay.remove(this.points),this.points=null},e}(),rn=function(e){throw new Error(e)},nn=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e.setGeoFence=function(t){(isNaN(t)||t<0)&&rn("Geofence radius should be a positive Number"),e._e()._config.geoFence=+t},e}return d(r,t),r.prototype.checkCrossings=function(e){var t=Ze.private(this),r=t.xt||new Mr(this._e(),this);return t.xt=r,r.getCrossings(e)},r.prototype.showDirectionHint=function(e,t){e={B:"BOTH",F:"START_TO_END",T:"END_TO_START",N:"BLOCKED"}[e]||e;var r=Ze.private(this),n=r.dh;n&&n.destroy(),r.dh=e&&new tn(this._e().objects.overlay,this,e,t)},r.prototype.addShape=function(e,t){var r=!1;return(e=this._e().map.getGeoCoord(e))?!1!==(r=Ze.addShp(this,e,t,void 0,!0))&&Ze.markAsModified(this):rn("missing pixel coordinate"),r},r.prototype.getConnectedLinks=function(e,t){void 0===t&&(t=!1);var r,n,i=this._e(),o=this.coord(),s=o[e],a=[];if(0==e||e==o.length-1)for(var c=0,u=i.objects.getInBBox(this.bbox,this.getProvider());c<u.length;c++){var l=u[c];l.id!=this.id&&"NAVLINK"==l.class&&(n=(r=l.coord()).length-1,null!=(e=Ze.isIntersection(i,r[0],s)?0:Ze.isIntersection(i,r[n],s)?n:null)&&a.push(t?{index:e,link:l}:l))}return a},r.prototype.getZLevels=function(){for(var e=this.geometry.coordinates,t=e.length,r=[];t--;)r[t]=e[t][2]||0;return r},r.prototype.setZLevels=function(e){var t=this.getZLevels().length;e instanceof Array||rn("Invalid 'zlevel' argument given, no array"),e.length!==t&&rn("Given 'zlevel' argument is of an invalid size, a length of "+t+" is required!"),this._e().objects.history.origin(this);for(var r=this.geometry.coordinates,n=!1,i=0,o=void 0;i<e.length;i++)(o=0^e[i])!=r[i][2]&&(r[i][2]=o,n=!0);n&&(Ze.refreshGeometry(this),Ze.markAsModified(this))},r.prototype.editTurnRestrictions=function(e){var t=this.coord(),r=0==e||e==t.length-1?[e]:void 0===e?[0,t.length-1]:[],n=[],i=this._e();i.listeners.trigger("_clearOverlay");for(var o=0;o<r.length;o++){var s=new Yr(i);s.showRestrictions(this,r[o]),n.push(new Gr(s))}return n},r.prototype.prop=function(t,r){var n=this._e(),i=!1,o=arguments.length,s=this.getProvider().getFeatureProperties(this);if(0==o||1==o&&"string"==typeof t){var a=t?s[t]:s;return"object"==typeof a?e.extend(!0,new a.constructor,a):a}var c=t;if(2==o){var u={};u[t]=arguments[1],c=u}for(var l in c){var d=c[l],p="object"==typeof d,h=s[l];(p&&JSON.stringify(d)!=JSON.stringify(h)||!p&&h!==d)&&(i||(n.objects.history.origin(this),i=!0),s[l]=d)}i&&(n.setStyle(this),this.editState("selected")&&Ze.showDirection(this),Ze.markAsModified(this))},r}(lt);nn.prototype.class="NAVLINK";var on,sn="currentChangeStep";function an(){}var cn,un,ln=an.prototype;function dn(e,t,r,n){function i(t,r){t=(""+t).split(" ");for(var n=0;n<t.length;n++)r(t[n],e[t[n]])}return{add:function(e,n,o){i(e,function(e,i){var s=n;i&&(i[i.length]=n,s=i[i.length]=i[0]?t(e,n,o):o,e=i[0]),e&&r(e,s,o)})},remove:function(e,t,r){i(e,function(e,i){if(i){var o=i.indexOf(t);-1!=o&&(e=i[0],t=i[o+1],i.splice(o,2))}e&&n(e,t,r)})}}}function pn(e,t){!function(e,t){var r=lt.prototype,n=Rr.prototype,i=Dr.prototype,o=nn.prototype;n.toFront=function(){},n.setIcon=function(e,t,n,i,o){var s;"object"==typeof e&&(e.offset,n=e.height,t=e.width,e.animation,e=e.icon),(e||t!==on||n!==on)&&(s=r.style.call(this),e&&(s[0][1].src=e),t!==on&&n!==on&&(s[0][1].width=t,s[0][1].height=n),r.style.call(this,s))},n.style=function(e){if("string"==typeof e||!arguments.length)return r.style.apply(this,arguments)[0][1];var t=r.style.call(this);t[0][1]=e,r.style.call(this,t)},i.style=function(e){if(!e)return r.style.call(this)[0][1];if("default"===e)e=r.style.call(this,e);else if("object"==typeof e){var t=r.style.call(this);t[0][1]=e,e=t}r.style.call(this,e)},o.style=function(e){var t;if("string"==typeof e||!arguments.length)return t={},(e=r.style.apply(this,arguments))[0]&&(t.outline=e[0][1]),e[1]&&(t.inline=e[1][1]),t;t=[],e.outline&&(t[0]=[0,e.outline]),e.inline&&(t[1]=[1,e.inline]),r.style.call(this,t)};var s=here.xyz.maps.editor.GeoCoordinate;r.getGeoCoordinates=function(){var e,t=this.geometry.type,r=this.coord(),n=r.length;if("Point"==t)return new s(r[0],r[1],r[2]);var i=[];if("LineString"==t)for(var o=0;o<n;o++)e=r[o],i[o]=new s(e[0],e[1],e[2]);else for(var a=0;a<r.length;a++)for(var c=r[a],u=i[a]=[],l=0;l<c.length;l++)for(var d=c[l],p=u[u.length]=[],h=0;h<d.length;h++)e=d[h],p[h]=new s(e[0],e[1],e[2]);return i},r.getPixelCoordinates=function(){var e,r,n,i=this.geometry.type,o=this.coord();if("Point"==i)n=o[2],(e=t.geoToPixel(o[0],o[1])).z=n;else if(e=[],"LineString"==i)for(var s=o.length,a=0;a<s;a++)n=(r=o[a])[2],e[a]=t.geoToPixel(r[0],r[1]),e[a].z=n;else for(var c=0;c<o.length;c++)for(var u=o[c],l=e[c]=[],d=0;d<u.length;d++)for(var p=u[d],h=l[l.length]=[],f=0;f<p.length;f++)n=(r=p[f])[2],h[f]=t.geoToPixel(r[0],r[1]),h[f].z=n;return e},r.setCoordinates=function(e){var t,r,n=[],i=[];function o(e){var t=(e=this._e().map.getGeoCoord(e))[0],r=e[1],n=e[2];return"number"!=typeof t||"number"!=typeof r?"Point is neither valid pixel nor valid WGS coordinate!":r>90||r<-90||t>180||t<-180?"Coordinates out of bounds! Defective coordinate: ["+t+", "+r+"]":i[1]!=r||i[0]!=t||i[2]!=e[2]?(i=e,(n=+n)!=n||n<-4||n>5||n!==~~n?"invalid zLevel: "+n+" ,the value must be an integer between -4 and +5 and is ":[t,r,n||0]):void 0}if("NAVLINK"==this.class){for(var s=0;s<e.length;s++){if(r=null,"string"==typeof(t=o(t=e[s]))){r=t;break}t&&n.push(t)}r||n.length<2&&(r="Coordinates should be an array, A line needs to have at least two coordinates!")}else"Point"==this.geometry.type?"string"==typeof(n=o(e))&&(r=n):n=e;r?this._e().listeners.trigger("error",{name:"InvalidCoordinates",message:r}):this.coord(n)},r.getAttributes=function(e){return e&&this.prop(e)||this.prop()},r.setAttributes=function(e,t){return this.prop.apply(this,arguments)},r.attr=r.prop}(0,t);var r=here.xyz.maps.editor.objects=here.xyz.maps.editor.features;r.POI=r.Place,r.Link=r.Navlink,e.zoneSelector=e.getZoneSelector(),e.drawingManager=e.getDrawingBoard();var n=e.changes={undo:e.undo,redo:e.redo,info:e.info,import:e.import,export:e.export,revert:e.revert,submit:e.submit,length:0,currentStep:0,totalSteps:0};e.addObserver("history.current",function(t,r,o){n.currentStep=r,n.length=e.get("changes.length"),n.totalSteps=e.get("history.length");for(var s=i[sn],a=1;a<s.length;a+=2)s[a].call(s[a+1],sn,r,o)}),e.layers={add:e.addLayer,remove:e.removeLayer,get:e.getLayers},e.listeners=dn({dblclick:["dbltap"],click:["pointerup"],mouseover:["pointerenter"],mouseout:["pointerenter"]},function(e,t,r){return function(n){var i={};for(var o in n)i[o]=n[o];null==i.target&&(i.target=new an),i.type=e,t.call(r,i)}},e.addEventListener,e.removeEventListener);var i={sync:["ready"],totalSteps:["history.length"],zoomLevel:[null],currentChangeStep:[null]},o=t.getZoomlevel();t.addObserver("zoomlevel",function(e,t,r){if(t=Math.round(t),o!=t){for(var n=i.zoomLevel,s=1;s<n.length;s+=2)n[s].call(n[s+1],"zoomLevel",t,o);o=t}}),e.observers=dn(i,function(e,t,r){return"sync"==e?function(n,i,o){t.call(r,e,o,i)}:function(n,i,o){t.call(r,e,i,o)}},e.addObserver,e.removeObserver);var s={currentChangeStep:"history.current",totalSteps:"history.length"};e.observers.get=function(t){return"sync"==t?!e.get("ready"):e.get(s[t]||t)},e.objects={add:e.addFeature,get:e.getFeature,createContainer:e.createFeatureContainer,clearSelection:e.clearObjectSelection};var a=!1,c=e.viewport={center:null,topLeft:null,bottomRight:null,block:function(e){var r=!1,n=!1;return e!==on&&(a=e,n="number"==typeof e?e:(r=e)?!e:e,t.lockViewport({pan:r,minLevel:n})),!("number"==typeof a||!1===a)},getObjects:function(r,n,i){for(var o,s={minLon:1/0,maxLon:-1/0,minLat:1/0,maxLat:-1/0},a=0,c=0,u=void 0;c<arguments.length;c++)if((u=arguments[c])instanceof Array)o=u;else if("string"==typeof u)o=[u];else if("object"==typeof u){u.x!=on&&u.y!=on&&(u=t.pixelToGeo(u)),a++;var l=u.longitude,d=u.latitude;l<s.minLon&&(s.minLon=l),l>s.maxLon&&(s.maxLon=l),d<s.minLat&&(s.minLat=d),d>s.maxLat&&(s.maxLat=d)}a||(s=t.getViewBounds());var p=e.search({rect:s,filter:o&&function(e){return-1!=o.indexOf(e._provider.detectFeatureClass(e))}});return e.createFeatureContainer.apply(e,p)}};e.addObserver("ready",function(){var e=t.getViewBounds();c.topLeft={longitude:e.minLon,latitude:e.maxLat},c.bottomRight={longitude:e.maxLon,latitude:e.minLat},c.center=t.getCenter()}),e.show=function(){return e.active(!0),e},e.hide=function(){return e.active(!1),e},e.legacy=!0}function hn(e){return function(t){var r,n=[];if("object"==typeof t)for(var i=t.filter,o=t.layers||e.layers,s=o.length;s--;)for(var a=o[s].search(t),c=a.length;r=a[--c];)i&&!i(r)||n.push(r);return n}}function fn(t,r){r.addEventListener=function(r,n,i){var o=function(){var e=t.supported.apply(t,arguments);if("boolean"==typeof e)return e;return e.filter(function(e){return"_"!=e[0]})}();String(r).split(" ").forEach(function(r){o.indexOf(r)>-1?t.bind.call(t,r,n,i):e.dump(r+" is not a valid event. Use: "+o.join(", "),"warn")})},r.removeEventListener=function(){t.remove.apply(t,arguments)}}function vn(e,t){t.addObserver=function(t,r,n){e.addObserver(t,r,n)},t.get=function(t){return e.get(t)},t.removeObserver=function(t,r){e.removeObserver(t,r)}}function An(e,r,n,i,o,s,a,c,u){function l(e){var t=n.coord();return R(t,P(t)*e)}i=i.toUpperCase();var d=l(o),p=r.addPoint(d.slice(),[{zIndex:11,type:"Rect",fill:s,width:10,height:30}]),h=!1;function f(i,o){var s=n.coord(),a=k(s,o),c=E(s[a],s[a+1]),u=i.properties,l=o[0],d=o[1];c="L"===i.side?t.calcBearing(s[a],s[a+1]):t.calcBearing(s[a+1],s[a]);var p=e.getStyle(i);p[0].rotation=-c,e.setStyle(i,p),r.setFeatureCoordinates(i,o.slice()),u.x=l,u.y=d}p.side=i,this.getRelPosOfSubLink=function(e){var t=p.properties,r=[t.x,t.y],i=k(n.coord(),r);if(i>=e.from&&i<e.to){var o=e.link.coord(),s=se(r,e.reversed?o.reverse():o);return s>.995?1:s}return i<e.from?0:1},f(p,d),p.pressmove=function(t,r,i,s,u){if(!a()){var d=n.coord(),v=ae(d,e.map.getGeoCoord(t.mapX,t.mapY)),A=l(v.offset);o=v.offset,f(p,A),c(),h=!0}},p.pointerdown=function(){h=!1},p.pointerup=function(){h&&u()},this.remove=function(){r.remove(p)},this.getRelPos=function(){return o}}function gn(e,t){return e.concat(t.slice(1))}function yn(e,t,r){var n,i,o=[],s=[],a=this;if(r===cn)return null;function c(e,t,r,n){return{zIndex:e,type:"Line",stroke:t,strokeWidth:r,strokeDasharray:n||"none",strokeLinejoin:"round",strokeLinecap:n?"butt":"round"}}n=r.coord();var u=[c(0,"white",23),c(1,"grey",20),c(2,"white",3,[5,4])];function l(){t.setFeatureCoordinates(i,n)}function d(){t.remove(i)}function p(){s.forEach(function(e){e.remove()}),s.length=0}i=t.addPath(n,u),d(),o.push({from:0,to:n.length-1,link:r,reversed:!1}),l(),this.getChilds=function(){return o},this.coord=function(){return n.map(function(e){return e.slice()})},this.show=function(r){p(),t.addFeature(i,u),r.forEach(function(r){var n,i=r.side,o=r.style||{},c=o.stroke||"#ff4040";function u(){r.onChange&&r.onChange(n)}-1!=["L","R","B"].indexOf(i)&&((n={_zone:r,line:t.addPath([[0,0],[0,0]],[{zIndex:4,type:"Line",strokeWidth:9,opacity:o.opacity||.6,stroke:c}]),markers:[],remove:function(){t.remove(this.line),this.markers[0].remove(),this.markers[1].remove()},locked:function(){return!!r.locked},draw:function(){var e=n.markers[0].getRelPos(),r=n.markers[1].getRelPos(),i=a.coord(),o=P(i);if(e>r){var s=e;e=r,r=s}t.setFeatureCoordinates(n.line,w(i,e*o,r*o))}}).markers.push(new An(e,t,a,i,r.from,c,n.locked,n.draw,u),new An(e,t,a,i,r.to,c,n.locked,n.draw,u)),s.push(n),n.draw())})},this.addLink=function(t){var r=t.coord(),i="CASE ";function s(e,t){return e[0]===t[0]&&e[1]===t[1]}function a(e,i,s){if(s&&r.reverse(),0===e){for(var a=0;a<o.length;a++)o[a].from+=i,o[a].to+=i;n=gn(r,n)}else n=gn(n,r);o.unshift({from:e,to:i,link:t,reversed:!!s})}Ze.defaults(t),s(r[r.length-1],n[0])?(i+="0->N",a(0,r.length-1)):s(r[0],n[0])?(i+="0->0",a(0,r.length-1,!0)):s(r[0],n[n.length-1])?(i+="N->0",a(n.length-1,n.length+r.length-2)):s(r[r.length-1],n[n.length-1])&&(i+="N->N",a(n.length-1,n.length+r.length-2,!0)),e.dump(i),l()},this.destroy=function(){d(),p()},this.coord=function(){return n},this.getZones=function(e,t){return s},this.getZoneSegments=function(e){var t=e.markers[0],r=e.markers[1],n=[];function i(e){var t=e[0];e[0]=e[1],e[1]=t}return o.forEach(function(e){var o=[t.getRelPosOfSubLink(e),r.getRelPosOfSubLink(e)];o[0]>o[1]&&i(o),e.reversed&&(i(o),o[0]=1-o[0],o[1]=1-o[1]),o[0]!==o[1]&&n.push([e.link,o[0],o[1],e.reversed])}),n}}function mn(e,t){var r=null,n={ref:null,nref:null},i=[];this.getCollection=function(){return r},this.show=function(e){r&&r.show(e)},this.hide=function(){for(var e=0;e<i.length;e++)Ze.defaults(i[e]);i=[],n={ref:null,nref:null},r&&(r.destroy(),r=null)},this.addLink=function(o){var s,a,c;if(null!=o&&(c=o.coord().length-1,(a=!i.length)&&(n.ref=o.getConnectedLinks(0,!0),n.nref=o.getConnectedLinks(c,!0),i.push(Ze.deHighlight(o)),r=new yn(e,t,o,"B")),s=function(e){for(var t in n)for(var r in n[t])if(e.id===n[t][r].link.id)return t;return null}(o))){var u=i[i.length-1],l=n[s];for(var d in Ze.deHighlight(u),l)Ze.defaults(l[d].link),l[d].link.id==o.id&&(n[s]=o.getConnectedLinks(0==l[d].index?c:0,!0),i.push(o),r.addLink(o))}return!(!s&&!a)},e.display.addEventListener("mapviewchangestart",this.hide)}function Sn(e){var t,r=new mn(e,e.objects.overlay);function n(e){var t=[];return r.getCollection().getZoneSegments(e).forEach(function(e){t.push({Link:e[0],from:e[1],to:e[2],reversed:e[3]})}),t}this.add=function(e){e=e instanceof Array?e:[].slice.call(arguments);for(var t=0;t<e.length;t++)e[t]instanceof lt&&r.addLink(e[t])},this.show=function(e){(t=e instanceof Array?e:[].slice.call(arguments)).forEach(function(e){var t=e.onChange;e.from=e.from||0,e.to=(e.to==un?1:e.to)||0,t&&(e.onChange=function(e){t(n(e))})}),r.show(t)},this.hide=r.hide,this.info=function(){var e=[],t=r.getCollection();t&&t.getZones().forEach(function(t){var r=t._zone;r.segments=n(t),e.push(r)});return e}}ln.type="Feature",ln.class="GROUND",ln.bbox=[-180,-90,180,90],ln.properties={"@ns:com:here:editor":{}},ln.geometry={type:"Polygon",coordinates:[[[-180,90],[180,90],[180,-90],[-180,-90],[-180,90]]]};var En,Cn={debug:!0,editRestrictions:function(){return!1},services:{reverseGeocoder:{}},destination:function(e){e instanceof Array||(e=[e]);for(var t=document.getElementsByTagName("script"),r="toLowerCase",n="",i=0;i<e.length;i++)for(var o=t.length-1;o>=0;--o){var s=t[o].src[r](),a=s.indexOf(e[i][r]());if(a>=0)return n=s.substr(0,a)}return n}(["mapedit.js"]),geoFence:!1,minShapeDistance:2,autoConnectShapeDistance:2,intersectionScale:5,XTestMaxDistance:2,disconnectShapeDistance:3,keepFeatureSelection:"viewportChange",featureSelectionByDefault:!0,enableHover:!0,maxRoutingPointDistance:1e3,autoSnapShape:!1},kn=function(t){var r=e.extend(!0,{},Cn);for(var n in t)switch(n){case"services":e.extend(!0,r[n],t[n]);break;case"editRestrictions":if("function"!=typeof t[n])break;default:r[n]=t[n]}return r},xn=function(e,t,r,n){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:n})},Ln=function(e,t,r,n,i){t.getProvider().writeTurnRestriction(e,{link:t,index:r},{link:n,index:i})},bn={"Navlink.split":[function(e){for(var t=e.link,r=e.children,n=r[0],i=r[1],o=t.coord().length-1,s=n.coord().length-1,a=i.coord().length-1,c=0,u=t.getConnectedLinks(0,!0);c<u.length;c++){var l=u[c],d=l.link,p=l.index;xn(t,0,d,p)&&(Ln(!0,n,0,d,p),Ln(!1,i,0,d,p)),xn(d,p,t,0)&&(Ln(!0,d,p,n,0),Ln(!1,d,p,i,0))}for(var h=0,f=t.getConnectedLinks(o,!0);h<f.length;h++){var v=f[h];d=v.link,p=v.index;xn(t,o,d,p)&&(Ln(!0,i,a,d,p),Ln(!1,n,s,d,p)),xn(d,p,t,o)&&(Ln(!0,d,p,i,a),Ln(!1,d,p,n,s))}}],"Feature.remove":function(e){var t=e.feature;if("NAVLINK"==t.class){for(var r=t.coord().length-1,n=0,i=t.getConnectedLinks(0,!0);n<i.length;n++){var o=i[n],s=o.link,a=o.index;Ln(!1,t,0,s,a)}for(var c=0,u=t.getConnectedLinks(r,!0);c<u.length;c++){var l=u[c];s=l.link,a=l.index;Ln(!1,t,r,s,a)}}},"Navlink.disconnect":function(e){var t=e.link,r=e.index;t.getConnectedLinks(r,!0).forEach(function(e){var n=e.link,i=e.index;Ln(!1,t,r,n,i),Ln(!1,n,i,t,r)})}},_n=function(e){[bn].forEach(function(t){return function(t){var r;for(var n in t){"function"==typeof(r=t[n])&&(r=[r]);for(var i=0,o=r;i<o.length;i++){var s=o[i];e.hooks.add(n,s)}}}(t)})},In=null,Pn=function(){return function(t,n){var i=this,o=(n=kn(n||{})).layers;delete n.layers,e.loglevel=n.debug;var s=new gr(n,t),a=r.here.xyz.maps.editor;i._i=function(){return s},i.addHook=function(e,t,r){return s.hooks.add(e,t,r)},i.removeHook=function(e,t,r){return s.hooks.remove(e,t,r)},i.getHooks=function(e){return s.hooks.get(e)},_n(s),ft(s,i),i.container=t.getContainer(),i.active=function(e){var t=s.observers.get("active");return null!=e&&(e=!!e)!=t&&(t=e,s.objects.listenDisplay(e),s.observers.change("active",e,!0)),t},i.destroy=function(){for(var e in i.getLayers().forEach(i.removeLayer),i.active(!1),s.destroy(),i)delete i[e];return null},new Sr(s,i,o),o=null,new fn(s.listeners,i),new vn(s.observers,i),new yt(s,i),i.setZoomLevel=function(e){t.setZoomlevel(e)},i.getZoomLevel=function(){return t.getZoomlevel()},i.pixelToGeo=function(e){var t=s.map.getGeoCoord(e);return t?new a.GeoCoordinate(t[0],t[1]):In},i.geoToPixel=function(e){var t=s.map.getPixelCoord(e);return t?new a.PixelCoordinate(t[0],t[1]):In};var c=new wr(s,s.map,a);i.getDrawingBoard=function(){return c};var u=new Sn(s);i.getZoneSelector=function(){return u},i.getOverlay=function(){return s.objects.overlay.layer},i.undo=function(e){for(e=Math.min(i.get("history.current"),e||1);e--;)s.objects.history.recoverViewport(-1,!!e)},i.redo=function(e){for(e=Math.min(i.get("history.length"),e||1);e--;)s.objects.history.recoverViewport(1,!!e)},i.search=new hn(s),n.legacy&&pn(i,t),i.active(!0),setTimeout(function(){var e=s.observers.get("active"),t=e;s.observers.change("active",e,t)},0)}}(),wn="POST",Rn="url",Fn="statusText",Dn="responseText",Nn="setRequestHeader",Tn="dataType",On="contentType",Bn="processData",jn="timeout",Mn="error",Gn="data",Hn="success",zn="headers",Kn="type",Un="async",Vn="withCredentials",Qn=null,Wn=Vn in new XMLHttpRequest;function Jn(e){var t=new(Wn?XMLHttpRequest:XDomainRequest),r=e[Rn],n="";function i(e,t){n+=((r+n).split("?")[1]?"&":"?")+e+"="+encodeURIComponent(t)}if("GET"===e[Kn])for(var o in e[Gn])i(o,e[Gn][o]);function s(){e[zn]&&i("CORSH",JSON.stringify(e[zn])),t.open(e[Kn],r+n,e[Un]===En||!!e[Un])}if(Wn){s(),e[On]&&t[Nn]("Content-Type",e[On]),t[Nn]("Accept",e.accepts?e.accepts.json:"*/*"),t.onload=e[Hn],t.onreadystatechange=function(){var r=t.status;4==t.readyState&&(r<200||r>=300)&&0!==r?e[Mn](t,Qn):clearTimeout(a)};var a=setTimeout(function(){t.abort(),e[Mn](t,jn)},e[jn])}else delete e[zn].Accept,i("t",+new Date),e[On]&&(e[zn]["Content-Type"]=e[On]),s(),t.onprogress=function(e,t){return t},t.onload=function(r){e[Hn]({responseText:t[Dn]})},e[Gn]=String(e[Gn]),t.ontimeout=function(t){t[Fn]=jn,e[Mn](t,jn)};return t.onerror=e[Mn],t[jn]=e[jn],t.tryCount=e.tryCount,t.retryLimit=e.retryLimit,t[Vn]=e[Vn],t.send(e[Kn]==wn?e[Gn]:Qn),t}function Yn(e){this.name="NetworkError",this.message="Service request failed with HTTP status: '"+e.status+" "+e[Fn]+"'",this.statusCode=e.status,this.responseText=e[Dn]||Qn,this[Wn?"XHR":"XDR"]=e}function Zn(t){var r=this;var n=(t=t||{})[jn]||2e4,i=t.retry||3,o=t.error,s=t[Vn];"function"!=typeof s&&(s=function(){}),this.send=function(t,a,c){t=t instanceof Array?t:[t];var u=[],l=t.length,d=!1,p=[];return l?t.forEach(function(h,f){h[Kn]=h[Kn]||"GET",h[Bn]===En&&(h[Bn]=h[Kn]!=wn),h[Tn]=h[Tn]||"json",h[On]=h[On]||Qn,function(){var v=f,A=e.extend({withCredentials:!!s(),timeout:window.timeout||n,tryCount:0,retryLimit:i},h);A[Rn]=A[Rn].replace("{SUBDOMAIN}",Math.floor(4*Math.random())),A[Mn]=function(e,r,n){if(!d)if(r==jn&&++this.tryCount<=this.retryLimit)Jn(A);else{d=!0;var i=new Yn(e);o&&o(i);try{t[v][Mn]?t[v][Mn](i):c&&c(i)}catch(e){}}},A[Hn]=function(e){var r,n=this;d||(r=e[Dn]||e.currentTarget[Dn],function(e){t[v][Hn]&&t[v][Hn](e,n),a&&(u[v]=e,--l||a(u,n))}(JSON.parse(r)))};var g=r.headers;if(g)for(var y in g)(A[zn]=A[zn]||{})[y]=g[y];p.push(Jn(A))}()}):a(u),p}}var qn=u.HTTPLoader,Xn={Line:"LineString",Point:"Point",Area:"MultiPolygon"},$n=function(){function e(e,t){this.q={},this.headers={},this.ajax=t||new Zn,this.setUrl(e)}return e.prototype.abort=function(e){var t=this.q,r=e.quadkey,n=t[r];delete t[r],n.abort()},e.prototype.load=function(t,r,n){var i=this.getUrl(t),o=this.q,s=t.quadkey;o[s]=this.ajax.send({url:i},function(t,n){delete o[s],t=t[0];for(var i=0;i<t.length;i++)t[i]=e.toGeoJSON(t[i]);return r(t,n)},function(){delete o[s],n&&n(arguments[0])})[0]},e.prototype.xhr=function(e,t,r){this.ajax.send({url:e},t,r)},e.prototype.setUrl=function(e){e&&(this.baseUrl=e)},e.toGeoJSON=function(e){var t=e.type,r=e.properties;return r["@ns:com:here:maphub"]={layerId:e.layerId,lastUpdateTS:e.lastUpdateTS,createdTS:e.createdTS,guid:e.guid,nodeId:e.nodeId,previousGuid:e.previousGuid,states:e.states,version:e.version},{id:e.id,type:"Feature",geometry:{coordinates:e.coordinates,type:Xn[t]||t},properties:r}},e}();function ei(e,t){var r=new $n(e),n=new $n(t);function i(e,t,r){return function(n,i){e[t][0]=n,e[t][1]=i,2==e["b"===t?"d":"b"].length&&r(function(e){var t={},r=[],n=0;function i(e){for(var r=0;r<e.length;r++)t[e[r].id]=e[r]}for(var o in i(e.b[0]),i(e.d[0]),t)r[n++]=t[o];return r}(e),e.b[1]+e.d[1])}}this.setUrl=function(e,t){r.setUrl(e),n.setUrl(t)},this.load=function(e,t,o){var s={b:[],d:[]};r.load(e,new i(s,"b",t),function(){}),n.load(e,new i(s,"d",t),function(){})},this.abort=function(e){r.abort(e),n.abort(e)}}function ti(){}function ri(e,t){for(var r in t)e[r]=t[r];return e}function ni(){var e=this;function t(e,t,r,n){return[{zIndex:e,type:"Polygon",fill:t,strokeWidth:n||1,stroke:r||"#FFFFFF"}]}e.styleGroups={undefined:t(0,"#FF0000","#FFFFFF",2),900170:t(1,"#E5F0DC"),900101:t(2,"#FAF9F5"),900107:t(3,e.randomColor()),509999:t(4,"#F4F8FA"),900103:t(8,"#D0F1CC"),600102:t(7,e.randomColor()),600101:t(6,e.randomColor()),600103:t(5,e.randomColor()),900130:t(9,e.randomColor()),900202:t(11,"#C9DFAF"),509997:t(10,e.randomColor()),900156:t(13,"#E0E7EB"),900108:t(12,e.randomColor()),908003:t(15,e.randomColor()),908002:t(14,"#F0EFED"),2000403:t(19,"#D0DADD"),9997004:t(18,"#E9E5DC"),900160:t(16,"#E9E5DC"),900150:t(21,"#B3E89E"),509998:t(20,"#FDF8CB"),1900403:t(24,"#E2E2E2"),9997007:t(23,e.randomColor()),9997008:t(22,e.randomColor()),1907403:t(25,"#D8D8D8"),2000457:t(33,"#D1C9C5"),2000420:t(32,"#D1C9C5"),2000124:t(31,"#D1C9C5"),2000123:t(30,"#D1C9C5"),2000200:t(29,"#D1C9C5"),2000408:t(28,"#D1C9C5"),2000461:t(27,"#D1C9C5"),2000460:t(26,"#D1C9C5"),900159:t(38,e.randomColor()),900158:t(37,e.randomColor()),1700215:t(36,"#EDEAE8"),1700216:t(35,"#EED5D2"),500414:t(43,"#99CEFE"),500421:t(42,"#A2C9FF"),500412:t(41,"#99CEFF"),507116:t(40,"#A2C9FF"),500116:t(39,"#99CEFF")},e.hovered=[{zIndex:0,type:"Polygon",fill:"#FF0000",opacity:.5,strokeWidth:2}],e.modified=[{zIndex:0,type:"Polygon",strokeWidth:3,stroke:"#1BBADD"}],e.selected=[{zIndex:0,type:"Polygon",opacity:.5,strokeWidth:4}];for(var r=t(34,"#B7BCBF","#545758"),n=2005e3;n<2005700;n++)e.styleGroups[n]=t(34,e.randomColor(),e.randomColor());for(n=2005700;n<=2005901;n++)e.styleGroups[n]=r;this.assign=function(t){var r,n=t.properties||{},i=t.editState(),o=n.featureType||n.feature_type;return i[e.STATE_SELECTED]?r=e.mergeStyles(e.styleGroups[o],e[e.STATE_SELECTED]):i[e.STATE_HOVERED]&&(r=e.mergeStyles(e.styleGroups[o],e[e.STATE_HOVERED])),i[e.STATE_MODIFIED]&&(r=e.mergeStyles(e.styleGroups[o],e[e.STATE_MODIFIED])),r||o}}$n.prototype.getUrl=qn.prototype.getUrl,ti.prototype.STATE_SELECTED="selected",ti.prototype.STATE_HOVERED="hovered",ti.prototype.STATE_MODIFIED="modified",ti.prototype.STATE_REMOVED="removed",ti.prototype.STATE_SPLIT="split",ti.prototype.STATE_CREATED="created",ti.prototype.mergeStyles=function(e,t){if(null===t||!1===t)return null;for(var r,n=[],i=0,o=e.length;i<o;i++)r=ri({},e[i]),t[i]&&ri(r,t[i]),n[i]=r;return n},ti.prototype.randomColor=function(){for(var e="0123456789ABCDEF".split(""),t="#",r=0;r<6;r++)t+=e[Math.round(15*Math.random())];return t},e.inheritClass(ti,ni);var ii="selected",oi="hovered",si="modified",ai="properties.name";function ci(){var e=this;e.strokeWidthZoomScale=function(e){return 1+.2*(e-18)},e.styleGroups={1:[{zIndex:0,type:"Line",stroke:"#BE6B65",strokeWidth:16,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#E6A08C",strokeWidth:12,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:ai}],2:[{zIndex:0,type:"Line",stroke:"#DAAC21",strokeWidth:14,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#FADC96",strokeWidth:10,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:ai}],3:[{zIndex:0,type:"Line",stroke:"#D7BE13",strokeWidth:14,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#F6F299",strokeWidth:10,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:ai}],4:[{zIndex:0,type:"Line",stroke:"#8C8E8E",strokeWidth:14,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#FFFFFF",strokeWidth:10,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:ai}],5:[{zIndex:0,type:"Line",stroke:"#1C4409",strokeWidth:7,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#50A62B",strokeWidth:5,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:ai}],hovered:[{zIndex:0,type:"Line",opacity:.8,strokeWidth:16,stroke:"#222222"}],modified:[{zIndex:0,type:"Line",opacity:1,stroke:"#1BBADD"}],selected:[{zIndex:0,type:"Line",opacity:1,strokeWidth:18}]},e.assign=function(t,r){var n=t.properties||{},i=t.editState(),o=n.fc||5,s=n.access;5==o&&16!=s&&528!=s&&(o=4),o=o>5?5:o;var a=e.styleGroups[o];return i[ii]?a=e.mergeStyles(a,e.styleGroups[ii]):i[oi]&&(a=e.mergeStyles(a,e.styleGroups[oi])),i[si]&&(a=e.mergeStyles(a,e.styleGroups[si])),a}}e.inheritClass(ti,ci);var ui="data:image/gif;base64,R0lGODdhEAAQALMAAAAAABUuPxcyRBw9VB5EXCBHYSNNaSdXdShZeSpegP///wAAAAAAAAAAAAAAAAAAACH5BAkAAAsALAAAAAAQABAAAARYcAxCqyVDSHO6/4eREUdinmhyEAKJKrByIkVbmjKe03aqmzzXKZZLBG8JmO84LO5qQp0SCEX6qL1X0VhNTYGsAQdBLpdDg4CGUGi73RhBIK0W2O/2gH4QAQA7",li=function(){function e(){this.styleGroups={default:[{zIndex:0,type:"Image",src:ui,width:16,height:16}]}}return e.prototype.assign=function(){return"default"},e}();function di(){this.styleGroups={address:[{zIndex:0,type:"Rect",fill:"#4C9EEF",stroke:"#0156BB",width:20,height:20},{zIndex:1,type:"Text",fill:"#FFFFFF",textRef:"properties.address"}]},this.assign=function(e,t){return"address"}}var pi,hi="LineString",fi="selected",vi="hovered",Ai="modified";function gi(){var e=this;e[hi]={default:[[0,{stroke:"#580008",strokeWidth:16,strokeLinejoin:"round",strokeLinecap:"round",strokeDasharray:"none",opacity:1}],[1,{stroke:"#e63d32",strokeWidth:12,strokeLinejoin:"round",strokeLinecap:"round",strokeDasharray:"none",opacity:1}]],hovered:[[0,{opacity:.8,strokeWidth:16,stroke:"#222222"}]],modified:[[0,{opacity:1,stroke:"#1BBADD"}]],selected:[[2,{stroke:"#222222",strokeWidth:18}],[3,{stroke:"#F9B708",strokeWidth:14}]]},e.Point={default:[[0,{fill:"#580008",radius:12,opacity:1}]],hovered:[[0,{radius:16}]],modified:[[0,{fill:"#1BBADD"}]],selected:[[0,{radius:14}]]},e.assign=function(t,r){var n=t.properties.editStates,i=t.geometry.type,o=e[i].default;return n[fi]?o=e.mergeStyles(o,e[i][fi]):n[vi]&&(o=e.mergeStyles(o,e[i][vi])),n[Ai]&&(o=e.mergeStyles(o,e[i][Ai])),o}}e.inheritClass(ti,gi);var yi=function(t,r){for(var n in r)t[n]==pi&&(t[n]=e.clone(r[n]))},mi="@ns:com:here:maphub";var Si=function(e){return e&&""!=e&&"-"!=e},Ei=function(e,t){var r=e.split(":"),n=r[0],i=r[1].split("-"),o=parseInt(i[0]),s=parseInt(i[1]),a=!1;if("M"==n||o==s)return[e,e];o>s&&(a=s,s=o,o=a,a=!0,t=1-t);var c=Math.abs(o-s)/2+1,u=Math.round(c*t),l=2*(u-1)+o,d=[o,l],p=[l+2,s],h=function(){return!u},f=function(){return c==u},v=function(e){return n+":"+e.join("-")};return a&&(a=d,d=p.reverse(),p=a.reverse(),a=h,h=f,f=a),[h()?null:v(d),f()?null:v(p)]},Ci={};[{"Navlink.split":function(e){var t=e.link,r=e.children,n=r[0],i=r[1],o=e.index,s=t.prop("bn");if(s){for(var a=[],c=[],u=0,l=s;u<l.length;u++){var d=l[u];d<o?a.push(d):d==o?(a.push(d),c.push(d-o)):c.push(d-o)}n.prop("bn",a),i.prop("bn",c)}}},{"Navlink.split":function(e){var t=e.link,r=t.id,n=t.prop();e.children.forEach(function(e){var t=e.prop();("number"==typeof r||n.originLink)&&(t.originLink=n.originLink||r),"number"==typeof r&&void 0!==t.originLink&&t.originLink!=r&&(t.parentLink=r),e.prop(t)})}},{"Navlink.split":function(e){var t=e.link,r=e.children,n=r[0],i=r[1],o=e.relativePosition,s=t.coord(),a=P(s),c=Math.round,u=o*a,l=(1-o)*a,d=["speedlimit","revspeedlimit"];for(var p in d){var h=d[p],f=t.prop(h);if(f){var v=f[0]||0,A=(f[1]||0)/100,g="number"==typeof f[2]?f[2]/100:1;if(A<o)var y=A*a/u,m=0;else y=1,m=(A*a-u)/l;if(g<o)var S=g*a/u,E=0;else S=1,E=(g*a-u)/l;n.prop(h,[v,c(100*y),c(100*S)]),i.prop(h,[v,c(100*m),c(100*E)]);var C=[n.properties,i.properties];for(var p in C){var k=C[p][h];0==k[0]?delete C[p][h]:(0===k[1]&&100===k[2]||null==k[1]||null==k[2])&&(C[p][h]=[k[0]])}}}}},{"Navlink.split":function(e){var t,r,n,i,o=e.link,s=e.children,a=s[0],c=s[1],u=e.relativePosition,l=["left","right"];for(var d in l){t=l[d],r=o.properties[t];var p=[],h=[];if(Si(r))for(var f in n=r.split(";"))if(Si(n[f])){var v=n[f];if(-1==v.indexOf(":")){var A=!(parseInt(v[1].split("-")[0])%2);v=(A?"E:":"O:")+v}i=Ei(v,u),p[f]=i[0],h[f]=i[1]}a.prop(t,p.join(";")),c.prop(t,h.join(";")),[a.properties,c.properties].forEach(function(e){""==e[t]&&delete e[t]})}}},{"Navlink.split":function(e){var t,r=e.link,n=e.children,i=n[0],o=n[1],s=r.prop("dd");null!=s&&("N"!=s&&"0"!=s?"A"==s?t=["A","A"]:"1"==s?t=["A","1"]:"2"==s?t=["2","A"]:"L"==s&&(t=["2","1"]):t=[s,s],i.prop("dd",t[0]),o.prop("dd",t[1]))}}].forEach(function(e){for(var t in e){var r=e[t];Ci[t]=Ci[t]||[],r instanceof Array?Ci[t]=Ci[t].concat(r):Ci[t].push(r)}});var ki={LineString:"Line",Point:"Point",MultiPolygon:"Area",Polygon:"Area"},xi="EXISTS",Li=function(){return function(t){var r=t.geometry,n=r.coordinates,i=e.clone(t.properties),o=i["@ns:com:here:maphub"];delete i["@ns:com:here:maphub"],delete i["@ns:com:here:editor"],this.id=t.id,n&&("Polygon"==r.type?this.coordinates=[n]:this.coordinates=n),o.owner&&(this.owner=o.owner),o.guid==xi&&(this.guid=xi),this.layerId=o.layerId,this.states=o.states,this.version=o.version,this.properties=i,this.type=ki[r.type]}}(),bi=function(){function e(){}return e.prototype.createFeature=function(e){return new Li(e)},e.prototype.createFeatureContainer=function(e){for(var t=new Array,r=0;r<e.length;r++)t.push(this.createFeature(e[r]));return t},e}(),_i=function(e){function t(t,r){return e.call(this,t,r)||this}return d(t,e),t.prototype.getBBox=function(){var e=this.geometry.coordinates;return[e[0],e[1],e[0],e[1]]},t.prototype.getLink=function(){var e=Se.getRoutingData(this),t=e.link;if(t){var r=Se.getRoutingProvider(this);t=r&&r.search(e.link)}return t||null},t}(Rr),Ii=function(t){function r(e,r){return t.call(this,e,r)||this}return d(r,t),r.prototype.createRoutingPoint=function(){Se.getRoutingData(this).link||(Se.connect(this),Se.getRoutingData(this).link&&Se.markAsModified(this))},r.prototype.removeRoutingPoint=function(){Se.getRoutingData(this).link&&(Se.disconnect(this),Se.markAsModified(this))},r.prototype.prop=function(t){var r=arguments.length,n=this.getProvider().getFeatureProperties(this),i=!1;if(!r||1==r&&"string"==typeof t)return null!=(t=t?n[t]:n)&&"object"==typeof t?e.extend(!0,new t.constructor,t):t;if(2==r){var o={};o[t]=arguments[1],t=o}for(var s in t){var a=t[s],c="object"==typeof a,u=n[s];(c&&JSON.stringify(a)!=JSON.stringify(u)||!c&&u!==a)&&(i||(this._e().objects.history.origin(this),i=!0),n[s]=a)}Se.getRoutingData(this).link?Se.connect(this,null):Se.disconnect(this),i&&(this._e().setStyle(this),Se.markAsModified(this))},r}(_i);Ii.prototype.class="PLACE";var Pi=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return d(r,t),r.prototype.prop=function(t){var r=!1,n=arguments.length,i=this.getProvider().getFeatureProperties(this);if(!n||1==n&&"string"==typeof t)return null!=(t=t?i[t]:i)&&"object"==typeof t?e.extend(!0,new t.constructor,t):t;if(2==n){var o={};o[t]=arguments[1],t=o}for(var s in t){var a=t[s],c="object"==typeof a,u=i[s];(c&&JSON.stringify(a)!=JSON.stringify(u)||!c&&u!==a)&&(r||(this._e().objects.history.origin(this),r=!0),i[s]=a)}Se.connect(this,null),r&&(this._e().setStyle(this),Se.markAsModified(this))},r}(_i);Pi.prototype.class="ADDRESS";var wi=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return d(t,e),t.prototype.addShape=function(e,t){return(e=this._e().map.getGeoCoord(e))?(t=ie.addCoord(this,e,t))&&ie.markAsModified(this):(!function(e){throw new Error(e)}("missing pixel coordinate"),t=!1),t},t}(lt);wi.prototype.class="LINE";var Ri=a.EditableProvider,Fi=new bi,Di="defaultObject",Ni=[Di],Ti={json:"application/vnd.here.idList+json"},Oi="POST",Bi="error",ji="app_id",Mi="app_code",Gi={NVT_LINE:"LINE",NVT_LINK:"NAVLINK",NVT_POI:"PLACE",NVT_ADDRESS:"ADDRESS",NVT_MARKER:"MARKER",NVT_AREA:"AREA"};function Hi(t){var r=this;for(var n in t)this[n]=t[n];var i=r.class||r.type;function o(e){return r._getUrl(r.getTileUrl(e))}i&&(r.class=Gi[i]||i),t.user&&!t.credentials&&(t.credentials=t.user),r.metadata={},this.setCredentials=function(e){var n=this.headers||{};for(var i in e)i==ji||i==Mi?this[i]=e[i]:(n=n||{})[i]=e[i];this.headers=n,r.loader&&(t.src?r.loader.setUrl(o(t.src)):r.loader.setUrl(o(t.base),o(t.delta)))},this.setCredentials(t.credentials),this.ajax=new Zn({timeout:r.timeout,retry:r.retry,error:function(e){r.listeners.trigger(Bi,[e])},withCredentials:function(){return r.withCredentials}});var s=t.src?new $n(o(t.src),r.ajax):new ei(o(t.base),o(t.delta)),a=this.class,c=this.headers;Ri.call(r,e.extend({maxLevel:20,minLevel:13,loader:s,styles:new("ADDRESS"==a?di:"NAVLINK"==a?ci:"PLACE"==a||"MARKER"==a?li:"AREA"==a?ni:gi),isDroppable:function(e){var t=e.editState();return!t||!t.modified&&!t.removed&&!t.split},Feature:lt},t),function(e){var t=e.provider.preprocessor,r=e.data,n=e.ready;return e.provider.getMetaData(Di,function(i){t?t(e):n(r)}),!1}),r.headers=s.headers=c,r.setHeaders(c),r.getMetaData(Ni)}e.inheritClass(Ri,Hi),Hi.prototype.prepareFeature=function(t){var r=t.properties=t.properties||{},n=!1;t.id==pi&&(n=!0,t.id=e.String.random()+"-NEW",r[mi]=pi);var i=r[mi]=r[mi]||{},o=this.metadata.defaultObject;return o&&(yi(r,o.properties),i.version||(i.version=o.version),n&&!i.states&&(i.states=o.states.slice()),i.layerId||(i.layerId=this.src||this.delta)),t},Hi.prototype.app_id=null,Hi.prototype.app_code=null,Hi.prototype.headers=null,Hi.prototype.withCredentials=!1,Hi.prototype.setHeader=function(e,t){var r={};r[e]=t,this.setHeaders(r)},Hi.prototype.setHeaders=function(e){this.setCredentials(e),Ri.prototype.setHeaders.call(this,e)},Hi.prototype._getUrl=function(e){var t=this.headers,r=-1==e.indexOf("?")?"?":"&";return this[ji]&&this[Mi]&&(e=e+r+"app_id="+this[ji]+"&app_code="+this[Mi],r="&"),t&&"{}"!=(t=JSON.stringify(t))&&(e+=r+"headers="+encodeURIComponent(t)),e},Hi.prototype._requestFeatures=function(e,t,r){this.ajax.send({url:this._getUrl(this.getFeatureUrl(this.src||this.base,e.filter(function(e){return"number"==typeof e})))},function(e){for(var r=(e=e[0]).length;r--;)e[r]=$n.toGeoJSON(e[r]);t&&t(e)},r)},Hi.prototype.getFeatureUrl=function(e,t){return"number"==typeof t&&(t=[t]),this.getLayerUrl(e)+"/?id="+t.join(",")},Hi.prototype.reserveId=function(e,t,r){var n=e.length;this.ajax.send({type:Oi,url:this._getUrl(this.getReserveIdUrl(this.delta||this.src,n)),contentType:"text/plain",data:String(n),accepts:Ti},function(e){t&&t(e[0])},r)},Hi.prototype.commit=function(t,r,n,i){var o=arguments,s=o.length;"string"==typeof o[s-1]&&(i=o[s-1]),t=Array.prototype.concat(t.put||[],t.remove||[]);for(var a=this,c={},u={},l=0,d=0,p=0,h=0,f=0;f<t.length;f++){var v=t[f],A=v.properties,g=A["@ns:com:here:maphub"],y=A["@ns:com:here:editor"],m=y.created,S=y.split,E=y.removed,C=g.layerId,k=g.states||[null],x=a.src||a.base,L=a.src||a.delta;i&&(this.getFeatureProperties(v).transactionId=i),x==C&&x!=L&&((c[x]=c[x]||[]).push({id:v.id,geometry:{type:v.geometry.type},properties:{layerId:C,states:[S?"SPLIT":"REMOVED",null,null,null]}}),l++,g.owner="BASE:"+g.guid),E?p++:m?h++:d++,k[0]=S?"SPLIT":E?"REMOVED":m?"CREATED":"UPDATED",g.layerId=L,m||(k[1]=k[2]=k[3]=null),g.states=k,(u[L]=u[L]||[]).push(v)}function b(e){var t=[];for(var r in e)e[r].length&&(t[t.length]={url:a._getUrl(a.getLayerUrl(r)),data:JSON.stringify(Fi.createFeatureContainer(e[r])),type:Oi,contentType:"application/vnd.here.layerObjectList+json",accepts:Ti});return t}e.dump("Layer",a.src||[a.base,a.delta].join("&"),"->","Flags",l,"Creates",h,"Mods",d,"Deletes",p,"info"),a.ajax.send([].concat(b(u),b(c)),r,n)},Hi.prototype.getLayerUrl=function(e){return this.url+"/"+e},Hi.prototype.getMetadataUrl=function(e,t){return t instanceof Array||(t=[]),this.getLayerUrl(e)+"/metadata?key="+t.join(",")},Hi.prototype.getTileUrl=function(e){return this.getLayerUrl(e)+"/tile?tileId={QUADKEY}"},Hi.prototype.getReserveIdUrl=function(e,t){return this.getLayerUrl(e)+"/reserve/"+t},Hi.prototype.getMetaData=function(t,r){var n,i=[],o=this;function s(){return e.clone(n?o.metadata[n]:o.metadata)}function a(){"function"==typeof r&&r(s())}if(r||"function"!=typeof t||(t=r=t),t){"string"==typeof t&&(t=[n=t]);for(var c=0;c<t.length;c++)void 0===o.metadata[t[c]]&&i.push(t[c])}if(!i.length)return a(),s();var u={url:o._getUrl(o.getMetadataUrl(o.src||o.base,t))};o.ajax.send(u,function(t){t=t[0],e.extend(o.metadata,t),a()})};var zi={NAV:"NAVLINK",PNT:"ADDRESS",PLA:"PLACE",POI:"PLACE",CAR:"AREA",MARKER:"MARKER",NAVLINK:"NAVLINK",ADDRESS:"ADDRESS",PLACE:"PLACE"};Hi.prototype.getFeatureClass=function(e){var t,r=this.detectFeatureClass(e);return"NAVLINK"==r?t=nn:"PLACE"==r?t=Ii:"ADDRESS"==r?t=Pi:"AREA"==r?t=Dr:"MARKER"==r?t=Rr:"LINE"==r&&(t=wi),t},Hi.prototype.getFeatureProperties=function(e){return e.properties},Hi.prototype.detectFeatureClass=function(e){var t=e.properties["@ns:com:here:maphub"].version;return zi[t&&t.substr(0,3)]||this.class};Hi.prototype.isoCC=function(e,t){var r=e.properties;if(1==arguments.length)return(t=r.isocc)instanceof Array&&(t=t[0]),t;if(2==arguments.length)if("NAVLINK"==this.detectFeatureClass(e)){var n=r.isocc=r.isocc||[];-1==n.indexOf(t)&&n.push(t)}else r.isocc=t},Hi.prototype.hooks=Ci,Hi.prototype.readRoutingProvider=function(e,t){for(var r=0,n=t;r<n.length;r++){var i=n[r];if("NAVLINK"==i.class)return i.id}},Hi.prototype.readRoutingPosition=function(e){return e.properties.rp},Hi.prototype.readRoutingLink=function(e){var t=e.prop("link");return"string"==typeof t?t.split(":")[0]:t},Hi.prototype.writeRoutingPosition=function(e,t){e.prop("rp",t)},Hi.prototype.writeRoutingLink=function(e,t){e.prop("link",t?String(t.id):t)},Hi.prototype.readPedestrianOnly=function(e){var t=e.prop("access");return 16==t||528==t},Hi.prototype.readDirection=function(e){var t=e.prop("dir");return"B"==t?"BOTH":"F"==t?"START_TO_END":"T"==t?"END_TO_START":void 0},Hi.prototype.readTurnRestriction=function(e,t){return-1!=((t.link.prop("tr")||{})[0==t.index?"ref":"nref"]||[]).indexOf(e.link.id)},Hi.prototype.writeTurnRestriction=function(e,t,r){var n=r.link,i=t.link.id,o=n.prop("tr")||{};o.ref=o.ref||[],o.nref=o.nref||[];var s=o[0==r.index?"ref":"nref"],a=s.indexOf(i);e?-1==a&&(s.push(i),n.prop("tr",o)):a>=0&&(s.splice(a,1),n.prop("tr",o))},Hi.prototype.writeEditState=function(e,t){var r=e.properties["@ns:com:here:maphub"],n=r.states=r.states||[,null,null,null],i=n[0];"SPLIT"!=i&&("CREATED"==i&&"REMOVED"!=t||(n[0]="modified"==t?"UPDATED":t.toUpperCase()))};var Ki,Ui={};Ui.NAVLINK="Navlink",Ui.AREA="Area",Ui.PLACE="Place",Ui.ADDRESS="Address",Ui.MARKER="Marker",Ui.LINE="Line";for(var Vi=function(){function t(t){var r=function(e){if("number"==typeof(e.x!=Ki?e.x:e.longitude!=Ki?e.longitude:e[0]))return e;for(var t=[],n=0,i=e;n<i.length;n++){var o=i[n];t[t.length]=r(o)}return t};function n(n,i,o){"number"!=typeof n&&"string"!=typeof n?(o=i,i=n):this.id=n,this.type="Feature",this.class=t,this.properties=e.extend({"@ns:com:here:editor":new st},o||{}),this.geometry={type:"PLACE"==t||"ADDRESS"==t||"MARKER"==t?"Point":"AREA"==t?"MultiPolygon":"LineString",coordinates:r(i)}}return n.prototype=lt.prototype,n}var r={};for(var n in Ui)r[Ui[n]]=t(n);return r}(),Qi=function(e,t,r){this.x=e,this.y=t,this.z=r||0},Wi=function(e,t,r){this.longitude=e,this.latitude=t,this.z=r||0},Ji={create:function(t,r,n){try{var i=(void 0).destination+"ui/";e.executeScript(i+t+"/main.js",{name:t,editor:r,destination:i,params:n})}catch(t){e.dump(t,"warn")}}},Yi="here.xyz.maps.editor".split("."),Zi=r,qi=0;qi<Yi.length-1;qi++)Zi=Zi[Yi[qi]]=Zi[Yi[qi]]||{};var Xi=Zi[Yi.pop()]={Editor:Pn,features:Vi,PixelCoordinate:Qi,GeoCoordinate:Wi,UI:Ji},$i=r.HERE.xyz.maps.providers,eo=Hi.prototype.getFeatureClass;$i.EditableProvider.prototype.getFeatureClass=function(e){return eo.call(this,e)||this.Feature},$i.ProProvider=Hi;export default Xi;export{Pn as Editor,Wi as GeoCoordinate,Qi as PixelCoordinate,Ji as UI,Vi as features};
