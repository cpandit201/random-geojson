/*
 * @here/xyz-maps-editor
 * (c) 2019 HERE
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@here/xyz-maps-common"),require("@here/xyz-maps-core")):"function"==typeof define&&define.amd?define(["exports","@here/xyz-maps-common","@here/xyz-maps-core"],t):t(((e=e||self).here=e.here||{},e.here.xyz=e.here.xyz||{},e.here.xyz.maps=e.here.xyz.maps||{},e.here.xyz.maps.editor={}),e.here.xyz.maps.common,e.here.xyz.maps)}(this,function(e,w,a){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function c(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var o;function l(e,t,r){e._e().listeners.trigger(t,e,r)}function d(e,t){var r=e.__;return r||(r=e.__={isEditable:!0}),t?r[t]:r}var i={private:d,_evl:{pointerdown:function(){var e=d(this);e.moved=!1,e.pdm=[0,0]},pointerup:function(e){var t=d(this),r=t.moved;!t.isSelected&&this._e()._config.featureSelectionByDefault?i._select(this):r&&i.markAsModified(this),l(this,e,r?"dragStop":"pointerup")},pointerenter:function(e){this._e().listeners.trigger(e,this)},pointerleave:function(e){this._e().listeners.trigger(e,this)}},deHighlight:function(e){var t=d(e);t.selector&&(e._e().objects.overlay.remove(t.selector),t.selector=null,t.pointerdown=o,t.pressmove=o)},_editable:function(e,t){var r=d(e);return t!=o&&(r.isEditable=!!t),i.deHighlight(e),r.isEditable},_select:function(i){var s=i._e();if(s.objects.selection.select(i)){var a=d(i);a.pressmove=function(e,t,r,n,o){a.isEditable&&a.isSelected&&!s._config.editRestrictions(i,1)&&(s.map.pixelMove(i,t-a.pdm[0],r-a.pdm[1]),a.pdm[0]=t,a.pdm[1]=r,l(i,e,a.moved?"dragMove":"dragStart"),a.moved=!0)},a.selector||(a.selector=s.objects.overlay.addCircle(i.coord(),o,{type:"MARKER_SELECTOR"}))}},_setCoords:function(e,t){e._e().objects.history.origin(e);var r=d(e,"selector");r&&r._provider.setFeatureCoordinates(r,t),e._provider.setFeatureCoordinates(e,t.slice())},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),i.deHighlight(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),(t==o||t)&&e._e().objects.history.saveChanges(),e}},g=Math,s=g.PI,A=g.pow,y=g.sqrt,m=function(e,t,r,n,o){void 0===r&&(r=0),void 0===n&&(n=e.length),void 0===o&&(o=[]);var i,s,a,c,l,d,u,p=0,h=0;n--;for(var f=r+1;f<n;f++){var v=(i=e[r],s=e[n],a=e[f],l=c=void 0,d=(s[1]-i[1])/(s[0]-i[0]),u=i[1]-d*i[0],c=g.abs(a[1]-d*a[0]-u)/y(A(d,2)+1),(l=L(a,i))<c&&(c=l),(l=L(a,s)<c)&&(c=l),c);p<v&&(h=f,p=v)}return t<p?(m(e,t,r,h,o),m(e,t,h,n+1,o)):(o.push(e[r]),0<n-r&&o.push(e[n])),o},S=function(e,t){var r=t[0]-e[0],n=t[1]-e[1];return r||n?(180+180*g.atan2(n,r)/s)%360:0},x=function(e,t,r){var n=(S(e,t)-180)*s/180;return[e[0]+(r||0)*g.cos(n),e[1]+(r||0)*g.sin(n)]},k=function(e,t){for(var r=999999,n=!1,o=0;o<e.length-1;o++){var i=o+1,s=R(e[o],e[i],t);if(s){var a=L(s,t);a<r&&(r=a,n=o)}}return n},E=function(e,t,r,n){var o=(n[0]-r[0])*(e[1]-r[1])-(n[1]-r[1])*(e[0]-r[0]),i=(t[0]-e[0])*(e[1]-r[1])-(t[1]-e[1])*(e[0]-r[0]),s=(n[1]-r[1])*(t[0]-e[0])-(n[0]-r[0])*(t[1]-e[1]);if(0!=s){var a=o/s,c=i/s;if(0<=a&&a<=1&&0<=c&&c<=1)return[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}},R=function(e,t,r){if(e[0]==t[0]){var n=[e[0],r[1]];return!!p(e,t,n)&&n}if(e[1]==t[1]){var o=[r[0],e[1]];return!!p(e,t,o)&&o}var i=(t[1]-e[1])/(t[0]-e[0]),s=e[1]-i*e[0],a=-1/i,c=(r[1]-a*r[0]-s)/(i-a),l=[c,i*c+s];return!!p(e,t,l)&&l},u=function(e,t,r){return[(t[0]-e[0])*r+e[0],(t[1]-e[1])*r+e[1]]},L=function(e,t){return y(A(e[0]-t[0],2)+A(e[1]-t[1],2))},p=function(e,t,r,n){n=n||1e-7;var o=r[0]-e[0],i=r[1]-e[1],s=t[0]-e[0],a=t[1]-e[1],c=(o*s+i*a)/(s*s+a*a);return(c=(s=o-(c=c<0?0:1<c?1:c)*s)*s+(a=i-c*a)*a)<n*n},b=function(e){for(var t=0,r=0;r<e.length-1;r++)t+=L(e[r],e[r+1]);return t},h=function(e,t,r){for(var n=C(e,t),o=C(e,r),i=k(e,n),s=k(e,o),a=[n],c=i+1;c<s+1;c++)a.push([e[c][0],e[c][1]]);return a.push(o),a},C=function(e,t){for(var r,n,o,i,s=0,a=0;a<e.length-1;a++)if(n=e[a],o=e[a+1],t<=(s+=r=L(n,o)))return i=(t-(s-r))/r,[(o[0]-n[0])*i+n[0],(o[1]-n[1])*i+n[1]];return o};function f(e,t,r){for(var n=0,o=r.length-1;n<o;n++)if(E(e,t,r[n],r[n+1]))return 1}function _(e,t){for(var r=0,n=e.length-1;r<n;r++)if(f(e[r],e[r+1],t))return 1}function I(e,t){for(var r=e[0],n=e[1],o=!1,i=0,s=t.length-1;i<t.length;s=i++){var a=t[i][0],c=t[i][1],l=t[s][0],d=t[s][1];n<c!=n<d&&r<(l-a)*(n-c)/(d-c)+a&&(o=!o)}return o}function v(h,f,e,t,r,v){var g=h.objects.overlay;function n(e){var t,r=this.properties["@ns:com:here:editor"];t="pointerleave"==e.type?(delete r.hovered,"default"):(r.hovered=!0,"move"),document.body.style.cursor=t,h.setStyle(this)}function A(e,t){h.listeners.trigger(e,E,t)}var y=!1,m=0,S=0;var E=g.addPoint([e,t],{type:"AREA_SHAPE",poly:r[0],index:r[1],hole:r[2],AREA:{style:h.getStyle(f)}});return E.__={pointerdown:function(){y=!1,S=m=0},pressmove:function(e,t,r,n,o){y||(y=!0,v.hideShape(v.private(f,"midShapePnts"),g),A(e,"dragStart"));var i=E.getIndex(),s=E.properties.poly,a=E.properties.hole,c=v.getCoords(f)[s],l=c[a],d=l[i],u=h.map.translateGeo(l[i],t-m,r-S);if(l[i]=u,i||(l[l.length-1]=u),!function(e,t,r){for(var n=0,o=t.length;n<o;n++)if(n!=r&&_(e,t[n]))return 1}(l,c,a)&&function(e,t,r){for(var n=0^r,o=e.length;n<o;n++)for(var i=0;i<e[n].length;i++)if(!I(e[n][i],t))return 0;return 1}(c,c[0],1)){var p=v.private(f,"shapePnts");v.forEachAt(f,d,function(e,t,r,n,o){o[t][r][n][0]=u[0],o[t][r][n][1]=u[1],v._setCoords(e,o,!1);for(var i=0,s=void 0,a=void 0;i<p.length;i++)(a=(s=p[i]).geometry.coordinates)[0]==d[0]&&a[1]==d[1]&&s.getProvider().setFeatureCoordinates(s,u.slice())}),m=t,S=r}},pointerup:function(e){y&&v.markAsModified(f),v.addVShapes(f),A(e,y?"dragStop":void 0)},pointerenter:n,pointerleave:n},E.class="AREA_SHAPE",E.getArea=function(){return f},E.remove=function(){return v.deleteShape(f,this)},E.getIndex=function(){return this.properties.index},E.removeGeometry=function(){var e=E.properties.poly,t=E.properties.hole,r=f.coord();r[e].splice(t,1),v._setCoords(f,r,!1),v.deHighlight(f),v._select(f),v.markAsModified(f)},E}function P(n,f,e,t,r,v){var g;function o(e){var t,r=this.properties["@ns:com:here:editor"];t="pointerleave"==e.type?(delete r.hovered,"default"):(r.hovered=!0,"move"),document.body.style.cursor=t,n.setStyle(this)}var A=n.objects.overlay.addPoint([e,t],{type:"AREA_VIRTUAL_SHAPE",poly:r[0],index:r[1],hole:r[2],AREA:{style:n.getStyle(f)}});return A.__={pointerdown:function(){g=!1},pressmove:function(e,t,r,n,o){var i=A.properties,s=i.index+1,a=i.poly,c=A.geometry.coordinates;if(!g){g=!0;for(var l=v.private(f,"midShapePnts"),d=0,u=void 0,p=void 0,h=void 0;d<l.length;d++)(p=(u=l[d]).geometry.coordinates)[0]==c[0]&&p[1]==c[1]&&(h=u.properties,v.addShp(f,c.slice(),h.poly,h.hole,h.index+1));g=v.getShp(f,a,i.hole,s)}g.__.pressmove.apply(g,arguments)},pointerup:function(e){if(g){var t=A.properties,r=v.getShp(f,t.poly,t.hole,t.index+1);r.__.pointerup.call(r,e)}},pointerenter:o,pointerleave:o},A.isNode=!1,A}function F(e,t){for(var r,n,o,i,s,a,c,l,d,u,p,h,f=1/0,v=t.length-1,g=0;g<v;g++){var A=(r=e,n=t[g],o=t[g+1],void 0,i=r[0],s=r[1],a=n[0],c=n[1],l=o[0],d=o[1],L([i,s],(h=((i-a)*(u=l-a)+(s-c)*(p=d-c))/(u*u+p*p))<0?[a,c]:1<h?[l,d]:[a+h*u,c+h*p]));A<f&&(f=A)}return f}function D(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,shapePnts:[],midShapePnts:[]}),t?r[t]:r}function r(e){var t=D(e),r=e._e().objects.overlay;M.hideShape(t.shapePnts,r),M.hideShape(t.midShapePnts,r)}function N(e,t,r,n){for(var o,i=0;i<t[r].length;i++){o=t[r][i];for(var s=0;s<o.length-1;s++)e.push(n(o[s],o[s+1],[r,s,i]))}}function t(n){for(var e=D(n,"midShapePnts"),t=M.getCoords(n),r=0;r<t.length;r++)N(e,t,r,function(e,t,r){return new P(n._e(),n,(e[0]+t[0])/2,(e[1]+t[1])/2,r,M)})}function T(e){D(e,"isSelected")&&(r(e),function(n){for(var e=D(n,"shapePnts"),t=M.getCoords(n),r=0;r<t.length;r++)N(e,t,r,function(e,t,r){return new v(n._e(),n,e[0],e[1],r,M)})}(e),t(e))}function O(e){var t=this,r=D(t);r.allowEdit&&!r.isSelected&&(t._e().listeners.trigger(e,t),t.editState("hovered","pointerenter"==e.type),t._e().setStyle(this))}function j(e){var t=D(this);t.isSelected||this._e()._config.featureSelectionByDefault&&t.allowEdit&&M._select(this,e),this._e().listeners.trigger(e,this)}var B,M={private:D,_evl:{pointerenter:O,pointerleave:O,dbltap:j,pointerup:j},deHighlight:function(e){var t=D(e);t.isSelected&&(r(e),e.editState("hovered",!1),e.editState("selected",!1),e._e().setStyle(e),t.isSelected=!1)},_editable:function(e,t){var r=D(e);t&&t!=r.allowEdit?document.body.style.cursor="pointer":t||t==r.allowEdit||(M.deHighlight(e),document.body.style.cursor="default"),r.allowEdit=t},_select:function(e,t){var r=D(e);r.isSelected||(e._e().objects.selection.select(e),e._e().dump(e,"info"),r.isSelected=!0,e.editState("selected",!0),e._e().setStyle(e),T(e))},_setCoords:function(e,t,r){"number"==typeof t[0][0][0]&&(t=[t]);for(var n=t.length;n--;)for(var o=t[n],i=o.length;i--;){var s=o[i];s[s.length-1]=s[0]}e._e().objects.history.origin(e),"Polygon"==e.geometry.type&&(1==t.length?t=t[0]:e.geometry.type="MultiPolygon"),e._provider.setFeatureCoordinates(e,t),r&&T(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),M.deHighlight(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),(t||void 0===t)&&e._e().objects.history.saveChanges(),e},deleteShape:function(e,t){var r=t.properties,n=M.getCoords(e),o=n[r.poly][r.hole];return!(o.length<=4)&&(o.splice(t.getIndex(),1),M._setCoords(e,n),M.deHighlight(e),M._select(e),M.markAsModified(e),!0)},getCoords:function(e){var t=e.coord();return"Polygon"==e.geometry.type?[t]:t},isClockwise:function(e){for(var t=0,r=0,n=void 0,o=e.length-1;r<o;r++)n=(r+1)%o,t+=e[r][0]*e[n][1],t-=e[n][0]*e[r][1];return t<0},forEachAt:function(e,t,r){for(var n=e._e(),o=function(e){return Math.round(1e9*e)},i=o(t[0]),s=o(t[1]),a=n.objects.getInBBox([t[0],t[1],t[0],t[1]],n.getLayer(e)),c=a.length;c--;)for(var l=a[c],d=M.getCoords(l),u=d.length;u--;)for(var p=d[u].length;p--;)for(var h=d[u][p],f=h.length-1;f--;)o(h[f][0])==i&&o(h[f][1])==s&&r(l,u,p,f,d)},getPoly:function(e,t){for(var r=e.e,n=M.getCoords(e),o=1/0,i=null,s=0;s<n.length;s++){var a=F(t,n[s][0].map(function(e){return r.map.getGeoCoord(e[0],e[1])}));a<o&&(o=a,i=s)}return i},addVShapes:t,getShp:function(e,t,r,n){for(var o=D(e,"shapePnts"),i=0,s=void 0;i<o.length;i++)if((s=o[i].properties).poly==t&&s.index==n&&s.hole==r)return o[i]},addShp:function(e,t,r,n,o){for(var i=M.getCoords(e),s=i[r][n],a="number"==typeof o?o:k(s,t)+1,c=0;c<s.length;c++)if(s[c][0]==t[0]&&s[c][1]==t[1])return!1;return s.splice(a,0,t),M._setCoords(e,i),T(e),a},hideShape:function(e,t){e instanceof Array||(e=[e]);for(var r=0;r<e.length;r++)t.remove(e[r]);e.length=0}},G=function(s){function e(e,t,r,n){var o=this;B=n;var i=e._e().getStyle(e);return(o=s.call(this,{properties:{index:r,LINE:{properties:e.prop(),style:i}},geometry:{type:"Point",coordinates:t}})||this)._l=e,o}return c(e,s),e.prototype.getLine=function(){return this._l},e.prototype.pointerdown=function(e){var t=this.properties,r=this.geometry.coordinates,n=e.detail.display;t.moved=!1;var o=n.geoToPixel.apply(n,r);t.x=o.x,t.y=o.y,B.removeShapes(this.getLine(),"vShps","LINE_VIRTUAL_SHAPE"==this.class&&this)},e.prototype.pressmove=function(e,t,r){var n=e.detail.display,o=this.properties,i=n.pixelToGeo(o.x+t,o.y+r),s=i.longitude,a=i.latitude,c=this.getLine(),l=c.coord();o.moved||(o.moved=!0,c._e().listeners.trigger(e,this,"dragStart")),this.getProvider().setFeatureCoordinates(this,[s,a]),l[o.index][0]=s,l[o.index][1]=a,B._setCoords(c,l)},e.prototype.pointerup=function(e){var t=this.getLine(),r=this.properties.moved;r&&B.markAsModified(t),B.displayShapes(t),t._e().listeners.trigger(e,this,r?"dragStop":void 0)},e.prototype.remove=function(){B.removeCoord(this.getLine(),this.properties.index)},e}(a.features.Feature);G.prototype.class="LINE_SHAPE";var U,z,H=function(i){function e(e,t,r,n){return U=n,i.call(this,e,t,r,n)||this}return c(e,i),e.prototype.pointerdown=function(e){i.prototype.pointerdown.call(this,e)},e.prototype.pressmove=function(e,t,r){var n=this.properties,o=this.getLine();n.moved||(n.index++,U.addCoord(o,this.geometry.coordinates.slice(),n.index,!0),U.removeShapes(o,"vShps",this)),i.prototype.pressmove.call(this,e,t,r)},e.prototype.pointerup=function(e){this.getProvider().removeFeature(this),i.prototype.pointerup.call(this,e)},e}(G);function K(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,highlight:!0,moved:!1,shps:[],vShps:[]}),t?r[t]:r}H.prototype.class="LINE_VIRTUAL_SHAPE";var J=function(e,t,r){void 0===r&&(r=!1),t&&e.editState(t,r),e._e().setStyle(e,z)};function V(e){K(this,"isEditable")&&this._e().listeners.trigger(e,this)}var Q,W,Y,q,Z={private:K,_evl:{pointerenter:V,pointerleave:V,pointerup:function(e){var t=this,r=K(t);r.isEditable&&(!r.isSelected&&t._e()._config.featureSelectionByDefault&&Z._select(t),t._e().listeners.trigger(e,t))}},addCoord:function(e,t,r,n){var o=e.coord();if(r==z){if(!1===(r=k(o,t)))return!1;r++}return o.splice(r,0,t),Z._setCoords(e,o),n||Z.displayShapes(e),r},removeCoord:function(e,t){var r,n=e.coord(),o=n.length;return 2<o&&0<=t&&t<o&&(r=n.splice(t,1),Z._setCoords(e,n),Z.displayShapes(e)),r},createShapes:function(e,t,r,n){var o=K(e,r),i=t.length;o.length&&Z.removeShapes(e,r);for(var s=0;s<i;s++)o[s]=new n(e,[t[s][0],t[s][1]],s,Z),e._e().objects.overlay.addFeature(o[s])},createVShapes:function(e){for(var t=e.geometry.coordinates,r=[],n=1;n<t.length;n++)r.push(u(t[n-1],t[n],.5));Z.createShapes(e,r,"vShps",H)},displayShapes:function(e){if(K(e,"isSelected")){var t=e.geometry.coordinates;Z.createShapes(e,t,"shps",G),Z.createVShapes(e)}},removeShapes:function(t,e,r){var n=K(t,e);n.forEach(function(e){e!=r&&t._e().objects.overlay.remove(e)}),n.length=0},deHighlight:function(e){K(e,"isSelected")&&(J(e,"selected",!1),Z.removeShapes(e,"shps"),Z.removeShapes(e,"vShps"))},_editable:function(e,t){var r=K(e);return t!=z&&(r.isEditable=!!t),Z.deHighlight(e),r.isEditable},_select:function(e){e._e().objects.selection.select(e)&&(J(e,"selected",!0),Z.displayShapes(e))},_setCoords:function(e,t){e._e().objects.history.origin(e),e.getProvider().setFeatureCoordinates(e,t)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),Z.deHighlight(e),e.getProvider().removeFeature(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),(t==z||t)&&e._e().objects.history.saveChanges(),e}},X=function(e,t){this.offset=e,this.distance=t},$=function(e,t){for(var r=0,n=0,o=0;o<t.length-1;o++){var i=t[o],s=t[o+1];0!=p(t[o],t[o+1],e)&&(n=r+L(i,e)),r+=L(i,s)}return n/r},ee=function(e,t){for(var r=0,n={lenPntToLine:1/0,lenTotal:0,shp:0},o=0;o<e.length-1;o++){var i=e[o],s=e[o+1],a=R(e[o],e[o+1],t);if(0!=a){var c=L(a,t);c<n.lenPntToLine&&(n.shp=o,n.lenPntToLine=c,n.lenTotal=r+L(i,a))}r+=L(i,s)}var l=0,d={shp:-1,distancePoi:1/0,length:-1};for(o=0;o<e.length;o++){var u=L(e[o],t);0<o&&(l+=L(e[o],e[o-1])),u<d.distancePoi&&(d.shp=o,d.distancePoi=u,d.length=l)}return n.lenPntToLine<d.distancePoi?new X(n.lenTotal/r,n.lenPntToLine):new X(d.length/r,d.distancePoi)},te=function(e,t,r){if(t[0]==r[0]&&t[1]==r[1])return!1;var n=e[0]-t[0],o=e[1]-t[1],i=r[0]-t[0];return 0<n*(r[1]-t[1])-o*i?"L":"R"},re=function(e,t,r,n){e.target=r||"display",e._e().listeners.trigger(t,e,n)};function ne(e,t){var r=null,n=e.getLink();if(n){var o=n.coord(),i=k(o,e.coord());if(!1!==i)var s=o[i],a=o[i+1];s!==W&&a!==W&&(r=te(t.coord(),s,a))}return r}function oe(h,c,e){Q=e;var f,n,v,l,g=this,A=h._e();function t(){this.prevDMove=null,f.moved=!1}function r(e,t,r,n,o){var i=this.prevDMove||[0,0],s=t-i[0],a=r-i[1];if(v&&!A._config.editRestrictions(h,1)){var c=A.map.getEventsMapXY(e),l=A.map.getGeoCoord(c[0]+s,c[1]+a);l.pop();var d=A.objects.getNearestLine(l,[v]),u=-1!=[0,h.geometry.coordinates.length-1].indexOf(d.shpIndex);if(f.moved||(f.moved=!0,re(h,e,"routing","dragStart")),u||g.setRoutingPoint(v,d.point),1<d.distance||u){var p=A.objects.getNearestLine(l,v.getProvider(),{ignore:[v],maxDistance:10});if(p&&(p.distance<d.distance||u))return Q.defaults(v),g.setRoutingPoint(p.line,p.point),void Q.displayAsSelected(p.line,h.id,!0)}u||y()}i[0]=t,i[1]=r,this.prevDMove=i}function o(e){f.moved&&(c.setRoutingData(h),y(ne(g,h)),c.markAsModified(h)),re(h,e,"routing",f.moved?"dragStop":W)}function y(e){if(v){var t=v.coord(),r=b(t),n=0^ee(t,l).offset,o=C(t,r*n),i=C(t,r*n+(n<1?1:-1));o[0]==i[0]&&i[1]==o[1]||f&&(g.updateStreetLine(),A.objects.overlay.setFeatureCoordinates(f,l.slice()))}}g.getLink=function(){return v},g.coord=function(){return l},g.show=function(){if(v&&!f){var e=h.class;n=A.objects.overlay.addPath([h.coord().slice(),l.slice()],W,{type:e+"_LINE"}),(f=A.objects.overlay.addPoint(l.slice(),{type:e+"_ROUTING_POINT"})).pointerdown=t,f.pressmove=r,f.pointerup=o}return v&&(y(ne(g,h)),Q.displayAsSelected(v,h.id)),v},g.hide=function(){f&&(f.pointerdown=f.pressmove=f.pointerup=W,A.objects.overlay.remove(f),A.objects.overlay.remove(n),f=n=null)},g.updateRoutingPoint=function(){var e,t,r=c.getRoutingData(h),n=r.link,o=c.getRoutingProvider(h),i=r.position;if(v=l=null,n&&o&&(v=o.search(n)),v){if(i){t=v.coord();for(var s=0;s<t.length-1;s++)if(p(t[s],t[s+1],i,1e-6))return l=i,v;e=i}else e=h.coord();var a=A.objects.getNearestLine(e,[v]);a&&(v=a.line,l=a.point)}return v},g.searchLink=function(){var e=c.getRoutingProvider(h);return e&&A.objects.getNearestLine(h.coord(),e,{maxDistance:A._config.maxRoutingPointDistance})},g.setRoutingPoint=function(e,t){if(l=v=null,e)v=e,l=t;else{var r=g.searchLink();r&&(v=r.line,l=r.point)}return v},g.clearRoutingPoint=function(){v=l=null,g.hide()},g.updateStreetLine=function(){if(n){var e=h.coord(),t=c.private(h);if(t.isSelected){var r=(A.getStyle(t.selector)[0]||[])[1]||{};e=A.map.getGeoCoord(x(A.map.getPixelCoord(e),A.map.getPixelCoord(l),r.radius||r.width/2))}A.objects.overlay.setFeatureCoordinates(n,[l].concat([e]))}}}var ie=function(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,isHovered:!1,cLink:null,moved:!1,prevDMove:null}),t?r[t]:r};var se=function(e){return Math.round(1e5*e)/1e5},ae=function(e){return"PLACE"==e.class},ce=function(e){var t=ie(e);return null==t._rp&&(t._rp=new oe(e,he,Y)),t._rp};function le(e,t){var r=!ae(e),n=he.getRoutingData(e).link,o=ie(e);o.isHovered=t;var i=n||r;if(n||r){var s=ce(e);(s.updateRoutingPoint()||s.setRoutingPoint())&&(o.cLink=s.show(),i&&he.setRoutingData(e))}t&&re(e,t)}function de(e,t){var r=ie(e,"cLink");ie(e).isHovered=!t,r&&Y.defaults(r,e.id)&&Y.private(r,"isSelected")&&Y.displayAsSelected(r),t&&re(e,t),ce(e).hide()}function ue(e){var t=ie(this);t.allowEdit&&!t.isSelected&&("pointerenter"==e.type?le(this,e):de(this,e))}function pe(e,t,r,n,o){var i=this,s=ie(i),a=i._e();if(s.isSelected&&!a._config.editRestrictions(i,1)){s.moved||(s.moved=!0,he.getRoutingData(i).link!=q&&he.connect(i,null),re(i,e,"display","dragStart"));var c=s.prevDMove||[0,0],l=t-c[0],d=r-c[1];a.map.pixelMove(i,l,d),c[0]=t,c[1]=r,s.prevDMove=c,ce(i).updateStreetLine()}}var he={private:ie,setLinkTools:function(e){Y=e},_evl:{pointerenter:ue,pointerleave:ue,dbltap:function(e){re(this,e)},pointerup:function(e){var t=ie(this),r=t.moved,n=this._e();t.allowEdit&&(t.isSelected||(n.dump(this),n._config.featureSelectionByDefault&&he._select(this)),r&&(ce(this).show(),he.markAsModified(this)),re(this,e,"display",r?"dragStop":q),t.moved=!1,t.prevDMove=null)},pointerdown:function(){var e=ie(this);e.allowEdit&&e.isSelected&&(e.moved=!1,e.prevDMove=null)}},deHighlight:function(e){var t=ie(e);return t.selector&&e._e().objects.overlay.remove(t.selector),t.selector=null,t.isSelected&&(de(e),t.pressmove=null,t.isSelected=!1,t.cLink&&Y.defaults(t.cLink,e.id)),e},_editable:function(e,t){var r=ie(e);t!=r.allowEdit&&(t||(he.deHighlight(e),r.isHovered&&(r.isHovered.type="mouseout",de(e,r.isHovered))),r.allowEdit=t)},_select:function(e){e._e().objects.selection.select(e)&&(ie(e).pressmove=pe,he.highlight(e),le(e))},_setCoords:i._setCoords,markAsRemoved:i.markAsRemoved,markAsModified:i.markAsModified,_props:function(e,t){var r=arguments.length,n=e.getProvider().getFeatureProperties(e);if(1<r){if(2==r&&"string"==typeof t)return n[t];if(3==r){var o=t;(t={})[o]=arguments[2]}e._e().objects.history.origin(e),w.JSUtils.extend(n,t)}return n},highlight:function(e){var t=ie(e);t.selector||(t.selector=e._e().objects.overlay.addCircle(e.geometry.coordinates,q,{type:e.class+"_SELECTOR"}))},getRoutingProvider:function(e){var t=e._e(),r=e.getProvider().readRoutingProvider(e,t.layers.map(function(e){return e.getProvider()}));return t.getProviderById(r)},getRoutingData:function(e){return e.getProvider().readRoutingPoint(e)},setRoutingData:function(e){var t=ce(e),r=t.getLink(),n=t.coord(),o=ie(e);o.cLink=r;var i=n?[se(n[0]),se(n[1]),0|n[2]]:[],s=he.getRoutingData(e),a=s.position||[],c=r?r.id:null;s.link==c&&i[0]==se(a[0])&&i[1]==se(a[1])||(e._e().objects.history.ignore(function(){o.writeProp=!0,e.getProvider().writeRoutingPoint(e,r,n?i:n),delete o.writeProp}),he._setCoords(e,e.geometry.coordinates))},connect:function(e,t,r){var n=ie(e);if(!n.writeProp){var o=ce(e),i=o.getLink(),s=(he.getRoutingData(e).position||[]).slice();i&&Y.defaults(i),t?n.cLink=o.setRoutingPoint(t,r):(n.cLink=o.updateRoutingPoint())||!1===t||(n.cLink=o.setRoutingPoint()),(ae(e)||n.cLink)&&he.setRoutingData(e),n.isSelected&&(n.cLink?le(e):de(e));var a=he.getRoutingData(e).position||[];i==n.cLink&&s[0]==a[0]&&s[1]==a[1]||he.markAsModified(e,!1)}},disconnect:function(e){var t=ie(e);t.writeProp||(de(e),ce(e).clearRoutingPoint(),t.cLink=null,ae(e)||ce(e).setRoutingPoint(),he.setRoutingData(e),he.markAsModified(e,!1))},getRoutingPosition:function(e){var t=ce(e),r=t.coord();return r||(t.updateRoutingPoint(),r=t.coord()),r&&[r[0],r[1],r[2]||0]||q}};function fe(e,t,r){this.isPntInFence=function(){return!0},this.isHidden=function(){return!0},this.remove=function(){}}var ve,ge,Ae,ye="@ns:com:here:editor",me=function(e){return e.__||(e.__={})},Se=function(e,t){var r,n,o=e.coord()[t],i=e.getConnectedLinks(t),s=e._e();return i.push(e),null!=(r=s.objects.getNearestLine(o,e.getProvider(),{maxDistance:s._config.autoConnectShapeDistance,ignore:i.map(function(e){return e.id})}))&&((n=r.point)[2]=o[2]||0,null===ve.connectShpToLink(e,t,r=r.line,n)&&(r=null)),r};function Ee(e,t){me(this).line._e().listeners.trigger(e,this,t)}function Ce(){var e=(r=me(this)).line,t=e._e();r._cls=r.cLinks.map(function(e){return e.link}),r.drg=!1;var r,n=this.geometry.coordinates,o=t.display.geoToPixel.apply(t.display,n);(r=me(this)).x=o.x,r.y=o.y,t.dump(this),ve.removeShapePnts(e,!0),t.listeners.trigger("_clearOverlay"),ve.hideDirection(e),ge=new fe(t,n[0],n[1])}function ke(e,t,r){var n=me(this),o=n.line,i=o._e(),s=i._config,a=i.map.getGeoCoord(n.x+t,n.y+r);if(!s.editRestrictions(o,1))if(ge.isPntInFence(a)){if(!ge.isHidden()&&ge.hide(),s.autoSnapShape)for(var c=2*(21-i.display.getZoomlevel()),l=o.getProvider().search({point:a,radius:c}),d=l.length,u=void 0;u=l[--d];)if(u.id!=o.id&&-1==n._cls.indexOf(u)){var p=i.map.calcCrossingAt(u.geometry.coordinates,a,s.minShapeDistance,Ae,c);if(p&&p.index!=Ae){a=p;break}}ve.moveShapeAtIndexTo(o,n.index,a[0],a[1]),n.drg||(n.drg=!0,Ee.call(this,e,"dragStart"))}else ge.isHidden()&&ge.show()}function xe(e){var t,r,n=me(this),o=n.index,i=n.drg,s=!1,a=n.line,c=!1,l=!1,d=n.cLinks;n._cls=null,i&&("boolean"==typeof(r=ve.fixGeo(a,o))?c=!r:(c=0<=r,(l=o!=r)&&(o=r))),ve.showDirection(a),ge.isHidden()&&!c&&i&&(t=Se(a,o)),t||(i&&((!1===r?d:a.getConnectedLinks(o,!0)).forEach(function(e){var t=ve.fixGeo(e.link,e.index);l="number"==typeof t||!t||l,ve.markAsModified(e.link,!1,!1)}),s=!0),ve.createAddShapePnts(a)),ge&&ge.remove(),n.drg=!1,(l||i)&&ve.refreshGeometry(a),a._e().listeners.trigger(e,a.editState("removed")?this:ve.private(a,"shps")[o],i?"dragStop":void 0),s&&ve.markAsModified(a,!0,!1)}function Le(){var e=me(this);document.body.style.cursor="default",e.cLinks.forEach(function(e){ve.defaults(e.link)}),delete this.properties[ye].hovered,e.line._e().setStyle(this)}function be(){var e=me(this),n=e.line._e();document.body.style.cursor="move",e.cLinks.forEach(function(e){for(var t=n.getStyle(e.link),r=0;r<t.length;r++)t[r].opacity=.5;n.setStyle(e.link,t)}),this.properties[ye].hovered=!0,n.setStyle(this)}var _e=function(d){function e(e,t,r,n){var o;ve=n;var i=e._e(),s=e.getConnectedLinks(r,!0),a=0==r||r==e.geometry.coordinates.length-1,c={type:"Feature",geometry:{type:"Point",coordinates:t.slice()},properties:{isNode:a,isConnected:!!s.length,"@ns:com:here:editor":{},NAVLINK:{properties:w.JSUtils.extend(!0,{},e.properties),style:i.getStyle(e)},parent:e}};o=d.call(this,c,i.objects.overlay.layer.getProvider())||this;var l=me(o);return l.index=r,l.line=e,l.drg=!1,l.cLinks=s,l.dblclick=Ee,l.pressmove=ke,l.pointerdown=Ce,l.pointerup=xe,i._config.editRestrictions(e,1)||(l.pointerenter=be,l.pointerleave=Le),o}return c(e,d),e.prototype.getLink=function(){return this.properties.parent},e.prototype.isNode=function(){return this.properties.isNode},e.prototype.isOverlapping=function(){return ve.checkOverlapping(this.properties.parent,this.getIndex())},e.prototype.getIndex=function(){return me(this).index},e.prototype.editTurnRestrictions=function(){if(this.isNode())return this.getLink().editTurnRestrictions(this.getIndex())[0]},e.prototype.getConnectedLinks=function(){return this.getLink().getConnectedLinks(this.getIndex())},e.prototype.remove=function(){var e=this.getLink();e._e()._config.editRestrictions(e||this,2)||ve.deleteShape(e,this)},e.prototype.disconnect=function(){var e=me(this),t=e.line._e();if(this.isNode()&&e.cLinks.length){var r=e.line,n=e.index,o=r.coord(),i=o[n],s=o[n+(n?-1:1)],a=90-w.geotools.calcBearing(i,s),c=t.map.movePoint(i,t._config.disconnectShapeDistance,a);t.hooks.trigger("Navlink.disconnect",{link:r,index:n},r.getProvider()),o[n][0]=c[0],o[n][1]=c[1],ve._setCoords(r,o),ve.fixGeo(r),ve.refreshGeometry(r),ve.markAsModified(r)}},e.prototype.splitLink=function(){var e,t=this.getLink(),r=t._e();return this.isNode()||(e=r.objects.splitLinkAt({link:t,index:this.getIndex()})).length&&r.objects.history.saveChanges(),e},e}(a.features.Feature);_e.prototype.class="NAVLINK_SHAPE";var Ie,Pe=function(o){function e(e,t,d,u){var r,p,h=e._e(),n=h.display;var f=r=o.call(this,{type:"Feature",geometry:{type:"Point",coordinates:t.slice()},properties:{type:"NAVLINK_VIRTUAL_SHAPE",NAVLINK:{properties:w.JSUtils.extend(!0,{},e.properties),style:h.getStyle(e)},parent:e}},h.objects.overlay.layer.getProvider())||this;return f.pointerdown=function(){var e=f.properties.parent;f.moved=!1,u.hideDirection(e);var t=n.geoToPixel.apply(n,this.geometry.coordinates);p=new fe(h,f.x=t.x,f.y=t.y)},f.pressmove=function(e,t,r,n,o){var i=f.properties.parent,s=h.map.getGeoCoord(f.x+t,f.y+r);if(p.isPntInFence(s)){p.isHidden()||p.hide();var a=u.private(i,"shps");if(!f.moved){u.addShp(i,s,d,!1,!0),u.removeShapePnts(i,!0,f.id),f.pointerenter=f.pointerleave=void 0,f.moved=!0;var c=a[d];c.x=f.x,c.y=f.y,c.__.pointerdown.call(c)}var l=a[d];l.__.pressmove.apply(l,arguments)}else p.isHidden()&&p.show()},f.pointerup=function(e){var t=f.properties.parent,r=u.private(t);if(f.moved){var n=r.shps[d];n.__.pointerup.call(n,e),this.getProvider().removeFeature(this)}else r.isSelected&&u.showDirection(t)},h._config.editRestrictions(e,1)||(f.pointerenter=f.pointerleave=function(e){var t="pointerenter"==e.type;document.body.style.cursor=t?"move":"default",this.properties["@ns:com:here:editor"].hovered=t,h.setStyle(this)}),r}return c(e,o),e}(a.features.Feature),we=function(){},Re=function(e,t){var r=e.__;return r||(r=e.__={isSelected:!1,isEditable:!0,allowEdit:!0,shps:[],vShps:[],isHovered:null,_cPnt:null,arrows:null,prevBBox:null,isGeoMod:!1,dh:null,xt:null}),t?r[t]:r};function Fe(e,t){var r=arguments.length,n=e.getProvider().getFeatureProperties(e);if(1<r){if(2==r&&"string"==typeof t)return n[t];if(3==r){var o=t;(t={})[o]=arguments[2]}e._e().objects.history.origin(e),w.JSUtils.extend(n,t)}return n}function De(e){var t=this,r=e.type;Re(t,"allowEdit")&&t._e()._config.featureSelectionByDefault&&("dbltap"==r||"pointerup"==r)&&Ue._select(t),t._e().listeners.trigger(e,t)}function Ne(e,t){if(t)for(var r in t)e.editState(r,t[r]);e._e().setStyle(e,Ie)}function Te(e){var t=Re(e),r=t.prevBBox=t.prevBBox||e.bbox.slice();return Ue.getConnectedObjects(e,w.geotools.mergeBBoxes(r,e.bbox))}function Oe(e,t){Re(e).isGeoMod=!0,e._e().objects.history.origin(e),e._provider.setFeatureCoordinates(e,t)}function je(e,t){if(e._e().objects.overlay.remove(t),t.class){for(var r in t)"id"!=r&&"type"!=r&&"class"!=r&&"properties"!=r&&"geometry"!=r&&(t[r]=Ie);t.isDeleted=!0}}function Be(e,t){var r=e.__.ol;e.properties.isOverlapping=t,r!=(e.__.ol=t)&&e.getLink()._e().setStyle(e,Ie)}function Me(e){e.listeners.trigger("featureUnselected",{featureUnselected:!0})}function Ge(e){var t=Re(this);t.allowEdit&&(document.body.style.cursor="default",De.call(this,e),t.isSelected||function(e){for(var t=Ue.getConnectedObjects(e),r=0;r<t.length;r++)if(he.private(t[r],"isSelected"))return!0}(this)||Ne(this,{hovered:!1}),t.isHovered=null)}var Ue={private:Re,_evl:{pointerenter:function(e){var t=Re(this);t.allowEdit&&(document.body.style.cursor="Pointer",t.isHovered=e,De.call(this,e),Ne(this,{hovered:!0}))},pointerleave:Ge,dbltap:De,pointerup:De},deHighlight:function(e){return Re(e,"isSelected")&&(Ne(e,{selected:!1,hovered:!1}),Ue.removeShapePnts(e),Ue.hideDirection(e)),e},_editable:function(e,t){var r=Re(e);if(t!=r.allowEdit){if(!t){var n=r.isHovered;n&&(n.type="mouseout",Ge.call(n.target,n)),Ue.deHighlight(e)}r.allowEdit=t}},_select:function(e){Re(e,"isSelected")||(e._e().objects.selection.select(e),e._e().dump(e,"info"),Ue.refreshGeometry(e))},_setCoords:function(e,t){for(var r=t.length;r--;)t[r][2]=t[r][2]||0;Te(e),Oe(e,t),Ue.refreshGeometry(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),Ue.hideDirection(e),Te(e).forEach(function(e){he.disconnect(e)}),Ue._editable(e,!1);var t,r,n,o=e.coord(),i=o[0].slice(0,2),s=o[o.length-1].slice(0,2);r=s,n=n||0,(t=i)[2]==r[2]&&L(t,r)<=n&&(o[0][0]+=1e-5,o[0][1]+=1e-5,Oe(e,o))},markAsModified:function(r,e,t){void 0===e&&(e=!0),void 0===t&&(t=!0);var n=r.editState("modified"),o=Re(r);if(r.editState("modified",Date.now()),o.isGeoMod){var i=r.coord();Te(r).forEach(function(e){var t=C(i,b(i)*ee(i,he.getRoutingPosition(e)).offset);he.connect(e,r,t)}),o.isGeoMod=!1}return n||(Ne(r),!o.isSelected&&t&&Ue.defaults(r)),e&&r._e().objects.history.saveChanges(),r},_props:Fe,getConnectedObjects:function(r,e){return r._e().objects.getInBBox(e||r.bbox).filter(function(e){var t=e.class;if("PLACE"==t||"ADDRESS"==t)return e.getLink()==r})},refreshGeometry:function(e){Ue.removeShapePnts(e),Re(e,"isSelected")&&(Ue.displayAsSelected(e),Ue.showDirection(e),Ue.createShapes(e),Ue.createAddShapePnts(e))},checkOverlapping:function(e,t){var r=e.coord(),n=t==Ie,o=n?1:t,i=n?r.length-1:o+1,s=[];i==r.length&&i--;for(var a,c=e._e().objects.getInBBox(e.bbox,e.getProvider()),l=c.length;l--;)if((a=c[l]).id!=e.id&&"NAVLINK"==a.class)for(var d=o;d<i;d++)for(var u=0,p=a.coord();u<p.length;u++)if(r[d][0]==p[u][0]&&r[d][1]==p[u][1]){s.push(d);break}return n?s:!!s.pop()},createLinkShape:function(e,t,r){return e._e().objects.overlay.addFeature(new _e(e,t,r,Ue))},createShapes:function(r){var e=Re(r,"shps"),t=r.geometry.coordinates,n=t.length;if(!r.editState("removed")){var o=Ue.checkOverlapping(r);if(e.length)e.forEach(function(e,t){e.__.cLinks=r.getConnectedLinks(t,!0)});else for(var i=0;i<n;i++){var s=Ue.createLinkShape(r,[t[i][0],t[i][1]],i);Be(s,0<=o.indexOf(i)),e[i]=s}}},createAddShapePnts:function(e){var t=Re(e,"vShps");if(!t.length&&!e.editState("removed")&&!e._e()._config.editRestrictions(e,1))for(var r=e.geometry.coordinates,n=1,o=void 0,i=void 0;n<r.length;n++)o=r[n-1],i=r[n],t.push(e._e().objects.overlay.addFeature(new Pe(e,u(o,i,.5),n,Ue)))},removeShapePnts:function(r,e,n){function t(e){for(var t=0;t<e.length;t++)e[t].id!=n&&je(r,e[t]);e.length=0}var o=Re(r),i=o.vShps;return e||t(o.shps),(i.length||e)&&t(i),r},moveShapeAtIndexTo:function(r,e,n,o,t){var i=r.coord(),s=Re(r,"shps");i[e][0]=n,i[e][1]=o,Te(r),Oe(r,i),Ue.hideDirection(r);var a=s[e];return!t&&a&&(r._e().objects.overlay.setFeatureCoordinates(a,[n,o]),a.__.cLinks.forEach(function(e){var t=e.link;!r._e()._config.editRestrictions(t,1)&&Ue.moveShapeAtIndexTo(t,e.index,n,o)}),Be(a,Ue.checkOverlapping(r,e))),i},deleteShape:function(e,t,r){var n="number"==typeof t?t:t.getIndex(),o=e.coord();if(2<o.length){o.splice(n,1);var i=Re(e),s=i.shps;s.length&&(je(e,s[n]),s.splice(n,1),s.forEach(function(e){e.__.index-=Number(e.getIndex()>=n)})),Te(e),Oe(e,o),r||Ue.markAsModified(e),i.isSelected&&Ue.refreshGeometry(e)}},showDirection:function(e){if(!e.editState("removed")){var t=(""+e.getProvider().readDirection(e)).toUpperCase(),r=void 0,n=void 0,o=void 0,i=void 0,s=void 0;if(Ue.hideDirection(e),"START_TO_END"==t?i=90:"END_TO_START"==t&&(i=-90),i!=Ie){var a=Re(e).arrows=[];r=e.geometry.coordinates;for(var c=0;c<r.length-1;c++)n=r[c],o=r[c+1],s=w.geotools.calcBearing(n,o)-i,a.push(e._e().objects.overlay.addPoint(u(n,o,.5),{type:"NAVLINK_DIRECTION",bearing:s}))}}return e},displayAsSelected:function(e,t,r){var n=Re(e);n.isSelected||(n._cPnt=t),Ne(e,{selected:!0})},addShp:function(t,e,r,n,o,i){var s=t.coord(),a=t._e(),c=a.map.calcCrossingAt(s,e,a._config.minShapeDistance,i);if(r="number"==typeof r?r:c.index,!c.existingShape||o){c.existingShape&&(r=k(s,e)+1),e[2]=e[2]||0,a.map.clipGeoCoord(e),s.splice(r,0,e),function(e,t){for(var r=Fe(e,"bn")||[],n=0;n<r.length;n++)r[n]+=r[n]>=t}(t,r),Te(t),Oe(t,s);var l=Re(t,"shps");l.length&&(l.splice(r,0,Ue.createLinkShape(t,e,r)),l.forEach(function(e){e.__.index+=Number(e.getIndex()>r)}),l.forEach(function(e){Be(e,Ue.checkOverlapping(t,e.getIndex()))})),Ue.refreshGeometry(t)}else n||(r=!1);return r},defaults:function(e,t){var r=Re(e);return(!t||t==r._cPnt)&&(r._cPnt=null,Ne(e,{selected:!1,hovered:!1}),e)},hideDirection:function(e){var t=Re(e,"arrows");if(t){for(var r=0;r<t.length;r++)e._e().objects.overlay.remove(t[r]);t.length=0}return e},fixGeo:function(e,t,r,n){return He(e,t,r,n)},connectShpToLink:function(e,t,r,n,o,i,s){var a,c=new we,l=e._e().objects;if(r.id!=e.id){var d=function(e,t,r,n,o,i,s){var a=e._e(),c=e.coord(),l=e.getConnectedLinks(t,!0),d=o[0],u=o[1],p=a.objects.factory,h=a._config.minShapeDistance,f=a.map.calcCrossingAt(r.coord(),o,h,n),v=a.map.clipGeoCoord(f.point),g=null,A=f.existingShape,y=A&&(m=r,S=f.index,-1!=(Fe(m,"bn")||[]).indexOf(S==m.geometry.coordinates.length-1?"N":S));var m,S;c[t][0]=d,c[t][1]=u,Ue._setCoords(e,c),y&&p.blockShapeAtIndex(e,t);null!==f.index&&(g=a.objects.splitLinkAt(A?{link:r,index:f.index,avoidSnapping:!0}:{link:r,point:v,preferSegment:n,avoidSnapping:!0}),ze(e,t,v[0],v[1]),l.forEach(function(e){var t=e.link;ze(t,e.index,v[0],v[1]),He(t,e.index,!0),y&&p.blockShapeAtIndex(t,e.index),Ue.markAsModified(t,!1,!1),Ue.defaults(t)}));return g}(e,t,r,o,n);if(null===d)return null;0<t&&t<e.geometry.coordinates.length-1&&(Re(e,"isSelected")&&Me(e._e()),Ue.deHighlight(e),a=l.splitLinkAt({link:e,index:t}));var u=e.geometry.coordinates;2==u.length&&u[0][0]==u[1][0]&&u[0][1]==u[1][1]&&l.remove(e),Ue.markAsModified(e),Re(e,"isSelected")&&Ue.refreshGeometry(e),d&&(c.targetSplittedInto=d),a&&(c.splittedInto=a)}return c},isIntersection:function(e,t,r){var n=Math.pow(10,e._config.intersectionScale),o=function(e){return Math.round(e*n)};return o(t[0])==o(r[0])&&o(t[1])==o(r[1])}},ze=Ue.moveShapeAtIndexTo;function He(L,b,_,n){var I=L._e(),P=I.objects,w=!0===_,e=b||0,t=L.getZLevels().length,r=b===Ie?t:e+1,o=!0,R=I._config.minShapeDistance||2;function i(v){if(n==v)return!0;function g(e){return 0==e||e==C-1}function A(e){var t=L.getConnectedLinks(e,!0);return t.forEach(function(e){var t=e.link;Ue.markAsModified(t,!1),ze(t,e.index,m[0],m[1],!0)}),t}for(var y,m,S=L.coord(),E=Re(L),C=S.length,k=!1,x=!1,e=function(e){if(v!=e){var t=S[e],r=S[v];if(h=r,f=(f=R)||1,(p=t)[2]==h[2]&&I.map.distance(p,h)<=f){if(y=Math.abs(v-e)-1,g(e)&&g(v)?1==y?k=v:x=e:g(v)?y<=1?k=v:x=e:g(e)?(1==y&&e<v&&(k=e),0==y?k=v:0<y?x=v:k=e):0==y?k=v:x=e,!1!==x){var n,o,i=void 0;if(m=S[x],2==C){var s=A(b);ze(L,v==x?e:v,m[0],m[1]),Me(L._e()),P.remove(Ue.deHighlight(L)),s.forEach(function(e){w||He(e.link,e.index,!0)})}else A(v),ze(L,v,m[0],m[1]),(o=P.splitLinkAt({link:L,index:x===C-1||0===x?~~(C/2):x})).forEach(function(e,t){He(e,Ie,_.concat(L,o[Number(0==t)]))}),!(i=o[Number(x<=v)]).editState("removed")&&2<=Math.abs(v-x)&&(i.coord().forEach(function(e,t){e[0]==m[0]&&e[1]==m[1]&&(n=t)}),n&&P.splitLinkAt({link:i,index:n}));return{value:!1}}if(!1!==k){var a=S[e][0],c=S[e][1],l=!1;L.getConnectedLinks(k,!0).forEach(function(e){var t,r=e.link;Ue.markAsModified(r,!1),Ue.moveShapeAtIndexTo(r,e.index,a,c,!0),t=r,l=!(w||-1!=_.indexOf(t))}),ze(L,v==e?e:v,a,c,!0),Ue.deleteShape(L,k,!0),g(k)&&(!g(v)&&0<v-1&&ze(L,v-1,a,c,!0),E.isSelected&&Ue.refreshGeometry(L),l&&2<S.length&&P.splitLinkAt({link:L,index:e-Number(0===k)}));var d=v-e,u=void 0;return 0<d?u=v-1-y:d<0&&(u=v+y),{value:u}}}}var p,h,f},t=0;t<C;t++){var r=e(t);if("object"==typeof r)return r.value}return!0}if(!L.editState("removed")&&e<t)for(_=w||!_?[]:_;e<r&&!0===(o=i(e));e++);return o}var Ke={};Ke.MARKER=i,Ke.AREA=M,Ke.LINE=Z;var Je=Ke.NAVLINK=Ue;function Ve(e){return Ke[e.class]}function Qe(n){return function(e){var t=e.class,r=Ke[t][n];if(r)return r.apply(r,arguments)}}(Ke.PLACE=Ke.ADDRESS=he).setLinkTools(Je);var We={getTool:function(e,t){var r=Ve(e);return r&&t?r[t]:r},private:Qe("private"),getEventListener:function(e,t){var r=Ve(e);return r?r._evl[t]||r.private(e,t):e.__&&e.__[t]||e[t]}};for(var Ye in Ke)for(var qe in Ke[Ye])We[qe]||(We[qe]=Qe(qe));var Ze=function(){},Xe=Ze.prototype;Xe.created=!1,Xe.modified=!1,Xe.removed=!1,Xe.split=!1,Xe.selected=!1,Xe.hovered=!1;var $e=a.features.Feature,et=function(e){return 3==e.length?[e[0],e[1],e[2]]:[e[0],e[1]]},tt=function(n){function e(e,t){var r=n.call(this,e,t)||this;return r.properties["@ns:com:here:editor"]=new Ze,r}return c(e,n),e.prototype.toString=function(){return this.class+" ðŸŒŽ "+this.id},e.prototype.getProvider=function(){return this._provider},e.prototype._e=function(){return this._provider._e},e.prototype.editState=function(e,t){var r=arguments.length,n=this,o=n.properties["@ns:com:here:editor"];if(!r)return o;if(2==r){if(this._esu)return;t?o[e]=t:delete o[e],"hovered"!=e&&"selected"!=e&&n._e().objects.history.ignore(function(){n._esu=!0,n.getProvider().writeEditState(n,e),n._esu=void 0})}return o[e]},e.prototype.style=function(e){if("string"==typeof e||0==arguments.length)return this._e().getStyle(this,void 0);this._e().setStyle(this,e,!0)},e.prototype.prop=function(e){var t=this,r=!1,n=arguments.length,o=t.getProvider().getFeatureProperties(t);if(!n||1==n&&"string"==typeof e)return"object"==typeof(e=e?o[e]:o)?w.JSUtils.extend(!0,new e.constructor,e):e;if(2==n){var i={};i[e]=arguments[1],e=i}for(var s in e){var a=e[s],c="object"==typeof a,l=o[s];(c&&JSON.stringify(a)!=JSON.stringify(l)||!c&&l!==a)&&(r||(this._e().objects.history.origin(t),r=!0),o[s]=a)}r&&(this._e().setStyle(t),We.markAsModified(t))},e.prototype.getCoordinates=function(){return this.coord()},e.prototype.coord=function(e){var t,r=this,n=r.geometry.type;if(e instanceof Array)We.deHighlight(r),We._setCoords(r,e),We.markAsModified(r);else if(e=r.getProvider().decCoord(r),"Point"==n)t=et(e);else{t=[];for(var o=e.length,i=0;i<o;i++)t[i]=et(e[i])}return t},e.prototype.editable=function(e){return We._editable(this,e),this.unselect(),this},e.prototype.select=function(){We._select(this)},e.prototype.unselect=function(){We.private(this,"isSelected")&&this._e().objects.selection.clearSelected()},e.prototype.transform=function(){this._e().transformer.show(this)},e.prototype.remove=function(){this._e().objects.remove(this,{save:!0})},e}($e);tt.prototype.id=null;var rt="coordinates",nt="info";function ot(g){var A={};function t(e){return e.properties["@ns:com:here:editor"]}function p(e){return!!t(e).created}function y(e){return!!t(e).removed}function h(e,r,n,t){var o=e.id,i=[];for(var s in r)p(r[s])&&(A[o][s]||i.push(r[s]));0<i.length?e.reserveId(i,function(e){for(var t in r){p(r[t])&&!A[o][t]&&(A[o][t]=e.shift())}n(A[o],o)},t):w.global.setTimeout(function(){n(A[o],o)},0)}this.submit=function(i,t,r,e){var s=g._config.services.reverseGeocoder.getISOCC,n=e||w.JSUtils.String.random(),a=0;function c(){!function(s,a,e){var c,t,l,d=0;for(var r in l=JSON.stringify(s),s){for(var n in d++,t=!1,s[r])if(p(s[r][n])){t=!0;break}A[r]||(A[r]={}),t?(g.dump("REQUESTING PERMANENT IDs..",nt),h(g.getProviderById(r),s[r],function(e,t){var r,n,o="#"+w.JSUtils.String.random()+"#";for(var i in e)(c=s[t][i])&&(r=e[i],n=c.id.replace(/(?=[.\\+*?[^\]$(){}\|])/g,"\\"),l=l.replace('"'+n+'":{',o).replace(new RegExp('"link":"'+n+'"',"g"),'"link":"'+r+'"').replace(new RegExp('"'+n+'"|'+n,"g"),"number"==typeof r?r:'"'+r+'"').replace(o,'"'+r+'":{'),g.dump(c.id+" -> "+r,nt));--d||a(JSON.parse(l))},e)):d--}!d&&a(s)}(i,function(e){!function(e,t,r,n){var o=0;function i(){--o||(t(JSON.parse(JSON.stringify(A))),A={})}for(var s in e){o++;var a=g.getProviderById(s),c=e[s],l=[],d=[],u=void 0;for(var p in c)(y(u=c[p])?d:l).push(u);var h=A[s],f={};for(var v in h)f[h[v]]=v;l.length|d.length?a.commit({put:l,remove:d},i,function(e){r&&r(e)},n):i()}}(e,t,r,n)},r)}function l(e){if(e)return"number"==typeof e[0]?e:l(e[0])}for(var d in g.dump("COMMIT",n,nt),i){var o=function(e){var t,r,n=i[d][e],o=g.getProviderById(d);y(n)?p(n)&&delete i[d][e]:s&&(o.isoCC(n)||(a++,g.dump(n.id,"["+o.detectFeatureClass(n)+"] MISSING ISOCC -> REVERSE GEOCODING..",nt),r=l((t=n).geometry[rt]),s(r[0],r[1],function(e){e&&o.isoCC(t,e),--a||c()})))};for(var u in i[d])o(u)}a||c()}}function it(A,e){var y=!1,m=new ot(A);function S(e){!function(){var e,t,r=A.objects.history.getChanges(),n=[];for(var o in r)for(var i in t=A.getProviderById(o),r[o])(e=t.search(i))&&delete e.properties["@ns:com:here:editor"],n.push(t,r[o][i].bbox);for(var s=0;s<n.length;s+=2)(t=n[s]).clear.apply(t,n[s+1])}(),A.objects.history.clear(e),A.display.refresh()}e.revert=function(){for(var e=A.observers.get("history.current");e--;)A.objects.history.recoverViewport(-1,!0);S()},e.submit=function(e){var t,r,n,o,i,s=!1,a=[],c=!1,l=(e=e||{}).ignoreEventBlock,d=e.layer,u=e.onError,p=e.onSuccess,h=e.transactionId;if("function"==typeof l)throw new Error("Invalid parameter!");if(l||!y){for(var f in d=d instanceof Array?d:[d]){var v=d[f];v&&v instanceof WIKI.Layer&&"MARKER"==v.type&&(v.base&&a.push(v.base),v.delta&&a.push(v.delta),v.src&&a.push(v.src))}for(var g in t=A.objects.history.getChanges())0<a.length&&a.indexOf(g)<0?(c=!0,delete t[g]):s=!0;if(s)return A.objects.clear(),r=t,n=function(e){S(c?a:null),p&&p({permanentIDMap:e})},o=function(e){u&&u(e)},i=h,y||(A.objects.selection.clearSelected(),A.observers.change("ready",y),y=!0,m.submit(r,function(e){y=!1,n.call(null,e)},function(e){y=!1,o.call(null,e)},i)),!0}return!1},e.info=function(){var e=[],t=A.objects.history.getChanges();for(var r in t)for(var n in t[r])e[e.length]=w.JSUtils.clone(t[r][n]);return e},e.export=function(){return JSON.stringify(A.objects.history.getChanges())},e.import=function(e){return"string"==typeof e&&(e=JSON.parse(e)),A.objects.history.import(e)}}var st,at=function(){function e(e){this.type="CONTAINER",this.length=0,this._e=e}return e.prototype.push=function(e,t){var r,n,o={};t&&"Feature"==t.type&&(e=arguments,t=void 0),null==e.length&&(e=[e]);for(var i=this._e,s=0,a=e;s<a.length;s++){var c=a[s];(n=i.objects.add(c,t,o))&&(c=n,r=!0),this[this.length++]=c}return r&&i.objects.history.saveChanges(),this.length},e.prototype.forEach=function(e,t){for(var r=0;r<this.length;r++)e.call(t,this[r],r)},e.prototype.toArray=function(){for(var e=[],t=0;t<this.length;t++)e[e.length]=this[t];return e},e.prototype.highlight=function(){for(var e,t=this.length;e=this[--t];)We.highlight(e)},e.prototype.remove=function(){for(var e=this,t=e._e.objects,r=!1,n=e.length;n--;)r=t.remove(e[n],{animation:!1,save:!1})||r,delete e[n];r&&(e.length=0,t.history.saveChanges())},e.prototype.transform=function(){this.length&&this._e.transformer.show(this.toArray())},e.prototype.unhighlight=function(){for(var e,t=this.length;e=this[--t];)We.deHighlight(e)},e.prototype.pop=function(){var e=this;if(e.length){var t=e[--e.length];return delete e[e.length],t}},e.prototype.getBBox=function(){for(var e,t=this,r=[1/0,1/0,-1/0,-1/0],n=0;n<t.length;n++)(e=t[n].getBBox?t[n].getBBox():t[n].bbox)[0]<r[0]&&(r[0]=e[0]),e[1]<r[1]&&(r[1]=e[1]),e[2]>r[2]&&(r[2]=e[2]),e[3]>r[3]&&(r[3]=e[3]);return t.length?r:[0,0,0,0]},e}(),ct=function(e){return e.x!=st&&e.y!=st||e.longitude!=st&&e.latitude!=st};function lt(f,v){var g=function(e,t){if(ct(e)&&(e=f.map.getGeoCoord(e)),"number"==typeof e[0])return e[0]+=t[0],e[1]+=t[1],f.map.clipGeoCoord(e);for(var r=[],n=0;n<e.length;n++)r[n]=g(e[n],t);return r};v.addFeature=function(e,t,r){var n,o,i=arguments,s=[],a={},c={},l=function(e,t){var r=t&&t.id;(c[r]=c[r]||[]).push(e)};if(e instanceof tt)l(e,t);else if(e instanceof Array)e.forEach(function(e){return l(e,t)});else for(var d in c=e)"Feature"==(e=c[d]).type&&(c[d]=[e]);if(r=i[i.length-1],ct(r)){r=f.map.getGeoCoord(r);var u=f.display.getViewBounds();o=[r[0]-u.minLon,r[1]-u.maxLat]}else o=[0,0];var p=function(r){c[r].forEach(function(e){var t=e.geometry;t.coordinates=g(t.coordinates,o),(e=f.objects.add(e,"undefined"==r?st:r,a))&&(n=!0,s.push(e))})};for(var h in c)p(h);return n&&f.objects.history.saveChanges(),1<s.length?v.createFeatureContainer.apply(v,s):s[0]},v.getFeature=function(e,t){return f.objects.get(e,t)||null},v.createFeatureContainer=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=new at(f);return r.push(e),r},v.clearObjectSelection=function(){return f.objects.selection.clearSelected()||null}}
// const isCoordinate = (c) => {
//         if (isCoordinate(c)) {
//             c = HERE_WIKI.map.getGeoCoord(c);
//             return HERE_WIKI.map.clipGeoCoord(c);
function dt(a,e,r,c,n,o){var l,d,u,p,h,f,i=r.addImage(e,n);i.pressmove=function(e,t,r,n,o){l||c.visible(!(l=!0));for(var i=w.geotools.calcBearing(u,a.map.getGeoCoord(e.mapX,e.mapY))-p,s=0;s<d.length;s++)f=d[s],We._setCoords(f,a.map.rotateGeometry(f.geometry,u,i-h));h=i},i.pointerdown=function(e){l=!1,u=c.getCenter(),p=w.geotools.calcBearing(u,a.map.getGeoCoord(e.mapX,e.mapY)),d=c.getObjects(),h=0},i.pointerup=function(){l&&(1<d.length||"Point"!=d[0].geometry.type)&&(c.markObjsAsMod(),c.objBBoxChanged()),u=d=null,c.visible(!0)},i.pointerenter=i.pointerleave=function(e){var t="pointerenter"==e.type;document.body.style.cursor=t?"move":"default",a.setStyle(i,t?o:n)},this.setPosition=function(e,t){r.setFeatureCoordinates(i,[e,t])},this.hide=function(){r.hideFeature(i)},this.show=function(){r.showFeature(i)},this.remove=function(){r.remove(i)}}function ut(s,e,r,a,t,n){var c,l,d,o=r.addCircle(e,t),u=null;o.pointerdown=function(){c=!1,d=l=0,u=a.getObjects()},o.pressmove=function(e,t,r,n,o){c=!0;for(var i=0;i<u.length;i++)s.map.pixelMove(u[i],t-l,r-d);l=t,d=r,a.objBBoxChanged()},o.pointerup=function(){c&&a.markObjsAsMod(),u=null},this.setPosition=function(e,t){r.setFeatureCoordinates(o,[e,t])},this.getCenter=function(){return o.geometry.coordinates.slice()},this.hide=function(){r.hideFeature(o)},this.show=function(){r.showFeature(o)},this.remove=function(){r.remove(o)}}function pt(f,e,t,r,n,s,v,o,i){for(var g,A,y,m,S,a=[s.addRect(e,t,r,n,o)],c=[[[e,n],[r,n]],[[r,n],[r,t]],[[r,t],[e,t]],[[e,t],[e,n]]],l=0;l<c.length;l++){var d=l%2;a.push(s.addPath(c[l],[{zIndex:0,type:"Line",opacity:.02,strokeWidth:4}],{orientation:d?"V":"H",index:l,cursor:(d?"ew":"ns")+"-resize"}))}function u(e,t,r){var n=this.properties.index,o=this.properties.orientation,i=null,s=null,a=S,c=[],l=f.map.getGeoCoord(e.mapX,e.mapY),d=v.getGap();if((1!=a.length||"Point"!=a[0].geometry.type)&&(m=!0,"V"==o&&0<A?(c[1]=g[3],s=1,c[0]=g[0]+(1==n?0:A),l[0]+=1==n?-d:d,i=(A+l[0]-(g[0]+A))/A,i=3==n?1-i:i):0<y&&(c[0]=g[0],c[i=1]=g[3]-(2==n?0:y),l[1]+=2==n?d:-d,s=(y+(g[1]-l[1]))/y,s=0==n?1-s:s),i&&s)){for(var u=0;u<a.length;u++){var p=a[u],h=f.map.scaleGeometry(p.geometry,[i/this.properties.fx,s/this.properties.fy],c);We._setCoords(p,h)}v.objBBoxChanged(),this.properties.fx=i,this.properties.fy=s}}function p(){S=v.getObjects(),m=!1,g=S.getBBox(),A=g[2]-g[0],y=g[3]-g[1],this.properties.fx=1,this.properties.fy=1}function h(){m&&v.markObjsAsMod()}function E(){document.body.style.cursor=this.properties.cursor}function C(){document.body.style.cursor="default"}for(var k=0;k<a.length;k++){var x=a[k];x.pointerdown=p,x.pressmove=u,x.pointerup=h,x.pointerenter=E,x.pointerleave=C}this.update=function(e,t,r,n){var o=[[[e,n],[r,n]],[[r,n],[r,t]],[[r,t],[e,t]],[[e,t],[e,n]]];s.modifyRect(a[0],e,t,r,n);for(var i=1;i<a.length;i++)s.setFeatureCoordinates(a[i],o[i-1])},this.hide=function(){s.hideFeature(a)},this.show=function(){s.showFeature(a)},this.remove=function(){s.remove(a)}}var ht="data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAAKIAELHhEaLCEqOjE5SEFIVlFYZXF2gYCFj5CVnaCkq7CzucDDx9DS1uDh5PDx8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABIALAAAAAATABMAAAVpoCSOkmCaZDqeLKqWbSykck2aRCEQSIIQrZXJAFFEjkdFECYwHCELwwISWbCYzadOMKBuYwOD+JuIJGq1ghktK5/ZrUfEcG1FHAdBgRFpXLECC0hHDQN/gAUJinSHgGw0cDMvaC+QJy8hADs=",ft="data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAELHhAZKyApOTA4R0BHVlBXZGBmcnB1gICFjo+UnK+yuL/Cx8/R1d/g4+/w8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABEALAAAAAATABMAAAVpYCSOEWSaZDqeLKqWbQylck2aTgM5SqI4rZWJIUAEjkdEEAZhHAUHxkEQOLCYzacO8qBuYw+G+JsIJGq1hhktK5/ZrUGAcW0FCAtIwxAoXLEQB0hHBQ9/gA0JinSHgGw0cDMvaC+QJy8hADs=",vt=18,gt=function(e){for(var t=[1/0,1/0,-1/0,-1/0],r=0,n=e;r<n.length;r++){var o=n[r],i=o.getBBox?o.getBBox():o.bbox;i[0]<t[0]&&(t[0]=i[0]),i[1]<t[1]&&(t[1]=i[1]),i[2]>t[2]&&(t[2]=i[2]),i[3]>t[3]&&(t[3]=i[3])}return t};function At(a,e){var c=a.objects.overlay,l=this,d=null,u=null,p=null,h=null,f=4e-5,n=[],v="#010B1E";function o(e){for(var t=e.length;t--;){var r=e[t];0<=n.indexOf(r.id)&&We._editable(r,!0)}}l.markObjsAsMod=function(){for(var e=h.length,t=0;t<e;t++)We.markAsModified(h[t],!1);e&&a.objects.history.saveChanges()},l.getObjects=function(){return h},l.visible=function(e){p&&(e?(d.show(),p.show(),u.show()):(d.hide(),p.hide(),u.hide()))},this.isActive=function(){return null!==d},this.hide=function(){d&&(d.remove(),p.remove(),u.remove()),d=u=p=null,null!=h&&(o(h),h=null)},this.objBBoxChanged=function(){var e=h.getBBox(),t=e[0]-=f,r=e[1]-=f,n=e[2]+=f,o=e[3]+=f,i=e[0]+(e[2]-e[0])/2,s=e[1]+(e[3]-e[1])/2;null!=d?d.update(t,r,n,o):(d=new pt(a,t,r,n,o,c,l,{type:"Line",zIndex:0,strokeDasharray:[4,4],strokeWidth:2,stroke:v}),u=new ut(a,[i,s],c,l,{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:v,strokeWidth:3,opacity:.3,radius:9}),p=new dt(a,[n,r],c,l,[{type:"Image",zIndex:4,src:ht,width:vt,height:vt}],[{type:"Image",zIndex:4,src:ft,width:vt,height:vt}])),p.setPosition(n,r),u.setPosition(i,s)},this.getGap=function(){return f},this.getCenter=function(){return u.getCenter()},this.show=function(e){var t;a.listeners.trigger("_clearOverlay"),null!=h&&o(h),(h=e instanceof Array?e:[e]).getBBox=function(){return gt(h)},n=[];for(var r=0;r<h.length;r++)t=h[r],We.deHighlight(t),We.private(t,"allowEdit")&&(n.push(t.id),We._editable(t,!1));l.objBBoxChanged()}}var yt=["ready","active","history.current","history.length","changes.length"],mt={ready:!0,active:null},St=function(){function e(){this.listeners=new w.Listener(yt).sync(!0),this.val={};for(var e,t,r=this.val,n=yt.length;e=yt[--n];)t=mt[e],r[e]=void 0!==t&&t}return e.prototype.addObserver=function(e,t,r){var n=this.val;if("*"==e)for(var o in n)this.addObserver(o,t,r);else this.listeners.add(e,t,r)},e.prototype.removeObserver=function(e,t,r){var n=this.val;if("*"==e)for(var o in n)this.removeObserver(o,t,r);else this.listeners.remove(e,t,r)},e.prototype.get=function(e){return this.val[e]},e.prototype.change=function(e,t,r){var n=this.val[e];(r||n!=t&&this.get("active"))&&(this.val[e]=t,this.listeners.trigger(e,[e,t,n]))},e}(),Et=null,Ct=function(e,t,r,n,o,i,s){var a=this;a.type=e,a.timeStamp=Date.now(),a.mapX=t,a.mapY=r,a.nativeEvent=n,a.button=o,a.target=i,a.detail=s},kt=Ct.prototype;kt.nativeEvent=Et,kt.detail=Et,kt.target=Et,kt.mapX=Et,kt.mapY=Et,kt.type=Et,kt.button=Et,kt.timeStamp=Et,kt.toString=function(){return"EditorEvent "+this.type};var xt,Lt,bt,_t=function(){function e(){this.listeners=new w.Listener("tap","dbltap","pointerup","pointerenter","pointerleave","dragStart","dragStop","dragMove","featureUnselected","error","_domResize","_panMap","_layerAdd","_layerRemove","_clearOverlay").sync(!0)}return e.prototype.trigger=function(e,t,r){var n,o,i,s,a=r||e.type||e;return(s=t)&&s.class?(o=e.detail,i=t):o=t,"touchend"==e.type&&(e=e.changedTouches[0]),n=this.listeners.trigger(a,[new Ct(a,e.mapX,e.mapY,e.nativeEvent,e.button,i,o)],"_"==a[0]),"pointerup"==a&&(n=this.listeners.trigger("tap",[new Ct("tap",e.mapX,e.mapY,e.nativeEvent,e.button,i,o)],!1)||n),n},e.prototype.bind=function(e,t,r){return this.listeners.add(e,t,r)},e.prototype.remove=function(e,t,r){return this.listeners.remove(e,t,r)},e.prototype.supported=function(){return this.listeners.getEvents()},e.prototype.destroy=function(){this.listeners=null},e}(),It=function(){function e(e,n){this.s=[],this.zClearFeat=null,this.ie=e,this.display=n;var o=this,t=this.s,r=t.push;if(t.push=function(){for(var e=0;e<arguments.length;e++)We.private(arguments[e]).isSelected=!0;r.apply(t,arguments)},t.remove=function(){for(var e=0;e<arguments.length;e++)We.private(arguments[e]).isSelected=!1,t.splice(t.indexOf(arguments[e]),1)},e._config.keepFeatureSelection){var i=n.getZoomlevel();n.addEventListener("mapviewchangeend",function(){var e=n.getZoomlevel();if(e!=i){var t=o.getCurSelObj()||o.zClearFeat,r=void 0;t&&((r=t._provider.minLevel)<=i?e<r&&(o.clearSelected(),o.zClearFeat=t):r<=e&&We._select(t))}i=e})}}return e.prototype.select=function(e){var t=this.display.getZoomlevel(),r=e.getProvider();if(t>=r.minLevel&&t<=r.maxLevel)return this.clearSelected(),this.s.push(e),!0;this.zClearFeat=e},e.prototype.getCurSelObj=function(){return this.s[0]},e.prototype.unselectFeature=function(e){var t,r=this.ie;if(e||!r._config.keepFeatureSelection){if(t=this.getCurSelObj()){var n=We.private(t,"xt");n&&n.clear(),r.listeners.trigger("featureUnselected",{featureUnselected:!0})}this.clearSelected()}},e.prototype.clearSelected=function(){var r,n=this.s,e=this.ie;return e.listeners.trigger("_clearOverlay"),n.forEach(function(e){var t=We.getTool(e,"deHighlight");t&&(t(r=e,!0),n.remove(e)),We.private(e).isSelected=!1}),n.length=0,this.zClearFeat=null,e.transformer.hide(),r},e}(),Pt="@ns:com:here:editor",wt=function(){function e(){this.steps={}}return e.prototype.clone=function(e){return e?JSON.parse(JSON.stringify(e)):e},e.prototype.add=function(e,t,r){var n=this.steps[e]||{},o=n[t]=n[t]||{},i=r.id;if(!o[i])return o[i]=r,this.set(e,n),!0},e.prototype.remove=function(e,t,r){try{var n=this.steps[e][t],o=r.id;if(n[o])return delete n[o],this.set(e,this.steps[e]),!0}catch(e){}return!1},e.prototype.get=function(e){return this.clone(this.steps[e])},e.prototype.set=function(e,t){this.steps[e]=this.clone(t)},e.prototype.clear=function(){var e=this.steps;for(var t in e)delete e[t]},e}(),Rt=function(e){return e.properties[Pt]},Ft=function(e){var t=e.toJSON(),r=Rt(t);return t.class=e.class,r&&(delete r.hovered,delete r.selected),t},Dt=function(){function e(e){this.current=0,this.total=0,this.changes={},this.cached=null,this._a=!0;this.iEdit=e,this.storage=new wt}return e.prototype.updateObservers=function(e){var t=this.iEdit.observers;t.change("changes.length",this.getLength()),t.change("history.length",this.total),t.change("history.current",this.current,e)},e.prototype.getTotal=function(){return this.total},e.prototype.getLength=function(){var e=this.getChanges(),t=0;for(var r in e)for(var n in e[r])Rt(e[r][n]).origin||t++;return t},e.prototype.remove=function(e){var t=e.getProvider().id;this.storage.remove(this.current,t,e)&&(delete this.changes[t][e.id],this.cached=null)},e.prototype.origin=function(e,t){var r=e.id,n=e.getProvider().id,o=this.storage,i=this.changes,s=this.current,a=o[s],c=i[n];if(c||(c=i[n]={}),c[r]=e,!a||!a[n]||!a[n][r]){var l=Ft(e),d=Rt(l);t&&(d.removed=!0),d.origin=!0,o.add(s,n,l)}},e.prototype.saveChanges=function(){var e=this,t=0;if(e.active()){e.cached=null;var r=function(e){var t={},r=0;for(var n in e)for(var o in t[n]={},e[n])t[n][o]=Ft(e[n][o]),r++;return{data:t,length:r}}(e.changes);if(t=r.length){var n=++e.current;e.storage.set(n,r.data),n>e.total?e.total++:e.total=n,e.iEdit.dump("History step saved...",n,"warn"),e.changes={},e.updateObservers()}}return t},e.prototype.getChanges=function(){if(!this.cached){for(var e=this.storage,t=this.current,r={},n=1,o=void 0;n<=t;n++)for(var i in o=e.get(n))for(var s in o[i]){var a=o[i][s];void 0,(l=Rt(a)).created&&l.removed?r[i]&&r[i][s]&&delete r[i][s]:(void 0,((c=Rt(a)).modified||c.removed||c.split||c.created)&&((r[i]=r[i]||{})[s]=a))}this.cached=r}var c,l;return this.cached},e.prototype.clear=function(){var e=this;e.storage.clear(),e.current=0,e.total=0,e.changes={},e.cached=null,this.updateObservers(!0)},e.prototype.import=function(e){var t=this,r=t.storage;for(var n in e)for(var o in e[n]){var i=t.iEdit.objects.get(o,n);if(i)t.origin(i);else{var s=w.JSUtils.extend(!0,{},e[n][o]),a=s.properties[Pt]=s.properties[Pt]||{};a.removed=!0,a.origin=!0,r.add(t.current,n,s)}}t.total=++t.current,r.set(t.current,e),t.recoverViewport(0)},e.prototype.recoverViewport=function(e,t){var r=+new Date,n=this.current+e,o=this.storage.get(n),i=this.iEdit;if(this.cached=null,0<=n&&n<=this.total){i.objects.selection.unselectFeature(),i.dump(arguments,n,"REBUILDED VIEW IN",+new Date-r,"ms"),i.objects.selection.getCurSelObj()&&i.listeners.trigger("featureUnselected",{featureUnselected:!0}),i.objects.selection.clearSelected();var s=[];for(var a in o){var c=o[a];for(var l in c){s["NAVLINk"==(h=c[l]).class?"unshift":"push"]({provider:i.getProviderById(a),feature:h})}}for(var d=0,u=s;d<u.length;d++){var p=u[d],h=p.feature,f=p.provider,v=f.search(h.id);v&&f.removeFeature(v);var g=Rt(h);if(!g.removed){for(var A in h=i.objects.create(h,f,void 0,!0),g)h.properties[Pt][A]=g[A];i.setStyle(h)}}this.current=n,t||this.updateObservers()}},e.prototype.active=function(e){return arguments.length&&(this._a=!!e),this._a},e.prototype.ignore=function(e){var t=this.active();this.active(!1),e(),this.active(t)},e}(),Nt=function(e,t,r){return{geometry:{coordinates:t,type:e},type:"Feature",properties:r||{}}},Tt=function(e,t){for(var r=0;r<e.length;r++)e[r].opacity!=xt&&(e[r]._opacity=e[r]._opacity||e[r].opacity),e[r].opacity=t;return e},Ot=function(e){for(var t=0;t<e.length;t++)e[t].opacity=e[t]._opacity==xt?1:e[t]._opacity,delete e[t]._opacity;return e},jt=function(e){return e=e?e instanceof Array?e:[e]:xt},Bt=function(e,t,r,n){return[[[e,t],[e,n],[r,n],[r,t],[e,t]]]},Mt=function(){function e(e){this.layer=e}return e.prototype.getProvider=function(){return this.layer.getProvider()},e.prototype.hideFeature=function(){for(var e,t=this.layer,r=0;r<arguments.length;r++)(e=arguments[r])instanceof at&&(e=e.toArray()),e instanceof Array?this.hideFeature.apply(this,e):t.setStyleGroup(e,Tt(t.getStyleGroup(e),0))},e.prototype.showFeature=function(){for(var e,t=this.layer,r=0;r<arguments.length;r++)(e=arguments[r])instanceof at&&(e=e.toArray()),e instanceof Array?this.showFeature.apply(this,e):t.setStyleGroup(e,Ot(t.getStyleGroup(e)))},e.prototype.addFeature=function(e,t){return(e=this.layer.addFeature(e,jt(t))).properties["@ns:com:here:editor"]=e.properties["@ns:com:here:editor"]||new Ze,e},e.prototype.addCircle=function(e,t,r){return this.addFeature(Nt("Point",e,r),t)},e.prototype.remove=function(e){var t=this.layer;if(e instanceof at)for(var r=0;r<e.length;r++)t.removeFeature(e[r]);else e&&t.removeFeature(e)},e.prototype.setFeatureCoordinates=function(e,t){e._provider.setFeatureCoordinates(e,t)},e.prototype.getStyles=function(e){return this.layer.getStyleGroup(e)},e.prototype.modifyRect=function(e,t,r,n,o){this.setFeatureCoordinates(e,Bt(t,r,n,o))},e.prototype.addRect=function(e,t,r,n,o){return this.addFeature(Nt("Polygon",Bt(e,t,r,n)),o)},e.prototype.addPolygon=function(e,t,r){return this.addFeature(Nt("Polygon",[e],r),t)},e.prototype.addSquare=function(e,t,r,n,o){var i=w.geotools.movePoint;return r^=0,this.addPolygon([i(e,t,-45+r),i(e,t,45+r),i(e,t,135+r),i(e,t,225+r),i(e,t,-45+r)],n,o)},e.prototype.addPath=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"LineString"},type:"Feature",properties:r||{}},jt(t))},e.prototype.addPoint=function(e,t,r){t instanceof Array||(r=t,t=xt);var n={geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}};return this.addFeature(n,jt(t))},e.prototype.addImage=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}},jt(t))},e}(),Gt="data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO8AAPACAvoCAvoMDPAODvASEvoXF/oZGfAdHfAkJPAqKv1BQf1KSv5QUP9dXf9paf9zc/95ef+Ghv+Njf+Skv+dnf+lpf+rq/vFxf3MzPzW1vfa2vvc3P3i4v7q6v/y8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACIALAAAAAAYABgAAAb/QJFwKAyBOpnMBhQiOp2hDSZSsVgqkYum+SR6LoJAoBMKecICCrkbbQQECwHZLFAkAoPtcxNeFARyZWcCBnECekMeboYGgXSEdYAdQyEXAYYCBWOCgI1wARRcGwOZgKVzg54BjRoiIRgBCqannJCACgEWZRMBCbMGm4+eAr4QHx8Pq78BHLXDjQgbHQzKpn/NwtaNHdPVgH+ondpyHsnDtNmdAQcbIby+1o6ppsUfr7Gz4M6muLoiGwRKfXPUQdzAVq4sYdIXgoPBBaC4iPDg4FImhh3eNMI1YBIRPpcKMEwF8ZDEIhvcRAqXABgBRE88WAgTzIMYARXWdEGJQUKVDStZYO6kdCRJByY7gwAAOw==",Ut="#111111",zt=function(e){return e.properties["@ns:com:here:editor"].hovered},Ht=function(e){return[{zIndex:0,type:"Circle",radius:13,fill:"#ffffff",stroke:Ut,strokeWidth:1.5},{zIndex:1,type:"Text",fill:Ut,font:"normal 16px Arial",text:e}]},Kt=function(e){return[{zIndex:1,type:"Image",src:e,width:24,height:24,rotation:function(e){return e.properties.rotation}}]},Jt=function(){var r=this;this.styleGroups={ADDRESS_LINE:[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#FF0000"}],ADDRESS_ROUTING_POINT:[{zIndex:0,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zIndex:1,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}],ADDRESS_SELECTOR:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}],PLACE_LINE:[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#FF0000"}],PLACE_ROUTING_POINT:[{zIndex:0,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zIndex:1,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}],AREA_SHAPE:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:Ut,radius:function(e){return zt(e)?6:4},fill:function(e){return zt(e)?Ut:e.properties.AREA.style[0].fill}}],AREA_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",strokeWidth:1,fill:Ut,stroke:Ut,radius:function(e){return zt(e)?5:3}}],LINE_SHAPE:[{zIndex:0,type:"Circle",radius:function(e){return e.properties.LINE.style[0].strokeWidth/2+4^0},stroke:function(e){var t=e.properties.LINE.style.filter(function(e){return"Line"==e.type}),r=t.length-1;return 0<r?t[r].stroke:Ut},fill:function(e){var t=e.properties.LINE.style;return 1<t.length?t[0].stroke:"#151515"},strokeWidth:2}],LINE_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",radius:function(e){return e.properties.LINE.style[0].strokeWidth/2^0},fill:"#151515"}],MARKER_SELECTOR:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}],PLACE_SELECTOR:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}],NAVLINK_SHAPE:[{zIndex:0,type:function(e){return e.properties.isConnected?"Rect":"Circle"},width:function(e){return zt(e)?18:12},rotation:45,radius:function(e){return zt(e)?9:6},strokeWidth:2,fill:function(e){return e.isOverlapping()?"#FFFFFF":e.properties.NAVLINK.style[0].stroke},stroke:function(e){return e.isOverlapping()?"#FF0000":"#FFFFFF"}}],NAVLINK_VIRTUAL_SHAPE:[{zIndex:1,type:"Circle",radius:function(e){return e.properties.NAVLINK.style[0].strokeWidth/5},opacity:.7,fill:Ut,stroke:Ut,strokeWidth:2}],NAVLINK_DIRECTION_HINT_1WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACUcHCMfICMgICklJSsnKS4qKzMvLzMvMTo3OD05OlpXWGVjY2pnZ25rbHFub5mXmJ6dncXExMjHx9bV1eXl5e7u7vHx8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABkALAAAAAAfAAwAAAVcYCaO5FgUZaquo7EQyMDOQ20PBGVFikHMKkHDQSQ+KpjkxEE4BIAjwSVJrVItkIQPKrV6qxJGU7bqfr/hMct8TmK1P6CwaEQqmU6o6GbL7XpxeiwuMGSCMwQohyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12}],NAVLINK_DIRECTION_HINT_2WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACMeISMfHyQhISklJisnKS0pKjIuLjMvMUNAQElFRVJPUG5rbHh1do2LjJORkrWztM/OztbW1uvr6////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABUALAAAAAAfAAwAAAV6YCWOpBgYoxGUbEsWhnKMh2IUbl4dBBNRicAgkKBEGISZTjQ4IB4TitTBqDqklMkDcRi4bgsIdkwmQxawkQBBaEjK8LikQUAIBDx3fD+eJwUpBWF8cGdpLU1PUVNVDFdSWlxeSzs9P0FDRUdJlCwwMjQ2OJ0uJykrSyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12}],NAVLINK_DIRECTION_HINT_BLOCKED:[{zIndex:1,type:"Image",src:Gt,rotation:90,width:24,height:24}],NAVLINK_DIRECTION_HINT_A:Ht("A"),NAVLINK_DIRECTION_HINT_B:Ht("B"),NAVLINK_DIRECTION:[{zIndex:0,type:"Image",src:"data:image/gif;base64,R0lGODdhEAAcALMAAAAAACgbGxwcHCMfHyMfICMhISsrK////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAAAgALAAAAAAQABwAAAQ/EMlJq5WE3Jt3HdngTVk3FiVRjGApbmkKx2ZFy9Qd53pJ9jggjjfk7Dy0URJ5nBUtS6eP+bQ1jVXiVFrDbiURADs=",width:16,height:28,rotation:function(e){return-e.properties.bearing},opacity:.7}],NAVLINK_DIRECTION_NONE:[{zIndex:0,type:"Image",src:Gt,width:24,height:24,rotation:90}],TURN_RESTRICTION_START:[{type:"Image",zIndex:1,src:"data:image/gif;base64,R0lGODdhJAAUAPcAAAAAAAAAgAsDAA4JABMNABcQABoQAAARKwgSABQVMgYWIhMXIQ0YLQ0ZQRsaAAobJBocQAcfLAofUQYgHx0gTQAhzhIheRchXwUiJRAiKwAkxiMkXQclKB8mZwAonhQoKyEpGCUpLwkqoBsqgwQrpgAsygAtuwAtxCEtVgYurTEutQAv02kviQcwq0AwsAExvQAy0QEzxQ4zuA8zpCwzOTczAAE1ywo1xQo3yB45OgM6yww6yxA6wRI6sy46tAA71H87jwA92w890C09bxE+0DM+jh0/yx8/sBxBxAdC1A1C1SFCtABD2xND1BtDuAFF4h5FzxNG2xVHx2dIshZJ2SNK1xtL1kxLJCVM4T5Mx0hMNBZN6xxN3DxNqEBNeXhNjilO0CJP3X9Pph9R4yNT5jlTwyxU3EBUuXZVoytW5DNW1RtX81hXKCxY7S9Z3DtZrEZZsFRZYoZZoSNa7TZa2U5ajj1b0Thc4yFd+S5d5jJd5ktdvU5dnEFexURe0T5f20Jf3T9g1lZgdFdgbzJh7jpi5D5j3VljilxjajNk9z1k7EBl5ktl2JJllS5m/k9ntDto9FRoxF1otjRp/U9p3lhpbGFplHZpklVq0ENr7Utr4mBs0VJt23Rtw2lxrkdy9lVy9E1z6FJz60J0/lx03VB15GF28GV351p45U15/VN57mR58Ft68mZ66ml62Vh77Gh8znV8pHl8x1R9/FV/9GZ/5WqA43CA636AlICA/1uC/FyC9XOC3W6E3HSEwYSEj4uFgGCG93WH1ICHooeHnI6HbnKJ6A+L/2iL8nuMv3OO4GqP/5CPnaeQpImSso+Ti3KU/IuUwIGV8H2W+IKY4ZiYopmZsHea/ZGbzJqbiHqc/oqc4oSd65Od1oWg9QCi/4Si/Jaj2LSjz4uk+o2l55Cm7JGn9qGooI2p/5ip3pKq/KGq5qer1qaswI6w/5W0/5y1/a61q7i446u57Ki9/p6//7/H16zJ/7rL/7TM/7/R/+bm5gD/////qv///wAAACH5BAkAAP8ALAAAAAAkABQAAAj/AP8JHGgLlShUtlyduoWJUStWplqtWtXKFapatmr1EuaL2MCPuCJl+vQJEiEzacCAWeKhzJkyamKmaZNoEiE7eyR5snRJ1kdScYpwMWNlRwwrThpIGOKFzyFEggYJqkNnDhkyY7g0MYLEB5pNAkHtudInTRIbJ2zkQSEAAQgtj1IVMhTIjh9DecJQUdKkiY0SK1h8EXinC5xMVWzEiGHjSAEGEQ4AeDNqjWU8jlKpoqUnjRkwUG7YUDFFFKnEaE8sZmyBwIMJCgDMiHJjx44mXMjoIWSolKpQhqzgOPFElJ8fq5PHuEBAAQYFAjwoXnyiuokTKWQsvoEjxo0SlPzA/7ihXDGEAQ+eAyAxPfmLGNeV39DASI3q8i8SCEgfm73yGO+9998Jf3DxH2P5oYfBAwL4p5yAB9pARxg26IBfAq5xwKCD7gEYIR2A/CBEewhCkOGGJC4GoXwEavJEXzuQSEGGCzSYoocrbkefKFswwYQSRBjFWAcGZPBBCA6IYAN5HbYwAw8xblcCJ/8oUogeTwTxg2I2jGBABDnQ4MAMMJRQgg1o/qBDE0ok8cObTRBxAhas/DMLL9hAo4oeUTQRRQ81IFJJHGx0McksuswySiKEFAKcIZq88soiP7ggRp3L2FIMNcsE88kYUTCxQTbxnPOML+CQsw01yiiDzC60IHFzjTbIuFFBBUDIMdA0zHSzjC6fzPFDGFLg0o4zsURTDTDA/DJMMtfMuswrdtyQxSadNMLLR//MQw886ozjjTfjcMMNJ7CkE0446ZRTjjfgoPMOOtJssw471jTDLbf44JPPR+OMs69AAYMzjjrmhMNtQAA7",width:36,height:20,rotation:function(e){return e.properties.rotation}}],TURN_RESTRICTION_LINE:[{type:"Line",zIndex:0,strokeWidth:5,strokeLinecap:"round",stroke:function(e){return"TURN_RESTRICTION_ALLOWED"==e.properties.sign?"#0000ff":"#ff0000"}}],TURN_RESTRICTION_ONEWAY:Kt(Gt),TURN_RESTRICTION_FORBIDDEN:Kt("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO0AAO4ACPAAAPYlK/YpL/YrMO4sMu9VV/tVV/xWWfxYWu9aW/BaXPBkZvBnafBpav9zdf93efOOj/+Oj/OPkP+PkP+RkvOSk/SenvSfoPSjo/WnqPWpqfe/v/XDxP/Dw/bHyPnOzvnR0fni4v309P749////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACgALAAAAAAYABgAAAb2QJRwKDyRRp/PiHQiOp2lz2VhGAwIi8un9CSeRpKAeEyOjJrPE2gQEAQYGA4HwxgPQOihOnAIOEQlJ4InJSIPfAF4RCMDfRmDkIMZfAMjQyURYo+RnJMBEVwoH2IOnKYnhwEeKCcXYiKnnCJiF0YLAQiBsZF1CkcFARW7nBgBBCIhbBvDkR1iScrMkM4BSgYBE9KDxcckCri60g0BCUyuAbDSI2IWTaN+2hBiqyiYYsvDGmKgQyKNAfhObaAkwgsIRA5GmIBUSF4fRQbZiGmAoUMHDOPGQHRyQkQmMiAjwOpyyQOFBATEEEhAwUMokl6OhFDChGQQADs="),TURN_RESTRICTION_ALLOWED:Kt("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAAA/qgBFqgBLrABTrgBWsQBZrwBdsQJlswBnuAtnsxFntBNoswBpuR5qtSNrtClstj10uEt+w0+AxFCBxG6Pwm6TzXWTxHKVznuXxnyYxoGax4OcyIym1Y+p15Cp1papz5ms0KGy06q41q672LG+2bTA2rzH3r7I3r/J4MLL37/M6MHO6cXO4MfQ4c7V5tDX59DY59Tb6d7j7uDl7uLm8OXp8uns9PHz9/P0+f///wAAAAAAAAAAAAAAAAAAACH5BAkKADsALAAAAAAYABgAAAb/wJ1wKNTVZK0WrKYjOp05VGfSOBwaFA8K9yTqXpgB4YBgMBAHwgDzaj51rALh4VgoEAjFwvEYs9xDcAIKD3iGCw90CA8KAn9ELwV6hngKBwNiDmUIBS9DOBZzlGUHFSUjHKJ9GFw7KAOFo3cRMzo6ILCLBCo7Oh0EEA7Cww4QaDK2IbAOBB5GElYE0tPSlwNttwMQBxM1MAkIFRoZ4xrm4xsXGje2IAIODTEuBQg2tvf4+bYiBgctLgTq6Rt4j98BFS/AXeCwgYPDhw3NsdOhDN4SaGmoTbOGTdm2br6AERtm7AAyigLoEPjQ5EQuWQhoJcv1YEAKIaAIaKLEoJQJThKpCjHDkGNIJAYLRi04ICDTpk5eWAyKdSiRJgcKAjzyskIOnTuU+BAosNXJFwtiyAhDo4YNoC44pEhIIC2BhA5bunTRQeNFkhc03hIJAgA7"),TURN_RESTRICTION_PEDESTRIAN:Kt("data:image/gif;base64,R0lGODdhGAAYAOYAAAAAAO0AAO4ACPAAAPYlK/YpLy0rK/YrMO4tMjMxMUVDRFRTU+9UVvtVV/xVWF9WVvxYWvBZW+9bXWNdXfBjZe9kZmhnZ/BnafBpa2xsbHJxcv9zdf93eX18fISEhIuLi/OOj/+Oj/OPkP+PkP+RkvOSk5iVlZ2dnfSenvSkpPWpqaysrLO0tLy8vPe/v8PDw//Dw/XExMjHyPbHyPnOzsbPz8/Pz8fQ0PnR0dPT09zc3Pri4uPj4+rq6vLy8v3z8////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKAEEALAAAAAAYABgAAAf/gEGCg4JAOzgxMzg7QISOjj8xJBAHAwMFECQxP4+EQDQbAaKjpBs4jY9AMAOjDCApKSIMowMwqIOqAQgBFDQ/QMBAPzQUugG2hDQDuynBzsEougM4gz+hASjP2kDRARycQS6iFdvbFAIBMUFAIaI4NT3OPNs0oiSGDQEMQCwAK8EvFuh49iNCAAiHCAQoAYxHBwUtgOnIwAJYDx9ARAQ4gGOGKBXOcmTw0GLFBwAedACYAERFgAExYnx85iPDAgAADAB48cFEy5cxcChkGIxFghM5ZNiwoMFZiQAEFuWTACyghoE9WKzIgBFYwYOM2gXAceNBjmA+WrCIF6xegHvhUERhKKftgih1QayJakYXWLcN4ILU25WNbjQE0zzBMIbh1DMadnchU8xKlIQSKlSUkEBrsqNP10iVOtWpmosRDRRCdUDCReDSuHbQiEmDUelAADs="),UNKNOWN:[{zIndex:0,type:"Circle",strokeWidth:1,stroke:"#FF0000",fill:"#0000FF",radius:10}]},this.assign=function(e){var t=e.class||e.properties.type;return void 0!==r.styleGroups[t]?t:"UNKNOWN"}},Vt=function(r){function e(e){void 0===e&&(e={});var t=this;return e.name="EOP",(t=r.call(this,e)||this).id="EOP-"+t.id,t}return c(e,r),e}(a.providers.LocalProvider),Qt=a.providers.EditableProvider,Wt="pointerenter pointerleave pointerup pressmove pointerdown dbltap",Yt="addLayer removeLayer",qt=function(e){return e.class},Zt=function(){function e(n,e){this.listen=!1;var t=this;t.iEdit=n,t.display=e,t.history=new Dt(n),t.selection=new It(n,e);var r,o,i=(r=n,(o=new Vt)._e=function(){return r},new a.layers.TileLayer({name:"EditorOverlay",min:1,max:20,styles:new Jt,provider:o}));t.overlay=new Mt(i);var s=new w.Map([[i.id,i]]);this.layers=s,e.addLayer(i,function(e){for(var t,r=e.length;r--;)if((t=e[r].getProvider())&&"NAVLINK"==t.class)return r+1;return e.length}(e.getLayers())),t.arrangeOverlay=t.arrangeOverlay.bind(t),t.pointerListener=t.pointerListener.bind(t),n.listeners.bind("_layerAdd",function(e){var t=e.detail.layer;s.set(t.id,t)}),n.listeners.bind("_layerRemove",function(e){var t=e.detail.layer;s.delete(t.id);var r=n.objects.selection.getCurSelObj();r&&n.getLayer(r)==t&&n.objects.selection.clearSelected()}),t.onMVCStart=t.onMVCStart.bind(t)}return e.prototype.onMVCStart=function(){this.selection.unselectFeature()},e.prototype.splitLinkAt=function(e){return function(o,e){var t,r,n=e.link,i=e.index,s=e.preferSegment,a=e.avoidSnapping,c=n.coord(),l=c.length-1,d=Ue._props(n),u=o._config.minShapeDistance;if(e.point&&(t=e.point[0],r=e.point[1]),0===i||i===l||t==c[0][0]&&r==c[0][1]||t==c[l][0]&&r==c[l][1])return!1;if(void 0===i){var p=o.map.calcCrossingAt(c,e.point,u,s);if(i=p.index,p.existingShape&&(0===i||i===l))return!1;i=Ue.addShp(n,[t,r],null,!0,null,s),c=n.coord()}Ue.deHighlight(n);var h=n.getProvider(),f=function(e,t){var r=w.JSUtils.extend(!0,{},d),n={type:"Feature",geometry:{type:"LineString",coordinates:e},properties:r};return delete r["@ns:com:here:editor"],o.objects.create([n],h,t,void 0)},v=f(c.slice(0,i+1),a&&i),g=f(c.slice(i),a&&0),A=$(c[i],c);.995<A&&(A=1);var y=ee(c,c[i]).offset,m=Ue.getConnectedObjects(n);for(var S in m){var E=m[S],C=he.getRoutingPosition(E),k=ee(c,C).offset<y?v:g;he.connect(E,k,C),he.markAsModified(E,!1)}return o.hooks.trigger("Navlink.split",{link:n,index:i,children:[v,g],relativePosition:A},h),n.editState("split",Date.now()),o.objects.remove(n,{animation:!1,split:!0}),[v,g]}(this.iEdit,e)},e.prototype.destroy=function(){this.display.removeLayer(this.overlay.layer)},e.prototype.arrangeOverlay=function(e){var t=e&&e.detail.layer,r=this.display,n=this.overlay.layer;if(r.getLayers){var o=r.getLayers();if(!(t.getProvider()instanceof Vt)){var i=o.map(function(e){var t=e.getProvider();return t&&t.class}).indexOf("NAVLINK");r.removeLayer(n),0<=i?r.addLayer(n,i+1):r.addLayer(n)}}},e.prototype.pointerListener=function(e){var t=this.iEdit,r=e.target,n=e.type;if(r){var o=e.detail.layer;if(!this.layers.has(o.id))return;var i=We.getEventListener(r,n);if(i)return e.stopPropagation(),i.apply(r,arguments)}"pointerup"!=n&&"dbltap"!=n||t.objects.selection.unselectFeature("viewportChange"==t._config.keepFeatureSelection),t.listeners.trigger(e,null)},e.prototype.listenDisplay=function(e){var t=this.display,r=this.listen,n=this.pointerListener,o=this.arrangeOverlay;e?r||(this.listen=!0,t.addEventListener("mapviewchangestart",this.onMVCStart),t.addEventListener(Wt,n),t.addEventListener(Yt,o)):r&&(this.listen=!1,t.removeEventListener("mapviewchangestart",this.onMVCStart),t.removeEventListener(Wt,n),t.removeEventListener(Yt,o))},e.prototype.clear=function(){},e.prototype.get=function(e,t){var r=this.iEdit;return t?"object"!=typeof t&&(t=r.getLayer(t)):t=r.getLayer(e),"object"!=typeof e&&t&&(e=t.search(e)),e&&t?e:null},e.prototype.getInBBox=function(e,t){e||(e=[(e=this.display.getViewBounds()).minLon,e.minLat,e.maxLon,e.maxLat]);var r=1/Math.pow(10,this.iEdit._config.intersectionScale);e=[e[0]-r,e[1]-r,e[2]+r,e[3]+r],(t=t||this.layers.values())instanceof Array||(t=[t]);for(var n,o=[],i=0;i<t.length;i++)if(n=t[i].search(e))for(var s=0;s<n.length;s++)o.push(n[s]);return o},e.prototype.remove=function(e,t){var r=!1;if((t=t||{}).split||!this.iEdit._config.editRestrictions(e,2)){var n=null==t.animation||t.animation;n&&We.private(e,"isSelected")&&this.selection.clearSelected(),qt(e)&&(this.history.origin(e),We.markAsRemoved(e,n),t.save&&this.history.saveChanges(),r=!0);var o=e.getProvider();return e.editState&&!e.editState("created")&&o.blockFeature(e,!0),o.removeFeature(e),r}},e.prototype.add=function(e,t,r){var n=this.iEdit;if(!e.getProvider()&&("string"==typeof t?t=this.layers.get(t):t||(t=n.getLayerForClass(qt(e))),t)){var o=e.id,i=o!=Lt&&t.search(o);return o!=Lt&&i?i:this.create(e,t.getProvider(),Lt,Lt,r)}},e.prototype.create=function(l,d,u,p,h){var f=this.iEdit,v=[];l=l instanceof Array?l:[l],h=h||{};for(var e=function(e){var t,r,n=l[e],o=n.id;if(p||(n.id=Lt),n=d.prepareFeature(n),t=d.detectFeatureClass(n),o==Lt&&(o=n.id),h[o]=n.id,r=n,p&&d.blockFeature(r,!1),r=d.addFeature(r),r=d.search(r.id),p||(r.editState("created",Date.now()),We.markAsModified(r,!1),f.objects.history.origin(r,!0)),v.push(r),n=r,"NAVLINK"===t)n.geometry.coordinates.forEach(function(e){e[2]=0^e[2]}),p||We.fixGeo(n,Lt,Lt,u);else if("PLACE"===t||"ADDRESS"===t){var i=We.getRoutingData(n),s=i.link;if(h[s]){var a=We.getRoutingProvider(n),c=a&&a.search(h[s]);f.objects.history.ignore(function(){n.getProvider().writeRoutingPoint(n,c,i.position)})}"ADDRESS"===t&&(We.connect(n),n.getLink()||(f.objects.history.remove(n),d.removeFeature(v.pop()),f.dump("No Link found within "+f._config.maxRoutingPointDistance+" meters","warn")))}},t=0;t<l.length;t++)e(t);return 1<v.length?v:v[0]},e.prototype.getNearestLine=function(e,t,r){var n=this.iEdit;r=w.JSUtils.extend({ignore:[],maxDistance:1/0,shapeThreshold:0,onlyExsitingShape:!1},r||{});var o,i,s,a,c,l,d,u,p,h={line:null,point:null,distance:1/0,shpIndex:null,segmentNumber:null},f=e,v=r.maxDistance,g=v<1/0?w.geotools.getPointBBox(f,v):null;function A(e){return e[2]===Lt||f[2]===Lt||e[2]===f[2]?w.geotools.distance(e,f):1/0}t instanceof Qt&&(t=this.getInBBox(g,t)),e=n.map.getPixelCoord(e);for(var y=0,m=t;y<m.length;y++){var S=m[y];if(-1==r.ignore.indexOf(S.id)&&(o=S.bbox,v==1/0||(i=g[0],s=g[2],a=g[1],c=g[3],l=o[0],d=o[2],u=o[1],p=o[3],i<=d&&l<=s&&a<=p&&u<=c))){for(var E,C=S.geometry.coordinates,k=void 0,x=r.maxDistance,L=void 0,b=[],_=void 0,I=void 0,P=0;P<C.length;P++)b[P]=n.map.getPixelCoord(E=C[P]),(I=A(E))<x&&(x=I,k=0^(0<(L=P)&&P-1),_=E);if(!r.onlyExsitingShape&&(_==Lt||x>r.shapeThreshold))for(P=0;P<b.length-1;P++)(E=R(b[P],b[P+1],e))&&(I=A([(E=n.map.getGeoCoord(E))[0],E[1]]))<x&&(x=I,L=null,k=P,_=E);_&&x<h.distance&&(h.point=_,h.distance=x,h.shpIndex=L,h.segmentNumber=k,h.line=S,v=w.geotools.distance(_,f),g=w.geotools.getPointBBox(f,v))}}return h.line?h:null},e}(),Xt=function(){function e(e,t){var r=this;this.busy=null,this.display=t,this.iEdit=e,this.observers=e.observers,this.onStart=this.onStart.bind(this),this.onStop=this.onStop.bind(this),e.listeners.bind("_layerAdd",function(e){e.detail.layer.addEventListener("viewportReady",r.onStop)}),e.listeners.bind("_layerRemove",function(e){e.detail.layer.removeEventListener("viewportReady",r.onStop)})}return e.prototype.onStart=function(){this.busy||(this.busy=new w.Set(this.iEdit.layers),this.observers.change("ready",!1))},e.prototype.onStop=function(e){var t=e.detail.layer,r=this.busy;r&&(r.delete(t),r.size||(this.observers.change("ready",!0),this.busy=null))},e.prototype.start=function(){this.display.addEventListener("mapviewchangestart",this.onStart)},e.prototype.stop=function(){this.display.removeEventListener("mapviewchangestart",this.onStart)},e}(),$t=["Navlink.split","Navlink.disconnect","Feature.remove"],er=function(e,t){var r=e.__=e.__||String(1e9*Math.random()^0);return t&&(r+=";"+t.id),r},tr=function(){function e(e){this.h=new w.Listener($t),this.h.sync(!0),this.history=e,this.w=new Map}return e.prototype.add=function(e,t,r){var n,o,i,s=er(t,r),a=this.w.get(s);return a||this.w.set(s,(o=r,(i=function(e,t){o&&t!=o||n(e)}).h=n=t,a=i)),this.h.add(e,a)},e.prototype.remove=function(e,t,r){return this.h.remove(e,this.w.get(er(t,r)))},e.prototype.get=function(e){return this.h.get(e).map(function(e){return e[0].h})},e.prototype.trigger=function(e,t,r){var n=this.history,o=n.active();n.active(!1),this.h.trigger(e,[t,r]),n.active(o)},e}(),rr=Math.PI/180,nr=function(e,t,r,n){this.point=[e,t],this.index=r,this.existingShape=n};function or(e,t){if("number"==typeof e[0])return t(e);for(var r=[],n=e.length;n--;)r[n]=or(e[n],t);return r}var ir=function(){function e(e){this.display=e}return e.prototype.distance=function(e,t){return w.geotools.distance(e,t)},e.prototype.rotatePoint=function(e,t,r){return this.clipGeoCoord((o=t,i=r,s=(n=e)[0]-o[0],a=n[1]-o[1],c=i*rr,[o[0]+(Math.cos(c)*s-Math.sin(c)*a/Math.abs(Math.cos(o[1]*rr))),o[1]+(Math.sin(c)*s*Math.abs(Math.cos(o[1]*rr))+Math.cos(c)*a),0^n[2]]));var n,o,i,s,a,c},e.prototype.movePoint=function(e,t,r,n){return this.clipGeoCoord(w.geotools.movePoint(e,t,r,n))},e.prototype.scaleGeometry=function(e,t,r){var n=this;return or(e.coordinates,function(e){return n.clipGeoCoord([r[0]+(e[0]-r[0])*t[0],r[1]+(e[1]-r[1])*t[1],0^e[2]])})},e.prototype.rotateGeometry=function(e,t,r){var n=this;return or(e.coordinates,function(e){return n.rotatePoint(e,t,r)})},e.prototype.getClosestPoint=function(e,t,r){var n=e[0]-t[0],o=e[1]-t[1],i=e[1]*t[0]-e[0]*t[1],s=n*r[0]+o*r[1],a=1/(n*n+o*o);return[(s*n+i*o)*a,(s*o-i*n)*a]},e.prototype.calcCrossingAt=function(e,t,r,n,o){var i,s,a,c=null,l=o||1/0,d=!1,u=null,p=null;if(n!=bt){var h=this.calcCrossingAt(e.slice(n,n+2),t,r,bt,o);return h.index+=n,h}for(var f=0;f<e.length;f++)i=e[f],(a=this.distance(i,t))<=l&&(l=a,u=i[0],p=i[1],c=f,d=!0);if(r<l||!d)for(f=0;f<e.length;f++)f<e.length-1&&(s=R(e[f],e[f+1],t))&&(a=this.distance(s,t))<l&&(l=a,c=f+1,u=s[0],p=s[1],d=!1);return new nr(u,p,c,d)},e.prototype.translateGeo=function(e,r,n){var o=this,i=o.display;return or(e,function(e){var t=i.geoToPixel(e[0],e[1]);return o.getGeoCoord(t.x+r,t.y+n,e[2])})},e.prototype.pixelMove=function(e,t,r){var n=e.getProvider(),o=this.translateGeo(n.decCoord(e),t,r),i=We.getTool(e,"_setCoords");i?i(e,o):n.setFeatureCoordinates(e,o)},e.prototype.clipGeoCoord=function(e){return e[0]=Math.round(1e9*e[0])/1e9,e[1]=Math.round(1e9*e[1])/1e9,e},e.prototype.getGeoCoord=function(e,t,r){var n,o=this.display;return 1<arguments.length?n=o.pixelToGeo(e,t):(n=e).x!=bt&&n.y!=bt?(r=n.z,n=o.pixelToGeo(n.x,n.y)):e[0]!=bt&&e[1]!=bt&&(r=n[2],n=o.pixelToGeo(n[0],n[1])),this.clipGeoCoord([n.longitude,n.latitude,0|r])},e.prototype.getPixelCoord=function(e,t,r){var n=this.display;return 2==arguments.length?e=n.geoToPixel(e,t):e.longitude!=bt&&e.latitude!=bt?e=n.geoToPixel(e.longitude,e.latitude):e[0]!=bt&&e[1]!=bt&&(e=n.geoToPixel(e[0],e[1])),[e.x,e.y,0|e.z]},e.prototype.getEventsMapXY=function(e){var t,r,n=this.display;if(e.mapX!=bt)t=e.mapX,r=e.mapY;else{var o=n.getContainer().getBoundingClientRect();t=e.pageX-o.left,r=e.pageY-o.top}return[t,r]},e}(),sr="error",ar=function(e,t){this._config=e;var c=this;c.observers=new St,c.listeners=new _t,c.objects=new Zt(c,t),c.hooks=new tr(c.objects.history);var r=new Xt(c,t);r.start();var n=c.objects.overlay.layer,s={};function a(e){c.listeners.trigger(sr,e)}s[n.getProvider().id]=n,c.listeners.bind("_layerAdd",function(e){for(var t=e.detail.layer,r=t.getProvider(),n=0,o=["src","base","delta","id"];n<o.length;n++){var i=r[o[n]];i&&(s[i]=t)}t.removeEventListener(sr,a),t.addEventListener(sr,a)}),c.getLayerForClass=function(e){for(var t,r,n,o,i=0,s=c.layers;i<s.length;i++){var a=s[i];a.getProvider&&(o=a.getProvider()),(r=o.class)?e==r&&(n=a):t||(t=a)}return n||t},c.getProviderById=function(e){return s[e].getProvider()},c.getLayerById=function(e){for(var t=0,r=c.layers;t<r.length;t++){var n=r[t];if(n.id==e)return n}},c.getLayer=function(e){var t;if("object"==typeof e){var r=e._provider;e=r.src||r.delta||r.base||r.id}return e&&(t=s[e]),t},c.getStyle=function(e,t){var r=this.getLayer(e).getStyleGroup(e,void 0,t);return w.JSUtils.extend(!0,[],r)},c.setStyle=function(e,t,r){this.getLayer(e).setStyleGroup(e,t,r)},c.map=new ir(t),c.transformer=new At(c),c.display=t,c.destroy=function(){r.stop(),c.objects.destroy(),c.listeners.destroy()},c.dump=w.JSUtils.dump},cr="NAVLINK",lr=function(e){var t=e.class;return t==cr?cr:String(t)+(e.src||e.base+e.delta||e.id)},dr=function(e,t,r){var n=t.hooks;if(n)for(var o in n){var i=n[o];i instanceof Array||(i=[i]);for(var s=0,a=i;s<a.length;s++){var c=a[s];r.hooks[e](o,c,t)}}},ur=function(n,e,t){var o={},i=n.layers=[];e.addLayer=function(e){if(e){var t=e.getProvider();if("FeatureProvider"==t.__type&&t.isEditable&&(!o[lr(t)]||t.class==cr)){if(t._e instanceof ar)throw new Error("Provider already in use by another editor");return t._e=n,e.class=t.class,n.listeners.trigger("_layerAdd",{layer:e}),o[lr(t)]=e,i.push(e),dr("add",t,n),!0}}return!1},e.getLayers=function(e){return e?i[e]:i.slice()},e.removeLayer=function(e){if(e){var t=e.getProvider(),r=lr(t);if("FeatureProvider"==t.__type&&t.isEditable&&o[r])return n.listeners.trigger("_layerRemove",{layer:e}),delete o[r],i.splice(i.indexOf(e),1),dr("remove",t,n),delete t._e,!0}return!1},t instanceof Array&&t.forEach(e.addLayer)},pr=function(s){function e(a,c,e,t,r){var n=s.call(this,{type:"Feature",geometry:{type:"Point",coordinates:t},properties:{"@ns:com:here:editor":{},index:e,isMoved:!1}},a.overlay.getProvider())||this;n.type="Feature";var o=a.getFeature().geojson,i=n;return i.properties[r]={properties:w.JSUtils.extend(!0,{},o.properties),style:c.getStyle(o)},i._b=a,i.__={pointerdown:function(){this.properties.isMoved=!1,this.properties.p=c.display.geoToPixel.apply(c.display,this.geometry.coordinates)},pressmove:function(e,t,r,n,o){var i=this.properties.p,s=c.map.getGeoCoord(i.x+t,i.y+r);a.getFeature().update(this.properties.index,s),this._provider.setFeatureCoordinates(this,s.slice()),this.isMoved=!0},pointerup:function(e){this.properties.isMoved||c.listeners.trigger(e,this)}},i.class=r+"_SHAPE",n}return c(e,s),e.prototype.remove=function(){this.__=null,this._b.removeShape(this.properties.index)},e.prototype.getLength=function(){return this._b.getLength()},e.prototype.getIndex=function(){return this.properties.index},e}(a.features.Feature),hr=function(){function e(e,t){this.type="LineString",this.path=[],this.geojson=e.addFeature({type:"feature",geometry:{type:"LineString",coordinates:[t,[t[0]-1e-6,t[1]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;t&&(r[e]=t),1<r.length&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(r))},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.createGeo=function(e){return e.slice()},e.prototype.isValid=function(){return 1<this.path.length},e}(),fr=function(){function e(e,t){this.path=[],this.type="MultiPolygon",this.geojson=e.addFeature({type:"feature",geometry:{type:"MultiPolygon",coordinates:[[[t,[t[0]-1e-6,t[1]],[t[0]-1e-6,t[1]-1e-6],t]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;t&&(r[e]=t),2<r.length&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(r))},e.prototype.createGeo=function(e){return[[e.concat([e[0]])]]},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.isValid=function(){return 2<this.path.length},e}(),vr=[{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:"#000000",strokeWidth:2,radius:6}],gr=[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#ffffff"}];function Ar(e,t){var r=w.JSUtils.clone(e||vr);return r.forEach(function(e){return e.zIndex=(0^e.zIndex)+t}),r}var yr,mr=function(){function e(e,t,r){this.shapes=[],this.originLink=null,this.originPos=null;var n=this;n.overlay=e,n.iEdit=t,n.display=r,n.onBoardUp=n.onBoardUp.bind(n),n.updateMousePosition=n.updateMousePosition.bind(n)}return e.prototype.onBoardUp=function(){this.mousedown=!1},e.prototype.updateMousePosition=function(e){var t=this,r=t.iEdit,n=t.feature,o=t.shapes,i=t.display,s=t.cursor,a=t.mousedown,c=t.overlay;if(a){var l=r.map.getEventsMapXY(e),d=s.properties.prevPos;i.lockViewport().pan||i.pan(l[0]-d[0],l[1]-d[1],0,0),d[0]=l[0],d[1]=l[1]}else{var u=r.map.getGeoCoord(r.map.getEventsMapXY(e));n.update(o.length,u),c.setFeatureCoordinates(s,u)}},e.prototype.init=function(){var o=this,i=o.iEdit,e=o.display,t=o.overlay,s=o.updateMousePosition,r=e.getViewBounds(),n=[r.minLon,r.maxLat];this.feature=new this.FeatureClass(t,n);var a=t.addCircle(n,Ar(vr,1));a.pointerdown=function(e,t,r){var n=a.properties;n.prevPos=i.map.getEventsMapXY(e),o.mousedown=!0,n.panned=!1},a.pressmove=function(e,t,r,n,o){s(e),a.properties.panned=!0},a.pointerup=function(e){a.properties.panned||o.addShape(i.map.getGeoCoord(e.mapX,e.mapY),yr,e),o.onBoardUp()},this.cursor=a,w.global.addEventListener("mousemove",this.updateMousePosition),w.global.addEventListener("mouseup",this.onBoardUp)},e.prototype.addShape=function(e,t,r){var n,o=this.iEdit,i=this.settings,s=this.shapes,a=this.feature;if(t){if(n=(this.originLink=t).geometry.coordinates,"number"==typeof e)e=[n[e][0],n[e][1],n[e][2]];else{var c=o.map.calcCrossingAt(n,e,o._config.minShapeDistance);!c.existingShape||0!=c.index&&c.index!=n.length-1||(this.originLink=null),e=c.point}this.originPos=e}var l=this.overlay.addFeature(new pr(this,o,s.length,e,i.mode),Ar(this.shpStyle,9));a.update(s.length,e),s.push(l),i.onShapeAdd&&i.onShapeAdd(new Ct("onShapeAdd",e[0],e[1],r,r&&r.button,l,{index:l.properties.index}))},e.prototype.removeShape=function(e){var t=this,r=t.shapes,n=t.iEdit,o=t.overlay,i=t.feature,s=t.settings;e==yr&&(e=r.length-1);var a=r[e],c=n.map.getGeoCoord(a.geometry.coordinates);o.remove(a),r.splice(e,1),i.removeAt(e);for(var l=e;l<r.length;l++)r[l].properties.index--;i.update(),s.onShapeRemove&&s.onShapeRemove(new Ct("onShapeRemove",c[0],c[1],yr,yr,yr,{index:e}))},e.prototype.getFeature=function(){return this.feature},e.prototype.getLength=function(){return this.shapes.length},e.prototype.setAttributes=function(e){var t=this,r=t.feature,n=t.iEdit,o=t.cursor,i=t.settings,s=t.shapes;if(e){w.JSUtils.extend(r.properties,e);var a=function(e,t){var r,n,o,i,s=e.mode;if(e.styleGroup)r=e.styleGroup;else if("NAVLINK"!=s&&"AREA"!=s||(t.editState=function(){return{}},t.class=s),r=e.layer.getStyleGroup(t),"AREA"!=s)return(i=w.JSUtils.clone(vr))[0].fill=r[0].stroke,(o=w.JSUtils.clone(gr))[0].stroke=(r[1]||r[0]).stroke,{feature:o,shape:i};var a=function(e){return-1!=["Circle","Image","Rect","Text"].indexOf(e.type)};if(o=r.filter(function(e){return!a(e)}),i=r.filter(a),o.length||(o=e.layer.getStyleGroup(t)),!e.styleGroup||!i.length){i=w.JSUtils.clone(vr);var c=o[0];n=c.stroke;var l=void 0;"AREA"==s?(l=c.fill,n&&(i[0].stroke=n)):l=n,l&&(i[0].fill=l)}return{feature:o,shape:i}}(i,r.geojson);this.shpStyle=a.shape,r.geojson.class=yr,n.setStyle(r.geojson,a.feature),s.concat(o).forEach(function(e){n.setStyle(e,Ar(a.shape,n.getStyle(e)[0].zIndex))})}},e.prototype.createGeom=function(){var e=this.feature,t=this.shapes,r=this.settings,n=t.map(function(e){return e.geometry.coordinates});return"AREA"!=r.mode&&(n=m(n,r.generalization||1e-5)),{type:e.type,coordinates:e.createGeo(n)}},e.prototype.create=function(e){var t=this,r=t.iEdit,n=t.FeatureClass,o=t.shapes,i=t.feature,s=t.originLink,a=t.originPos,c=t.settings;if(this.setAttributes(e),n==hr){var l=o[0].geometry.coordinates;s&&a[0]==l[0]&&a[1]==l[1]&&r.objects.splitLinkAt({link:r.objects.get(s),point:l})}if(i.isValid()){var d=r.objects.create({type:"Feature",geometry:this.createGeom(),properties:i.properties},c.layer.getProvider(),yr,yr);return r.objects.history.saveChanges(),this.hide(),d}},e.prototype.isActive=function(){return this.active},e.prototype.show=function(e){if(!this.active){var t=this.overlay.layer,r=this.iEdit,n=this.display;r.objects.listenDisplay(!1),n.removeLayer(t),n.addLayer(t),r.objects.listenDisplay(!0),"AREA"==(this.settings=e).mode?this.FeatureClass=fr:this.FeatureClass=hr,this.originLink=null,this.originPos=null,this.active=!0,this.init(),this.setAttributes(e.attributes)}},e.prototype.hide=function(){var e=this,t=e.display,r=e.overlay,n=e.shapes,o=e.feature;if(e.active){e.active=!1;var i=r.layer;t.removeLayer(i),t.addLayer(i),r.remove(o.geojson),e.feature=null,n.forEach(function(e){return r.remove(e)}),n.length=0,r.remove(e.cursor),e.cursor=null,w.global.removeEventListener("mousemove",e.updateMousePosition),w.global.removeEventListener("mouseup",e.onBoardUp)}},e}(),Sr="AREA",Er="NAVLINK";function Cr(n,e,o){var i=this,t=n.objects.overlay,s=new mr(t,n,n.display),a=s,c=!1;i.addShape=function(e,t){c&&a.addShape(n.map.getGeoCoord(e),t)},i.removeShape=function(e){c&&a.removeShape(e)},i.getLength=function(){return a.getLength()},i.cancel=function(){a.hide(),c=!1},i.setProperties=function(e){c&&a.setAttributes(e)},i.setAttributes=i.setProperties,i.create=function(e){if(c){var t=a.create(e);return t&&(c=!1),t}},i.start=function(e){var t=(e=e||{}).connectTo,r=e.mode||Er;return r="string"!=typeof r?r===o.features.Area?Sr:Er:r.toUpperCase(),e.mode=r,e.attributes=e.properties||e.attributes||{},c||(a="FREEHAND"==e.control?touchDraw:s,e.layer=e.layer||n.getLayerForClass(r),(r!=Sr||e.layer)&&(n.listeners.trigger("_clearOverlay"),a.show.call(a,e),c=a.isActive(),e.position&&i.addShape(e.position,t))),c},i.isActive=function(){return c},i.getGeometry=function(){return a.createGeom()}}var kr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t}(tt);kr.prototype.class="MARKER";var xr=function(e){for(var t,r=[],n=0;n<e.length;n++)for(var o=e[n],i=r[r.length]=[],s=0;s<o.length;s++)i[s]=3==(t=o[s]).length?[t[0],t[1],t[2]]:[t[0],t[1]];return r},Lr=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.coord=function(e){var t,r=this,n=r.geometry.type;if(e instanceof Array)M.deHighlight(r),M._setCoords(r,e),M.markAsModified(r);else if(e=r.getProvider().decCoord(r),"Polygon"==n)t=xr(e);else{t=[];for(var o=0;o<e.length;o++)t[o]=xr(e[o])}return t},t.prototype.addShape=function(e,t,r){var n=!1;return(e=this._e().map.getGeoCoord(e))?(1==arguments.length&&(t=M.getPoly(this,e)),!1!==(n=M.addShp(this,e,0^t,0,r))&&M.markAsModified(this)):function(e){throw new Error(e)}("missing coordinate"),n},t.prototype.addHole=function(e){var t=this;if(e){e=this._e().map.getPixelCoord(e);for(var r=M.getPoly(this,e),n=M.getCoords(this),o=n[r],i=1/0,s=0;s<o.length;s++){var a=M.getMaxSpace(e,o[s]);a<i&&(i=a)}if(8<(i=Math.floor(.5*i))){var c=e[0],l=e[1],d=[[c-i,l+i],[c+i,l+i],[c+i,l-i],[c-i,l-i],[c-i,l+i]].map(function(e){return t._e().map.getGeoCoord(e)});M.isClockwise(o[0])||d.reverse(),o.push(d),M._setCoords(this,n,!0),M.markAsModified(this)}}},t}(tt);Lr.prototype.class="AREA";var br,_r="#FFFFFF",Ir="#FF0000",Pr="#000000";function wr(h,f,e){var t,i=this,v=h.objects.overlay,s=e.link,a=e.candidate,r=e.searchPnt,c=e.foundPnt||r,l=!!e.foundPnt,n=h.map.getPixelCoord(e.cx,e.cy),g={zIndex:0,type:"Line",stroke:Ir,strokeWidth:22,strokeLinecap:"round",opacity:.5},A={zIndex:1,type:"Line",stroke:_r,strokeWidth:18,strokeLinecap:"round",opacity:.8},y={zIndex:2,type:"Line",stroke:Pr,strokeWidth:14,strokeLinecap:"round",opacity:.8},m={zIndex:3,type:"Circle",stroke:Ir,strokeWidth:1,opacity:.5,radius:12,fill:Ir},S={zIndex:4,type:"Circle",stroke:_r,strokeWidth:2,opacity:1,radius:10,fill:_r},E={zIndex:5,type:"Circle",stroke:_r,radius:3,fill:_r};function C(e){return h.getStyle(e)[0].stroke}function d(){return u(s,r)}function u(e,t){for(var r=e.coord(),n=0;n<r.length;n++)if(t.x==r[n][0]&&t.y==r[n][1])return n;return k(r,[t.x,t.y])}i.class="CROSSING"+(l?"_CANDIDATE":""),i.type="Feature",i.geometry=l?{type:"LineString",coordinates:[[r.x,r.y],[c.x,c.y]]}:{type:"Point",coordinates:[e.cx,e.cy]},i.x=n[0],i.y=n[1],i.getRelatedLink=function(){return a};var o=h.display.geoToPixel(r.x,r.y),p=h.display.geoToPixel(c.x,c.y);i.distance=L([o.x,o.y],[p.x,p.y]),i.connect=function(){if(!a.id||!s.id||a.editState("removed")||a.editState("modified")>f.createTS||s.editState("removed")||s.editState("modified")>f.createTS)return!1;var e,t,r=u(a,c),n=[];for(var o in l||(e=We.addShp(s,h.map.clipGeoCoord([c.x,c.y]),null,!0)),t=l?d():e,!1!==d()&&(l&&s.getConnectedLinks(t).forEach(function(e){We.markAsModified(e,!1,!1)}),(We.connectShpToLink(s,t,a,h.map.clipGeoCoord([c.x,c.y]),r,!1,!0).splittedInto||[]).forEach(function(e){null!=e&&n.push(e)})),i.hide(),i)"type"!==o&&(i[o]=br);return i.isDeleted=!0,f.getCrossings({links:n,croLink:s})},i.show=function(){t=t||function(t,r,e,n,o){var i=f.cStyles,s=C(e),a=C(n),c=w.JSUtils.extend;function l(e){return v.addPath([[t.x,t.y],[r.x,r.y]],e)}function d(e,t){return v.addCircle([e.x,e.y],t)}function u(e){h.listeners.trigger(e,o)}if(c(g,i.connector1),c(A,i.connector2),c(y,i.connector3),c(m,i.search1),c(S,{fill:s},i.search2),c(E,{fill:a,stroke:a},i.found),s&&a){var p=[l(g),l(A),l(y),d(t,m),d(t,S),d(r,E)];return p.forEach(function(e){e.pointerup=u}),p}}(r,c,s,a,i),h.objects.overlay.showFeature(t)},i.hide=function(){t&&t.forEach(function(e){e._provider.removeFeature(e)}),t=null},i.getLink=function(){return s},i.getConnectedLinks=function(){return l?s.getConnectedLinks(d()):[]}}function Rr(f,r){var l,d,s,n,u,a=this,o=[],i=[],p=!1,c="CROSSING",h=c+"_CANDIDATE";function v(e,t,r,n){var o=this,i=null,s=n||r;o.candidate=t,o.link=e,o.foundPnt=n,o.searchPnt=r,o.distance=n?L([r.x,r.y],[n.x,n.y]):0,o.cx=(s.x-r.x)/2+r.x,o.cy=(s.y-r.y)/2+r.y,o.getSimplified=function(){return i||(i=new wr(f,a,o))}}function g(u,e,t){var r=[],p=u.coord();function n(e){for(var t=!1,r=[],n=function(e,t){for(var r,n=[],o=0;o<e.length-1;o++)for(var i=0;i<t.length-1;i++)(r=E(e[o],e[o+1],t[i],t[i+1]))&&(r.s1=o+1,r.s2=i+1,n.push(r));return n}(p,e.coord()),o=0,i=0,s=n.length;o<s-1;i=++o)for(var a=n[o],c=void 0;++i<s;)c=n[i],a[0]==c[0]&&a[1]==c[1]&&Math.abs(c.s1-a.s1)<=1&&Math.abs(c.s2-a.s2)<=1&&(n.splice(i--,1),s--);for(o=0;o<n.length;o++){t=!1;for(var l=0,d=void 0;l<h.length;l++)if((d=h[l]).link.id==e.id&&Ue.isIntersection(f,n[o],d.link.coord()[d.index])){t=!0;break}t||r.push(new v(u,e,{x:n[o][0],y:n[o][1]}))}return r}if(!u.editState("removed")){var h=u.getConnectedLinks(0,!0).concat(u.getConnectedLinks(p.length-1,!0));t.forEach(function(e){r=r.concat(n(e))})}return r}function A(e){var o,i=[];a.createTS=+new Date,(e.length==u?[e]:e).forEach(function(r){if(!(r.editState("removed")||s&&s!=c&&s!=h)){var e=w.geotools.extendBBox(r.getBBox(),l),n=f.objects.getInBBox(e,r.getProvider()),t=n.indexOf(r);-1!=t&&n.splice(t,1),s!=h&&(i=i.concat(g(r,0,n))),s!=c&&r.coord().forEach(function(e,t){(o=function e(t,r,n,o){var i,s,a;if(n===u)for(var c in i=t.getConnectedLinks(r,!0),n=[t.id],i)n.push(i[c].link.id);return s=t.coord(),null!=(a=f.objects.getNearestLine(s[r],o,{ignore:n,maxDistance:l,shapeThreshold:d,onlyExsitingShape:p}))&&function(e,t){for(var r in e)if(-1!=t.indexOf(e[r].link.id))return!0;return!1}(a.line.getConnectedLinks(a.shpIndex,!0),n)?(n.push(a.line.id),e(t,r,n,o)):a}(r,t,u,n))&&i.push(new v(r,o.line,{x:e[0],y:e[1],index:t},{x:o.point[0],y:o.point[1],index:o.shpIndex}))})}});for(var t=0,r=void 0;t<(r=i.length);t++)for(;t<--r;)i[t].cx==i[r].cx&&i[t].cy==i[r].cy&&i[t].candidate==i[r].candidate&&0==i[r].distance&&i[r].foundPnt&&i[t].searchPnt.x==i[r].searchPnt.x&&i[t].searchPnt.y==i[r].searchPnt.y&&i.splice(r,1);return i}a.getRelatedLink=function(){return r},a.setRelatedLink=function(e){e&&(n=[r=e])},a.setRelatedLink(r),a.clear=function(){a.createTS=0,i.forEach(function(e){e.hide&&e.hide()}),o.length=0,i.length=0},a.getCrossings=function(e,t){return e=e||{},a.setRelatedLink(t),e.links?e.croLink&&e.links.length&&(n=n.concat(e.links)):(s==e.class&&l==e.maxDistance||(a.createTS=0),a.cStyles=e.styles||{},s=e.class),l=e.maxDistance||f._config.XTestMaxDistance||3,d=f._config.minShapeDistance,(!a.createTS||r.editState("modified")>a.createTS||e.links)&&(a.clear(),o=A(n)),i.length=0,o.forEach(function(e,t){i[t]=e.getSimplified()}),i}}var Fr=function(){function e(e){this.hide=function(){return e.hideRestrictions()},this.isActive=function(){return e.isActive()}}return e.prototype.hide=function(){},e.prototype.isActive=function(){return!1},e}(),Dr=function(e){return e.getProvider().readPedestrianOnly(e)},Nr=function(e){return e.getProvider().readDirection(e)},Tr=function(e,t,r,n){var o=Nr(r);return r.getZLevels()[n]===e.getZLevels()[t]&&("BOTH"==o||(0==n?"START_TO_END":"END_TO_START")==o)},Or="TURN_RESTRICTION_",jr=function(){function e(e,i,s,a,c,t){var r,n,o,l,d,u,p,h,f,v=e.objects.overlay,g=0==c?1:a.coord().length-2,A=a.coord(),y=A[c].slice(),m=A[g].slice(),S=x(y,m,8e-5),E=(u=n=s,p=o=a,h=l=c,f=(d=r=i).getProvider().readTurnRestriction({link:d,index:u},{link:p,index:h}),Tr(r,n,o,l)?f?"FORBIDDEN":Dr(o)?"PEDESTRIAN":"ALLOWED":"ONEWAY"),C=v.addPath([S,y,t],null,{type:Or+"LINE",sign:Or+E}),k=v.addImage(S,null,{type:Or+E,rotation:-w.geotools.calcBearing(y,S)});this.sign=k,this.line=C,this.overlay=v,this.to=a,this.from=i,Ue.showDirection(a),v.remove(C),k.pointerenter=function(){v.addFeature(C)},k.pointerleave=function(){v.remove(C)},k.pointerup=function(){Tr(i,s,a,c)&&!Dr(a)&&(e.objects.history.ignore(function(){var e,t,r,n,o;e="ALLOWED"==E,r=s,n=a,o=c,(t=i).getProvider().writeTurnRestriction(e,{index:r,link:t},{index:o,link:n})}),E="ALLOWED"==E?"FORBIDDEN":"ALLOWED",e.objects.history.saveChanges()&&(k.properties.type=Or+E,C.properties.sign=k.properties.type,e.setStyle(k),e.setStyle(C)))}}return e.prototype.hide=function(){Ue.hideDirection(this.to),this.overlay.remove(this.sign),this.overlay.remove(this.line),this.sign=null,this.line=null},e}(),Br=function(){function e(e){var t=this;this.editor=e,this.overlay=e.objects.overlay,this.trs=[],e.listeners.bind("_clearOverlay",function(){return t.hideRestrictions()})}return e.prototype.hideCar=function(){this.car&&this.overlay.remove(this.car),this.car=null},e.prototype.showCar=function(e,t){var r=e.coord(),n=0==t?1:r.length-2,o={geometry:{coordinates:x(r[t],r[n],1e-4),type:"Point"},type:"Feature",properties:{type:"TURN_RESTRICTION_START",rotation:-w.geotools.calcBearing(r[t],r[n])}};this.car=this.overlay.addFeature(o)},e.prototype.showRestrictions=function(t,r){var n=this,e=Nr(t);if(!("B"!=e&&(0==r?"F":"T")==e||Dr(t))){var o=t.getConnectedLinks(r,!0);o.length&&this.showCar(t,r),this.trs=o.map(function(e){return new jr(n.editor,t,r,e.link,e.index,n.car.geometry.coordinates)})}},e.prototype.hideRestrictions=function(){var e=this.trs;for(var t in e)e[t].hide(),e[t]=null;e.length=0,this.hideCar()},e.prototype.isActive=function(){return 0<this.trs.length},e}(),Mr=function(){function e(e,t,r,n){var o=t.coord(),i="END_TO_START"==r?180:0,s=[];n||s.push(e.addPoint(o[0].slice(),{type:"NAVLINK_DIRECTION_HINT_A"}),e.addPoint(o[o.length-1].slice(),{type:"NAVLINK_DIRECTION_HINT_B"}));for(var a=0;a<o.length-1;a++){var c=o[a],l=o[a+1],d={type:"BLOCKED"==r?"NAVLINK_DIRECTION_HINT_BLOCKED":"BOTH"==r?"NAVLINK_DIRECTION_HINT_2WAY":"NAVLINK_DIRECTION_HINT_1WAY"};"BLOCKED"!=r&&(d.bearing=i-w.geotools.calcBearing(c,l)),s.push(e.addPoint(u(c,l,.5),d))}this.overlay=e,this.points=s}return e.prototype.destroy=function(){this.overlay.remove(this.points),this.points=null},e}(),Gr=function(e){throw new Error(e)},Ur=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.setGeoFence=function(e){(isNaN(e)||e<0)&&Gr("Geofence radius should be a positive Number"),t._e()._config.geoFence=+e},t}return c(t,e),t.prototype.checkCrossings=function(e){var t=Ue.private(this),r=t.xt||new Rr(this._e(),this);return(t.xt=r).getCrossings(e)},t.prototype.showDirectionHint=function(e,t){e={B:"BOTH",F:"START_TO_END",T:"END_TO_START",N:"BLOCKED"}[e]||e;var r=Ue.private(this),n=r.dh;n&&n.destroy(),r.dh=e&&new Mr(this._e().objects.overlay,this,e,t)},t.prototype.addShape=function(e,t){var r=!1;return(e=this._e().map.getGeoCoord(e))?!1!==(r=Ue.addShp(this,e,t,void 0,!0))&&Ue.markAsModified(this):Gr("missing pixel coordinate"),r},t.prototype.getConnectedLinks=function(e,t){void 0===t&&(t=!1);var r,n,o=this,i=o._e(),s=o.coord(),a=s[e],c=[];if(0==e||e==s.length-1)for(var l=0,d=i.objects.getInBBox(o.bbox,o.getProvider());l<d.length;l++){var u=d[l];u.id!=o.id&&"NAVLINK"==u.class&&(n=(r=u.coord()).length-1,null!=(e=Ue.isIntersection(i,r[0],a)?0:Ue.isIntersection(i,r[n],a)?n:null)&&c.push(t?{index:e,link:u}:u))}return c},t.prototype.getZLevels=function(){for(var e=this.geometry.coordinates,t=e.length,r=[];t--;)r[t]=e[t][2]||0;return r},t.prototype.setZLevels=function(e){var t=this.getZLevels().length;e instanceof Array||Gr("Invalid 'zlevel' argument given, no array"),e.length!==t&&Gr("Given 'zlevel' argument is of an invalid size, a length of "+t+" is required!"),this._e().objects.history.origin(this);for(var r=this.geometry.coordinates,n=!1,o=0,i=void 0;o<e.length;o++)(i=0^e[o])!=r[o][2]&&(r[o][2]=i,n=!0);n&&(Ue.refreshGeometry(this),Ue.markAsModified(this))},t.prototype.editTurnRestrictions=function(e){var t=this.coord(),r=0==e||e==t.length-1?[e]:void 0===e?[0,t.length-1]:[],n=[],o=this._e();o.listeners.trigger("_clearOverlay");for(var i=0;i<r.length;i++){var s=new Br(o);s.showRestrictions(this,r[i]),n.push(new Fr(s))}return n},t.prototype.prop=function(e,t){var r=this,n=r._e(),o=!1,i=arguments.length,s=r.getProvider().getFeatureProperties(r);if(0==i||1==i&&"string"==typeof e){var a=e?s[e]:s;return"object"==typeof a?w.JSUtils.extend(!0,new a.constructor,a):a}var c=e;if(2==i){var l={};l[e]=t,c=l}for(var d in c){var u=c[d],p="object"==typeof u,h=s[d];(p&&JSON.stringify(u)!=JSON.stringify(h)||!p&&h!==u)&&(o||(n.objects.history.origin(r),o=!0),s[d]=u)}o&&(n.setStyle(r),r.editState("selected")&&Ue.showDirection(r),Ue.markAsModified(r))},t}(tt);Ur.prototype.class="NAVLINK";var zr,Hr="currentChangeStep";function Kr(){}var Jr,Vr,Qr=Kr.prototype;function Wr(n,i,s,a){function t(e,t){e=(""+e).split(" ");for(var r=0;r<e.length;r++)t(e[r],n[e[r]])}return{add:function(e,n,o){t(e,function(e,t){var r=n;t&&(t[t.length]=n,r=t[t.length]=t[0]?i(e,n,o):o,e=t[0]),e&&s(e,r,o)})},remove:function(e,n,o){t(e,function(e,t){if(t){var r=t.indexOf(n);-1!=r&&(e=t[0],n=t[r+1],t.splice(r,2))}e&&a(e,n,o)})}}}function Yr(u,p){!function(e,f){var s=tt.prototype,t=kr.prototype,r=Lr.prototype,n=Ur.prototype;t.toFront=function(){},t.setIcon=function(e,t,r,n,o){var i;"object"==typeof e&&(e.offset,r=e.height,t=e.width,e.animation,e=e.icon),(e||t!==zr||r!==zr)&&(i=s.style.call(this),e&&(i[0][1].src=e),t!==zr&&r!==zr&&(i[0][1].width=t,i[0][1].height=r),s.style.call(this,i))},t.style=function(e){if("string"==typeof e||!arguments.length)return s.style.apply(this,arguments)[0][1];var t=s.style.call(this);t[0][1]=e,s.style.call(this,t)},r.style=function(e){if(!e)return s.style.call(this)[0][1];if("default"===e)e=s.style.call(this,e);else if("object"==typeof e){var t=s.style.call(this);t[0][1]=e,e=t}s.style.call(this,e)},n.style=function(e){var t;if("string"==typeof e||!arguments.length)return t={},(e=s.style.apply(this,arguments))[0]&&(t.outline=e[0][1]),e[1]&&(t.inline=e[1][1]),t;t=[],e.outline&&(t[0]=[0,e.outline]),e.inline&&(t[1]=[1,e.inline]),s.style.call(this,t)};var h=here.xyz.maps.editor.GeoCoordinate;s.getGeoCoordinates=function(){var e,t=this.geometry.type,r=this.coord(),n=r.length;if("Point"==t)return new h(r[0],r[1],r[2]);var o=[];if("LineString"==t)for(var i=0;i<n;i++)e=r[i],o[i]=new h(e[0],e[1],e[2]);else for(var s=0;s<r.length;s++)for(var a=r[s],c=o[s]=[],l=0;l<a.length;l++)for(var d=a[l],u=c[c.length]=[],p=0;p<d.length;p++)e=d[p],u[p]=new h(e[0],e[1],e[2]);return o},s.getPixelCoordinates=function(){var e,t,r,n=this.geometry.type,o=this.coord();if("Point"==n)r=o[2],(e=f.geoToPixel(o[0],o[1])).z=r;else if(e=[],"LineString"==n)for(var i=o.length,s=0;s<i;s++)r=(t=o[s])[2],e[s]=f.geoToPixel(t[0],t[1]),e[s].z=r;else for(var a=0;a<o.length;a++)for(var c=o[a],l=e[a]=[],d=0;d<c.length;d++)for(var u=c[d],p=l[l.length]=[],h=0;h<u.length;h++)r=(t=u[h])[2],p[h]=f.geoToPixel(t[0],t[1]),p[h].z=r;return e},s.setCoordinates=function(e){var t,r,n=[],o=[];function i(e){var t=(e=this._e().map.getGeoCoord(e))[0],r=e[1],n=e[2];return"number"!=typeof t||"number"!=typeof r?"Point is neither valid pixel nor valid WGS coordinate!":90<r||r<-90||180<t||t<-180?"Coordinates out of bounds! Defective coordinate: ["+t+", "+r+"]":o[1]!=r||o[0]!=t||o[2]!=e[2]?(o=e,(n=+n)!=n||n<-4||5<n||n!==~~n?"invalid zLevel: "+n+" ,the value must be an integer between -4 and +5 and is ":[t,r,n||0]):void 0}if("NAVLINK"==this.class){for(var s=0;s<e.length;s++){if(r=null,"string"==typeof(t=i(t=e[s]))){r=t;break}t&&n.push(t)}r||n.length<2&&(r="Coordinates should be an array, A line needs to have at least two coordinates!")}else"Point"==this.geometry.type?"string"==typeof(n=i(e))&&(r=n):n=e;r?this._e().listeners.trigger("error",{name:"InvalidCoordinates",message:r}):this.coord(n)},s.getAttributes=function(e){return e&&this.prop(e)||this.prop()},s.setAttributes=function(e,t){return this.prop.apply(this,arguments)},s.attr=s.prop}(0,p);var e=here.xyz.maps.editor.objects=here.xyz.maps.editor.features;e.POI=e.Place,e.Link=e.Navlink,u.zoneSelector=u.getZoneSelector(),u.drawingManager=u.getDrawingBoard();var i=u.changes={undo:u.undo,redo:u.redo,info:u.info,import:u.import,export:u.export,revert:u.revert,submit:u.submit,length:0,currentStep:0,totalSteps:0};u.addObserver("history.current",function(e,t,r){i.currentStep=t,i.length=u.get("changes.length"),i.totalSteps=u.get("history.length");for(var n=s[Hr],o=1;o<n.length;o+=2)n[o].call(n[o+1],Hr,t,r)}),u.layers={add:u.addLayer,remove:u.removeLayer,get:u.getLayers},u.listeners=Wr({dblclick:["dbltap"],click:["pointerup"],mouseover:["pointerenter"],mouseout:["pointerenter"]},function(n,o,i){return function(e){var t={};for(var r in e)t[r]=e[r];null==t.target&&(t.target=new Kr),t.type=n,o.call(i,t)}},u.addEventListener,u.removeEventListener);var s={sync:["ready"],totalSteps:["history.length"],zoomLevel:[null],currentChangeStep:[null]},a=p.getZoomlevel();p.addObserver("zoomlevel",function(e,t,r){if(t=Math.round(t),a!=t){for(var n=s.zoomLevel,o=1;o<n.length;o+=2)n[o].call(n[o+1],"zoomLevel",t,a);a=t}}),u.observers=Wr(s,function(n,o,i){return"sync"==n?function(e,t,r){o.call(i,n,r,t)}:function(e,t,r){o.call(i,n,t,r)}},u.addObserver,u.removeObserver);var t={currentChangeStep:"history.current",totalSteps:"history.length"};u.observers.get=function(e){return"sync"==e?!u.get("ready"):u.get(t[e]||e)};var n=!(u.objects={add:u.addFeature,get:u.getFeature,createContainer:u.createFeatureContainer,clearSelection:u.clearObjectSelection}),r=u.viewport={center:null,topLeft:null,bottomRight:null,block:function(e){var t=!1,r=!1;return e!==zr&&(r="number"==typeof(n=e)?e:(t=e)?!e:e,p.lockViewport({pan:t,minLevel:r})),!("number"==typeof n||!1===n)},getObjects:function(e,t,r){for(var n,o={minLon:1/0,maxLon:-1/0,minLat:1/0,maxLat:-1/0},i=0,s=0,a=void 0;s<arguments.length;s++)if((a=arguments[s])instanceof Array)n=a;else if("string"==typeof a)n=[a];else if("object"==typeof a){a.x!=zr&&a.y!=zr&&(a=p.pixelToGeo(a)),i++;var c=a.longitude,l=a.latitude;c<o.minLon&&(o.minLon=c),c>o.maxLon&&(o.maxLon=c),l<o.minLat&&(o.minLat=l),l>o.maxLat&&(o.maxLat=l)}i||(o=p.getViewBounds());var d=u.search({rect:o,filter:n&&function(e){return-1!=n.indexOf(e._provider.detectFeatureClass(e))}});return u.createFeatureContainer.apply(u,d)}};u.addObserver("ready",function(){var e=p.getViewBounds();r.topLeft={longitude:e.minLon,latitude:e.maxLat},r.bottomRight={longitude:e.maxLon,latitude:e.minLat},r.center=p.getCenter()}),u.show=function(){return u.active(!0),u},u.hide=function(){return u.active(!1),u},u.legacy=!0}function qr(c){return function(e){var t,r=[];if("object"==typeof e)for(var n=e.filter,o=e.layers||c.layers,i=o.length;i--;)for(var s=o[i].search(e),a=s.length;t=s[--a];)n&&!n(t)||r.push(t);return r}}function Zr(o,e){e.addEventListener=function(e,t,r){var n=function(){var e=o.supported.apply(o,arguments);return"boolean"!=typeof e?e.filter(function(e){return"_"!=e[0]}):e}();String(e).split(" ").forEach(function(e){-1<n.indexOf(e)?o.bind.call(o,e,t,r):w.JSUtils.dump(e+" is not a valid event. Use: "+n.join(", "),"warn")})},e.removeEventListener=function(){o.remove.apply(o,arguments)}}function Xr(n,e){e.addObserver=function(e,t,r){n.addObserver(e,t,r)},e.get=function(e){return n.get(e)},e.removeObserver=function(e,t){n.removeObserver(e,t)}}function $r(l,d,u,e,c,t,p,h,r){function f(e){var t=u.coord();return C(t,b(t)*e)}e=e.toUpperCase();var n=f(c),v=d.addPoint(n.slice(),[{zIndex:11,type:"Rect",fill:t,width:10,height:30}]),g=!1;function A(e,t){var r=u.coord(),n=k(r,t),o=S(r[n],r[n+1]),i=e.properties,s=t[0],a=t[1];o="L"===e.side?w.geotools.calcBearing(r[n],r[n+1]):w.geotools.calcBearing(r[n+1],r[n]);var c=l.getStyle(e);c[0].rotation=-o,l.setStyle(e,c),d.setFeatureCoordinates(e,t.slice()),i.x=s,i.y=a}v.side=e,this.getRelPosOfSubLink=function(e){var t=v.properties,r=[t.x,t.y],n=k(u.coord(),r);if(n>=e.from&&n<e.to){var o=e.link.coord(),i=$(r,e.reversed?o.reverse():o);return.995<i?1:i}return n<e.from?0:1},A(v,n),v.pressmove=function(e,t,r,n,o){if(!p()){var i=u.coord(),s=ee(i,l.map.getGeoCoord(e.mapX,e.mapY)),a=f(s.offset);c=s.offset,A(v,a),h(),g=!0}},v.pointerdown=function(){g=!1},v.pointerup=function(){g&&r()},this.remove=function(){d.remove(v)},this.getRelPos=function(){return c}}function en(e,t){return e.concat(t.slice(1))}function tn(s,a,e){var c,t,l=[],d=[],u=this;if(e===Jr)return null;function r(e,t,r,n){return{zIndex:e,type:"Line",stroke:t,strokeWidth:r,strokeDasharray:n||"none",strokeLinejoin:"round",strokeLinecap:n?"butt":"round"}}c=e.coord();var n=[r(0,"white",23),r(1,"grey",20),r(2,"white",3,[5,4])];function p(){a.setFeatureCoordinates(t,c)}function o(){a.remove(t)}function i(){d.forEach(function(e){e.remove()}),d.length=0}t=a.addPath(c,n),o(),l.push({from:0,to:c.length-1,link:e,reversed:!1}),p(),this.getChilds=function(){return l},this.coord=function(){return c.map(function(e){return e.slice()})},this.show=function(e){i(),a.addFeature(t,n),e.forEach(function(e){var i,t=e.side,r=e.style||{},n=r.stroke||"#ff4040";function o(){e.onChange&&e.onChange(i)}-1!=["L","R","B"].indexOf(t)&&((i={_zone:e,line:a.addPath([[0,0],[0,0]],[{zIndex:4,type:"Line",strokeWidth:9,opacity:r.opacity||.6,stroke:n}]),markers:[],remove:function(){a.remove(this.line),this.markers[0].remove(),this.markers[1].remove()},locked:function(){return!!e.locked},draw:function(){var e=i.markers[0].getRelPos(),t=i.markers[1].getRelPos(),r=u.coord(),n=b(r);if(t<e){var o=e;e=t,t=o}a.setFeatureCoordinates(i.line,h(r,e*n,t*n))}}).markers.push(new $r(s,a,u,t,e.from,n,i.locked,i.draw,o),new $r(s,a,u,t,e.to,n,i.locked,i.draw,o)),d.push(i),i.draw())})},this.addLink=function(o){var i=o.coord(),e="CASE ";function t(e,t){return e[0]===t[0]&&e[1]===t[1]}function r(e,t,r){if(r&&i.reverse(),0===e){for(var n=0;n<l.length;n++)l[n].from+=t,l[n].to+=t;c=en(i,c)}else c=en(c,i);l.unshift({from:e,to:t,link:o,reversed:!!r})}Ue.defaults(o),t(i[i.length-1],c[0])?(e+="0->N",r(0,i.length-1)):t(i[0],c[0])?(e+="0->0",r(0,i.length-1,!0)):t(i[0],c[c.length-1])?(e+="N->0",r(c.length-1,c.length+i.length-2)):t(i[i.length-1],c[c.length-1])&&(e+="N->N",r(c.length-1,c.length+i.length-2,!0)),s.dump(e),p()},this.destroy=function(){o(),i()},this.coord=function(){return c},this.getZones=function(e,t){return d},this.getZoneSegments=function(e){var r=e.markers[0],n=e.markers[1],o=[];function i(e){var t=e[0];e[0]=e[1],e[1]=t}return l.forEach(function(e){var t=[r.getRelPosOfSubLink(e),n.getRelPosOfSubLink(e)];t[0]>t[1]&&i(t),e.reversed&&(i(t),t[0]=1-t[0],t[1]=1-t[1]),t[0]!==t[1]&&o.push([e.link,t[0],t[1],e.reversed])}),o}}function rn(a,c){var l=null,d={ref:null,nref:null},u=[];this.getCollection=function(){return l},this.show=function(e){l&&l.show(e)},this.hide=function(){for(var e=0;e<u.length;e++)Ue.defaults(u[e]);u=[],d={ref:null,nref:null},l&&(l.destroy(),l=null)},this.addLink=function(e){var t,r,n;if(null!=e&&(n=e.coord().length-1,(r=!u.length)&&(d.ref=e.getConnectedLinks(0,!0),d.nref=e.getConnectedLinks(n,!0),u.push(Ue.deHighlight(e)),l=new tn(a,c,e,"B")),t=function(e){for(var t in d)for(var r in d[t])if(e.id===d[t][r].link.id)return t;return null}(e))){var o=u[u.length-1],i=d[t];for(var s in Ue.deHighlight(o),i)Ue.defaults(i[s].link),i[s].link.id==e.id&&(d[t]=e.getConnectedLinks(0==i[s].index?n:0,!0),u.push(e),l.addLink(e))}return!(!t&&!r)},a.display.addEventListener("mapviewchangestart",this.hide)}function nn(e){var t,n=new rn(e,e.objects.overlay);function o(e){var t=[];return n.getCollection().getZoneSegments(e).forEach(function(e){t.push({Link:e[0],from:e[1],to:e[2],reversed:e[3]})}),t}this.add=function(e){e=e instanceof Array?e:[].slice.call(arguments);for(var t=0;t<e.length;t++)e[t]instanceof tt&&n.addLink(e[t])},this.show=function(e){(t=e instanceof Array?e:[].slice.call(arguments)).forEach(function(e){var t=e.onChange;e.from=e.from||0,e.to=(e.to==Vr?1:e.to)||0,t&&(e.onChange=function(e){t(o(e))})}),n.show(t)},this.hide=n.hide,this.info=function(){var r=[],e=n.getCollection();e&&e.getZones().forEach(function(e){var t=e._zone;t.segments=o(e),r.push(t)});return r}}Qr.type="Feature",Qr.class="GROUND",Qr.bbox=[-180,-90,180,90],Qr.properties={"@ns:com:here:editor":{}},Qr.geometry={type:"Polygon",coordinates:[[[-180,90],[180,90],[180,-90],[-180,-90],[-180,90]]]};var on,sn={debug:!0,editRestrictions:function(){return!1},services:{reverseGeocoder:{}},destination:function(e){e instanceof Array||(e=[e]);for(var t=document.getElementsByTagName("script"),r="toLowerCase",n="",o=0;o<e.length;o++)for(var i=t.length-1;0<=i;--i){var s=t[i].src[r](),a=s.indexOf(e[o][r]());if(0<=a)return n=s.substr(0,a)}return n}(["mapedit.js"]),geoFence:!1,minShapeDistance:2,autoConnectShapeDistance:2,intersectionScale:5,XTestMaxDistance:2,disconnectShapeDistance:3,keepFeatureSelection:"viewportChange",featureSelectionByDefault:!0,enableHover:!0,maxRoutingPointDistance:1e3,autoSnapShape:!1},an=function(e,t,r,n){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:n})},cn=function(e,t,r,n,o){t.getProvider().writeTurnRestriction(e,{link:t,index:r},{link:n,index:o})},ln={"Navlink.split":[function(e){for(var t=e.link,r=e.children,n=r[0],o=r[1],i=t.coord().length-1,s=n.coord().length-1,a=o.coord().length-1,c=0,l=t.getConnectedLinks(0,!0);c<l.length;c++){var d=l[c],u=d.link,p=d.index;an(t,0,u,p)&&(cn(!0,n,0,u,p),cn(!1,o,0,u,p)),an(u,p,t,0)&&(cn(!0,u,p,n,0),cn(!1,u,p,o,0))}for(var h=0,f=t.getConnectedLinks(i,!0);h<f.length;h++){var v=f[h];u=v.link,p=v.index;an(t,i,u,p)&&(cn(!0,o,a,u,p),cn(!1,n,s,u,p)),an(u,p,t,i)&&(cn(!0,u,p,o,a),cn(!1,u,p,n,s))}}],"Feature.remove":function(e){var t=e.feature;if("NAVLINK"==t.class){for(var r=t.coord().length-1,n=0,o=t.getConnectedLinks(0,!0);n<o.length;n++){var i=o[n],s=i.link,a=i.index;cn(!1,t,0,s,a)}for(var c=0,l=t.getConnectedLinks(r,!0);c<l.length;c++){var d=l[c];s=d.link,a=d.index;cn(!1,t,r,s,a)}}},"Navlink.disconnect":function(e){var n=e.link,o=e.index;n.getConnectedLinks(o,!0).forEach(function(e){var t=e.link,r=e.index;cn(!1,n,o,t,r),cn(!1,t,r,n,o)})}},dn=function(s){[ln].forEach(function(e){return function(e){var t;for(var r in e){"function"==typeof(t=e[r])&&(t=[t]);for(var n=0,o=t;n<o.length;n++){var i=o[n];s.hooks.add(r,i)}}}(e)})},un=function(t,e){var r=this,n=(e=function(e){var t=w.JSUtils.extend(!0,{},sn);for(var r in e)switch(r){case"services":w.JSUtils.extend(!0,t[r],e[r]);break;case"editRestrictions":if("function"!=typeof e[r])break;default:t[r]=e[r]}return t}(e||{})).layers;delete e.layers,w.JSUtils.loglevel=e.debug;var o=new ar(e,t),i=w.global.here.xyz.maps.editor;r._i=function(){return o},r.addHook=function(e,t,r){return o.hooks.add(e,t,r)},r.removeHook=function(e,t,r){return o.hooks.remove(e,t,r)},r.getHooks=function(e){return o.hooks.get(e)},dn(o),it(o,r),r.container=t.getContainer(),r.active=function(e){var t=o.observers.get("active");return null!=e&&(e=!!e)!=t&&(t=e,o.objects.listenDisplay(e),o.observers.change("active",e,!0)),t},r.destroy=function(){for(var e in r.getLayers().forEach(r.removeLayer),r.active(!1),o.destroy(),r)delete r[e];return null},new ur(o,r,n),n=null,new Zr(o.listeners,r),new Xr(o.observers,r),new lt(o,r),r.setZoomLevel=function(e){t.setZoomlevel(e)},r.getZoomLevel=function(){return t.getZoomlevel()},r.pixelToGeo=function(e){var t=o.map.getGeoCoord(e);return t?new i.GeoCoordinate(t[0],t[1]):null},r.geoToPixel=function(e){var t=o.map.getPixelCoord(e);return t?new i.PixelCoordinate(t[0],t[1]):null};var s=new Cr(o,o.map,i);r.getDrawingBoard=function(){return s};var a=new nn(o);r.getZoneSelector=function(){return a},r.getOverlay=function(){return o.objects.overlay.layer},r.undo=function(e){for(e=Math.min(r.get("history.current"),e||1);e--;)o.objects.history.recoverViewport(-1,!!e)},r.redo=function(e){for(e=Math.min(r.get("history.length"),e||1);e--;)o.objects.history.recoverViewport(1,!!e)},r.search=new qr(o),e.legacy&&Yr(r,t),r.active(!0),setTimeout(function(){var e=o.observers.get("active"),t=e;o.observers.change("active",e,t)},0)},pn="POST",hn="url",fn="statusText",vn="responseText",gn="setRequestHeader",An="dataType",yn="contentType",mn="processData",Sn="timeout",En="error",Cn="data",kn="success",xn="headers",Ln="type",bn="async",_n="withCredentials",In=null,Pn=_n in new XMLHttpRequest;function wn(t){var r=new(Pn?XMLHttpRequest:XDomainRequest),n=t[hn],o="";function e(e,t){o+=((n+o).split("?")[1]?"&":"?")+e+"="+encodeURIComponent(t)}if("GET"===t[Ln])for(var i in t[Cn])e(i,t[Cn][i]);function s(){t[xn]&&e("CORSH",JSON.stringify(t[xn])),r.open(t[Ln],n+o,t[bn]===on||!!t[bn])}if(Pn){s(),t[yn]&&r[gn]("Content-Type",t[yn]),r[gn]("Accept",t.accepts?t.accepts.json:"*/*"),r.onload=t[kn],r.onreadystatechange=function(){var e=r.status;4==r.readyState&&(e<200||300<=e)&&0!==e?t[En](r,In):clearTimeout(a)};var a=setTimeout(function(){r.abort(),t[En](r,Sn)},t[Sn])}else delete t[xn].Accept,e("t",+new Date),t[yn]&&(t[xn]["Content-Type"]=t[yn]),s(),r.onprogress=function(e,t){return t},r.onload=function(e){t[kn]({responseText:r[vn]})},t[Cn]=String(t[Cn]),r.ontimeout=function(e){e[fn]=Sn,t[En](e,Sn)};return r.onerror=t[En],r[Sn]=t[Sn],r.tryCount=t.tryCount,r.retryLimit=t.retryLimit,r[_n]=t[_n],r.send(t[Ln]==pn?t[Cn]:In),r}function Rn(e){var t=this;t.name="NetworkError",t.message="Service request failed with HTTP status: '"+e.status+" "+e[fn]+"'",t.statusCode=e.status,t.responseText=e[vn]||In,t[Pn?"XHR":"XDR"]=e}function Fn(e){var h=this;var f=(e=e||{})[Sn]||2e4,v=e.retry||3,g=e.error,A=e[_n];"function"!=typeof A&&(A=function(){}),this.send=function(s,a,c){s=s instanceof Array?s:[s];var l=[],d=s.length,u=!1,p=[];return d?s.forEach(function(r,n){r[Ln]=r[Ln]||"GET",r[mn]===on&&(r[mn]=r[Ln]!=pn),r[An]=r[An]||"json",r[yn]=r[yn]||In,function(){var o=n,i=w.JSUtils.extend({withCredentials:!!A(),timeout:window.timeout||f,tryCount:0,retryLimit:v},r);i[hn]=i[hn].replace("{SUBDOMAIN}",Math.floor(4*Math.random())),i[En]=function(e,t,r){if(!u)if(t==Sn&&++this.tryCount<=this.retryLimit)wn(i);else{u=!0;var n=new Rn(e);g&&g(n);try{s[o][En]?s[o][En](n):c&&c(n)}catch(e){}}},i[kn]=function(e){var t,r=this;u||(t=e[vn]||e.currentTarget[vn],function(e){s[o][kn]&&s[o][kn](e,r),a&&(l[o]=e,--d||a(l,r))}(JSON.parse(t)))};var e=h.headers;if(e)for(var t in e)(i[xn]=i[xn]||{})[t]=e[t];p.push(wn(i))}()}):a(l),p}}var Dn=a.loaders.HTTPLoader,Nn={Line:"LineString",Point:"Point",Area:"MultiPolygon"},Tn=function(){function s(e,t){this.q={},this.headers={},this.ajax=t||new Fn,this.setUrl(e)}return s.prototype.abort=function(e){var t=this.q,r=e.quadkey,n=t[r];delete t[r],n.abort()},s.prototype.load=function(e,n,t){var r=this.getUrl(e),o=this.q,i=e.quadkey;o[i]=this.ajax.send({url:r},function(e,t){delete o[i],e=e[0];for(var r=0;r<e.length;r++)e[r]=s.toGeoJSON(e[r]);return n(e,t)},function(){delete o[i],t&&t(arguments[0])})[0]},s.prototype.xhr=function(e,t,r){this.ajax.send({url:e},t,r)},s.prototype.setUrl=function(e){e&&(this.baseUrl=e)},s.toGeoJSON=function(e){var t=e.type,r=e.properties;return r["@ns:com:here:maphub"]={layerId:e.layerId,lastUpdateTS:e.lastUpdateTS,createdTS:e.createdTS,guid:e.guid,nodeId:e.nodeId,previousGuid:e.previousGuid,states:e.states,version:e.version},{id:e.id,type:"Feature",geometry:{coordinates:e.coordinates,type:Nn[t]||t},properties:r}},s}();function On(e,t){var o=new Tn(e),i=new Tn(t);function s(r,n,o){return function(e,t){r[n][0]=e,r[n][1]=t,2==r["b"===n?"d":"b"].length&&o(function(e){var r={},t=[],n=0;function o(e){for(var t=0;t<e.length;t++)r[e[t].id]=e[t]}for(var i in o(e.b[0]),o(e.d[0]),r)t[n++]=r[i];return t}(r),r.b[1]+r.d[1])}}this.setUrl=function(e,t){o.setUrl(e),i.setUrl(t)},this.load=function(e,t,r){var n={b:[],d:[]};o.load(e,new s(n,"b",t),function(){}),i.load(e,new s(n,"d",t),function(){})},this.abort=function(e){o.abort(e),i.abort(e)}}function jn(){}function Bn(e,t){for(var r in t)e[r]=t[r];return e}function Mn(){var i=this;function e(e,t,r,n){return[{zIndex:e,type:"Polygon",fill:t,strokeWidth:n||1,stroke:r||"#FFFFFF"}]}i.styleGroups={undefined:e(0,"#FF0000","#FFFFFF",2),900170:e(1,"#E5F0DC"),900101:e(2,"#FAF9F5"),900107:e(3,i.randomColor()),509999:e(4,"#F4F8FA"),900103:e(8,"#D0F1CC"),600102:e(7,i.randomColor()),600101:e(6,i.randomColor()),600103:e(5,i.randomColor()),900130:e(9,i.randomColor()),900202:e(11,"#C9DFAF"),509997:e(10,i.randomColor()),900156:e(13,"#E0E7EB"),900108:e(12,i.randomColor()),908003:e(15,i.randomColor()),908002:e(14,"#F0EFED"),2000403:e(19,"#D0DADD"),9997004:e(18,"#E9E5DC"),900160:e(16,"#E9E5DC"),900150:e(21,"#B3E89E"),509998:e(20,"#FDF8CB"),1900403:e(24,"#E2E2E2"),9997007:e(23,i.randomColor()),9997008:e(22,i.randomColor()),1907403:e(25,"#D8D8D8"),2000457:e(33,"#D1C9C5"),2000420:e(32,"#D1C9C5"),2000124:e(31,"#D1C9C5"),2000123:e(30,"#D1C9C5"),2000200:e(29,"#D1C9C5"),2000408:e(28,"#D1C9C5"),2000461:e(27,"#D1C9C5"),2000460:e(26,"#D1C9C5"),900159:e(38,i.randomColor()),900158:e(37,i.randomColor()),1700215:e(36,"#EDEAE8"),1700216:e(35,"#EED5D2"),500414:e(43,"#99CEFE"),500421:e(42,"#A2C9FF"),500412:e(41,"#99CEFF"),507116:e(40,"#A2C9FF"),500116:e(39,"#99CEFF")},i.hovered=[{zIndex:0,type:"Polygon",fill:"#FF0000",opacity:.5,strokeWidth:2}],i.modified=[{zIndex:0,type:"Polygon",strokeWidth:3,stroke:"#1BBADD"}],i.selected=[{zIndex:0,type:"Polygon",opacity:.5,strokeWidth:4}];for(var t=e(34,"#B7BCBF","#545758"),r=2005e3;r<2005700;r++)i.styleGroups[r]=e(34,i.randomColor(),i.randomColor());for(r=2005700;r<=2005901;r++)i.styleGroups[r]=t;this.assign=function(e){var t,r=e.properties||{},n=e.editState(),o=r.featureType||r.feature_type;return n[i.STATE_SELECTED]?t=i.mergeStyles(i.styleGroups[o],i[i.STATE_SELECTED]):n[i.STATE_HOVERED]&&(t=i.mergeStyles(i.styleGroups[o],i[i.STATE_HOVERED])),n[i.STATE_MODIFIED]&&(t=i.mergeStyles(i.styleGroups[o],i[i.STATE_MODIFIED])),t||o}}Tn.prototype.getUrl=Dn.prototype.getUrl,jn.prototype.STATE_SELECTED="selected",jn.prototype.STATE_HOVERED="hovered",jn.prototype.STATE_MODIFIED="modified",jn.prototype.STATE_REMOVED="removed",jn.prototype.STATE_SPLIT="split",jn.prototype.STATE_CREATED="created",jn.prototype.mergeStyles=function(e,t){if(null===t||!1===t)return null;for(var r,n=[],o=0,i=e.length;o<i;o++)r=Bn({},e[o]),t[o]&&Bn(r,t[o]),n[o]=r;return n},jn.prototype.randomColor=function(){for(var e="0123456789ABCDEF".split(""),t="#",r=0;r<6;r++)t+=e[Math.round(15*Math.random())];return t},w.JSUtils.inheritClass(jn,Mn);var Gn="selected",Un="hovered",zn="modified",Hn="properties.name";function Kn(){var a=this;a.strokeWidthZoomScale=function(e){return 1+.2*(e-18)},a.styleGroups={1:[{zIndex:0,type:"Line",stroke:"#BE6B65",strokeWidth:16,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#E6A08C",strokeWidth:12,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:Hn}],2:[{zIndex:0,type:"Line",stroke:"#DAAC21",strokeWidth:14,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#FADC96",strokeWidth:10,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:Hn}],3:[{zIndex:0,type:"Line",stroke:"#D7BE13",strokeWidth:14,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#F6F299",strokeWidth:10,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:Hn}],4:[{zIndex:0,type:"Line",stroke:"#8C8E8E",strokeWidth:14,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#FFFFFF",strokeWidth:10,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:Hn}],5:[{zIndex:0,type:"Line",stroke:"#1C4409",strokeWidth:7,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:1,type:"Line",stroke:"#50A62B",strokeWidth:5,strokeLinejoin:"round",strokeLinecap:"round",opacity:1},{zIndex:2,type:"Text",fill:"#000000",textRef:Hn}],hovered:[{zIndex:0,type:"Line",opacity:.8,strokeWidth:16,stroke:"#222222"}],modified:[{zIndex:0,type:"Line",opacity:1,stroke:"#1BBADD"}],selected:[{zIndex:0,type:"Line",opacity:1,strokeWidth:18}]},a.assign=function(e,t){var r=e.properties||{},n=e.editState(),o=r.fc||5,i=r.access;5==o&&16!=i&&528!=i&&(o=4),o=5<o?5:o;var s=a.styleGroups[o];return n[Gn]?s=a.mergeStyles(s,a.styleGroups[Gn]):n[Un]&&(s=a.mergeStyles(s,a.styleGroups[Un])),n[zn]&&(s=a.mergeStyles(s,a.styleGroups[zn])),s}}w.JSUtils.inheritClass(jn,Kn);var Jn=function(){function e(){this.styleGroups={default:[{zIndex:0,type:"Image",src:"data:image/gif;base64,R0lGODdhEAAQALMAAAAAABUuPxcyRBw9VB5EXCBHYSNNaSdXdShZeSpegP///wAAAAAAAAAAAAAAAAAAACH5BAkAAAsALAAAAAAQABAAAARYcAxCqyVDSHO6/4eREUdinmhyEAKJKrByIkVbmjKe03aqmzzXKZZLBG8JmO84LO5qQp0SCEX6qL1X0VhNTYGsAQdBLpdDg4CGUGi73RhBIK0W2O/2gH4QAQA7",width:16,height:16}]}}return e.prototype.assign=function(){return"default"},e}();function Vn(){this.styleGroups={address:[{zIndex:0,type:"Rect",fill:"#4C9EEF",stroke:"#0156BB",width:20,height:20},{zIndex:1,type:"Text",fill:"#FFFFFF",textRef:"properties.address"}]},this.assign=function(e,t){return"address"}}var Qn,Wn="LineString",Yn="selected",qn="hovered",Zn="modified";function Xn(){var i=this;i[Wn]={default:[[0,{stroke:"#580008",strokeWidth:16,strokeLinejoin:"round",strokeLinecap:"round",strokeDasharray:"none",opacity:1}],[1,{stroke:"#e63d32",strokeWidth:12,strokeLinejoin:"round",strokeLinecap:"round",strokeDasharray:"none",opacity:1}]],hovered:[[0,{opacity:.8,strokeWidth:16,stroke:"#222222"}]],modified:[[0,{opacity:1,stroke:"#1BBADD"}]],selected:[[2,{stroke:"#222222",strokeWidth:18}],[3,{stroke:"#F9B708",strokeWidth:14}]]},i.Point={default:[[0,{fill:"#580008",radius:12,opacity:1}]],hovered:[[0,{radius:16}]],modified:[[0,{fill:"#1BBADD"}]],selected:[[0,{radius:14}]]},i.assign=function(e,t){var r=e.properties.editStates,n=e.geometry.type,o=i[n].default;return r[Yn]?o=i.mergeStyles(o,i[n][Yn]):r[qn]&&(o=i.mergeStyles(o,i[n][qn])),r[Zn]&&(o=i.mergeStyles(o,i[n][Zn])),o}}w.JSUtils.inheritClass(jn,Xn);var $n="@ns:com:here:maphub";var eo=function(e){return e&&""!=e&&"-"!=e},to=function(e,t){var r=e.split(":"),n=r[0],o=r[1].split("-"),i=parseInt(o[0]),s=parseInt(o[1]),a=!1;if("M"==n||i==s)return[e,e];s<i&&(a=s,s=i,i=a,a=!0,t=1-t);var c=Math.abs(i-s)/2+1,l=Math.round(c*t),d=2*(l-1)+i,u=[i,d],p=[d+2,s],h=function(){return!l},f=function(){return c==l},v=function(e){return n+":"+e.join("-")};return a&&(a=u,u=p.reverse(),p=a.reverse(),a=h,h=f,f=a),[h()?null:v(u),f()?null:v(p)]},ro={};[{"Navlink.split":function(e){var t=e.link,r=e.children,n=r[0],o=r[1],i=e.index,s=t.prop("bn");if(s){for(var a=[],c=[],l=0,d=s;l<d.length;l++){var u=d[l];u<i?a.push(u):(u==i&&a.push(u),c.push(u-i))}n.prop("bn",a),o.prop("bn",c)}}},{"Navlink.split":function(e){var t=e.link,r=t.id,n=t.prop();e.children.forEach(function(e){var t=e.prop();("number"==typeof r||n.originLink)&&(t.originLink=n.originLink||r),"number"==typeof r&&void 0!==t.originLink&&t.originLink!=r&&(t.parentLink=r),e.prop(t)})}},{"Navlink.split":function(e){var t=e.link,r=e.children,n=r[0],o=r[1],i=e.relativePosition,s=t.coord(),a=b(s),c=Math.round,l=i*a,d=(1-i)*a,u=["speedlimit","revspeedlimit"];for(var p in u){var h=u[p],f=t.prop(h);if(f){var v=f[0]||0,g=(f[1]||0)/100,A="number"==typeof f[2]?f[2]/100:1;if(g<i)var y=g*a/l,m=0;else y=1,m=(g*a-l)/d;if(A<i)var S=A*a/l,E=0;else S=1,E=(A*a-l)/d;n.prop(h,[v,c(100*y),c(100*S)]),o.prop(h,[v,c(100*m),c(100*E)]);var C=[n.properties,o.properties];for(var p in C){var k=C[p][h];0==k[0]?delete C[p][h]:(0===k[1]&&100===k[2]||null==k[1]||null==k[2])&&(C[p][h]=[k[0]])}}}}},{"Navlink.split":function(e){var t,r,n,o,i=e.link,s=e.children,a=s[0],c=s[1],l=e.relativePosition,d=["left","right"];for(var u in d){t=d[u],r=i.properties[t];var p=[],h=[];if(eo(r))for(var f in n=r.split(";"))if(eo(n[f])){var v=n[f];if(-1==v.indexOf(":"))v=(!(parseInt(v[1].split("-")[0])%2)?"E:":"O:")+v;o=to(v,l),p[f]=o[0],h[f]=o[1]}a.prop(t,p.join(";")),c.prop(t,h.join(";")),[a.properties,c.properties].forEach(function(e){""==e[t]&&delete e[t]})}}},{"Navlink.split":function(e){var t,r=e.link,n=e.children,o=n[0],i=n[1],s=r.prop("dd");null!=s&&("N"!=s&&"0"!=s?"A"==s?t=["A","A"]:"1"==s?t=["A","1"]:"2"==s?t=["2","A"]:"L"==s&&(t=["2","1"]):t=[s,s],o.prop("dd",t[0]),i.prop("dd",t[1]))}}].forEach(function(e){for(var t in e){var r=e[t];ro[t]=ro[t]||[],r instanceof Array?ro[t]=ro[t].concat(r):ro[t].push(r)}});var no={LineString:"Line",Point:"Point",MultiPolygon:"Area",Polygon:"Area"},oo=function(e){var t=e.geometry,r=t.coordinates,n=w.JSUtils.clone(e.properties),o=n["@ns:com:here:maphub"];delete n["@ns:com:here:maphub"],delete n["@ns:com:here:editor"],this.id=e.id,r&&("Polygon"==t.type?this.coordinates=[r]:this.coordinates=r),o.owner&&(this.owner=o.owner),"EXISTS"==o.guid&&(this.guid="EXISTS"),this.layerId=o.layerId,this.states=o.states,this.version=o.version,this.properties=n,this.type=no[t.type]},io=function(){function e(){}return e.prototype.createFeature=function(e){return new oo(e)},e.prototype.createFeatureContainer=function(e){for(var t=new Array,r=0;r<e.length;r++)t.push(this.createFeature(e[r]));return t},e}(),so=function(r){function e(e,t){return r.call(this,e,t)||this}return c(e,r),e.prototype.getBBox=function(){var e=this.geometry.coordinates;return[e[0],e[1],e[0],e[1]]},e.prototype.getLink=function(){var e=he.getRoutingData(this),t=e.link;if(t){var r=he.getRoutingProvider(this);t=r&&r.search(e.link)}return t||null},e}(kr),ao=function(r){function e(e,t){return r.call(this,e,t)||this}return c(e,r),e.prototype.createRoutingPoint=function(){he.getRoutingData(this).link||(he.connect(this),he.getRoutingData(this).link&&he.markAsModified(this))},e.prototype.removeRoutingPoint=function(){he.getRoutingData(this).link&&(he.disconnect(this),he.markAsModified(this))},e.prototype.prop=function(e){var t=this,r=arguments.length,n=t.getProvider().getFeatureProperties(t),o=!1;if(!r||1==r&&"string"==typeof e)return null!=(e=e?n[e]:n)&&"object"==typeof e?w.JSUtils.extend(!0,new e.constructor,e):e;if(2==r){var i={};i[e]=arguments[1],e=i}for(var s in e){var a=e[s],c="object"==typeof a,l=n[s];(c&&JSON.stringify(a)!=JSON.stringify(l)||!c&&l!==a)&&(o||(t._e().objects.history.origin(t),o=!0),n[s]=a)}he.getRoutingData(t).link?he.connect(t,null):he.disconnect(t),o&&(t._e().setStyle(t),he.markAsModified(t))},e}(so);ao.prototype.class="PLACE";var co=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.prop=function(e){var t=!1,r=arguments.length,n=this.getProvider().getFeatureProperties(this);if(!r||1==r&&"string"==typeof e)return null!=(e=e?n[e]:n)&&"object"==typeof e?w.JSUtils.extend(!0,new e.constructor,e):e;if(2==r){var o={};o[e]=arguments[1],e=o}for(var i in e){var s=e[i],a="object"==typeof s,c=n[i];(a&&JSON.stringify(s)!=JSON.stringify(c)||!a&&c!==s)&&(t||(this._e().objects.history.origin(this),t=!0),n[i]=s)}he.connect(this,null),t&&(this._e().setStyle(this),he.markAsModified(this))},t}(so);co.prototype.class="ADDRESS";var lo=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return c(t,e),t.prototype.addShape=function(e,t){return(e=this._e().map.getGeoCoord(e))?(t=Z.addCoord(this,e,t))&&Z.markAsModified(this):(!function(e){throw new Error(e)}("missing pixel coordinate"),t=!1),t},t}(tt);lo.prototype.class="LINE";var uo=a.providers.EditableProvider,po=new io,ho="defaultObject",fo=[ho],vo="REMOVED",go={json:"application/vnd.here.idList+json"},Ao="app_id",yo="app_code",mo={NVT_LINE:"LINE",NVT_LINK:"NAVLINK",NVT_POI:"PLACE",NVT_ADDRESS:"ADDRESS",NVT_MARKER:"MARKER",NVT_AREA:"AREA"};function So(n){var o=this;for(var e in n)this[e]=n[e];var t=o.class||o.type;function i(e){return o._getUrl(o.getTileUrl(e))}t&&(o.class=mo[t]||t),n.user&&!n.credentials&&(n.credentials=n.user),o.metadata={},this.setCredentials=function(e){var t=this.headers||{};for(var r in e)r==Ao||r==yo?this[r]=e[r]:(t=t||{})[r]=e[r];this.headers=t,o.loader&&(n.src?o.loader.setUrl(i(n.src)):o.loader.setUrl(i(n.base),i(n.delta)))},this.setCredentials(n.credentials),this.ajax=new Fn({timeout:o.timeout,retry:o.retry,error:function(e){o.listeners.trigger("error",[e])},withCredentials:function(){return o.withCredentials}});var r=n.src?new Tn(i(n.src),o.ajax):new On(i(n.base),i(n.delta)),s=this.class,a=this.headers;uo.call(o,w.JSUtils.extend({maxLevel:20,minLevel:13,loader:r,styles:new("ADDRESS"==s?Vn:"NAVLINK"==s?Kn:"PLACE"==s||"MARKER"==s?Jn:"AREA"==s?Mn:Xn),isDroppable:function(e){var t=e.editState();return!t||!t.modified&&!t.removed&&!t.split},Feature:tt},n),function(t){var r=t.provider.preprocessor,n=t.data,o=t.ready;return t.provider.getMetaData(ho,function(e){r?r(t):o(n)}),!1}),o.headers=r.headers=a,o.setHeaders(a),o.getMetaData(fo)}w.JSUtils.inheritClass(uo,So),So.prototype.prepareFeature=function(e){var t=e.properties=e.properties||{},r=!1;e.id==Qn&&(r=!0,e.id=w.JSUtils.String.random()+"-NEW",t[$n]=Qn);var n=t[$n]=t[$n]||{},o=this.metadata.defaultObject;return o&&(function(e,t){for(var r in t)e[r]==Qn&&(e[r]=w.JSUtils.clone(t[r]))}(t,o.properties),n.version||(n.version=o.version),r&&!n.states&&(n.states=o.states.slice()),n.layerId||(n.layerId=this.src||this.delta)),e},So.prototype.app_id=null,So.prototype.app_code=null,So.prototype.headers=null,So.prototype.withCredentials=!1,So.prototype.setHeader=function(e,t){var r={};r[e]=t,this.setHeaders(r)},So.prototype.setHeaders=function(e){this.setCredentials(e),uo.prototype.setHeaders.call(this,e)},So.prototype._getUrl=function(e){var t=this.headers,r=-1==e.indexOf("?")?"?":"&";return this[Ao]&&this[yo]&&(e=e+r+"app_id="+this[Ao]+"&app_code="+this[yo],r="&"),t&&"{}"!=(t=JSON.stringify(t))&&(e+=r+"headers="+encodeURIComponent(t)),e},So.prototype._requestFeatures=function(e,r,t){this.ajax.send({url:this._getUrl(this.getFeatureUrl(this.src||this.base,e.filter(function(e){return"number"==typeof e})))},function(e){for(var t=(e=e[0]).length;t--;)e[t]=Tn.toGeoJSON(e[t]);r&&r(e)},t)},So.prototype.getFeatureUrl=function(e,t){return"number"==typeof t&&(t=[t]),this.getLayerUrl(e)+"/?id="+t.join(",")},So.prototype.reserveId=function(e,t,r){var n=e.length;this.ajax.send({type:"POST",url:this._getUrl(this.getReserveIdUrl(this.delta||this.src,n)),contentType:"text/plain",data:String(n),accepts:go},function(e){t&&t(e[0])},r)},So.prototype.commit=function(e,t,r,n){var o=arguments,i=o.length;"string"==typeof o[i-1]&&(n=o[i-1]),e=Array.prototype.concat(e.put||[],e.remove||[]);for(var s=this,a={},c={},l=0,d=0,u=0,p=0,h=0;h<e.length;h++){var f=e[h],v=f.properties,g=v["@ns:com:here:maphub"],A=v["@ns:com:here:editor"],y=A.created,m=A.split,S=A.removed,E=g.layerId,C=g.states||[null],k=s.src||s.base,x=s.src||s.delta;n&&(this.getFeatureProperties(f).transactionId=n),k==E&&k!=x&&((a[k]=a[k]||[]).push({id:f.id,geometry:{type:f.geometry.type},properties:{layerId:E,states:[m?"SPLIT":vo,null,null,null]}}),l++,g.owner="BASE:"+g.guid),S?u++:y?p++:d++,C[0]=m?"SPLIT":S?vo:y?"CREATED":"UPDATED",g.layerId=x,y||(C[1]=C[2]=C[3]=null),g.states=C,(c[x]=c[x]||[]).push(f)}function L(e){var t=[];for(var r in e)e[r].length&&(t[t.length]={url:s._getUrl(s.getLayerUrl(r)),data:JSON.stringify(po.createFeatureContainer(e[r])),type:"POST",contentType:"application/vnd.here.layerObjectList+json",accepts:go});return t}w.JSUtils.dump("Layer",s.src||[s.base,s.delta].join("&"),"->","Flags",l,"Creates",p,"Mods",d,"Deletes",u,"info"),s.ajax.send([].concat(L(c),L(a)),t,r)},So.prototype.getLayerUrl=function(e){return this.url+"/"+e},So.prototype.getMetadataUrl=function(e,t){return t instanceof Array||(t=[]),this.getLayerUrl(e)+"/metadata?key="+t.join(",")},So.prototype.getTileUrl=function(e){return this.getLayerUrl(e)+"/tile?tileId={QUADKEY}"},So.prototype.getReserveIdUrl=function(e,t){return this.getLayerUrl(e)+"/reserve/"+t},So.prototype.getMetaData=function(e,t){var r,n=[],o=this;function i(){return w.JSUtils.clone(r?o.metadata[r]:o.metadata)}function s(){"function"==typeof t&&t(i())}if(t||"function"!=typeof e||(e=t=e),e){"string"==typeof e&&(e=[r=e]);for(var a=0;a<e.length;a++)void 0===o.metadata[e[a]]&&n.push(e[a])}if(!n.length)return s(),i();var c={url:o._getUrl(o.getMetadataUrl(o.src||o.base,e))};o.ajax.send(c,function(e){e=e[0],w.JSUtils.extend(o.metadata,e),s()})};var Eo={NAV:"NAVLINK",PNT:"ADDRESS",PLA:"PLACE",POI:"PLACE",CAR:"AREA",MARKER:"MARKER",NAVLINK:"NAVLINK",ADDRESS:"ADDRESS",PLACE:"PLACE"};So.prototype.getFeatureClass=function(e){var t,r=this.detectFeatureClass(e);return"NAVLINK"==r?t=Ur:"PLACE"==r?t=ao:"ADDRESS"==r?t=co:"AREA"==r?t=Lr:"MARKER"==r?t=kr:"LINE"==r&&(t=lo),t},So.prototype.getFeatureProperties=function(e){return e.properties},So.prototype.detectFeatureClass=function(e){var t=e.properties["@ns:com:here:maphub"].version;return Eo[t&&t.substr(0,3)]||this.class};var Co="isocc";So.prototype.isoCC=function(e,t){var r=e.properties;if(1==arguments.length)return(t=r[Co])instanceof Array&&(t=t[0]),t;if(2==arguments.length)if("NAVLINK"==this.detectFeatureClass(e)){var n=r[Co]=r[Co]||[];-1==n.indexOf(t)&&n.push(t)}else r[Co]=t},So.prototype.hooks=ro,So.prototype.readRoutingProvider=function(e,t){for(var r=0,n=t;r<n.length;r++){var o=n[r];if("NAVLINK"==o.class)return o.id}},So.prototype.readRoutingPosition=function(e){return e.properties.rp},So.prototype.readRoutingLink=function(e){var t=e.prop("link");return"string"==typeof t?t.split(":")[0]:t},So.prototype.writeRoutingPosition=function(e,t){e.prop("rp",t)},So.prototype.writeRoutingLink=function(e,t){e.prop("link",t?String(t.id):t)},So.prototype.readPedestrianOnly=function(e){var t=e.prop("access");return 16==t||528==t},So.prototype.readDirection=function(e){var t=e.prop("dir");return"B"==t?"BOTH":"F"==t?"START_TO_END":"T"==t?"END_TO_START":void 0},So.prototype.readTurnRestriction=function(e,t){return-1!=((t.link.prop("tr")||{})[0==t.index?"ref":"nref"]||[]).indexOf(e.link.id)},So.prototype.writeTurnRestriction=function(e,t,r){var n=r.link,o=t.link.id,i=n.prop("tr")||{};i.ref=i.ref||[],i.nref=i.nref||[];var s=i[0==r.index?"ref":"nref"],a=s.indexOf(o);e?-1==a&&(s.push(o),n.prop("tr",i)):0<=a&&(s.splice(a,1),n.prop("tr",i))},So.prototype.writeEditState=function(e,t){var r=e.properties["@ns:com:here:maphub"],n=r.states=r.states||[,null,null,null],o=n[0];"SPLIT"!=o&&("CREATED"==o&&"REMOVED"!=t||(n[0]="modified"==t?"UPDATED":t.toUpperCase()))};var ko={};ko.NAVLINK="Navlink",ko.AREA="Area",ko.PLACE="Place",ko.ADDRESS="Address",ko.MARKER="Marker",ko.LINE="Line";for(var xo=function(){function e(n){var i=function(e){if("number"==typeof(null!=e.x?e.x:null!=e.longitude?e.longitude:e[0]))return e;for(var t=[],r=0,n=e;r<n.length;r++){var o=n[r];t[t.length]=i(o)}return t};function e(e,t,r){"number"!=typeof e&&"string"!=typeof e?(r=t,t=e):this.id=e,this.type="Feature",this.class=n,this.properties=w.JSUtils.extend({"@ns:com:here:editor":new Ze},r||{}),this.geometry={type:"PLACE"==n||"ADDRESS"==n||"MARKER"==n?"Point":"AREA"==n?"MultiPolygon":"LineString",coordinates:i(t)}}return e.prototype=tt.prototype,e}var t={};for(var r in ko)t[ko[r]]=e(r);return t}(),Lo=function(e,t,r){this.x=e,this.y=t,this.z=r||0},bo=function(e,t,r){this.longitude=e,this.latitude=t,this.z=r||0},_o={create:function(e,t,r){try{var n=(void 0).destination+"ui/";w.JSUtils.executeScript(n+e+"/main.js",{name:e,editor:t,destination:n,params:r})}catch(e){w.JSUtils.dump(e,"warn")}}},Io="here.xyz.maps.editor".split("."),Po=w.global,wo=0;wo<Io.length-1;wo++)Po=Po[Io[wo]]=Po[Io[wo]]||{};var Ro=Po[Io.pop()]={Editor:un,features:xo,PixelCoordinate:Lo,GeoCoordinate:bo,UI:_o},Fo=w.global.HERE.xyz.maps.providers,Do=So.prototype.getFeatureClass;Fo.EditableProvider.prototype.getFeatureClass=function(e){return Do.call(this,e)||this.Feature},Fo.ProProvider=So,e.Editor=un,e.GeoCoordinate=bo,e.PixelCoordinate=Lo,e.UI=_o,e.default=Ro,e.features=xo,Object.defineProperty(e,"__esModule",{value:!0})});
